!function(){function e(e,t,r,a){Object.defineProperty(e,t,{get:r,set:a,enumerable:!0,configurable:!0})}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire594f;t.register("jvSuk",(function(r,a){e(r.exports,"default",(function(){return l}));var n=t("8TSCy"),i=t("10vEZ"),l=function(){"use strict";function e(){n.classCallCheck(this,e),this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}return n.createClass(e,[{key:"add",value:function(e,t,r){this._layerById[t]=r,this._layerByName[e]=r}},{key:"featureSetByName",value:function(e){return void 0===this._layerByName[e]?this.resolvePromise(null):this.resolvePromise(this._layerByName[e])}},{key:"featureSetById",value:function(e){return void 0===this._layerById[e]?this.resolvePromise(null):this.resolvePromise(this._layerById[e])}},{key:"castToText",value:function(){return"object, FeatureSetCollection"}},{key:"resolvePromise",value:function(e){return(0,i.resolve)(e)}}]),e}()})),t.register("fJC97",(function(r,a){e(r.exports,"default",(function(){return f}));var n=t("8TSCy"),i=t("ct6g2"),l=t("3khKC"),s=t("9yzf5"),u=t("jA3R1"),o=t("10vEZ"),d=t("9AqbE"),c=t("j40xv"),f=function(e){"use strict";n.inherits(r,e);var t=n.createSuper(r);function r(e){var a;return n.classCallCheck(this,r),(a=t.call(this,e)).declaredClass="esri.arcade.featureset.actions.AttributeFilter",a._maxProcessing=1e3,a._parent=e.parentfeatureset,e.whereclause instanceof d.WhereClause?(a._whereclause=e.whereclause,a._whereClauseFunction=null):(a._whereClauseFunction=e.whereclause,a._whereclause=null),n.possibleConstructorReturn(a)}return n.createClass(r,[{key:"_initialiseFeatureSet",value:function(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new(0,c.default)({wkid:4326}),this.geometryType=s.layerGeometryEsriConstants.point)}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getFilteredSet("",null,t._whereclause,null,e)})).then((function(r){return t._checkCancelled(e),null!==t._whereClauseFunction?t._wset=new(0,l.default)(r._candidates.slice(0).concat(r._known.slice(0)),[],r._ordered,t._clonePageDefinition(r.pagesDefinition)):t._wset=new(0,l.default)(r._candidates.slice(0),r._known.slice(0),r._ordered,t._clonePageDefinition(r.pagesDefinition)),t._wset})):(0,o.resolve)(this._wset)}},{key:"_isInFeatureSet",value:function(e){var t=this._parent._isInFeatureSet(e);return t===s.IdState.NotInFeatureSet?t:void 0===(t=this._idstates[e])?s.IdState.Unknown:t}},{key:"_getFeature",value:function(e,t,r){return this._parent._getFeature(e,t,r)}},{key:"_getFeatures",value:function(e,t,r,a){return this._parent._getFeatures(e,t,r,a)}},{key:"_featureFromCache",value:function(e){return this._parent._featureFromCache(e)}},{key:"executeWhereClause",value:function(e){return this._whereclause.testFeature(e)}},{key:"executeWhereClauseDeferred",value:function(e){if(null!==this._whereClauseFunction)try{var t=this._whereClauseFunction(e);return(0,o.isPromiseLike)(t)?t:(0,o.resolve)(t)}catch(e){return(0,o.reject)(e)}return(0,o.resolve)(this.executeWhereClause(e))}},{key:"_fetchAndRefineFeatures",value:function(e,t,r){var a=this,n=new(0,l.default)([],e,!1,null),i=Math.min(t,e.length);return this._parent._getFeatures(n,-1,i,r).then((function(){var n=a;if(a._checkCancelled(r),null==a._whereClauseFunction){for(var l=0;l<i;l++){var u=a._parent._featureFromCache(e[l]);!0===a.executeWhereClause(u)?a._idstates[e[l]]=s.IdState.InFeatureSet:a._idstates[e[l]]=s.IdState.NotInFeatureSet}return"success"}for(var d=[],c=0;c<i;c++){var f=a._parent._featureFromCache(e[c]);d.push(a.executeWhereClauseDeferred(f))}return(0,o.all)(d).then((function(r){for(var a=0;a<t;a++)!0===r[a]?n._idstates[e[a]]=s.IdState.InFeatureSet:n._idstates[e[a]]=s.IdState.NotInFeatureSet;return"success"}))}))}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return null!==this._whereClauseFunction||(null!==r?null!==this._whereclause&&(r=(0,u.combine)(this._whereclause,r)):r=this._whereclause),this._ensureLoaded().then((function(){return i._parent._getFilteredSet(e,t,r,a,n)})).then((function(e){return i._checkCancelled(n),null!==i._whereClauseFunction?new(0,l.default)(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,i._clonePageDefinition(e.pagesDefinition)):new(0,l.default)(e._candidates.slice(0),e._known.slice(0),e._ordered,i._clonePageDefinition(e.pagesDefinition))}))}},{key:"_stat",value:function(e,t,r,a,n,i,l){var s=this;if(null!==this._whereClauseFunction)return null===n&&""===r&&null===a?this._manualStat(e,t,i,l):(0,o.resolve)({calculated:!1});var d=this._whereclause;return null!==n&&null!==this._whereclause&&(d=(0,u.combine)(this._whereclause,n)),this._parent._stat(e,t,r,a,d,i,l).then((function(u){return!1===u.calculated?null===n&&""===r&&null===a?s._manualStat(e,t,i,l):{calculated:!1}:u}))}},{key:"_canDoAggregates",value:function(e,t,r,a,n){return null!==this._whereClauseFunction?(0,o.resolve)(!1):(null!==n?null!==this._whereclause&&(n=(0,u.combine)(this._whereclause,n)):n=this._whereclause,null===this._parent?(0,o.resolve)(!1):this._parent._canDoAggregates(e,t,r,a,n))}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,a,n,i,l){return null===this._parent?(0,o.reject)(new Error("Should never be called")):(null!==n?null!==this._whereclause&&(n=(0,u.combine)(this._whereclause,n)):n=this._whereclause,this._parent._getAggregatePagesDataSourceDefinition(e,t,r,a,n,i,l))}}],[{key:"registerAction",value:function(){i.default._featuresetFunctions.filter=function(e){if("function"==typeof e)return new r({parentfeatureset:this,whereclause:e});var t=null;return e instanceof d.WhereClause&&(t=e),new r({parentfeatureset:this,whereclause:t})}}}]),r}(i.default)})),t.register("bILeR",(function(r,a){e(r.exports,"default",(function(){return k}));var n=t("8TSCy"),i=t("bsvXr"),l=t("e8oaX"),s=t("jeRSU"),u=t("fJC97"),o=t("k1hID"),d=t("ct6g2"),c=t("3khKC"),f=t("aZgek"),h=t("9yzf5"),y=t("jA3R1"),p=t("hyZZn"),_=t("h1kCI"),v=t("fsJts"),g=t("10vEZ"),m=t("9AqbE"),S=t("j40xv"),w=t("buMuJ"),F=t("4nMX7");function b(e){if(!e)return"COUNT";switch(e.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}var k=function(e){"use strict";n.inherits(r,e);var t=n.createSuper(r);function r(e){var a;return n.classCallCheck(this,r),(a=t.call(this,e))._decodedStatsfield=[],a._decodedGroupbyfield=[],a._candosimplegroupby=!0,a.phsyicalgroupbyfields=[],a.objectIdField="ROW__ID",a._internalObjectIdField="ROW__ID",a._adaptedFields=[],a.declaredClass="esri.arcade.featureset.actions.Aggregate",a._uniqueIds=1,a._maxQuery=10,a._maxProcessing=10,a._parent=e.parentfeatureset,a._config=e,n.possibleConstructorReturn(a)}return n.createClass(r,[{key:"isTable",value:function(){return!0}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._getFilteredSet("",null,null,null,e).then((function(e){return t._wset=e,t._wset})):(0,g.resolve)(this._wset)}},{key:"_isInFeatureSet",value:function(){return h.IdState.InFeatureSet}},{key:"_nextUniqueName",value:function(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;var t="T"+this._uniqueIds.toString();return e[t]=1,t}},{key:"_convertToEsriFieldType",value:function(e){return e}},{key:"_initialiseFeatureSet",value:function(){var e={},t=!1,r=1,a=this._parent?this._parent.getFieldsIndex():new(0,F.default)([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){for(var n=!1,i=0;i<this._config.groupbyfields.length;i++)if(this._config.groupbyfields[i].name.toLowerCase()===this.objectIdField.toLowerCase()){n=!0;break}if(!1===n)for(var l=0;l<this._config.statsfields.length;l++)if(this._config.statsfields[l].name.toLowerCase()===this.objectIdField.toLowerCase()){n=!0;break}!1===n?t=!0:(this.objectIdField="ROW__ID"+r.toString(),r++)}var u=!0,o=!1,d=void 0;try{for(var c,f=this._config.statsfields[Symbol.iterator]();!(u=(c=f.next()).done);u=!0){var p=c.value,v=new(0,_.default);v.field=p.name,v.tofieldname=p.name,v.workingexpr=p.expression instanceof m.WhereClause?p.expression:m.WhereClause.create(p.expression,a),v.typeofstat=b(p.statistic),this._decodedStatsfield.push(v)}}catch(e){o=!0,d=e}finally{try{u||null==f.return||f.return()}finally{if(o)throw d}}this._decodedGroupbyfield=[];var g=!0,k=!1,C=void 0;try{for(var I,x=this._config.groupbyfields[Symbol.iterator]();!(g=(I=x.next()).done);g=!0){var D=I.value,R={name:D.name,singlefield:null,tofieldname:D.name,expression:D.expression instanceof m.WhereClause?D.expression:m.WhereClause.create(D.expression,a)};this._decodedGroupbyfield.push(R)}}catch(e){k=!0,C=e}finally{try{g||null==x.return||x.return()}finally{if(k)throw C}}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";var T=!0,E=!1,P=void 0;try{for(var N,A=this._parent.fields[Symbol.iterator]();!(T=(N=A.next()).done);T=!0){e[N.value.name.toUpperCase()]=1}}catch(e){E=!0,P=e}finally{try{T||null==A.return||A.return()}finally{if(E)throw P}}this.types=null}else this.geometryType=h.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null,this.spatialReference=new(0,S.default)({wkid:4326});this.fields=[];var O=new(0,_.default);O.field=this._nextUniqueName(e),O.tofieldname=this.objectIdField,O.workingexpr=m.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),O.typeofstat="MIN",this._decodedStatsfield.push(O);var j=!0,q=!1,L=void 0;try{for(var W,G=this._decodedGroupbyfield[Symbol.iterator]();!(j=(W=G.next()).done);j=!0){var B=W.value,U=new(0,w.default);if(B.name=this._nextUniqueName(e),U.name=B.tofieldname,U.alias=U.name,(0,y.isSingleField)(B.expression)){var M=this._parent.getField((0,y.toWhereClause)(B.expression,h.FeatureServiceDatabaseType.Standardised));if(!M)throw new Error("Field is not present for Aggregation");B.name=M.name,B.singlefield=M.name,this.phsyicalgroupbyfields.push(M.name),U.type=M.type}else{U.type=this._convertToEsriFieldType((0,y.predictType)(B.expression,this._parent.fields));var Q=new(0,w.default);Q.name=B.name,Q.alias=Q.name,this.phsyicalgroupbyfields.push(B.name),this._adaptedFields.push(new(0,s.SqlExpressionAdapted)(Q,B.expression)),this._candosimplegroupby=!1}this.fields.push(U)}}catch(e){q=!0,L=e}finally{try{j||null==G.return||G.return()}finally{if(q)throw L}}var V=!0,K=!1,J=void 0;if(this._adaptedFields.length>0)try{for(var Z,X=this._parent.fields[Symbol.iterator]();!(V=(Z=X.next()).done);V=!0){var z=Z.value;this._adaptedFields.push(new(0,s.OriginalField)(z))}}catch(e){K=!0,J=e}finally{try{V||null==X.return||X.return()}finally{if(K)throw J}}for(var H=0;H<this._decodedStatsfield.length;H++){var Y=new(0,w.default),$=null,ee=this._decodedStatsfield[H];ee.field=this._nextUniqueName(e),ee.tofieldname===this.objectIdField&&(this._internalObjectIdField=ee.field),Y.name=ee.tofieldname,Y.alias=Y.name;var te=null!==ee.workingexpr&&(0,y.isSingleField)(ee.workingexpr)?(0,y.toWhereClause)(ee.workingexpr,h.FeatureServiceDatabaseType.Standardised):"";switch(this._decodedStatsfield[H].typeofstat){case"SUM":if(""!==te){if(!($=this._parent.getField(te)))throw new Error("Field is not present for Aggregation");Y.type=$.type}else Y.type="double";break;case"MIN":case"MAX":if(""!==te){if(!($=this._parent.getField(te)))throw new Error("Field is not present for Aggregation");Y.type=$.type}else Y.type="double";break;case"COUNT":Y.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==te&&!($=this._parent.getField(te)))throw new Error("Field is not present for Aggregation");Y.type="double"}this.fields.push(Y)}}},{key:"_canDoAggregates",value:function(){return(0,g.resolve)(!1)}},{key:"_getFeatures",value:function(e,t,r,a){var n=this;-1!==t&&this._featureCache[t];var i=this._maxQuery;return!0===this._checkIfNeedToExpandKnownPage(e,i)?this._expandPagedSet(e,i,0,0,a).then((function(){return n._getFeatures(e,t,r,a)})):(0,g.resolve)("success")}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;if(""!==e)return(0,g.resolve)(new(0,c.default)([],[],!0,null));var l=null,d={ordered:!1,nowhereclause:!1};return this._ensureLoaded().then((function(){if(null!==r)for(var e=0;e<i._decodedStatsfield.length;e++)if(!0===(0,y.scanForField)(r,i._decodedStatsfield[e].tofieldname)){d.nowhereclause=!0,r=null;break}if(null!==a){d.ordered=!0;for(var t=0;t<i._decodedStatsfield.length;t++)if(!0===a.scanForField(i._decodedStatsfield[t].tofieldname)){a=null,d.ordered=!1;break}if(null!==a){var n=!0,l=!1,s=void 0;try{for(var u,o=i._decodedGroupbyfield[Symbol.iterator]();!(n=(u=o.next()).done);n=!0){var c=u.value;if(null===c.singlefield&&!0===a.scanForField(c.tofieldname)){a=null,d.ordered=!1;break}}}catch(e){l=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(l)throw s}}}}return!1===i._candosimplegroupby?(0,g.resolve)(!1):i._parent._canDoAggregates(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,null)})).then((function(e){if(e){var t=i,h=null;r&&(h=i._reformulateWhereClauseWithoutGroupByFields(r));var y=null;return a&&(y=i._reformulateOrderClauseWithoutGroupByFields(a)),i._parent._getAggregatePagesDataSourceDefinition(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,h,y,i._internalObjectIdField).then((function(e){return t._checkCancelled(n),l=!0===d.nowhereclause?new(0,c.default)(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===d.ordered&&e._ordered,t._clonePageDefinition(e.pagesDefinition)):new(0,c.default)(e._candidates.slice(0),e._known.slice(0),!0===d.ordered&&e._ordered,t._clonePageDefinition(e.pagesDefinition))}))}var p=i._parent;if(i._adaptedFields.length>0&&(p=new(0,s.AdaptedFeatureSet)({parentfeatureset:i._parent,adaptedFields:i._adaptedFields,extraFilter:null})),!0===d.nowhereclause)l=new(0,c.default)(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new(0,o.default)({parentfeatureset:p,orderbyclause:new(0,f.default)(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}});else{var _=p;if(null!==r){var v=null;r&&(v=i._reformulateWhereClauseWithoutGroupByFields(r)),_=new(0,u.default)({parentfeatureset:_,whereclause:v})}l=new(0,c.default)(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new(0,o.default)({parentfeatureset:_,orderbyclause:new(0,f.default)(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}})}return l}))}},{key:"_reformulateWhereClauseWithoutStatsFields",value:function(e){var t=!0,r=!1,a=void 0;try{for(var n,i=this._decodedStatsfield[Symbol.iterator]();!(t=(n=i.next()).done);t=!0){var l=n.value;e=(0,y.reformulateWithoutField)(e,l.tofieldname,(0,y.toWhereClause)(l.workingexpr,h.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex())}}catch(e){r=!0,a=e}finally{try{t||null==i.return||i.return()}finally{if(r)throw a}}return e}},{key:"_reformulateWhereClauseWithoutGroupByFields",value:function(e){var t=!0,r=!1,a=void 0;try{for(var n,i=this._decodedGroupbyfield[Symbol.iterator]();!(t=(n=i.next()).done);t=!0){var l=n.value;l.tofieldname!==l.name&&(e=(0,y.reformulateWithoutField)(e,l.tofieldname,(0,y.toWhereClause)(l.expression,h.FeatureServiceDatabaseType.Standardised),this._parent.getFieldsIndex()))}}catch(e){r=!0,a=e}finally{try{t||null==i.return||i.return()}finally{if(r)throw a}}return e}},{key:"_reformulateOrderClauseWithoutGroupByFields",value:function(e){var t=[],r=!0,a=!1,n=void 0;try{for(var i,l=this._decodedGroupbyfield[Symbol.iterator]();!(r=(i=l.next()).done);r=!0){var s=i.value;s.tofieldname!==s.name&&t.push({field:s.tofieldname,newfield:s.name})}}catch(e){a=!0,n=e}finally{try{r||null==l.return||l.return()}finally{if(a)throw n}}return t.length>0?e.replaceFields(t):e}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}},{key:"_refineSetBlock",value:function(e,t,r){try{var a=this;if(!0===this._checkIfNeedToExpandCandidatePage(e,this._maxQuery))return this._expandPagedSet(e,this._maxQuery,0,0,r).then((function(){return a._refineSetBlock(e,t,r)}));this._checkCancelled(r);e._candidates.length;return this._refineKnowns(e,t),e._candidates.length,e._candidates.length,(0,g.resolve)(e)}catch(e){return(0,g.reject)(e)}}},{key:"_expandPagedSet",value:function(e,t,r,a,n){return this._expandPagedSetFeatureSet(e,t,r,a,n)}},{key:"_getPhysicalPage",value:function(e,t,r){var a=this;return!0===e.pagesDefinition.aggregatefeaturesetpagedefinition?(0,g.create)((function(t,n){a._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,r,[]).then((function(e){t(e)}),n)})):this._getAgregagtePhysicalPage(e,t,r).then((function(e){var t=!0,r=!1,n=void 0;try{for(var l,s=e[Symbol.iterator]();!(t=(l=s.next()).done);t=!0){var u=l.value,o={geometry:u.geometry,attributes:{}},d=!0,c=!1,f=void 0;try{for(var h,y=a._decodedGroupbyfield[Symbol.iterator]();!(d=(h=y.next()).done);d=!0){var p=h.value;o.attributes[p.tofieldname]=u.attributes[p.name]}}catch(e){c=!0,f=e}finally{try{d||null==y.return||y.return()}finally{if(c)throw f}}var _=!0,v=!1,g=void 0;try{for(var m,S=a._decodedStatsfield[Symbol.iterator]();!(_=(m=S.next()).done);_=!0){var w=m.value;o.attributes[w.tofieldname]=u.attributes[w.field]}}catch(e){v=!0,g=e}finally{try{_||null==S.return||S.return()}finally{if(v)throw g}}a._featureCache[o.attributes[a.objectIdField]]=new(0,i.default)(o)}}catch(e){r=!0,n=e}finally{try{t||null==s.return||s.return()}finally{if(r)throw n}}return e.length}))}},{key:"_sequentialGetPhysicalItem",value:function(e,t,r,a){var n=this;return(0,g.create)((function(i,l){var s=n;null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(r)),!0===e.pagesDefinition.internal.fullyResolved||0===t?i(a.length):n._nextAggregateItem(e,t,r,a,(function(n){null===n?i(a.length):(t-=1,i(s._sequentialGetPhysicalItem(e,t,r,a)))}),l)}))}},{key:"_nextAggregateItem",value:function(e,t,r,a,n,i){try{var s=this;(0,l.X)(e.pagesDefinition.internal.iterator.next()).then((function(l){if(null===l)if(null!==e.pagesDefinition.internal.workingItem){var u=s._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);a.push(u),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(u.attributes[s.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,n(null)}else e.pagesDefinition.internal.fullyResolved=!0,n(null);else{var o=s._generateAggregateHash(l);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[l],id:o};else{if(o!==e.pagesDefinition.internal.workingItem.id){var d=s._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return a.push(d),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(d.attributes[s.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[l],id:o},void n(d)}e.pagesDefinition.internal.workingItem.features.push(l)}s._nextAggregateItem(e,t,r,a,n,i)}}),i)}catch(e){i(e)}}},{key:"_calculateFieldStat",value:function(e,t,r){for(var a=[],n=0;n<e.features.length;n++)if(null!==t.workingexpr){var i=t.workingexpr.calculateValue(e.features[n]);null!==i&&a.push(i)}else a.push(null);switch(t.typeofstat){case"MIN":r.attributes[t.tofieldname]=(0,p.calculateStat)("min",a,-1);break;case"MAX":r.attributes[t.tofieldname]=(0,p.calculateStat)("max",a,-1);break;case"SUM":r.attributes[t.tofieldname]=(0,p.calculateStat)("sum",a,-1);break;case"COUNT":r.attributes[t.tofieldname]=a.length;break;case"VAR":r.attributes[t.tofieldname]=(0,p.calculateStat)("var",a,-1);break;case"STDDEV":r.attributes[t.tofieldname]=(0,p.calculateStat)("stddev",a,-1);break;case"AVG":r.attributes[t.tofieldname]=(0,p.calculateStat)("avg",a,-1)}return!0}},{key:"_calculateAndAppendAggregateItem",value:function(e){var t={attributes:{},geometry:null},r=!0,a=!1,n=void 0;try{for(var l,s=this._decodedGroupbyfield[Symbol.iterator]();!(r=(l=s.next()).done);r=!0){var u=l.value,o=u.singlefield?e.features[0].attributes[u.singlefield]:u.expression.calculateValue(e.features[0]);t.attributes[u.tofieldname]=o}}catch(e){a=!0,n=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw n}}var d=!0,c=!1,f=void 0;try{for(var h,y=this._decodedStatsfield[Symbol.iterator]();!(d=(h=y.next()).done);d=!0){var p=h.value;this._calculateFieldStat(e,p,t)}}catch(e){c=!0,f=e}finally{try{d||null==y.return||y.return()}finally{if(c)throw f}}for(var _=[],v=0;v<this._decodedStatsfield.length;v++)_.push(this._calculateFieldStat(e,this._decodedStatsfield[v],t));return this._featureCache[t.attributes[this.objectIdField]]=new(0,i.default)({attributes:t.attributes,geometry:t.geometry}),t}},{key:"_generateAggregateHash",value:function(e){var t="",r=!0,a=!1,n=void 0;try{for(var i,l=this._decodedGroupbyfield[Symbol.iterator]();!(r=(i=l.next()).done);r=!0){var s=i.value,u=s.singlefield?e.attributes[s.singlefield]:s.expression.calculateValue(e);t+=null==u?":":":"+u.toString()}}catch(e){a=!0,n=e}finally{try{r||null==l.return||l.return()}finally{if(a)throw n}}return(0,v.createMD5Hash)(t,v.outputTypes.String)}},{key:"_stat",value:function(){return(0,g.resolve)({calculated:!1})}},{key:"getFeatureByObjectId",value:function(){return(0,g.resolve)(null)}}],[{key:"registerAction",value:function(){d.default._featuresetFunctions.groupby=function(e,t){return new r({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}]),r}(d.default)})),t.register("jeRSU",(function(r,a){e(r.exports,"OriginalField",(function(){return p})),e(r.exports,"FieldRename",(function(){return _})),e(r.exports,"StringToCodeAdapted",(function(){return v})),e(r.exports,"SqlExpressionAdapted",(function(){return g})),e(r.exports,"AdaptedFeatureSet",(function(){return m}));var n=t("8TSCy"),i=t("bsvXr"),l=t("dcpcS"),s=t("ct6g2"),u=t("3khKC"),o=t("9yzf5"),d=t("jA3R1"),c=t("10vEZ"),f=t("9AqbE"),h=t("j40xv"),y=function(){"use strict";function e(t){n.classCallCheck(this,e),this.field=t,this.sqlRewritable=!1}return n.createClass(e,[{key:"postInitialization",value:function(e,t){}}]),e}(),p=function(e){"use strict";n.inherits(r,e);var t=n.createSuper(r);function r(e){var a;return n.classCallCheck(this,r),(a=t.call(this,e)).sqlRewritable=!0,n.possibleConstructorReturn(a)}return n.createClass(r,[{key:"extractValue",value:function(e){return e.attributes[this.field.name]}},{key:"rewriteSql",value:function(e){return{rewritten:this.sqlRewritable,where:e}}}]),r}(y),_=function(e){"use strict";n.inherits(r,e);var t=n.createSuper(r);function r(e,a,i){var l;return n.classCallCheck(this,r),(l=t.call(this,(0,o.cloneField)(e))).originalField=e,l.sqlRewritable=!0,l.field.name=a,l.field.alias=i,n.possibleConstructorReturn(l)}return n.createClass(r,[{key:"rewriteSql",value:function(e,t){return{rewritten:this.sqlRewritable,where:(0,d.reformulateWithoutField)(e,this.field.name,this.originalField.name,t.getFieldsIndex())}}},{key:"extractValue",value:function(e){return e.attributes[this.originalField.name]}}]),r}(y),v=function(e){"use strict";n.inherits(r,e);var t=n.createSuper(r);function r(e,a,i){var l;for(var s in n.classCallCheck(this,r),(l=t.call(this,e)).codefield=a,l.lkp=i,l.reverseLkp={},i)l.reverseLkp[i[s]]=s;return l.sqlRewritable=!0,n.possibleConstructorReturn(l)}return n.createClass(r,[{key:"rewriteSql",value:function(e,t){var a=this.evaluateNodeToWhereClause(e.parseTree,o.FeatureServiceDatabaseType.Standardised,this.field.name,this.codefield instanceof f.WhereClause?(0,d.toWhereClause)(this.codefield,o.FeatureServiceDatabaseType.Standardised):this.codefield,e.parameters);return a.indexOf(r.BADNESS)>=0?{rewritten:!1,where:e}:{rewritten:this.sqlRewritable,where:f.WhereClause.create(a,t._parent.getFieldsIndex())}}},{key:"evaluateNodeToWhereClause",value:function(e,t){var a,n,i,l,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,u=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4?arguments[4]:void 0;switch(e.type){case"interval":return(0,d.convertIntervalToSql)(this.evaluateNodeToWhereClause(e.value,t,s,u,o),e.qualifier,e.op);case"case_expression":var c=" CASE ";"simple"===e.format&&(c+=this.evaluateNodeToWhereClause(e.operand,t,s,r.BADNESS,o));for(var f=0;f<e.clauses.length;f++)c+=" WHEN "+this.evaluateNodeToWhereClause(e.clauses[f].operand,t,s,r.BADNESS,o)+" THEN "+this.evaluateNodeToWhereClause(e.clauses[f].value,t,s,r.BADNESS,o);return null!==e.else&&(c+=" ELSE "+this.evaluateNodeToWhereClause(e.else,t,s,r.BADNESS,o)),c+=" END ";case"param":var h=o[e.value.toLowerCase()];if("string"==typeof h)return"'"+o[e.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(h instanceof Date)return(0,d.makeDateString)(h,t);if(h instanceof Array){for(var y=[],p=0;p<h.length;p++)"string"==typeof h[p]?y.push("'"+h[p].toString().replace(/'/g,"''")+"'"):h[p]instanceof Date?y.push((0,d.makeDateString)(h[p],t)):y.push(h[p].toString());return y}return h.toString();case"expr_list":n=[];var _=!0,v=!1,g=void 0;try{for(var m,S=e.value[Symbol.iterator]();!(_=(m=S.next()).done);_=!0){var w=m.value;n.push(this.evaluateNodeToWhereClause(w,t,s,u,o))}}catch(e){v=!0,g=e}finally{try{_||null==S.return||S.return()}finally{if(v)throw g}}return n;case"unary_expr":return" ( NOT "+this.evaluateNodeToWhereClause(e.expr,t,s,r.BADNESS,o)+" ) ";case"binary_expr":switch(e.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(e.left,t,s,u,o)+" AND "+this.evaluateNodeToWhereClause(e.right,t,s,u,o)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(e.left,t,s,u,o)+" OR "+this.evaluateNodeToWhereClause(e.right,t,s,u,o)+") ";case"IS":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,s,u,o)+" IS NULL )";case"ISNOT":if("null"!==e.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(e.left,t,s,u,o)+" IS NOT NULL )";case"IN":if(a=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){var F=[],b=!0,k=!0,C=!1,I=void 0;try{for(var x,D=e.right.value[Symbol.iterator]();!(k=(x=D.next()).done);k=!0){var R=x.value;if("string"!==R.type){b=!1;break}if(void 0===this.lkp[R.value]){b=!1;break}F.push(this.lkp[R.value].toString())}}catch(e){C=!0,I=e}finally{try{k||null==D.return||D.return()}finally{if(C)throw I}}if(b)return" ("+this.evaluateNodeToWhereClause(e.left,t,s,u,o)+" IN ("+F.join(",")+")) "}return a=this.evaluateNodeToWhereClause(e.right,t,s,u,o)," ("+this.evaluateNodeToWhereClause(e.left,t,s,u,o)+" IN ("+a.join(",")+")) "}return(l=this.evaluateNodeToWhereClause(e.right,t,s,u,o))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,s,u,o)+" IN ("+l.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,s,u,o)+" IN ("+l+")) ";case"NOT IN":if(a=[],"expr_list"===e.right.type){if("column_ref"===e.left.type&&e.left.column.toUpperCase()===this.field.name.toUpperCase()){var T=[],E=!0,P=!0,N=!1,A=void 0;try{for(var O,j=e.right.value[Symbol.iterator]();!(P=(O=j.next()).done);P=!0){var q=O.value;if("string"!==q.type){E=!1;break}if(void 0===this.lkp[q.value]){E=!1;break}T.push(this.lkp[q.value].toString())}}catch(e){N=!0,A=e}finally{try{P||null==j.return||j.return()}finally{if(N)throw A}}if(E)return" ("+this.evaluateNodeToWhereClause(e.left,t,s,u,o)+" NOT IN ("+T.join(",")+")) "}return a=this.evaluateNodeToWhereClause(e.right,t,s,u,o)," ("+this.evaluateNodeToWhereClause(e.left,t,s,u,o)+" NOT IN ("+a.join(",")+")) "}return(l=this.evaluateNodeToWhereClause(e.right,t,s,u,o))instanceof Array?" ("+this.evaluateNodeToWhereClause(e.left,t,s,u,o)+" NOT IN ("+l.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(e.left,t,s,u,o)+" NOT IN ("+l+")) ";case"BETWEEN":return i=this.evaluateNodeToWhereClause(e.right,t,s,r.BADNESS,o)," ("+this.evaluateNodeToWhereClause(e.left,t,s,r.BADNESS,o)+" BETWEEN "+i[0]+" AND "+i[1]+" ) ";case"NOTBETWEEN":return i=this.evaluateNodeToWhereClause(e.right,t,s,r.BADNESS,o)," ("+this.evaluateNodeToWhereClause(e.left,t,s,r.BADNESS,o)+" NOT BETWEEN "+i[0]+" AND "+i[1]+" ) ";case"LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,s,r.BADNESS,o)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,s,r.BADNESS,o)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,s,r.BADNESS,o)+" LIKE "+this.evaluateNodeToWhereClause(e.right,t,s,r.BADNESS,o)+") ";case"NOT LIKE":return""!==e.escape?" ("+this.evaluateNodeToWhereClause(e.left,t,s,r.BADNESS,o)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,s,r.BADNESS,o)+" ESCAPE '"+e.escape+"') ":" ("+this.evaluateNodeToWhereClause(e.left,t,s,r.BADNESS,o)+" NOT LIKE "+this.evaluateNodeToWhereClause(e.right,t,s,r.BADNESS,o)+") ";case"<>":case"=":if("column_ref"===e.left.type&&"string"===e.right.type){if(e.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[e.right.value.toString()])return" ("+u+" "+e.operator+" "+this.lkp[e.right.value.toString()].toString()+") "}else if("column_ref"===e.right.type&&"string"===e.left.type&&e.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[e.right.value.toString()].toString()+" "+e.operator+" "+u+") ";return" ("+this.evaluateNodeToWhereClause(e.left,t,s,r.BADNESS,o)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,s,r.BADNESS,o)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(e.left,t,s,r.BADNESS,o)+" "+e.operator+" "+this.evaluateNodeToWhereClause(e.right,t,s,r.BADNESS,o)+") "}throw new Error("Not Supported Operator "+e.operator);case"null":return"null";case"bool":return!0===e.value?"1":"0";case"string":return"'"+e.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return(0,d.makeDateString)(e.value,t);case"number":return e.value.toString();case"current_time":return(0,d.makeToday)("date"===e.mode,t);case"column_ref":return s&&s.toLowerCase()===e.column.toLowerCase()?"("+u+")":e.column;case"function":var L=this.evaluateNodeToWhereClause(e.args,t,s,r.BADNESS,o);return(0,d.translateFunctionToDatabaseSpecific)(e.name,L,t)}throw new Error("Unsupported sql syntax "+e.type)}},{key:"extractValue",value:function(e){return this.codefield instanceof f.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(e)]:this.reverseLkp[e.attributes[this.codefield]]}}]),r}(y);v.BADNESS="_!!!_BAD_LKP_!!!!";var g=function(e){"use strict";n.inherits(r,e);var t=n.createSuper(r);function r(e,a){var i;return n.classCallCheck(this,r),(i=t.call(this,e)).sql=a,n.possibleConstructorReturn(i)}return n.createClass(r,[{key:"rewriteSql",value:function(e,t){return{rewritten:!0,where:(0,d.reformulateWithoutField)(e,this.field.name,(0,d.toWhereClause)(this.sql,o.FeatureServiceDatabaseType.Standardised),t.getFieldsIndex())}}},{key:"extractValue",value:function(e){return this.sql.calculateValueCompiled(e)}}]),r}(y),m=function(e){"use strict";n.inherits(r,e);var t=n.createSuper(r);function r(e){var a;return n.classCallCheck(this,r),(a=t.call(this,e))._calcFunc=null,a.declaredClass="esri.arcade.featureset.actions.Adapted",a.adaptedFields=null,a._extraFilter=null,a._extraFilter=e.extraFilter,a._parent=e.parentfeatureset,a._maxProcessing=30,a.adaptedFields=e.adaptedFields,n.possibleConstructorReturn(a)}return n.createClass(r,[{key:"_initialiseFeatureSet",value:function(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new(0,h.default)({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=o.layerGeometryEsriConstants.point,this.typeIdField="",this.types=null),this.fields=[];var e=!0,t=!1,r=void 0;try{for(var a,n=this.adaptedFields[Symbol.iterator]();!(e=(a=n.next()).done);e=!0){var i=a.value;i.postInitialization(this,this._parent),this.fields.push(i.field)}}catch(e){t=!0,r=e}finally{try{e||null==n.return||n.return()}finally{if(t)throw r}}}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._extraFilter?t._getFilteredSet("",null,null,null,e):t._parent._getSet(e)})).then((function(r){return t._checkCancelled(e),t._wset=new(0,u.default)(r._candidates.slice(0),r._known.slice(0),r._ordered,t._clonePageDefinition(r.pagesDefinition)),t._wset})):(0,c.resolve)(this._wset)}},{key:"_isInFeatureSet",value:function(e){return this._parent._isInFeatureSet(e)}},{key:"_getFeatures",value:function(e,t,r,a){var n=this,s=[];-1!==t&&void 0===this._featureCache[t]&&s.push(t);var o=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,o))return this._expandPagedSet(e,o,0,0,a).then((function(){return n._getFeatures(e,t,r,a)}));for(var d=0,f=e._lastFetchedIndex;f<e._known.length&&(++d<=r&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[f]]&&(e._known[f]!==t&&s.push(e._known[f]),s.length>=o)));f++);if(0===s.length)return(0,c.resolve)("success");e=new(0,u.default)([],s,e._ordered,null);var h=Math.min(s.length,r);return this._parent._getFeatures(e,-1,h,a).then((function(){n._checkCancelled(a);for(var e=[],t=0;t<h;t++){var r=n._parent._featureFromCache(s[t]);void 0!==r&&e.push({geometry:r.geometry,attributes:r.attributes,id:s[t]})}var u=!0,o=!1,d=void 0;try{for(var c,f=e[Symbol.iterator]();!(u=(c=f.next()).done);u=!0){var y=c.value,p=[],_=!0,v=!1,g=void 0;try{for(var m,S=n.adaptedFields[Symbol.iterator]();!(_=(m=S.next()).done);_=!0){var w=m.value;p[w.field.name]=w.extractValue(y)}}catch(e){v=!0,g=e}finally{try{_||null==S.return||S.return()}finally{if(v)throw g}}n._featureCache[y.id]=new(0,i.default)({attributes:p,geometry:(0,l.cloneGeometry)(y.geometry)})}}catch(e){o=!0,d=e}finally{try{u||null==f.return||f.return()}finally{if(o)throw d}}return"success"}))}},{key:"_fetchAndRefineFeatures",value:function(){return(0,c.reject)(new Error("Fetch and Refine should not be called in this featureset"))}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i,l=this,s=this._reformulateWithoutAdaptions(r);i=s.cannot,r=s.where;var o=!1;if(null!==a){o=!0;var c=[],f=!0,h=!1,y=void 0;try{for(var v,g=this.adaptedFields[Symbol.iterator]();!(f=(v=g.next()).done);f=!0){var m=v.value;if(!(m instanceof p)&&!0===a.scanForField(m.field.name)){if(!(m instanceof _)){a=null,o=!1;break}c.push({field:m.field.name,newfield:m.originalField.name})}}}catch(e){h=!0,y=e}finally{try{f||null==g.return||g.return()}finally{if(h)throw y}}a&&c.length>0&&(a=a.replaceFields(c))}return null!==r?null!==this._extraFilter&&(r=(0,d.combine)(this._extraFilter,r)):r=this._extraFilter,this._ensureLoaded().then((function(){return l._parent._getFilteredSet(e,t,r,a,n)})).then((function(e){return l._checkCancelled(n),!0===i?new(0,u.default)(e._candidates.slice(0).concat(e._known.slice(0)),[],!0===o&&e._ordered,l._clonePageDefinition(e.pagesDefinition)):new(0,u.default)(e._candidates.slice(0),e._known.slice(0),!0===o&&e._ordered,l._clonePageDefinition(e.pagesDefinition))}))}},{key:"_reformulateWithoutAdaptions",value:function(e){var t={cannot:!1,where:e};if(null!==e){var r=!0,a=!1,n=void 0;try{for(var i,l=this.adaptedFields[Symbol.iterator]();!(r=(i=l.next()).done);r=!0){var s=i.value;if(!0===(0,d.scanForField)(e,s.field.name)){var u=s.rewriteSql(e,this);if(!0!==u.rewritten){t.cannot=!0,t.where=null;break}t.where=u.where}}}catch(e){a=!0,n=e}finally{try{r||null==l.return||l.return()}finally{if(a)throw n}}}return t}},{key:"_stat",value:function(e,t,r,a,n,i,l){var s=this,u=!1,o=this._reformulateWithoutAdaptions(t);return u=o.cannot,t=o.where,o=this._reformulateWithoutAdaptions(n),u=u||o.cannot,null!==(n=o.where)?null!==this._extraFilter&&(n=(0,d.combine)(this._extraFilter,n)):n=this._extraFilter,!0===u?null===n&&""===r&&null===a?this._manualStat(e,t,i,l):(0,c.resolve)({calculated:!1}):this._parent._stat(e,t,r,a,n,i,l).then((function(u){return!1===u.calculated?null===n&&""===r&&null===a?s._manualStat(e,t,i,l):{calculated:!1}:u}))}},{key:"_canDoAggregates",value:function(e,t,r,a,n){if(null===this._parent)return(0,c.resolve)(!1);for(var i=!0,l=!1,s=void 0,u=0;u<e.length;u++)try{for(var o,f=this.adaptedFields[Symbol.iterator]();!(i=(o=f.next()).done);i=!0){var h=o.value;if(e[u].toLowerCase()===h.field.name.toLowerCase()&&!(h instanceof p))return(0,c.resolve)(!1)}}catch(e){l=!0,s=e}finally{try{i||null==f.return||f.return()}finally{if(l)throw s}}for(var y=[],_=0;_<t.length;_++){var v=t[_];if(null!==v.workingexpr){var g=this._reformulateWithoutAdaptions(v.workingexpr);if(g.cannot)return(0,c.resolve)(!1);var m=v.clone();m.workingexpr=g.where,y.push(m)}else y.push(v)}var S=this._reformulateWithoutAdaptions(n);return S.cannot?(0,c.resolve)(!1):(null!==(n=S.where)?null!==this._extraFilter&&(n=(0,d.combine)(this._extraFilter,n)):n=this._extraFilter,this._parent._canDoAggregates(e,y,r,a,n))}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,a,n,i,l){if(null===this._parent)return(0,c.reject)(new Error("Should never be called"));for(var s=[],u=0;u<t.length;u++){var o=t[u];if(null!==o.workingexpr){var f=this._reformulateWithoutAdaptions(o.workingexpr);if(f.cannot)return(0,c.reject)(new Error("Should never be called"));var h=o.clone();h.workingexpr=f.where,s.push(h)}else s.push(o)}var y=this._reformulateWithoutAdaptions(n);return y.cannot?(0,c.reject)(new Error("Should never be called")):(null!==(n=y.where)?null!==this._extraFilter&&(n=(0,d.combine)(this._extraFilter,n)):n=this._extraFilter,this._parent._getAggregatePagesDataSourceDefinition(e,s,r,a,n,i,l))}}],[{key:"findField",value:function(e,t){var r=!0,a=!1,n=void 0;try{for(var i,l=e[Symbol.iterator]();!(r=(i=l.next()).done);r=!0){var s=i.value;if(s.name.toLowerCase()===t.toString().toLowerCase())return s}}catch(e){a=!0,n=e}finally{try{r||null==l.return||l.return()}finally{if(a)throw n}}return null}}]),r}(s.default)})),t.register("k1hID",(function(r,a){e(r.exports,"default",(function(){return d}));var n=t("8TSCy"),i=t("e8oaX"),l=t("ct6g2"),s=t("3khKC"),u=t("aZgek"),o=t("10vEZ"),d=function(e){"use strict";n.inherits(r,e);var t=n.createSuper(r);function r(e){var a;return n.classCallCheck(this,r),(a=t.call(this,e))._orderbyclause=null,a.declaredClass="esri.arcade.featureset.actions.OrderBy",a._maxProcessing=100,a._orderbyclause=e.orderbyclause,a._parent=e.parentfeatureset,n.possibleConstructorReturn(a)}return n.createClass(r,[{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,t._orderbyclause,e)})).then((function(r){return t._checkCancelled(e),t._wset=r,t._wset})):(0,o.resolve)(this._wset)}},{key:"manualOrderSet",value:function(e,t){var r=this;return this.getIdColumnDictionary(e,[],-1,t).then((function(e){r._orderbyclause.order(e);for(var t=new(0,s.default)([],[],!0,null),a=0;a<e.length;a++)t._known.push(e[a].id);return t}))}},{key:"getIdColumnDictionary",value:function(e,t,r,a){var n=this;if(r<e._known.length-1){var l=this,s=this._maxQueryRate();if("GETPAGES"===e._known[r+1])return(0,i.X)(this._parent._expandPagedSet(e,s,0,0,a)).then((function(){return l.getIdColumnDictionary(e,t,r,a)}));for(var u=r+1,d=[];u<e._known.length&&"GETPAGES"!==e._known[u];)d.push(e._known[u]),u++;return r+=d.length,(0,i.X)(this._parent._getFeatureBatch(d,a)).then((function(n){l._checkCancelled(a);var i=!0,s=!1,u=void 0;try{for(var o,d=n[Symbol.iterator]();!(i=(o=d.next()).done);i=!0){var c=o.value;t.push({id:c.attributes[l.objectIdField],feature:c})}}catch(e){s=!0,u=e}finally{try{i||null==d.return||d.return()}finally{if(s)throw u}}return l.getIdColumnDictionary(e,t,r,a)}))}return e._candidates.length>0?(0,i.X)(this._refineSetBlock(e,this._maxProcessingRate(),a)).then((function(){return n._checkCancelled(a),n.getIdColumnDictionary(e,t,r,a)})):(0,o.resolve)(t)}},{key:"_isInFeatureSet",value:function(e){return this._parent._isInFeatureSet(e)}},{key:"_getFeatures",value:function(e,t,r,a){return this._parent._getFeatures(e,t,r,a)}},{key:"_featureFromCache",value:function(e){if(void 0===this._featureCache[e]){var t=this._parent._featureFromCache(e);if(void 0===t)return;return null===t?null:(this._featureCache[e]=t,t)}return this._featureCache[e]}},{key:"_fetchAndRefineFeatures",value:function(){return(0,o.reject)(new Error("Fetch and Refine should not be called in this featureset"))}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return this._ensureLoaded().then((function(){return i._parent._getFilteredSet(e,t,r,null===a?i._orderbyclause:a,n)})).then((function(e){var a=i;i._checkCancelled(n);var l=new(0,s.default)(e._candidates.slice(0),e._known.slice(0),e._ordered,i._clonePageDefinition(e.pagesDefinition)),u=!0;return e._candidates.length>0&&(u=!1),!1===l._ordered?i.manualOrderSet(l,n).then((function(e){return!1===u&&(null===t&&null===r||(e=new(0,s.default)(e._candidates.slice(0).concat(e._known.slice(0)),[],e._ordered,a._clonePageDefinition(e.pagesDefinition)))),e})):l}))}}],[{key:"registerAction",value:function(){l.default._featuresetFunctions.orderBy=function(e){return""===e?this:new r({parentfeatureset:this,orderbyclause:new(0,u.default)(e)})}}}]),r}(l.default)})),t.register("aZgek",(function(r,a){e(r.exports,"default",(function(){return l}));var n=t("8TSCy");function i(e,t){return e===t?0:null===e?-1:null===t?1:e<t?-1:1}var l=function(){"use strict";function e(t){n.classCallCheck(this,e);var r=t.split(",");this._fields=[],this._directions=[];for(var a=0;a<r.length;a++){var i=r[a].match(/\S+/g);this._fields.push(i[0]),2===i.length?"asc"===i[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}return n.createClass(e,[{key:"constructClause",value:function(){for(var e="",t=0;t<this._fields.length;t++)0!==t&&(e+=","),e+=this._fields[t],1===this._directions[t]?e+=" ASC":e+=" DESC";return e}},{key:"order",value:function(e){var t=this;e.sort((function(e,r){for(var a=0;a<t._fields.length;a++){var n,l=t.featureValue(e.feature,t._fields[a],a),s=t.featureValue(r.feature,t._fields[a],a);if(0!==(n=1===t._directions[a]?i(l,s):-1*i(l,s)))return n}return 0}))}},{key:"scanForField",value:function(e){for(var t=0;t<this._fields.length;t++)if(this._fields[t].toLowerCase().trim()===e.toLowerCase().trim())return!0;return!1}},{key:"replaceFields",value:function(t){for(var r="",a=0;a<this._fields.length;a++){0!==a&&(r+=",");var n=this._fields[a],i=!0,l=!1,s=void 0;try{for(var u,o=t[Symbol.iterator]();!(i=(u=o.next()).done);i=!0){var d=u.value;if(n.toLowerCase()===d.field.toLowerCase()){n=d.newfield;break}}}catch(e){l=!0,s=e}finally{try{i||null==o.return||o.return()}finally{if(l)throw s}}r+=n,1===this._directions[a]?r+=" ASC":r+=" DESC"}return new e(r)}},{key:"featureValue",value:function(e,t,r){var a=e.attributes[t];if(void 0!==a)return a;for(var n in e.attributes)if(t.toLowerCase()===n.toLowerCase())return this._fields[r]=n,e.attributes[n];return null}}]),e}()})),t.register("h1kCI",(function(r,a){e(r.exports,"default",(function(){return u}));var n=t("8TSCy"),i=t("9yzf5"),l=t("jA3R1"),s=t("9AqbE");var u=function(){"use strict";function e(){n.classCallCheck(this,e)}return n.createClass(e,[{key:"clone",value:function(){var t=new e;return t.field=this.field,t.tofieldname=this.tofieldname,t.typeofstat=this.typeofstat,t.workingexpr=this.workingexpr,t}},{key:"toStatisticsName",value:function(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}],[{key:"parseStatField",value:function(t,r,a){var n=new e;n.field=t;var u=s.WhereClause.create(r,a),o=function(e){if("function"===e.parseTree.type){if(0===e.parseTree.args.value.length)return{name:e.parseTree.name,expr:null};if(e.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");var t=s.WhereClause.create((0,l.toWhereClauseFromTree)(e.parseTree.args.value[0],i.FeatureServiceDatabaseType.Standardised,e.parameters),e.fieldsIndex);return{name:e.parseTree.name,expr:t}}return null}(u);if(null===o)throw new Error("Invalid Statistic Function");var d=o.name.toUpperCase().trim();if("MIN"===d){if(n.typeofstat="MIN",n.workingexpr=o.expr,null===u)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===d){if(n.typeofstat="MAX",n.workingexpr=o.expr,null===u)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===d)n.typeofstat="COUNT",n.workingexpr=o.expr;else if("STDEV"===d){if(n.typeofstat="STDDEV",n.workingexpr=o.expr,null===u)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===d){if(n.typeofstat="SUM",n.workingexpr=o.expr,null===u)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===d){if(n.typeofstat="AVG",n.workingexpr=o.expr,null===u)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===d){if(n.typeofstat="AVG",n.workingexpr=o.expr,null===u)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==d)throw new Error("Invalid Statistic Function");if(n.typeofstat="VAR",n.workingexpr=o.expr,null===u)throw new Error("Invalid Statistic Function Parameters")}return n}}]),e}()})),t.register("6ILB7",(function(r,a){e(r.exports,"default",(function(){return o}));var n=t("8TSCy"),i=t("ct6g2"),l=t("3khKC"),s=t("9yzf5"),u=t("10vEZ"),o=function(e){"use strict";n.inherits(r,e);var t=n.createSuper(r);function r(e){var a;return n.classCallCheck(this,r),(a=t.call(this,e))._topnum=0,a.declaredClass="esri.arcade.featureset.actions.Top",a._countedin=0,a._maxProcessing=100,a._topnum=e.topnum,a._parent=e.parentfeatureset,n.possibleConstructorReturn(a)}return n.createClass(r,[{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._parent._getSet(e)})).then((function(e){return t._wset=new(0,l.default)(e._candidates.slice(0),e._known.slice(0),!1,t._clonePageDefinition(e.pagesDefinition)),t._setKnownLength(t._wset)>t._topnum&&(t._wset._known=t._wset._known.slice(0,t._topnum)),t._setKnownLength(t._wset)>=t._topnum&&(t._wset._candidates=[]),t._wset})):(0,u.resolve)(this._wset)}},{key:"_setKnownLength",value:function(e){return e._known.length>0&&"GETPAGES"===e._known[e._known.length-1]?e._known.length-1:e._known.length}},{key:"_isInFeatureSet",value:function(e){var t=this._parent._isInFeatureSet(e);if(t===s.IdState.NotInFeatureSet)return t;var r=this._idstates[e];return r===s.IdState.InFeatureSet||r===s.IdState.NotInFeatureSet?r:t===s.IdState.InFeatureSet&&void 0===r?this._countedin<this._topnum?(this._idstates[e]=s.IdState.InFeatureSet,this._countedin++,s.IdState.InFeatureSet):(this._idstates[e]=s.IdState.NotInFeatureSet,s.IdState.NotInFeatureSet):s.IdState.Unknown}},{key:"_expandPagedSet",value:function(e,t,r,a,n){var i=this;if(null===this._parent)return(0,u.reject)(new Error("Parent Paging not implemented"));if(t>this._topnum&&(t=this._topnum),this._countedin>=this._topnum&&e.pagesDefinition.internal.set.length<=e.pagesDefinition.resultOffset){var l=e._known.length;return l>0&&"GETPAGES"===e._known[l-1]&&(e._known.length=l-1),(l=e._candidates.length)>0&&"GETPAGES"===e._candidates[l-1]&&(e._candidates.length=l-1),(0,u.resolve)("success")}return this._parent._expandPagedSet(e,t,r,a,n).then((function(t){return i._setKnownLength(e)>i._topnum&&(e._known.length=i._topnum),i._setKnownLength(e)>=i._topnum&&(e._candidates.length=0),t}))}},{key:"_getFeatures",value:function(e,t,r,a){var n=this,i=[],s=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,s))return this._expandPagedSet(e,s,0,0,a).then((function(){return n._getFeatures(e,t,r,a)}));-1!==t&&void 0===this._featureCache[t]&&i.push(t);for(var o=0,d=e._lastFetchedIndex;d<e._known.length&&(++o<=r&&(e._lastFetchedIndex+=1),!(void 0===this._featureCache[e._known[d]]&&(e._known[d]!==t&&i.push(e._known[d]),i.length>s)));d++);if(0===i.length)return(0,u.resolve)("success");var c=new(0,l.default)([],i,!1,null),f=Math.min(i.length,r);return this._parent._getFeatures(c,-1,f,a).then((function(){for(var e=0;e<f;e++){var t=n._parent._featureFromCache(i[e]);void 0!==t&&(n._featureCache[i[e]]=t)}return"success"}))}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return this._ensureLoaded().then((function(){return i._getSet(n)})).then((function(e){return new(0,l.default)(e._candidates.slice(0).concat(e._known.slice(0)),[],!1,i._clonePageDefinition(e.pagesDefinition))}))}},{key:"_refineKnowns",value:function(e,t){for(var r=0,a=null,n=[],i=0;i<e._candidates.length;i++){var l=this._isInFeatureSet(e._candidates[i]);if(l===s.IdState.InFeatureSet){if(e._known.push(e._candidates[i]),r+=1,null===a?a={start:i,end:i}:a.end===i-1?a.end=i:(n.push(a),a={start:i,end:i}),e._known.length>=this._topnum)break}else if(l===s.IdState.NotInFeatureSet)null===a?a={start:i,end:i}:a.end===i-1?a.end=i:(n.push(a),a={start:i,end:i}),r+=1;else if(l===s.IdState.Unknown)break;if(r>=t)break}null!==a&&n.push(a);for(var u=n.length-1;u>=0;u--)e._candidates.splice(n[u].start,n[u].end-n[u].start+1);this._setKnownLength(e)>this._topnum&&(e._known=e._known.slice(0,this._topnum)),this._setKnownLength(e)>=this._topnum&&(e._candidates=[])}},{key:"_stat",value:function(){return(0,u.resolve)({calculated:!1})}},{key:"_canDoAggregates",value:function(){return(0,u.resolve)(!1)}}],[{key:"registerAction",value:function(){i.default._featuresetFunctions.top=function(e){return new r({parentfeatureset:this,topnum:e})}}}]),r}(i.default)})),t.register("9eCQE",(function(r,a){e(r.exports,"default",(function(){return D}));var n=t("8TSCy"),i=t("bsvXr"),l=t("9pNSx"),s=t("MCT5v"),u=t("ct6g2"),o=t("3khKC"),d=t("9yzf5"),c=t("jA3R1"),f=t("hyZZn"),h=t("fsJts"),y=t("dLARP"),p=t("10vEZ"),_=t("79LpT"),v=t("g15Jq"),g=t("akQYU");t("kYueh"),t("5vzSQ"),t("crcVj"),t("lYvo2");var m=t("8iXHs");t("2ILM8");var S=t("j6c7r"),w=t("cRlei"),F=t("1d1jX"),b=t("3UMgP");t("2VlWd"),t("eY5Yp");var k=t("f4h86");t("8g8vH"),t("5On35"),t("7D30I");var C=t("7zyiu"),I=t("0L5NP"),x=t("3UOnP"),D=function(e){"use strict";n.inherits(r,e);var t=n.createSuper(r);function r(e){var a;return n.classCallCheck(this,r),(a=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",a._removeGeometry=!1,a._overrideFields=null,a.formulaCredential=null,a._pageJustIds=!1,a._requestStandardised=!1,a._useDefinitionExpression=!0,e.spatialReference&&(a.spatialReference=e.spatialReference),a._transparent=!0,a._maxProcessing=1e3,a._layer=e.layer,a._wset=null,void 0!==e.outFields&&(a._overrideFields=e.outFields),void 0!==e.includeGeometry&&(a._removeGeometry=!1===e.includeGeometry),n.possibleConstructorReturn(a)}return n.createClass(r,[{key:"_maxQueryRate",value:function(){return d.defaultMaxRecords}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(e){this._pageJustIds=e}},{key:"convertQueryToLruCacheKey",value:function(e){var t=(0,d.stableStringify)(e.toJSON());return(0,h.createMD5Hash)(t,h.outputTypes.String)}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=(0,p.create)((function(t,r){try{var a=e;if(!0===e._layer.loaded)return e._initialiseFeatureSet(),void t(e);e._layer.when().then((function(){try{a._initialiseFeatureSet(),t(a)}catch(e){r(e)}}),r),e._layer.load()}catch(e){r(e)}}))),this._loadPromise}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{var e=[],t=!0,r=!1,a=void 0,n=!0,i=!1,l=void 0;try{for(var s,u=this.fields[Symbol.iterator]();!(n=(s=u.next()).done);n=!0){var o=s.value;if("oid"===o.type)e.push(o);else try{for(var c,f=this._layer.outFields[Symbol.iterator]();!(t=(c=f.next()).done);t=!0){if(c.value.toLowerCase()===o.name.toLowerCase()){e.push(o);break}}}catch(e){r=!0,a=e}finally{try{t||null==f.return||f.return()}finally{if(r)throw a}}}}catch(e){i=!0,l=e}finally{try{n||null==u.return||u.return()}finally{if(i)throw l}}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var h=[],y=[],p=!0,_=!1,v=void 0,g=!0,m=!1,S=void 0;try{for(var w,F=this.fields[Symbol.iterator]();!(g=(w=F.next()).done);g=!0){var b=w.value;if("oid"===b.type)h.push(b),y.push(b.name);else try{for(var k,C=this._overrideFields[Symbol.iterator]();!(p=(k=C.next()).done);p=!0){if(k.value.toLowerCase()===b.name.toLowerCase()){h.push(b),y.push(b.name);break}}}catch(e){_=!0,v=e}finally{try{p||null==C.return||C.return()}finally{if(_)throw v}}}}catch(e){m=!0,S=e}finally{try{g||null==F.return||F.return()}finally{if(m)throw S}}this.fields=h,this._overrideFields=y}if(this._layer.source&&this._layer.source.sourceJSON){var I=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=d.FeatureServiceDatabaseType.StandardisedNoInterval,null!=I&&I>=10.61&&(this._databaseType=d.FeatureServiceDatabaseType.Standardised)):null!=I&&(I>=10.5&&(this._databaseType=d.FeatureServiceDatabaseType.StandardisedNoInterval,this._requestStandardised=!0),I>=10.61&&(this._databaseType=d.FeatureServiceDatabaseType.Standardised))}this.objectIdField=this._layer.objectIdField;var x=!0,D=!1,R=void 0;try{for(var T,E=this.fields[Symbol.iterator]();!(x=(T=E.next()).done);x=!0){var P=T.value;"global-id"===P.type&&(this.globalIdField=P.name)}}catch(e){D=!0,R=e}finally{try{x||null==E.return||E.return()}finally{if(D)throw R}}this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}},{key:"_isInFeatureSet",value:function(){return d.IdState.InFeatureSet}},{key:"_refineSetBlock",value:function(e){return(0,p.resolve)(e)}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):(0,p.resolve)(this._wset)}},{key:"_runDatabaseProbe",value:function(e){var t=this;return(0,p.create)((function(r,a){try{var n=t;t._ensureLoaded().then((function(){try{var t=new(0,w.default);t.where=e.replace("OBJECTID",n._layer.objectIdField),n._layer.queryObjectIds(t).then((function(){r(!0)}),(function(){try{r(!1)}catch(e){a(e)}}))}catch(e){a(e)}}))}catch(e){a(e)}}))}},{key:"_canUsePagination",value:function(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}},{key:"_cacheableFeatureSetSourceKey",value:function(){return this._layer.url}},{key:"pbfSupportedForQuery",value:function(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}},{key:"queryPBF",value:function(e){return e.quantizationParameters={mode:"edit"},(0,S.executeQueryPBF)(this._layer.parsedUrl,e,new(0,C.OptimizedFeatureSetParserContext)({})).then((function(e){return k.default.fromJSON((0,g.convertToFeatureSet)(e.data)).unquantize()}))}},{key:"gdbVersion",get:function(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}},{key:"nativeCapabilities",value:function(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}},{key:"executeQuery",value:function(e,t){var r="execute"===t?b.executeQueryJSON:"executeForCount"===t?m.executeForCount:F.executeForIds,a="execute"===t&&this.pbfSupportedForQuery(e),n=null;if(this.recentlyUsedQueries){var i=this,l=this.convertQueryToLruCacheKey(e);null===(n=this.recentlyUsedQueries.getFromCache(l))&&(n=!0!==a?r(this._layer.parsedUrl.path,e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(l,n),n=n.catch((function(e){throw i.recentlyUsedQueries.removeFromCache(l),e})))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===n&&(n=!0!==a?r(this._layer.parsedUrl.path,e):this.queryPBF(e)),n}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return this.databaseType().then((function(l){var s=i;if(i.isTable()&&t&&null!==e&&""!==e)return new(0,o.default)([],[],!0,null);if(i._canUsePagination())return i._getFilteredSetUsingPaging(e,t,r,a,n);var u="",d=!1;null!==a&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(u=a.constructClause(),d=!0);var f=new(0,w.default);return f.where=null===r?null===t?"1=1":"":(0,c.toWhereClause)(r,l),i._requestStandardised&&(f.sqlFormat="standard"),f.spatialRelationship=i._makeRelationshipEnum(e),f.outSpatialReference=i.spatialReference,f.orderByFields=""!==u?u.split(","):null,f.geometry=null===t?null:t,f.relationParameter=i._makeRelationshipParam(e),i.executeQuery(f,"executeForIds").then((function(e){return null===e&&(e=[]),s._checkCancelled(n),new(0,o.default)([],e,d,null)}))}))}},{key:"_expandPagedSet",value:function(e,t,r,a,n){return this._expandPagedSetFeatureSet(e,t,r,a,n)}},{key:"_getFilteredSetUsingPaging",value:function(e,t,r,a,n){try{var i=this,l="",s=!1;return null!==a&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsOrderBy&&(l=a.constructClause(),s=!0),this.databaseType().then((function(a){var u=null===r?null===t?"1=1":"":(0,c.toWhereClause)(r,a);i._layer.definitionExpression&&i._useDefinitionExpression&&(u=""!==u?"(("+i._layer.definitionExpression+") AND ("+u+"))":i._layer.definitionExpression);var d=i._maxQueryRate(),f=i._layer.capabilities.query.maxRecordCount;void 0!==f&&f<d&&(d=f);var h=null;if(!0===i._pageJustIds)h=new(0,o.default)([],["GETPAGES"],s,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:i._layer.objectIdField,resultRecordCount:d,resultOffset:0,geometry:null===t?null:t,where:u,orderByFields:l,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{var y=!0;!0===i._removeGeometry&&(y=!1);var p=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._layer.outFields?i._layer.outFields:["*"]);h=new(0,o.default)([],["GETPAGES"],s,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:p.join(","),resultRecordCount:d,resultOffset:0,geometry:null===t?null:t,where:u,orderByFields:l,returnGeometry:y,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return i._expandPagedSet(h,d,0,1,n).then((function(){return h}))}))}catch(e){return(0,p.reject)(e)}}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}},{key:"_getPhysicalPage",value:function(e,t,r){try{var a=this,n=e.pagesDefinition.internal.lastRetrieved,i=n,l=e.pagesDefinition.internal.lastPage,s=new(0,w.default);return this._requestStandardised&&(s.sqlFormat="standard"),s.spatialRelationship=e.pagesDefinition.spatialRel,s.relationParameter=e.pagesDefinition.relationParam,s.outFields=e.pagesDefinition.outFields.split(","),s.num=e.pagesDefinition.resultRecordCount,s.start=e.pagesDefinition.internal.lastPage,s.geometry=e.pagesDefinition.geometry,s.where=e.pagesDefinition.where,s.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,s.returnGeometry=e.pagesDefinition.returnGeometry,s.outSpatialReference=this.spatialReference,this.executeQuery(s,"execute").then((function(t){if(a._checkCancelled(r),e.pagesDefinition.internal.lastPage!==l)return"done";for(var s=0;s<t.features.length;s++)e.pagesDefinition.internal.set[i+s]=t.features[s].attributes[a._layer.objectIdField];if(!1===a._pageJustIds)for(var u=0;u<t.features.length;u++)a._featureCache[t.features[u].attributes[a._layer.objectIdField]]=t.features[u];return(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=n+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"}))}catch(e){return(0,p.reject)(e)}}},{key:"_fieldsIncludingObjectId",value:function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;var r=!1,a=!0,n=!1,i=void 0;try{for(var l,s=t[Symbol.iterator]();!(a=(l=s.next()).done);a=!0){if(l.value.toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}}}catch(e){n=!0,i=e}finally{try{a||null==s.return||s.return()}finally{if(n)throw i}}return!1===r&&t.push(this.objectIdField),t}},{key:"_getFeatures",value:function(e,t,r,a){var n=[];try{var i=this;if(-1!==t&&void 0===this._featureCache[t]&&n.push(t),!0===this._checkIfNeedToExpandKnownPage(e,this._maxProcessingRate()))return this._expandPagedSet(e,this._maxProcessingRate(),0,0,a).then((function(){return i._getFeatures(e,t,r,a)}));for(var l=0,s=e._lastFetchedIndex;s<e._known.length;s++){if(e._lastFetchedIndex+=1,l++,void 0===this._featureCache[e._known[s]]){var u=!1;if(null!==this._layer._mode&&void 0!==this._layer._mode){var o=this._layer._mode;if(void 0!==o._featureMap[e._known[s]]){var d=o._featureMap[e._known[s]];null!==d&&(u=!0,this._featureCache[e._known[s]]=d)}}if(!1===u&&(e._known[s]!==t&&n.push(e._known[s]),n.length>=this._maxProcessingRate()-1))break}if(l>=r&&0===n.length)break}if(0===n.length)return(0,p.resolve)("success");try{var c=this,f=new(0,w.default);return this._requestStandardised&&(f.sqlFormat="standard"),f.objectIds=n,f.outFields=null!==this._overrideFields?this._overrideFields:this._fieldsIncludingObjectId(this._layer.outFields?this._layer.outFields:["*"]),f.returnGeometry=!0,!0===this._removeGeometry&&(f.returnGeometry=!1),f.outSpatialReference=this.spatialReference,this.executeQuery(f,"execute").then((function(e){if(c._checkCancelled(a),void 0!==e.error)return(0,p.reject)(new Error(e.error));for(var t=0;t<e.features.length;t++)c._featureCache[e.features[t].attributes[c._layer.objectIdField]]=e.features[t];return"success"}))}catch(e){return(0,p.reject)(e)}}catch(e){return(0,p.reject)(e)}}},{key:"_getDistinctPages",value:function(e,t,r,a,n,i,l,s,u){var o=this;return this._ensureLoaded().then((function(){return o.databaseType()})).then((function(d){for(var f=o,h=r.parseTree.column,y=0;y<o._layer.fields.length;y++)if(o._layer.fields[y].name.toLowerCase()===h.toLowerCase()){h=o._layer.fields[y].name;break}var _=new(0,w.default);o._requestStandardised&&(_.sqlFormat="standard");var v=null===i?null===n?"1=1":"":(0,c.toWhereClause)(i,d);return o._layer.definitionExpression&&o._useDefinitionExpression&&(v=""!==v?"(("+o._layer.definitionExpression+") AND ("+v+"))":o._layer.definitionExpression),_.where=v,_.spatialRelationship=o._makeRelationshipEnum(a),_.relationParameter=o._makeRelationshipParam(a),_.geometry=null===n?null:n,_.returnDistinctValues=!0,_.returnGeometry=!1,_.outFields=[h],o.executeQuery(_,"execute").then((function(o){if(f._checkCancelled(u),!o.hasOwnProperty("features"))return(0,p.reject)(new Error("Unnexected Result querying statistics from layer"));for(var d=!1,c=0;c<f._layer.fields.length;c++)if(f._layer.fields[c].name===h){"date"===f._layer.fields[c].type&&(d=!0);break}for(var y=0;y<o.features.length;y++){if(d){var _=o.features[y].attributes[h];null!==_?s.push(new Date(_)):s.push(_)}else s.push(o.features[y].attributes[h]);if(s.length>=l)break}return 0===o.features.length?s:o.features.length===f._layer.capabilities.query.maxRecordCount&&s.length<l?f._getDistinctPages(e+o.features.length,t,r,a,n,i,l,s,u).then((function(e){return{calculated:!0,result:e}})):s}))}))}},{key:"_distinctStat",value:function(e,t,r,a,n,i,l){return this._getDistinctPages(0,e,t,r,a,n,i,[],l).then((function(e){return{calculated:!0,result:e}}))}},{key:"isTable",value:function(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}},{key:"_countstat",value:function(e,t,r,a){var n=this;return this.databaseType().then((function(e){var i=new(0,w.default);if(n._requestStandardised&&(i.sqlFormat="standard"),n.isTable()&&r&&null!==t&&""!==t)return{calculated:!0,result:0};var l=null===a?null===r?"1=1":"":(0,c.toWhereClause)(a,e);return n._layer.definitionExpression&&n._useDefinitionExpression&&(l=""!==l?"(("+n._layer.definitionExpression+") AND ("+l+"))":n._layer.definitionExpression),i.where=l,i.where=l,i.spatialRelationship=n._makeRelationshipEnum(t),i.relationParameter=n._makeRelationshipParam(t),i.geometry=null===r?null:r,i.returnGeometry=!1,n.executeQuery(i,"executeForCount").then((function(e){return{calculated:!0,result:e}}))}))}},{key:"_stats",value:function(e,t,r,a,n,i,l){var s=this;return this._ensureLoaded().then((function(){var u=s,o=s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsSqlExpression,d=s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsStatistics,h=s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsDistinct;return"count"===e?h?s._countstat(e,r,a,n):{calculated:!1}:!1===d||!1===(0,c.isSingleField)(t)&&!1===o||!1===t.isStandardized?""!==r||null!==n?{calculated:!1}:s._manualStat(e,t,i,l):"distinct"===e?!1===h?""!==r||null!==n?{calculated:!1}:s._manualStat(e,t,i,l):s._distinctStat(e,t,r,a,n,i,l):s.databaseType().then((function(i){if(u.isTable()&&a&&null!==r&&""!==r)return{calculated:!0,result:null};var l=new(0,w.default);u._requestStandardised&&(l.sqlFormat="standard");var s=null===n?null===a?"1=1":"":(0,c.toWhereClause)(n,i);u._layer.definitionExpression&&u._useDefinitionExpression&&(s=""!==s?"(("+u._layer.definitionExpression+") AND ("+s+"))":u._layer.definitionExpression),l.where=s,l.spatialRelationship=u._makeRelationshipEnum(r),l.relationParameter=u._makeRelationshipParam(r),l.geometry=null===a?null:a;var o=new(0,I.default);o.statisticType=(0,f.decodeStatType)(e),o.onStatisticField=(0,c.toWhereClause)(t,i),o.outStatisticFieldName="ARCADE_STAT_RESULT",l.returnGeometry=!1;var d="ARCADE_STAT_RESULT";return l.outStatistics=[o],u.executeQuery(l,"execute").then((function(e){if(!e.hasOwnProperty("features")||0===e.features.length)return(0,p.reject)(new Error("Unnexected Result querying statistics from layer"));for(var t=!1,r=0;r<e.fields.length;r++)if("ARCADE_STAT_RESULT"===e.fields[r].name.toUpperCase()){d=e.fields[r].name,"date"===e.fields[r].type&&(t=!0);break}if(t){var a=e.features[0].attributes[d];return null!==a&&(a=new Date(e.features[0].attributes[d])),{calculated:!0,result:a}}return{calculated:!0,result:e.features[0].attributes[d]}}))}))}))}},{key:"_stat",value:function(e,t,r,a,n,i,l){return this._stats(e,t,r,a,n,i,l)}},{key:"_canDoAggregates",value:function(e,t){var r=this;return this._ensureLoaded().then((function(){var e=!1,a=r._layer.capabilities&&r._layer.capabilities.query&&!0===r._layer.capabilities.query.supportsSqlExpression;if(void 0!==r._layer.capabilities&&null!==r._layer.capabilities.query&&!0===r._layer.capabilities.query.supportsStatistics&&!0===r._layer.capabilities.query.supportsOrderBy&&(e=!0),e)for(var n=0;n<t.length-1;n++)null!==t[n].workingexpr&&(!1===t[n].workingexpr.isStandardized||!1===(0,c.isSingleField)(t[n].workingexpr)&&!1===a)&&(e=!1);return!1!==e}))}},{key:"_makeRelationshipEnum",value:function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}},{key:"_makeRelationshipParam",value:function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}},{key:"_getAggregatePagesDataSourceDefinition",value:function(e,t,r,a,n,i,l){var s=this;return this._ensureLoaded().then((function(){return s.databaseType()})).then((function(u){var d="",f=!1,h=!1;null!==i&&s._layer.capabilities&&s._layer.capabilities.query&&!0===s._layer.capabilities.query.supportsOrderBy&&(d=i.constructClause(),h=!0),s._layer.capabilities&&s._layer.capabilities.query&&!1===s._layer.capabilities.query.supportsPagination&&(h=!1,f=!0,d=s._layer.objectIdField);for(var y=[],p=0;p<t.length;p++){var _=new(0,I.default);_.onStatisticField=null!==t[p].workingexpr?(0,c.toWhereClause)(t[p].workingexpr,u):"",_.outStatisticFieldName=t[p].field,_.statisticType=t[p].toStatisticsName(),y.push(_)}""===d&&(d=e.join(","));var v=s._maxQueryRate(),g=s._layer.capabilities.query.maxRecordCount;void 0!==g&&g<v&&(v=g);var m=null===n?null===a?"1=1":"":(0,c.toWhereClause)(n,u);return s._layer.definitionExpression&&s._useDefinitionExpression&&(m=""!==m?"(("+s._layer.definitionExpression+") AND ("+m+"))":s._layer.definitionExpression),new(0,o.default)([],["GETPAGES"],h,{groupbypage:!0,spatialRel:s._makeRelationshipEnum(r),relationParam:s._makeRelationshipParam(r),outFields:["*"],useOIDpagination:f,generatedOid:l,resultRecordCount:v,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:y,geometry:null===a?null:a,where:m,orderByFields:d,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}))}},{key:"_getAgregagtePhysicalPage",value:function(e,t,r){try{var a=this,n=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(n=""!==n?"("+n+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());var l=e.pagesDefinition.internal.lastRetrieved,s=l,u=e.pagesDefinition.internal.lastPage,o=new(0,w.default);return this._requestStandardised&&(o.sqlFormat="standard"),o.where=n,o.spatialRelationship=e.pagesDefinition.spatialRel,o.relationParameter=e.pagesDefinition.relationParam,o.outFields=e.pagesDefinition.outFields,o.outStatistics=e.pagesDefinition.outStatistics,o.geometry=e.pagesDefinition.geometry,o.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,o.num=e.pagesDefinition.resultRecordCount,o.start=e.pagesDefinition.internal.lastPage,o.returnGeometry=e.pagesDefinition.returnGeometry,o.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,this.isTable()&&o.geometry&&o.spatialRelationship?(0,p.resolve)([]):this.executeQuery(o,"execute").then((function(t){if(a._checkCancelled(r),!t.hasOwnProperty("features"))return(0,p.reject)(new Error("Unnexected Result querying aggregates from layer"));var n=[];if(e.pagesDefinition.internal.lastPage!==u)return[];for(var o=0;o<t.features.length;o++)e.pagesDefinition.internal.set[s+o]=t.features[o].attributes[e.pagesDefinition.generatedOid];for(var d=0;d<t.features.length;d++)n.push(new(0,i.default)({attributes:t.features[d].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===t.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=t.features[t.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===t.exceededTransferLimit&&t.features.length!==e.pagesDefinition.resultRecordCount||!1===t.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=l+t.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,n}))}catch(e){return(0,p.reject)(e)}}},{key:"relationshipMetaData",value:function(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}},{key:"serviceUrl",value:function(){return(0,d.extractServiceUrl)(this._layer.parsedUrl.path)}},{key:"queryAttachments",value:function(e,t,r,a,n){if(this._layer.capabilities.data.supportsAttachment&&this._layer.capabilities.operations.supportsQueryAttachments){var i=this,l={objectIds:[e],returnMetadata:n};return(t&&t>0||r&&r>0)&&(l.size=[t&&t>0?t:0,r&&r>0?r:t+1]),a&&a.length>0&&(l.attachmentTypes=a),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:l,method:"attachments"}),this._layer.queryAttachments(l).then((function(t){var r=i,a=[];return t&&t[e]&&t[e].forEach((function(t){var i=r._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+t.id.toString(),l=null;n&&t.exifInfo&&(l=x.default.convertJsonToArcade(t.exifInfo,!0)),a.push(new(0,s.default)(t.id,t.name,t.contentType,t.size,i,l))})),a}))}return(0,p.resolve)([])}},{key:"queryRelatedFeatures",value:function(e){var t={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};return void 0!==e.resultOffset&&null!==e.resultOffset&&(t.resultOffset=e.resultOffset.toString()),void 0!==e.resultRecordCount&&null!==e.resultRecordCount&&(t.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(t.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(t.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(t.outSR=JSON.stringify(e.outSpatialReference.toJSON())),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preRequestCallback({layer:this._layer,queryPayload:t,method:"relatedrecords",url:this._layer.parsedUrl.path+"/queryRelatedRecords"}),(0,l.default)(this._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:t}).then((function(e){if(e.data){var t={},r=e.data;if(r&&r.relatedRecordGroups){var a=r.spatialReference,n=!0,l=!1,s=void 0;try{for(var u,o=r.relatedRecordGroups[Symbol.iterator]();!(n=(u=o.next()).done);n=!0){var d=u.value,c=d.objectId,f=[],h=!0,y=!1,v=void 0;try{for(var g,m=d.relatedRecords[Symbol.iterator]();!(h=(g=m.next()).done);h=!0){var S=g.value;S.geometry&&(S.geometry.spatialReference=a);var w=new(0,i.default)({geometry:S.geometry?(0,_.fromJSON)(S.geometry):null,attributes:S.attributes});f.push(w)}}catch(e){y=!0,v=e}finally{try{h||null==m.return||m.return()}finally{if(y)throw v}}t[c]={features:f,exceededTransferLimit:!0===r.exceededTransferLimit}}}catch(e){l=!0,s=e}finally{try{n||null==o.return||o.return()}finally{if(l)throw s}}}return t}return(0,p.reject)("Invalid Request")}))}},{key:"getFeatureByObjectId",value:function(e,t){var r=new(0,w.default);return r.outFields=t,r.returnGeometry=!1,r.outSpatialReference=this.spatialReference,r.where=this.objectIdField+"="+e.toString(),this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:r,method:"execute"}),(0,b.executeQueryJSON)(this._layer.parsedUrl.path,r).then((function(e){return 1===e.features.length?e.features[0]:null}))}},{key:"getIdentityUser",value:function(){var e=this;return this.load().then((function(){var t,r=null==(t=y.id)?void 0:t.findCredential(e._layer.url);return r?r.userId:null}))}},{key:"getOwningSystemUrl",value:function(){var e=this;return this.load().then((function(){var t,r=null==(t=y.id)?void 0:t.findServerInfo(e._layer.url);if(r)return(0,p.resolve)(r.owningSystemUrl);var a=e._layer.url,n=a.toLowerCase().indexOf("/rest/services");return(a=n>-1?a.substring(0,n):a)?(a+="/rest/info",(0,p.create)((function(e,t){(0,l.default)(a,{query:{f:"json"}}).then((function(t){var r="";t.data&&t.data.owningSystemUrl&&(r=t.data.owningSystemUrl),e(r)}),(function(t){e("")}))}))):(0,p.resolve)("")}))}},{key:"getDataSourceFeatureSet",value:function(){var e=new r({layer:this._layer,spatialReference:this.spatialReference,outFields:this._overrideFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});return e._useDefinitionExpression=!1,e}}],[{key:"create",value:function(e,t,a,n,i){return new r({layer:new(0,v.default)({url:e,outFields:null===t?["*"]:t}),spatialReference:a,lrucache:n,interceptor:i})}}]),r}(u.default)})),t.register("2ANni",(function(r,a){e(r.exports,"default",(function(){return _}));var n=t("8TSCy"),i=t("bsvXr"),l=t("ct6g2"),s=t("3khKC"),u=t("9yzf5"),o=t("jA3R1"),d=t("10vEZ"),c=t("Pe3X5"),f=t("g15Jq"),h=t("hRnYX"),y=t("buMuJ"),p=t("cRlei"),_=function(e){"use strict";n.inherits(r,e);var t=n.createSuper(r);function r(e){var a;return n.classCallCheck(this,r),(a=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",a._removeGeometry=!1,a._overrideFields=null,a._forceIsTable=!1,e.spatialReference&&(a.spatialReference=e.spatialReference),a._transparent=!0,a._maxProcessing=1e3,a._layer=e.layer,a._wset=null,!0===e.isTable&&(a._forceIsTable=!0),void 0!==e.outFields&&(a._overrideFields=e.outFields),void 0!==e.includeGeometry&&(a._removeGeometry=!1===e.includeGeometry),n.possibleConstructorReturn(a)}return n.createClass(r,[{key:"_maxQueryRate",value:function(){return u.defaultMaxRecords}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(){}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=(0,d.create)((function(t,r){var a=e;if(!0===e._layer.loaded)return e._initialiseFeatureSet(),void t(e);e._layer.when().then((function(){try{a._initialiseFeatureSet(),t(a)}catch(e){r(e)}}),r),e._layer.load()}))),this._loadPromise}},{key:"gdbVersion",get:function(){return""}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields)if(1===this._layer.outFields.length&&"*"===this._layer.outFields[0]);else{var e=[],t=!0,r=!1,a=void 0,n=!0,i=!1,l=void 0;try{for(var s,o=this.fields[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var d=s.value;if("oid"===d.type)e.push(d);else try{for(var c,f=this._layer.outFields[Symbol.iterator]();!(t=(c=f.next()).done);t=!0){if(c.value.toLowerCase()===d.name.toLowerCase()){e.push(d);break}}}catch(e){r=!0,a=e}finally{try{t||null==f.return||f.return()}finally{if(r)throw a}}}}catch(e){i=!0,l=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw l}}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var h=[],y=[],p=!0,_=!1,v=void 0,g=!0,m=!1,S=void 0;try{for(var w,F=this.fields[Symbol.iterator]();!(g=(w=F.next()).done);g=!0){var b=w.value;if("oid"===b.type)h.push(b),y.push(b.name);else try{for(var k,C=this._overrideFields[Symbol.iterator]();!(p=(k=C.next()).done);p=!0){if(k.value.toLowerCase()===b.name.toLowerCase()){h.push(b),y.push(b.name);break}}}catch(e){_=!0,v=e}finally{try{p||null==C.return||C.return()}finally{if(_)throw v}}}}catch(e){m=!0,S=e}finally{try{g||null==F.return||F.return()}finally{if(m)throw S}}this.fields=h,this._overrideFields=y}this.objectIdField=this._layer.objectIdField;var I=!0,x=!1,D=void 0;try{for(var R,T=this.fields[Symbol.iterator]();!(I=(R=T.next()).done);I=!0){var E=R.value;"global-id"===E.type&&(this.globalIdField=E.name)}}catch(e){x=!0,D=e}finally{try{I||null==T.return||T.return()}finally{if(x)throw D}}this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=u.FeatureServiceDatabaseType.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}},{key:"isTable",value:function(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}},{key:"_isInFeatureSet",value:function(){return u.IdState.InFeatureSet}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):(0,d.resolve)(this._wset)}},{key:"_changeFeature",value:function(e){var t={},r=!0,a=!1,n=void 0;try{for(var l,s=this.fields[Symbol.iterator]();!(r=(l=s.next()).done);r=!0){var u=l.value;t[u.name]=e.attributes[u.name]}}catch(e){a=!0,n=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw n}}return new(0,i.default)({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this,l="",c=!1;if(null!==a&&(l=a.constructClause(),c=!0),this.isTable()&&t&&null!==e&&""!==e){var f=new(0,s.default)([],[],!0,null);return(0,d.resolve)(f)}var h=new(0,p.default);return h.where=null===r?null===t?"1=1":"":(0,o.toWhereClause)(r,u.FeatureServiceDatabaseType.Standardised),h.spatialRelationship=this._makeRelationshipEnum(e),h.outSpatialReference=this.spatialReference,h.orderByFields=""!==l?l.split(","):null,h.geometry=null===t?null:t,h.returnGeometry=!0,h.relationParameter=this._makeRelationshipParam(e),this._layer.queryFeatures(h).then((function(e){var t=i;if(null===e)return new(0,s.default)([],[],c,null);i._checkCancelled(n);var r=[];return e.features.forEach((function(e){var a=e.attributes[t._layer.objectIdField];r.push(a),t._featureCache[a]=t._changeFeature(e)})),new(0,s.default)([],r,c,null)}))}},{key:"_makeRelationshipEnum",value:function(e){if(e.indexOf("esriSpatialRelRelation")>=0)return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}},{key:"_makeRelationshipParam",value:function(e){return e.indexOf("esriSpatialRelRelation")>=0?e.split(":")[1]:""}},{key:"_queryAllFeatures",value:function(){var e=this;if(this._wset)return(0,d.resolve)(this._wset);var t=new(0,p.default);return t.where="1=1",this._ensureLoaded().then((function(){var r=e;if(e._layer.source&&e._layer.source.items){var a=e,n=[];return e._layer.source.items.forEach((function(e){var t=e.attributes[a._layer.objectIdField];n.push(t),a._featureCache[t]=a._changeFeature(e)})),e._wset=new(0,s.default)([],n,!1,null),e._wset}return e._layer.queryFeatures(t).then((function(e){var t=r,a=[];return e.features.forEach((function(e){var r=e.attributes[t._layer.objectIdField];a.push(r),t._featureCache[r]=t._changeFeature(e)})),r._wset=new(0,s.default)([],a,!1,null),r._wset}))}))}},{key:"_getFeatures",value:function(e,t,r){var a=[];-1!==t&&void 0===this._featureCache[t]&&a.push(t);for(var n=e._lastFetchedIndex;n<e._known.length&&(e._lastFetchedIndex+=1,!(void 0===this._featureCache[e._known[n]]&&(e._known[n]!==t&&a.push(e._known[n]),a.length>r)));n++);return 0===a.length?(0,d.resolve)("success"):(0,d.reject)(new Error("Unaccounted for Features. Not in Feature Collection"))}},{key:"_refineSetBlock",value:function(e){return(0,d.resolve)(e)}},{key:"_stat",value:function(){return(0,d.resolve)({calculated:!1})}},{key:"_canDoAggregates",value:function(){return(0,d.resolve)(!1)}},{key:"relationshipMetaData",value:function(){return[]}},{key:"nativeCapabilities",value:function(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}},{key:"queryAttachments",value:function(){return(0,d.resolve)([])}},{key:"getFeatureByObjectId",value:function(e){var t=new(0,p.default);return t.where=this.objectIdField+"="+e.toString(),this._layer.queryFeatures(t).then((function(e){return 1===e.features.length?e.features[0]:null}))}},{key:"getOwningSystemUrl",value:function(){return(0,d.resolve)("")}},{key:"getIdentityUser",value:function(){return(0,d.resolve)("")}}],[{key:"_cloneAttr",value:function(e){var t={};for(var r in e)t[r]=e[r];return t}},{key:"create",value:function(e,t){var a=e.layerDefinition.objectIdField,n=e.layerDefinition.typeIdField?e.layerDefinition.typeIdField:"",i=[],l=!0,s=!1,u=void 0;if(e.layerDefinition.types)try{for(var o,d=e.layerDefinition.types[Symbol.iterator]();!(l=(o=d.next()).done);l=!0){var p=o.value;i.push(h.default.fromJSON(p))}}catch(e){s=!0,u=e}finally{try{l||null==d.return||d.return()}finally{if(s)throw u}}var _=e.layerDefinition.geometryType;void 0===_&&(_=e.featureSet.geometryType||"");var v=e.featureSet.features,g=t.toJSON();if(""===a||void 0===a){var m=!1,S=!0,w=!1,F=void 0;try{for(var b,k=e.layerDefinition.fields[Symbol.iterator]();!(S=(b=k.next()).done);S=!0){var C=b.value;if("oid"===C.type||"esriFieldTypeOID"===C.type){a=C.name,m=!0;break}}}catch(e){w=!0,F=e}finally{try{S||null==k.return||k.return()}finally{if(w)throw F}}if(!1===m){for(var I="FID",x=!0,D=0;x;){var R=!0,T=!0,E=!1,P=void 0;try{for(var N,A=e.layerDefinition.fields[Symbol.iterator]();!(T=(N=A.next()).done);T=!0){if(N.value.name===I){R=!1;break}}}catch(e){E=!0,P=e}finally{try{T||null==A.return||A.return()}finally{if(E)throw P}}!0===R?x=!1:I="FID"+(++D).toString()}e.layerDefinition.fields.push({type:"esriFieldTypeOID",name:I,alias:I});for(var O=[],j=0;j<v.length;j++)O.push({geometry:e.featureSet.features[j].geometry,attributes:e.featureSet.features[j].attributes?this._cloneAttr(e.featureSet.features[j].attributes):{}}),O[j].attributes[I]=j;v=O,a=I}}var q=[],L=!0,W=!1,G=void 0;try{for(var B,U=e.layerDefinition.fields[Symbol.iterator]();!(L=(B=U.next()).done);L=!0){var M=B.value;M instanceof y.default?q.push(M):q.push(y.default.fromJSON(M))}}catch(e){W=!0,G=e}finally{try{L||null==U.return||U.return()}finally{if(W)throw G}}var Q=_;switch(Q){case"esriGeometryPoint":Q="point";break;case"esriGeometryPolyline":Q="polyline";break;case"esriGeometryPolygon":Q="polygon";break;case"esriGeometryExtent":Q="extent";break;case"esriGeometryMultipoint":Q="multipoint"}var V=!0,K=!1,J=void 0;try{for(var Z,X=v[Symbol.iterator]();!(V=(Z=X.next()).done);V=!0){var z=Z.value;z.geometry&&z.geometry instanceof c.default==0&&(z.geometry.type=Q,void 0===z.geometry.spatialReference&&(z.geometry.spatialReference=g))}}catch(e){K=!0,J=e}finally{try{V||null==X.return||X.return()}finally{if(K)throw J}}var H={outFields:["*"],source:v,fields:q,types:i,typeIdField:n,objectIdField:a,spatialReference:t};return H.geometryType=Q||"point",new r({layer:new(0,f.default)(H),spatialReference:t,isTable:null===Q||""===Q})}}]),r}(l.default)})),t.register("fqkMK",(function(r,a){e(r.exports,"default",(function(){return c}));var n=t("8TSCy"),i=t("bsvXr"),l=t("ct6g2"),s=t("3khKC"),u=t("9yzf5"),o=t("10vEZ"),d=t("8g8vH"),c=function(e){"use strict";n.inherits(r,e);var t=n.createSuper(r);function r(e){var a;return n.classCallCheck(this,r),(a=t.call(this,e)).declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",a._findObjectId=-1,a._requestStandardised=!1,a._removeGeometry=!1,a._overrideFields=null,a.featureObjectId=null,a.relatedLayer=null,a.relationship=null,e.spatialReference&&(a.spatialReference=e.spatialReference),a._transparent=!0,a._maxProcessing=1e3,a._layer=e.layer,a._wset=null,a._findObjectId=e.objectId,a.featureObjectId=e.objectId,a.relationship=e.relationship,a.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(a._overrideFields=e.outFields),void 0!==e.includeGeometry&&(a._removeGeometry=!1===e.includeGeometry),n.possibleConstructorReturn(a)}return n.createClass(r,[{key:"_maxQueryRate",value:function(){return u.defaultMaxRecords}},{key:"end",value:function(){return this._layer}},{key:"optimisePagingFeatureQueries",value:function(){}},{key:"load",value:function(){var e=this;return null===this._loadPromise&&(this._loadPromise=(0,o.create)((function(t,r){var a=e;(0,o.all)([e._layer.load(),e.relatedLayer.load()]).then((function(){a._initialiseFeatureSet(),t(a)}),r)}))),this._loadPromise}},{key:"nativeCapabilities",value:function(){return this.relatedLayer.nativeCapabilities()}},{key:"_initialiseFeatureSet",value:function(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{var e=[],t=[],r=!0,a=!1,n=void 0,i=!0,l=!1,s=void 0;try{for(var u,o=this.fields[Symbol.iterator]();!(i=(u=o.next()).done);i=!0){var d=u.value;if("oid"===d.type)e.push(d),t.push(d.name);else try{for(var c,f=this._overrideFields[Symbol.iterator]();!(r=(c=f.next()).done);r=!0){if(c.value.toLowerCase()===d.name.toLowerCase()){e.push(d),t.push(d.name);break}}}catch(e){a=!0,n=e}finally{try{r||null==f.return||f.return()}finally{if(a)throw n}}}}catch(e){l=!0,s=e}finally{try{i||null==o.return||o.return()}finally{if(l)throw s}}this.fields=e,this._overrideFields=t}var h=this._layer.nativeCapabilities();h&&(this._databaseType=h.databaseType,this._requestStandardised=h.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}},{key:"databaseType",value:function(){var e=this;return this.relatedLayer.databaseType().then((function(){return e._databaseType=e.relatedLayer._databaseType,e._databaseType}))}},{key:"isTable",value:function(){return this.relatedLayer.isTable()}},{key:"_isInFeatureSet",value:function(){return u.IdState.InFeatureSet}},{key:"_candidateIdTransform",value:function(e){return e}},{key:"_getSet",value:function(e){var t=this;return null===this._wset?this._ensureLoaded().then((function(){return t._getFilteredSet("",null,null,null,e)})).then((function(e){return t._wset=e,e})):(0,o.resolve)(this._wset)}},{key:"_changeFeature",value:function(e){var t={},r=!0,a=!1,n=void 0;try{for(var l,s=this.fields[Symbol.iterator]();!(r=(l=s.next()).done);r=!0){var u=l.value;t[u.name]=e.attributes[u.name]}}catch(e){a=!0,n=e}finally{try{r||null==s.return||s.return()}finally{if(a)throw n}}return new(0,i.default)({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}},{key:"_getFilteredSet",value:function(e,t,r,a,n){var i=this;return this.databaseType().then((function(){var l=i;if(i.isTable()&&t&&null!==e&&""!==e)return new(0,s.default)([],[],!0,null);var u=i._layer.nativeCapabilities();if(!1===u.canQueryRelated)return new(0,s.default)([],[],!0,null);if(u.capabilities.queryRelated&&u.capabilities.queryRelated.supportsPagination)return i._getFilteredSetUsingPaging(e,t,r,a,n);var o="",c=!1;null!==a&&u.capabilities&&u.capabilities.queryRelated&&!0===u.capabilities.queryRelated.supportsOrderBy&&(o=a.constructClause(),c=!0);var f=new(0,d.default);f.objectIds=[i._findObjectId];var h=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map((function(e){return e.name})):["*"]);f.outFields=h,f.relationshipId=i.relationship.id,f.where="1=1";var y=!0;return!0===i._removeGeometry&&(y=!1),f.returnGeometry=y,i._requestStandardised&&(f.sqlFormat="standard"),f.outSpatialReference=i.spatialReference,f.orderByFields=""!==o?o.split(","):null,u.source.queryRelatedFeatures(f).then((function(a){l._checkCancelled(n);for(var i=a[l._findObjectId]?a[l._findObjectId].features:[],u=[],o=0;o<i.length;o++)l._featureCache[i[o].attributes[l.relatedLayer.objectIdField]]=i[o],u.push(i[o].attributes[l.relatedLayer.objectIdField]);var d=t&&null!==e&&""!==e,f=null!=r;return new(0,s.default)(d||f?u:[],d||f?[]:u,c,null)}))}))}},{key:"_fieldsIncludingObjectId",value:function(e){if(null===e)return[this.objectIdField];var t=e.slice(0);if(t.indexOf("*")>-1)return t;var r=!1,a=!0,n=!1,i=void 0;try{for(var l,s=t[Symbol.iterator]();!(a=(l=s.next()).done);a=!0){if(l.value.toUpperCase()===this.objectIdField.toUpperCase()){r=!0;break}}}catch(e){n=!0,i=e}finally{try{a||null==s.return||s.return()}finally{if(n)throw i}}return!1===r&&t.push(this.objectIdField),t}},{key:"_getFilteredSetUsingPaging",value:function(e,t,r,a,n){try{var i=this,l="",u=!1,d=this._layer.nativeCapabilities();return null!==a&&d&&d.capabilities.queryRelated&&!0===d.capabilities.queryRelated.supportsOrderBy&&(l=a.constructClause(),u=!0),this.databaseType().then((function(){var a=i._maxQueryRate(),o=d.capabilities.query.maxRecordCount;void 0!==o&&o<a&&(a=o);var c,f=t&&null!==e&&""!==e,h=null!=r,y=!0;!0===i._removeGeometry&&(y=!1);var p=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map((function(e){return e.name})):["*"]);return c=new(0,s.default)(f||h?["GETPAGES"]:[],f||h?[]:["GETPAGES"],u,{outFields:p.join(","),resultRecordCount:a,resultOffset:0,objectIds:[i._findObjectId],where:"1=1",orderByFields:l,returnGeometry:y,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),i._expandPagedSet(c,a,0,0,n).then((function(){return c}))}))}catch(e){return(0,o.reject)(e)}}},{key:"_expandPagedSet",value:function(e,t,r,a,n){return this._expandPagedSetFeatureSet(e,t,r,a,n)}},{key:"_clonePageDefinition",value:function(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}},{key:"_getPhysicalPage",value:function(e,t,r){try{var a=this,n=e.pagesDefinition.internal.lastRetrieved,i=n,l=e.pagesDefinition.internal.lastPage,s=this._layer.nativeCapabilities(),u=new(0,d.default);return!0===this._requestStandardised&&(u.sqlFormat="standard"),u.relationshipId=this.relationship.id,u.objectIds=e.pagesDefinition.objectIds,u.resultOffset=e.pagesDefinition.internal.lastPage,u.resultRecordCount=e.pagesDefinition.resultRecordCount,u.outFields=e.pagesDefinition.outFields.split(","),u.where=e.pagesDefinition.where,u.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,u.returnGeometry=e.pagesDefinition.returnGeometry,u.outSpatialReference=this.spatialReference,s.source.queryRelatedFeatures(u).then((function(t){if(a._checkCancelled(r),e.pagesDefinition.internal.lastPage!==l)return 0;for(var s=t[a._findObjectId]?t[a._findObjectId].features:[],u=0;u<s.length;u++)e.pagesDefinition.internal.set[i+u]=s[u].attributes[a.relatedLayer.objectIdField];for(var o=0;o<s.length;o++)a._featureCache[s[o].attributes[a.relatedLayer.objectIdField]]=s[o];var d=!t[a._findObjectId]||!1===t[a._findObjectId].exceededTransferLimit;return s.length!==e.pagesDefinition.resultRecordCount&&d&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=n+s.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,s.length}))}catch(e){return(0,o.reject)(e)}}},{key:"_getFeatures",value:function(e,t,r,a){var n=this,i=[];-1!==t&&void 0===this._featureCache[t]&&i.push(t);var l=this._maxQueryRate();if(!0===this._checkIfNeedToExpandKnownPage(e,l))return this._expandPagedSet(e,l,0,0,a).then((function(){return n._getFeatures(e,t,r,a)}));for(var s=0,u=e._lastFetchedIndex;u<e._known.length&&(++s<=r&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[u]&&void 0===this._featureCache[e._known[u]]&&(e._known[u]!==t&&i.push(e._known[u]),i.length>r)))&&!(s>=r&&0===i.length);u++);return 0===i.length?(0,o.resolve)("success"):(0,o.reject)(new Error("Unaccounted for Features. Not in Feature Collection"))}},{key:"_refineSetBlock",value:function(e,t,r){return(0,o.resolve)(e)}},{key:"_stat",value:function(e,t,r,a,n,i,l){return(0,o.resolve)({calculated:!1})}},{key:"gdbVersion",get:function(){return this.relatedLayer.gdbVersion}},{key:"_canDoAggregates",value:function(e,t,r,a,n){return(0,o.resolve)(!1)}},{key:"relationshipMetaData",value:function(){return this.relatedLayer.relationshipMetaData()}},{key:"serviceUrl",value:function(){return this.relatedLayer.serviceUrl()}},{key:"queryAttachments",value:function(e,t,r,a,n){return this.relatedLayer.queryAttachments(e,t,r,a,n)}},{key:"getFeatureByObjectId",value:function(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}},{key:"getOwningSystemUrl",value:function(){return this.relatedLayer.getOwningSystemUrl()}},{key:"getIdentityUser",value:function(){return this.relatedLayer.getIdentityUser()}},{key:"getDataSourceFeatureSet",value:function(){return this.relatedLayer}}]),r}(l.default)}))}();
//# sourceMappingURL=featureSetUtils.e6af23e4.js.map
