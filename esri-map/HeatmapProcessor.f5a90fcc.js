function e(e,t,r,o){Object.defineProperty(e,t,{get:r,set:o,enumerable:!0,configurable:!0})}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire594f;t.register("46pKY",(function(r,o){var n;n=r.exports,Object.defineProperty(n,"__esModule",{value:!0,configurable:!0}),e(r.exports,"default",(function(){return y}));var a=t("j6uz9");t("5HTPH");var i=t("1CpCt");t("6TszD"),t("gHCNy"),t("aX9sh"),t("bXKTN");var s=t("qA6zg"),l=t("lDoe3"),c=t("4xw97"),d=t("aPQ4T"),u=t("lyPWm"),f=t("9F6Dg");class h{constructor(e,t){this.offset=e,this.extent=t}}let p=class extends u.default{initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))])}async update(e,t){const r=t.schema.processors[0];"heatmap"===r.type&&(0,l.diff)(this._schema,r)&&(e.mesh=!0,this._schema=r)}onTileUpdate(e){for(const t of e.removed)this._tileKeyToFeatureSets.delete(t.key.id)}onTileClear(e){return this._tileKeyToFeatureSets.delete(e.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:e.id,data:{clear:!0}})}async onTileMessage(e,t,r){this._tileKeyToFeatureSets.has(e.key.id)||this._tileKeyToFeatureSets.set(e.key.id,new Map);const o=this._tileKeyToFeatureSets.get(e.key.id);if((0,i.isSome)(t.addOrUpdate)&&t.addOrUpdate.hasFeatures&&o.set(t.addOrUpdate.instance,t),t.end){const t=[],o=function(e){const t=e.key,r=new Map,o=256,n=d.TILE_SIZE,a=e.tileInfoView.tileInfo.isWrappable;return r.set((0,f.getPow2NeighborKey)(t,-1,-1,a).id,new h([-n,-n],[n-o,n-o,n,n])),r.set((0,f.getPow2NeighborKey)(t,0,-1,a).id,new h([0,-n],[0,n-o,n,n])),r.set((0,f.getPow2NeighborKey)(t,1,-1,a).id,new h([n,-n],[0,n-o,o,n])),r.set((0,f.getPow2NeighborKey)(t,-1,0,a).id,new h([-n,0],[n-o,0,n,n])),r.set((0,f.getPow2NeighborKey)(t,1,0,a).id,new h([n,0],[0,0,o,n])),r.set((0,f.getPow2NeighborKey)(t,-1,1,a).id,new h([-n,n],[n-o,0,n,o])),r.set((0,f.getPow2NeighborKey)(t,0,1,a).id,new h([0,n],[0,0,n,o])),r.set((0,f.getPow2NeighborKey)(t,1,1,a).id,new h([n,n],[0,0,o,o])),r}(e);this._tileKeyToFeatureSets.forEach(((r,n)=>{if(n===e.key.id)r.forEach((e=>(0,i.applySome)(e.addOrUpdate,(e=>t.push(e)))));else if(o.has(n)){const e=o.get(n),[a,s]=e.offset;r.forEach((e=>(0,i.applySome)(e.addOrUpdate,(e=>{const r=e.transform(a,s,1,1);t.push(r)}))))}}));const n=(0,c.calculateHeatmapIntensityInfoReaders)(t,this._schema.mesh,512,512),a={tileKey:e.key.id,intensityInfo:n},s=[n.matrix];return this.remoteClient.invoke("tileRenderer.onTileData",a,{...r,transferList:s})}}onTileError(e,t,r){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:e.id,error:t},r)}constructor(){super(...arguments),this.type="heatmap",this._tileKeyToFeatureSets=new Map}};p=(0,a._)([(0,s.subclass)("esri.views.2d.layers.features.processors.HeatmapProcessor")],p);const y=p})),t.register("4xw97",(function(r,o){e(r.exports,"generateGradient",(function(){return a})),e(r.exports,"calculateHeatmapIntensityInfoReaders",(function(){return i})),e(r.exports,"drawHeatmap",(function(){return s}));var n=t("8TN87");const a=(()=>{if(!("document"in globalThis))return()=>null;const e=document.createElement("canvas"),t=e.getContext("2d");return e.height=512,e.width=1,r=>{t.clearRect(0,0,1,e.height);const o=t.createLinearGradient(0,0,0,e.height);for(const{ratio:e,color:t}of r)o.addColorStop(Math.max(e,.001),`rgba(${t.r}, ${t.g}, ${t.b}, ${t.a})`);return t.fillStyle=o,t.fillRect(0,0,1,e.height),t.getImageData(0,0,1,e.height).data}})();function i(e,t,r,o){const{blurRadius:n,fieldOffset:a,field:i}=t,s=new Float64Array(r*o),c=l(n),d=Math.round(3*n);let u,f=Number.NEGATIVE_INFINITY;const h=(g=a,null!=(y=i)?"string"==typeof g?e=>-1*+e.readAttribute(y):e=>+e.readAttribute(y)+g:e=>1),p=new Set;var y,g;for(const t of e){const e=t.getCursor();for(;e.next();){const t=e.getObjectId();if(p.has(t))continue;p.add(t);const n=e.readLegacyPointGeometry(),a=128;if(n.x<-a||n.x>=r+a||n.y<-a||n.y>o+a)continue;const i=+h(e),l=Math.round(n.x)-d,y=Math.round(n.y)-d,g=Math.max(0,l),w=Math.max(0,y),m=Math.min(o,Math.round(n.y)+d),b=Math.min(r,Math.round(n.x)+d);for(let e=w;e<m;e++){const t=c[e-y];for(let o=g;o<b;o++){const n=c[o-l];u=s[e*r+o]+=t*n*i,u>f&&(f=u)}}}}return{matrix:s.buffer,max:f}}function s(e,t,r,o,a,i){e.canvas.width=e.canvas.height=t,e.clearRect(0,0,t,t);const s=e.getImageData(0,0,t,t);r&&o&&s.data.set(new Uint8ClampedArray(function(e,t,r,o,a){const i=new Uint32Array(e*e),s="buffer"in t?t:new Float64Array(t),l="buffer"in r?new Uint32Array(r.buffer):new Uint32Array(new Uint8Array(r).buffer),c=l.length/(a-o);for(let e=0;e<s.length;e++){const t=s[e],r=Math.floor((t-o)*c);i[e]=l[(0,n.clamp)(r,0,l.length-1)]}return i.buffer}(t,r,o,a,i))),e.putImageData(s,0,0)}function l(e){const t=Math.round(3*e),r=2*e*e,o=new Float64Array(2*t+1);for(let n=0;n<=o.length;n++)o[n]=Math.exp(-((n-t)**2)/r)/Math.sqrt(2*Math.PI)*(e/2);return o}})),t.register("lyPWm",(function(r,o){e(r.exports,"default",(function(){return c}));var n=t("j6uz9"),a=t("8Y9g8"),i=t("hTI69");t("aX9sh"),t("5HTPH"),t("gHCNy");var s=t("qA6zg");let l=class extends a.HandleOwner{initialize(){}destroy(){}get supportsTileUpdates(){return!1}get spatialReference(){const e=this.get("tileStore.tileScheme.spatialReference");return e&&e.toJSON()||null}};(0,n._)([(0,i.property)({readOnly:!0})],l.prototype,"supportsTileUpdates",null),(0,n._)([(0,i.property)({constructOnly:!0})],l.prototype,"remoteClient",void 0),(0,n._)([(0,i.property)({constructOnly:!0})],l.prototype,"service",void 0),(0,n._)([(0,i.property)()],l.prototype,"spatialReference",null),(0,n._)([(0,i.property)({constructOnly:!0})],l.prototype,"tileInfo",void 0),(0,n._)([(0,i.property)({constructOnly:!0})],l.prototype,"tileStore",void 0),l=(0,n._)([(0,s.subclass)("esri.views.2d.layers.features.processors.BaseProcessor")],l);const c=l})),t.register("9F6Dg",(function(r,o){e(r.exports,"getPow2NeighborKey",(function(){return n}));t("6uWZ2");function n(e,t,r,o){const n=e.clone(),a=1<<n.level,i=n.col+t,s=n.row+r;return o&&i<0?(n.col=i+a,n.world-=1):i>=a?(n.col=i-a,n.world+=1):n.col=i,n.row=s,n}}));
//# sourceMappingURL=HeatmapProcessor.f5a90fcc.js.map
