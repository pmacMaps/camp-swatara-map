!function(){function e(e,t,r,i){Object.defineProperty(e,t,{get:r,set:i,enumerable:!0,configurable:!0})}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire594f;t.register("kJetr",(function(r,i){e(r.exports,"isMapServiceLayerView",(function(){return j})),e(r.exports,"MapServiceLayerViewHelper",(function(){return P}));var o=t("7eJjO"),n=t("bsvXr"),s=t("jymfC"),a=t("lNwWH"),l=t("d2yMj"),u=t("kyj08"),p=t("6ah52"),y=t("2VlWd"),c=t("edmn4"),d=t("10vEZ"),f=t("lKPaD"),h=t("5vzSQ"),m=t("iho5X");t("iJAIC");var g=t("fcwIv"),v=t("gINRd"),w=t("k0Vu4"),b=t("7vTUY"),x=t("1okjo"),S=t("85z0B"),_=t("aQ7xi"),F=t("67wgJ"),R=t("3nnTb"),I=t("ioNzP"),N=t("dB39e");let O=null;function j(e,t){return"tile"===t.type||"map-image"===t.type}let P=class extends s.default{initialize(){const e=e=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch((()=>{}))),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([(0,f.on)((()=>this.highlightGraphics),"change",(t=>e(t.added)),{onListenerAdd:t=>e(t)})])}async fetchPopupFeatures(e,t){var r,i;const{layerView:{layer:o,view:{scale:n}}}=this;if(!e)throw new(0,u.default)("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:o});const s=function(e,t,r){const i=[],o=e=>{const n=0===e.minScale||t<=e.minScale,s=0===e.maxScale||t>=e.maxScale;if(e.visible&&n&&s)if(e.sublayers)e.sublayers.forEach(o);else if(e.popupEnabled){const t=(0,N.getFetchPopupTemplate)(e,{...r,defaultPopupTemplateEnabled:!1});null!=t&&i.unshift({sublayer:e,popupTemplate:t})}};var n;return(null!==(n=null==e?void 0:e.toArray())&&void 0!==n?n:[]).reverse().map(o),i}(o.sublayers,n,t);if(!s.length)return[];const a=await async function(e,t){var r,i;if(null===(r=e.capabilities)||void 0===r||null===(i=r.operations)||void 0===i?void 0:i.supportsQuery)return!0;try{return await Promise.any(t.map((({sublayer:e})=>e.load().then((()=>e.capabilities.operations.supportsQuery)))))}catch{return!1}}(o,s);var l;if(!((null===(l=null===(r=o.capabilities)||void 0===r||null===(i=r.operations)||void 0===i?void 0:i.supportsIdentify)||void 0===l||l)&&o.version>=10.5||a))throw new(0,u.default)("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:o});return a?this._fetchPopupFeaturesUsingQueries(e,s,t):this._fetchPopupFeaturesUsingIdentify(e,s,t)}clearHighlights(){var e;null===(e=this.highlightGraphics)||void 0===e||e.removeAll()}highlight(e){const t=this.highlightGraphics;if(!t)return{remove(){}};let r=null;if(e instanceof n.default?r=[e]:l.default.isCollection(e)&&e.length>0?r=e.toArray():Array.isArray(e)&&e.length>0&&(r=e),r=null==r?void 0:r.filter(a.isSome),!r||!r.length)return(0,p.makeHandle)();for(const e of r){const t=e.sourceLayer;null!=t&&"geometryType"in t&&"point"===t.geometryType&&(e.visible=!1)}return t.addMany(r),{remove:()=>{t.removeMany(null!=r?r:[])}}}async _updateHighlightedFeaturesSymbols(e){const{layerView:{view:r},highlightGraphics:i,highlightGraphicUpdated:o}=this;if(i&&o)for(const n of e){const e=n.sourceLayer&&"renderer"in n.sourceLayer&&n.sourceLayer.renderer;n.sourceLayer&&"geometryType"in n.sourceLayer&&"point"===n.sourceLayer.geometryType&&e&&"getSymbolAsync"in e&&e.getSymbolAsync(n).then((async s=>{var a;s||(s=new(0,I.default));let l=null;const u="visualVariables"in e?null===(a=e.visualVariables)||void 0===a?void 0:a.find((e=>"size"===e.type)):void 0;u&&(O||(O=(await Promise.resolve(t("fO9V6"))).getSize),l=O(u,n,{view:r.type,scale:r.scale,shape:"simple-marker"===s.type?s.style:null})),l||(l="width"in s&&"height"in s&&null!=s.width&&null!=s.height?Math.max(s.width,s.height):"size"in s?s.size:16),i.includes(n)&&(n.symbol=new(0,I.default)({style:"square",size:l,xoffset:"xoffset"in s?s.xoffset:0,yoffset:"yoffset"in s?s.yoffset:0}),o(n,"symbol"),n.visible=!0)}))}}async _updateHighlightedFeaturesGeometries(e){const{layerView:{layer:t,view:r},highlightGraphics:i,highlightGraphicUpdated:o}=this;if(this._highlightGeometriesResolution=e,!o||!(null==i?void 0:i.length)||!t.capabilities.operations.supportsQuery)return;const n=this._getTargetResolution(e),s=new Map;for(const e of i)if(!this._featuresResolutions.has(e)||this._featuresResolutions.get(e)>n){const t=e.sourceLayer;(0,c.getOrCreateMapValue)(s,t,(()=>new Map)).set(e.getObjectId(),e)}const a=Array.from(s,(([e,t])=>{const i=e.createQuery();return i.objectIds=[...t.keys()],i.outFields=[e.objectIdField],i.returnGeometry=!0,i.maxAllowableOffset=n,i.outSpatialReference=r.spatialReference,e.queryFeatures(i)})),l=await Promise.all(a);if(!this.destroyed)for(const{features:e}of l)for(const t of e){const e=t.sourceLayer,r=s.get(e).get(t.getObjectId());r&&i.includes(r)&&(r.geometry=t.geometry,o(r,"geometry"),this._featuresResolutions.set(r,n))}}_getTargetResolution(e){const t=e*(0,h.getMetersPerUnitForSR)(this.layerView.view.spatialReference),r=t/16;return r<=10?0:e/t*r}async _fetchPopupFeaturesUsingIdentify(e,t,r){const i=await this._createIdentifyParameters(e,t,r);if(null==i)return[];const{results:o}=await(0,_.identify)(this.layerView.layer.parsedUrl,i);return o.map((e=>e.feature))}async _createIdentifyParameters(e,t,r){const{floors:i,layer:o,timeExtent:n,view:{spatialReference:s,scale:a}}=this.layerView,l=null!=r?r.event:null;if(!t.length)return null;await Promise.all(t.map((({sublayer:e})=>e.load().catch((()=>{})))));const u=Math.min((0,y.default)("mapservice-popup-identify-max-tolerance"),o.allSublayers.reduce(((e,t)=>t.renderer?(0,S.calculateTolerance)({renderer:t.renderer,event:l}):e),2)),p=this.createFetchPopupFeaturesQueryGeometry(e,u),c=(0,w.getResolutionForScale)(a,s),d=Math.round(p.width/c),f=new(0,v.default)({xmin:p.center.x-c*d,ymin:p.center.y-c*d,xmax:p.center.x+c*d,ymax:p.center.y+c*d,spatialReference:p.spatialReference});return new(0,F.default)({floors:i,gdbVersion:"gdbVersion"in o?o.gdbVersion:void 0,geometry:e,height:d,layerOption:"popup",mapExtent:f,returnGeometry:!0,spatialReference:s,sublayers:o.sublayers,timeExtent:n,tolerance:u,width:d})}async _fetchPopupFeaturesUsingQueries(e,t,r){const{layerView:{floors:i,timeExtent:o}}=this,n=null!=r?r.event:null,s=t.map((async({sublayer:t,popupTemplate:r})=>{var s;if(await t.load().catch((()=>{})),t.capabilities&&!t.capabilities.operations.supportsQuery)return[];const a=t.createQuery(),l=(0,S.calculateTolerance)({renderer:t.renderer,event:n}),u=this.createFetchPopupFeaturesQueryGeometry(e,l),p=new Set,[y]=await Promise.all([(0,N.getRequiredFields)(t,r),null===(s=t.renderer)||void 0===s?void 0:s.collectRequiredFields(p,t.fieldsIndex)]);(0,b.collectFields)(p,t.fieldsIndex,y);const c=Array.from(p).sort();if(a.geometry=u,a.outFields=c,a.timeExtent=o,i){const e=i.clone(),r=(0,x.getLayerFloorFilterClause)(e,t);null!=r&&(a.where=a.where?`(${a.where}) AND (${r})`:r)}const d=this._getTargetResolution(u.width/l),f=await function(e){var t;return(null===(t=e.expressionInfos)||void 0===t?void 0:t.length)||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type))?(0,R.loadArcade)():Promise.resolve()}(r),h="point"===t.geometryType||f&&f.arcadeUtils.hasGeometryOperations(r);h||(a.maxAllowableOffset=d);let{features:m}=await t.queryFeatures(a);const g=h?0:d;m=await async function(e,t){const r=e.renderer;return r&&"defaultSymbol"in r&&!r.defaultSymbol&&(t=r.valueExpression?await Promise.all(t.map((e=>r.getSymbolAsync(e).then((t=>t?e:null))))).then((e=>e.filter((e=>null!=e)))):t.filter((e=>null!=r.getSymbol(e)))),t}(t,m);for(const e of m)this._featuresResolutions.set(e,g);return m}));return(await(0,d.eachAlways)(s)).reverse().reduce(((e,t)=>t.value?[...e,...t.value]:e),[]).filter(a.isSome)}constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=(0,d.debounce)((async e=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch((()=>{})))}))}};(0,o._)([(0,m.property)({constructOnly:!0})],P.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),(0,o._)([(0,m.property)({constructOnly:!0})],P.prototype,"layerView",void 0),(0,o._)([(0,m.property)({constructOnly:!0})],P.prototype,"highlightGraphics",void 0),(0,o._)([(0,m.property)({constructOnly:!0})],P.prototype,"highlightGraphicUpdated",void 0),(0,o._)([(0,m.property)({constructOnly:!0})],P.prototype,"updatingHandles",void 0),P=(0,o._)([(0,g.subclass)("esri.views.layers.support.MapService")],P)})),t.register("85z0B",(function(t,r){function i(e,t){return t?"xoffset"in t&&t.xoffset?Math.max(e,Math.abs(t.xoffset)):"yoffset"in t&&t.yoffset?Math.max(e,Math.abs(t.yoffset||0)):e:e}function o(e,t){return"number"==typeof e?e:e&&e.stops&&e.stops.length?function(e){let t=0,r=0;for(let i=0;i<e.length;i++){const o=e[i].size;"number"==typeof o&&(t+=o,r++)}return t/r}(e.stops):t}function n(e){const t=e&&e.renderer,r="touch"===(e&&e.event&&e.event.pointerType)?9:6;if(!t)return r;const n="visualVariables"in t?function(e,t){if(!t)return e;const r=t.filter((e=>"size"===e.type)).map((t=>{const{maxSize:r,minSize:i}=t;return(o(r,e)+o(i,e))/2}));let i=0;const n=r.length;if(0===n)return e;for(let e=0;e<n;e++)i+=r[e];const s=Math.floor(i/n);return Math.max(s,e)}(r,t.visualVariables):r;if("simple"===t.type)return i(n,t.symbol);if("unique-value"===t.type){var s;let e=n;return null===(s=t.uniqueValueInfos)||void 0===s||s.forEach((t=>{e=i(e,t.symbol)})),e}if("class-breaks"===t.type){let e=n;return t.classBreakInfos.forEach((t=>{e=i(e,t.symbol)})),e}return"dot-density"===t.type||t.type,n}e(t.exports,"calculateTolerance",(function(){return n}))})),t.register("aQ7xi",(function(r,i){e(r.exports,"identify",(function(){return p}));var o=t("9pNSx"),n=t("5On35"),s=t("dsJ7q"),a=t("7KsvG"),l=t("67wgJ"),u=t("fa1Fy");async function p(e,t,r){const i=(p=t,t=l.default.from(p)).geometry?[t.geometry]:[],u=(0,s.parseUrl)(e);var p;return u.path+="/identify",(0,n.normalizeCentralMeridian)(i).then((e=>{const i=(0,a.identifyToIdentifyRESTParameters)(t,{geometry:e&&e[0]}),n=(0,s.encode)({...u.query,f:"json",...i}),l=(0,s.asValidOptions)(n,r);return(0,o.default)(u.path,l).then(y).then((e=>function(e,t){if(!(null==t?void 0:t.length))return e;const r=new Map;function i(e){r.set(e.id,e),e.sublayers&&e.sublayers.forEach(i)}t.forEach(i);for(const t of e.results)t.feature.sourceLayer=r.get(t.layerId);return e}(e,t.sublayers)))}))}function y(e){const t=e.data;return t.results=t.results||[],t.exceededTransferLimit=Boolean(t.exceededTransferLimit),t.results=t.results.map((e=>u.default.fromJSON(e))),t}})),t.register("7KsvG",(function(r,i){e(r.exports,"identifyToIdentifyRESTParameters",(function(){return p}));var o=t("37plS"),n=t("79LpT"),s=t("k0Vu4"),a=t("1okjo"),l=t("dL9AF");const u=e=>e.spatialReference.wkid||JSON.stringify(e.spatialReference);function p(e,t){const{dpi:r,gdbVersion:i,geometry:p,geometryPrecision:y,height:c,layerOption:d,mapExtent:f,maxAllowableOffset:h,returnFieldName:m,returnGeometry:g,returnUnformattedValues:v,returnZ:w,spatialReference:b,timeExtent:x,tolerance:S,width:_}=e.toJSON(),{dynamicLayers:F,layerDefs:R,layerIds:I}=function(e){var t,r;const{mapExtent:i,floors:n,width:u,sublayers:p,layerIds:y,layerOption:c,gdbVersion:d}=e,f=null===(t=null==p?void 0:p.find((e=>null!=e.layer)))||void 0===t||null===(r=t.layer)||void 0===r?void 0:r.serviceSublayers,h="popup"===c,m={},g=(0,s.getScale)({extent:i,width:u,spatialReference:null==i?void 0:i.spatialReference}),v=[],w=e=>{const t=0===g,r=0===e.minScale||g<=e.minScale,i=0===e.maxScale||g>=e.maxScale;if(e.visible&&(t||r&&i))if(e.sublayers)e.sublayers.forEach(w);else{if(!1===(null==y?void 0:y.includes(e.id))||h&&(!e.popupTemplate||!e.popupEnabled))return;v.unshift(e)}};if(null==p||p.forEach(w),p&&!v.length)m.layerIds=[];else{const e=(0,l.isExportDynamic)(v,f,d),t=v.map((e=>{const t=(0,a.getLayerFloorFilterClause)(n,e);return e.toExportImageJSON(t)}));if(e)m.dynamicLayers=JSON.stringify(t);else{if(p){let e=v.map((({id:e})=>e));y&&(e=e.filter((e=>y.includes(e)))),m.layerIds=e}else(null==y?void 0:y.length)&&(m.layerIds=y);const e=function(e,t){const r=!!(null==e?void 0:e.length),i=t.filter((e=>null!=e.definitionExpression||r&&null!=e.floorInfo));return i.length?i.map((t=>{const r=(0,a.getLayerFloorFilterClause)(e,t),i=(0,o.sqlAnd)(r,t.definitionExpression);return{id:t.id,definitionExpression:null!=i?i:void 0}})):null}(n,v);if(null!=e&&e.length){const t={};for(const r of e)r.definitionExpression&&(t[r.id]=r.definitionExpression);Object.keys(t).length&&(m.layerDefs=JSON.stringify(t))}}}return m}(e),N=t&&null!=t.geometry?t.geometry:null,O={geometryPrecision:y,maxAllowableOffset:h,returnFieldName:m,returnGeometry:g,returnUnformattedValues:v,returnZ:w,tolerance:S},j=N&&N.toJSON()||p;if(O.imageDisplay=`${_},${c},${r}`,i&&(O.gdbVersion=i),j&&(delete j.spatialReference,O.geometry=JSON.stringify(j),O.geometryType=(0,n.getJsonType)(j)),b?O.sr=b.wkid||JSON.stringify(b):j&&j.spatialReference?O.sr=u(j):f&&f.spatialReference&&(O.sr=u(f)),O.time=x?[x.start,x.end].join(","):null,f){const{xmin:e,ymin:t,xmax:r,ymax:i}=f;O.mapExtent=`${e},${t},${r},${i}`}return R&&(O.layerDefs=R),F&&!R&&(O.dynamicLayers=F),O.layers="popup"===d?"visible":d,I&&!F&&(O.layers+=`:${I.join(",")}`),O}})),t.register("67wgJ",(function(r,i){e(r.exports,"default",(function(){return m}));var o=t("7eJjO"),n=t("2ILM8"),s=t("9DeZf"),a=t("1XAcN"),l=t("iho5X"),u=t("iJAIC");t("lNwWH"),t("2VlWd");var p,y=t("fcwIv"),c=t("79LpT"),d=t("gINRd"),f=t("j40xv");let h=p=class extends a.JSONSupport{static from(e){return(0,u.ensureClass)(p,e)}constructor(e){super(e),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}};(0,o._)([(0,l.property)({type:Number,json:{write:!0}})],h.prototype,"dpi",void 0),(0,o._)([(0,l.property)()],h.prototype,"floors",void 0),(0,o._)([(0,l.property)({type:String,json:{write:!0}})],h.prototype,"gdbVersion",void 0),(0,o._)([(0,l.property)({types:n.geometryTypes,json:{read:c.fromJSON,write:!0}})],h.prototype,"geometry",void 0),(0,o._)([(0,l.property)({type:Number,json:{write:!0}})],h.prototype,"geometryPrecision",void 0),(0,o._)([(0,l.property)({type:Number,json:{write:!0}})],h.prototype,"height",void 0),(0,o._)([(0,l.property)({type:[Number],json:{write:!0}})],h.prototype,"layerIds",void 0),(0,o._)([(0,l.property)({type:["top","visible","all","popup"],json:{write:!0}})],h.prototype,"layerOption",void 0),(0,o._)([(0,l.property)({type:d.default,json:{write:!0}})],h.prototype,"mapExtent",void 0),(0,o._)([(0,l.property)({type:Number,json:{write:!0}})],h.prototype,"maxAllowableOffset",void 0),(0,o._)([(0,l.property)({type:Boolean,json:{write:!0}})],h.prototype,"returnFieldName",void 0),(0,o._)([(0,l.property)({type:Boolean,json:{write:!0}})],h.prototype,"returnGeometry",void 0),(0,o._)([(0,l.property)({type:Boolean,json:{write:!0}})],h.prototype,"returnM",void 0),(0,o._)([(0,l.property)({type:Boolean,json:{write:!0}})],h.prototype,"returnUnformattedValues",void 0),(0,o._)([(0,l.property)({type:Boolean,json:{write:!0}})],h.prototype,"returnZ",void 0),(0,o._)([(0,l.property)({type:f.default,json:{write:!0}})],h.prototype,"spatialReference",void 0),(0,o._)([(0,l.property)()],h.prototype,"sublayers",void 0),(0,o._)([(0,l.property)({type:s.default,json:{write:!0}})],h.prototype,"timeExtent",void 0),(0,o._)([(0,l.property)({type:Number,json:{write:!0}})],h.prototype,"tolerance",void 0),(0,o._)([(0,l.property)({type:Number,json:{write:!0}})],h.prototype,"width",void 0),h=p=(0,o._)([(0,y.subclass)("esri.rest.support.IdentifyParameters")],h);const m=h})),t.register("fa1Fy",(function(r,i){e(r.exports,"default",(function(){return d}));var o=t("7eJjO");t("2ILM8");var n=t("bsvXr"),s=t("1XAcN"),a=t("iho5X");t("iJAIC"),t("lNwWH"),t("2VlWd");var l=t("eB8sj"),u=t("fcwIv"),p=t("kced1"),y=t("7LVgC");let c=class extends s.JSONSupport{readFeature(e,t){return n.default.fromJSON({attributes:{...t.attributes},geometry:{...t.geometry}})}writeFeature(e,t){if(!e)return;const{attributes:r,geometry:i}=e;r&&(t.attributes={...r}),null!=i&&(t.geometry=i.toJSON(),t.geometryType=y.typeKebabDictionary.toJSON(i.type))}constructor(e){super(e),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}};(0,o._)([(0,a.property)({type:String,json:{write:!0}})],c.prototype,"displayFieldName",void 0),(0,o._)([(0,a.property)({type:n.default})],c.prototype,"feature",void 0),(0,o._)([(0,l.reader)("feature",["attributes","geometry"])],c.prototype,"readFeature",null),(0,o._)([(0,p.writer)("feature")],c.prototype,"writeFeature",null),(0,o._)([(0,a.property)({type:Number,json:{write:!0}})],c.prototype,"layerId",void 0),(0,o._)([(0,a.property)({type:String,json:{write:!0}})],c.prototype,"layerName",void 0),c=(0,o._)([(0,u.subclass)("esri.rest.support.IdentifyResult")],c);const d=c})),t.register("kmFW1",(function(r,i){e(r.exports,"createQueryGeometry",(function(){return s})),t("2ILM8");var o=t("5vzSQ"),n=(t("85z0B"),t("gINRd"));function s(e,t,r,i=new(0,n.default)){let s=0;var a;if("2d"===r.type)s=t*(null!==(a=r.resolution)&&void 0!==a?a:0);else if("3d"===r.type){const i=r.overlayPixelSizeInMapUnits(e),n=r.basemapSpatialReference;s=null==n||n.equals(r.spatialReference)?t*i:(0,o.getMetersPerUnitForSR)(n)/(0,o.getMetersPerUnitForSR)(r.spatialReference)}const l=e.x-s,u=e.y-s,p=e.x+s,y=e.y+s,{spatialReference:c}=r;return i.xmin=Math.min(l,p),i.ymin=Math.min(u,y),i.xmax=Math.max(l,p),i.ymax=Math.max(u,y),i.spatialReference=c,i}new(0,n.default)}))}();
//# sourceMappingURL=TileLayerView2D.ec76ab6b.js.map
