function e(e,t,r,i){Object.defineProperty(e,t,{get:r,set:i,enumerable:!0,configurable:!0})}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire594f;t.register("ejvG7",(function(r,i){e(r.exports,"isMapServiceLayerView",(function(){return E})),e(r.exports,"MapServiceLayerViewHelper",(function(){return T}));var o=t("j6uz9"),n=t("EvxpF"),s=t("27btt"),a=t("aX9sh"),l=t("26zvD"),u=t("bPmsI"),p=t("1gMab"),y=t("5HTPH"),c=t("035lZ"),f=t("lHg4e"),d=t("cc23H"),h=t("zPXCh"),m=t("hTI69");t("gHCNy");var g=t("qA6zg"),b=t("2WnyR"),w=t("bxT91"),v=t("15IfA"),x=t("dx4Ow"),S=t("eyDHN"),_=t("8gH7w"),F=t("3w7YE"),R=t("QiKdE"),N=t("2HOOk"),O=t("6hadY");let P=null;function E(e,t){return"tile"===t.type||"map-image"===t.type}let T=class extends s.default{initialize(){const e=e=>{this.updatingHandles.addPromise(this._updateHighlightedFeaturesSymbols(e).catch((()=>{}))),this.updateHighlightedFeatures(this._highlightGeometriesResolution)};this.addHandles([(0,d.on)((()=>this.highlightGraphics),"change",(t=>e(t.added)),{onListenerAdd:t=>e(t)})])}async fetchPopupFeatures(e,t){const{layerView:{layer:r,view:{scale:i}}}=this;if(!e)throw new(0,u.default)("fetchPopupFeatures:invalid-area","Nothing to fetch without area",{layer:r});const o=function(e,t,r){const i=[],o=e=>{const n=0===e.minScale||t<=e.minScale,s=0===e.maxScale||t>=e.maxScale;if(e.visible&&n&&s)if(e.sublayers)e.sublayers.forEach(o);else if(e.popupEnabled){const t=(0,O.getFetchPopupTemplate)(e,{...r,defaultPopupTemplateEnabled:!1});null!=t&&i.unshift({sublayer:e,popupTemplate:t})}};return(e?.toArray()??[]).reverse().map(o),i}(r.sublayers,i,t);if(!o.length)return[];const n=await async function(e,t){if(e.capabilities?.operations?.supportsQuery)return!0;try{return await Promise.any(t.map((({sublayer:e})=>e.load().then((()=>e.capabilities.operations.supportsQuery)))))}catch{return!1}}(r,o);if(!((r.capabilities?.operations?.supportsIdentify??1)&&r.version>=10.5||n))throw new(0,u.default)("fetchPopupFeatures:not-supported","query operation is disabled for this service",{layer:r});return n?this._fetchPopupFeaturesUsingQueries(e,o,t):this._fetchPopupFeaturesUsingIdentify(e,o,t)}clearHighlights(){this.highlightGraphics?.removeAll()}highlight(e){const t=this.highlightGraphics;if(!t)return{remove(){}};let r=null;if(e instanceof n.default?r=[e]:l.default.isCollection(e)&&e.length>0?r=e.toArray():Array.isArray(e)&&e.length>0&&(r=e),r=r?.filter(a.isSome),!r||!r.length)return(0,p.makeHandle)();for(const e of r){const t=e.sourceLayer;null!=t&&"geometryType"in t&&"point"===t.geometryType&&(e.visible=!1)}return t.addMany(r),{remove:()=>{t.removeMany(r??[])}}}async _updateHighlightedFeaturesSymbols(e){const{layerView:{view:r},highlightGraphics:i,highlightGraphicUpdated:o}=this;if(i&&o)for(const n of e){const e=n.sourceLayer&&"renderer"in n.sourceLayer&&n.sourceLayer.renderer;n.sourceLayer&&"geometryType"in n.sourceLayer&&"point"===n.sourceLayer.geometryType&&e&&"getSymbolAsync"in e&&e.getSymbolAsync(n).then((async s=>{s||=new(0,N.default);let a=null;const l="visualVariables"in e?e.visualVariables?.find((e=>"size"===e.type)):void 0;l&&(P||(P=(await Promise.resolve(t("64Tjv"))).getSize),a=P(l,n,{view:r.type,scale:r.scale,shape:"simple-marker"===s.type?s.style:null})),a||="width"in s&&"height"in s&&null!=s.width&&null!=s.height?Math.max(s.width,s.height):"size"in s?s.size:16,i.includes(n)&&(n.symbol=new(0,N.default)({style:"square",size:a,xoffset:"xoffset"in s?s.xoffset:0,yoffset:"yoffset"in s?s.yoffset:0}),o(n,"symbol"),n.visible=!0)}))}}async _updateHighlightedFeaturesGeometries(e){const{layerView:{layer:t,view:r},highlightGraphics:i,highlightGraphicUpdated:o}=this;if(this._highlightGeometriesResolution=e,!o||!i?.length||!t.capabilities.operations.supportsQuery)return;const n=this._getTargetResolution(e),s=new Map;for(const e of i)if(!this._featuresResolutions.has(e)||this._featuresResolutions.get(e)>n){const t=e.sourceLayer;(0,c.getOrCreateMapValue)(s,t,(()=>new Map)).set(e.getObjectId(),e)}const a=Array.from(s,(([e,t])=>{const i=e.createQuery();return i.objectIds=[...t.keys()],i.outFields=[e.objectIdField],i.returnGeometry=!0,i.maxAllowableOffset=n,i.outSpatialReference=r.spatialReference,e.queryFeatures(i)})),l=await Promise.all(a);if(!this.destroyed)for(const{features:e}of l)for(const t of e){const e=t.sourceLayer,r=s.get(e).get(t.getObjectId());r&&i.includes(r)&&(r.geometry=t.geometry,o(r,"geometry"),this._featuresResolutions.set(r,n))}}_getTargetResolution(e){const t=e*(0,h.getMetersPerUnitForSR)(this.layerView.view.spatialReference),r=t/16;return r<=10?0:e/t*r}async _fetchPopupFeaturesUsingIdentify(e,t,r){const i=await this._createIdentifyParameters(e,t,r);if(null==i)return[];const{results:o}=await(0,_.identify)(this.layerView.layer.parsedUrl,i);return o.map((e=>e.feature))}async _createIdentifyParameters(e,t,r){const{floors:i,layer:o,timeExtent:n,view:{spatialReference:s,scale:a}}=this.layerView,l=null!=r?r.event:null;if(!t.length)return null;await Promise.all(t.map((({sublayer:e})=>e.load().catch((()=>{})))));const u=Math.min((0,y.default)("mapservice-popup-identify-max-tolerance"),o.allSublayers.reduce(((e,t)=>t.renderer?(0,S.calculateTolerance)({renderer:t.renderer,event:l}):e),2)),p=this.createFetchPopupFeaturesQueryGeometry(e,u),c=(0,w.getResolutionForScale)(a,s),f=Math.round(p.width/c),d=new(0,b.default)({xmin:p.center.x-c*f,ymin:p.center.y-c*f,xmax:p.center.x+c*f,ymax:p.center.y+c*f,spatialReference:p.spatialReference});return new(0,F.default)({floors:i,gdbVersion:"gdbVersion"in o?o.gdbVersion:void 0,geometry:e,height:f,layerOption:"popup",mapExtent:d,returnGeometry:!0,spatialReference:s,sublayers:o.sublayers,timeExtent:n,tolerance:u,width:f})}async _fetchPopupFeaturesUsingQueries(e,t,r){const{layerView:{floors:i,timeExtent:o}}=this,n=null!=r?r.event:null,s=t.map((async({sublayer:t,popupTemplate:r})=>{if(await t.load().catch((()=>{})),t.capabilities&&!t.capabilities.operations.supportsQuery)return[];const s=t.createQuery(),a=(0,S.calculateTolerance)({renderer:t.renderer,event:n}),l=this.createFetchPopupFeaturesQueryGeometry(e,a),u=new Set,[p]=await Promise.all([(0,O.getRequiredFields)(t,r),t.renderer?.collectRequiredFields(u,t.fieldsIndex)]);(0,v.collectFields)(u,t.fieldsIndex,p);const y=Array.from(u).sort();if(s.geometry=l,s.outFields=y,s.timeExtent=o,i){const e=i.clone(),r=(0,x.getLayerFloorFilterClause)(e,t);null!=r&&(s.where=s.where?`(${s.where}) AND (${r})`:r)}const c=this._getTargetResolution(l.width/a),f=await function(e){return e.expressionInfos?.length||Array.isArray(e.content)&&e.content.some((e=>"expression"===e.type))?(0,R.loadArcade)():Promise.resolve()}(r),d="point"===t.geometryType||f&&f.arcadeUtils.hasGeometryOperations(r);d||(s.maxAllowableOffset=c);let{features:h}=await t.queryFeatures(s);const m=d?0:c;h=await async function(e,t){const r=e.renderer;return r&&"defaultSymbol"in r&&!r.defaultSymbol&&(t=r.valueExpression?await Promise.all(t.map((e=>r.getSymbolAsync(e).then((t=>t?e:null))))).then((e=>e.filter((e=>null!=e)))):t.filter((e=>null!=r.getSymbol(e)))),t}(t,h);for(const e of h)this._featuresResolutions.set(e,m);return h}));return(await(0,f.eachAlways)(s)).reverse().reduce(((e,t)=>t.value?[...e,...t.value]:e),[]).filter(a.isSome)}constructor(e){super(e),this._featuresResolutions=new WeakMap,this.highlightGraphics=null,this.highlightGraphicUpdated=null,this.updateHighlightedFeatures=(0,f.debounce)((async e=>{this.destroyed||this.updatingHandles.addPromise(this._updateHighlightedFeaturesGeometries(e).catch((()=>{})))}))}};(0,o._)([(0,m.property)({constructOnly:!0})],T.prototype,"createFetchPopupFeaturesQueryGeometry",void 0),(0,o._)([(0,m.property)({constructOnly:!0})],T.prototype,"layerView",void 0),(0,o._)([(0,m.property)({constructOnly:!0})],T.prototype,"highlightGraphics",void 0),(0,o._)([(0,m.property)({constructOnly:!0})],T.prototype,"highlightGraphicUpdated",void 0),(0,o._)([(0,m.property)({constructOnly:!0})],T.prototype,"updatingHandles",void 0),T=(0,o._)([(0,g.subclass)("esri.views.layers.support.MapService")],T)})),t.register("eyDHN",(function(t,r){function i(e,t){return t?"xoffset"in t&&t.xoffset?Math.max(e,Math.abs(t.xoffset)):"yoffset"in t&&t.yoffset?Math.max(e,Math.abs(t.yoffset||0)):e:e}function o(e,t){return"number"==typeof e?e:e&&e.stops&&e.stops.length?function(e){let t=0,r=0;for(let i=0;i<e.length;i++){const o=e[i].size;"number"==typeof o&&(t+=o,r++)}return t/r}(e.stops):t}function n(e){const t=e&&e.renderer,r="touch"===(e&&e.event&&e.event.pointerType)?9:6;if(!t)return r;const n="visualVariables"in t?function(e,t){if(!t)return e;const r=t.filter((e=>"size"===e.type)).map((t=>{const{maxSize:r,minSize:i}=t;return(o(r,e)+o(i,e))/2}));let i=0;const n=r.length;if(0===n)return e;for(let e=0;e<n;e++)i+=r[e];const s=Math.floor(i/n);return Math.max(s,e)}(r,t.visualVariables):r;if("simple"===t.type)return i(n,t.symbol);if("unique-value"===t.type){let e=n;return t.uniqueValueInfos?.forEach((t=>{e=i(e,t.symbol)})),e}if("class-breaks"===t.type){let e=n;return t.classBreakInfos.forEach((t=>{e=i(e,t.symbol)})),e}return"dot-density"===t.type||t.type,n}e(t.exports,"calculateTolerance",(function(){return n}))})),t.register("8gH7w",(function(r,i){e(r.exports,"identify",(function(){return p}));var o=t("bYA0c"),n=t("hq5aB"),s=t("dgLSf"),a=t("7kDMq"),l=t("3w7YE"),u=t("issNi");async function p(e,t,r){const i=(p=t,t=l.default.from(p)).geometry?[t.geometry]:[],u=(0,s.parseUrl)(e);var p;return u.path+="/identify",(0,n.normalizeCentralMeridian)(i).then((e=>{const i=(0,a.identifyToIdentifyRESTParameters)(t,{geometry:e&&e[0]}),n=(0,s.encode)({...u.query,f:"json",...i}),l=(0,s.asValidOptions)(n,r);return(0,o.default)(u.path,l).then(y).then((e=>function(e,t){if(!t?.length)return e;const r=new Map;function i(e){r.set(e.id,e),e.sublayers&&e.sublayers.forEach(i)}t.forEach(i);for(const t of e.results)t.feature.sourceLayer=r.get(t.layerId);return e}(e,t.sublayers)))}))}function y(e){const t=e.data;return t.results=t.results||[],t.exceededTransferLimit=Boolean(t.exceededTransferLimit),t.results=t.results.map((e=>u.default.fromJSON(e))),t}})),t.register("7kDMq",(function(r,i){e(r.exports,"identifyToIdentifyRESTParameters",(function(){return p}));var o=t("kwvM0"),n=t("86d4E"),s=t("bxT91"),a=t("dx4Ow"),l=t("8rwj2");const u=e=>e.spatialReference.wkid||JSON.stringify(e.spatialReference);function p(e,t){const{dpi:r,gdbVersion:i,geometry:p,geometryPrecision:y,height:c,layerOption:f,mapExtent:d,maxAllowableOffset:h,returnFieldName:m,returnGeometry:g,returnUnformattedValues:b,returnZ:w,spatialReference:v,timeExtent:x,tolerance:S,width:_}=e.toJSON(),{dynamicLayers:F,layerDefs:R,layerIds:N}=function(e){const{mapExtent:t,floors:r,width:i,sublayers:n,layerIds:u,layerOption:p,gdbVersion:y}=e,c=n?.find((e=>null!=e.layer))?.layer?.serviceSublayers,f="popup"===p,d={},h=(0,s.getScale)({extent:t,width:i,spatialReference:t?.spatialReference}),m=[],g=e=>{const t=0===h,r=0===e.minScale||h<=e.minScale,i=0===e.maxScale||h>=e.maxScale;if(e.visible&&(t||r&&i))if(e.sublayers)e.sublayers.forEach(g);else{if(!1===u?.includes(e.id)||f&&(!e.popupTemplate||!e.popupEnabled))return;m.unshift(e)}};if(n?.forEach(g),n&&!m.length)d.layerIds=[];else{const e=(0,l.isExportDynamic)(m,c,y),t=m.map((e=>{const t=(0,a.getLayerFloorFilterClause)(r,e);return e.toExportImageJSON(t)}));if(e)d.dynamicLayers=JSON.stringify(t);else{if(n){let e=m.map((({id:e})=>e));u&&(e=e.filter((e=>u.includes(e)))),d.layerIds=e}else u?.length&&(d.layerIds=u);const e=function(e,t){const r=!!e?.length,i=t.filter((e=>null!=e.definitionExpression||r&&null!=e.floorInfo));return i.length?i.map((t=>{const r=(0,a.getLayerFloorFilterClause)(e,t),i=(0,o.sqlAnd)(r,t.definitionExpression);return{id:t.id,definitionExpression:i??void 0}})):null}(r,m);if(null!=e&&e.length){const t={};for(const r of e)r.definitionExpression&&(t[r.id]=r.definitionExpression);Object.keys(t).length&&(d.layerDefs=JSON.stringify(t))}}}return d}(e),O=t&&null!=t.geometry?t.geometry:null,P={geometryPrecision:y,maxAllowableOffset:h,returnFieldName:m,returnGeometry:g,returnUnformattedValues:b,returnZ:w,tolerance:S},E=O&&O.toJSON()||p;if(P.imageDisplay=`${_},${c},${r}`,i&&(P.gdbVersion=i),E&&(delete E.spatialReference,P.geometry=JSON.stringify(E),P.geometryType=(0,n.getJsonType)(E)),v?P.sr=v.wkid||JSON.stringify(v):E&&E.spatialReference?P.sr=u(E):d&&d.spatialReference&&(P.sr=u(d)),P.time=x?[x.start,x.end].join(","):null,d){const{xmin:e,ymin:t,xmax:r,ymax:i}=d;P.mapExtent=`${e},${t},${r},${i}`}return R&&(P.layerDefs=R),F&&!R&&(P.dynamicLayers=F),P.layers="popup"===f?"visible":f,N&&!F&&(P.layers+=`:${N.join(",")}`),P}})),t.register("3w7YE",(function(r,i){e(r.exports,"default",(function(){return m}));var o=t("j6uz9"),n=t("ixrNB"),s=t("kURdk"),a=t("hO0an"),l=t("hTI69"),u=t("gHCNy");t("aX9sh"),t("5HTPH");var p,y=t("qA6zg"),c=t("86d4E"),f=t("2WnyR"),d=t("jaaCV");let h=p=class extends a.JSONSupport{static from(e){return(0,u.ensureClass)(p,e)}constructor(e){super(e),this.dpi=96,this.floors=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=null,this.height=400,this.layerIds=null,this.layerOption="top",this.mapExtent=null,this.maxAllowableOffset=null,this.returnFieldName=!0,this.returnGeometry=!1,this.returnM=!1,this.returnUnformattedValues=!0,this.returnZ=!1,this.spatialReference=null,this.sublayers=null,this.timeExtent=null,this.tolerance=null,this.width=400}};(0,o._)([(0,l.property)({type:Number,json:{write:!0}})],h.prototype,"dpi",void 0),(0,o._)([(0,l.property)()],h.prototype,"floors",void 0),(0,o._)([(0,l.property)({type:String,json:{write:!0}})],h.prototype,"gdbVersion",void 0),(0,o._)([(0,l.property)({types:n.geometryTypes,json:{read:c.fromJSON,write:!0}})],h.prototype,"geometry",void 0),(0,o._)([(0,l.property)({type:Number,json:{write:!0}})],h.prototype,"geometryPrecision",void 0),(0,o._)([(0,l.property)({type:Number,json:{write:!0}})],h.prototype,"height",void 0),(0,o._)([(0,l.property)({type:[Number],json:{write:!0}})],h.prototype,"layerIds",void 0),(0,o._)([(0,l.property)({type:["top","visible","all","popup"],json:{write:!0}})],h.prototype,"layerOption",void 0),(0,o._)([(0,l.property)({type:f.default,json:{write:!0}})],h.prototype,"mapExtent",void 0),(0,o._)([(0,l.property)({type:Number,json:{write:!0}})],h.prototype,"maxAllowableOffset",void 0),(0,o._)([(0,l.property)({type:Boolean,json:{write:!0}})],h.prototype,"returnFieldName",void 0),(0,o._)([(0,l.property)({type:Boolean,json:{write:!0}})],h.prototype,"returnGeometry",void 0),(0,o._)([(0,l.property)({type:Boolean,json:{write:!0}})],h.prototype,"returnM",void 0),(0,o._)([(0,l.property)({type:Boolean,json:{write:!0}})],h.prototype,"returnUnformattedValues",void 0),(0,o._)([(0,l.property)({type:Boolean,json:{write:!0}})],h.prototype,"returnZ",void 0),(0,o._)([(0,l.property)({type:d.default,json:{write:!0}})],h.prototype,"spatialReference",void 0),(0,o._)([(0,l.property)()],h.prototype,"sublayers",void 0),(0,o._)([(0,l.property)({type:s.default,json:{write:!0}})],h.prototype,"timeExtent",void 0),(0,o._)([(0,l.property)({type:Number,json:{write:!0}})],h.prototype,"tolerance",void 0),(0,o._)([(0,l.property)({type:Number,json:{write:!0}})],h.prototype,"width",void 0),h=p=(0,o._)([(0,y.subclass)("esri.rest.support.IdentifyParameters")],h);const m=h})),t.register("issNi",(function(r,i){e(r.exports,"default",(function(){return f}));var o=t("j6uz9");t("ixrNB");var n=t("EvxpF"),s=t("hO0an"),a=t("hTI69");t("gHCNy"),t("aX9sh"),t("5HTPH");var l=t("bzBbJ"),u=t("qA6zg"),p=t("g9601"),y=t("jaTH0");let c=class extends s.JSONSupport{readFeature(e,t){return n.default.fromJSON({attributes:{...t.attributes},geometry:{...t.geometry}})}writeFeature(e,t){if(!e)return;const{attributes:r,geometry:i}=e;r&&(t.attributes={...r}),null!=i&&(t.geometry=i.toJSON(),t.geometryType=y.typeKebabDictionary.toJSON(i.type))}constructor(e){super(e),this.displayFieldName=null,this.feature=null,this.layerId=null,this.layerName=null}};(0,o._)([(0,a.property)({type:String,json:{write:!0}})],c.prototype,"displayFieldName",void 0),(0,o._)([(0,a.property)({type:n.default})],c.prototype,"feature",void 0),(0,o._)([(0,l.reader)("feature",["attributes","geometry"])],c.prototype,"readFeature",null),(0,o._)([(0,p.writer)("feature")],c.prototype,"writeFeature",null),(0,o._)([(0,a.property)({type:Number,json:{write:!0}})],c.prototype,"layerId",void 0),(0,o._)([(0,a.property)({type:String,json:{write:!0}})],c.prototype,"layerName",void 0),c=(0,o._)([(0,u.subclass)("esri.rest.support.IdentifyResult")],c);const f=c})),t.register("dPhKw",(function(r,i){e(r.exports,"createQueryGeometry",(function(){return s})),t("ixrNB");var o=t("zPXCh"),n=(t("eyDHN"),t("2WnyR"));function s(e,t,r,i=new(0,n.default)){let s=0;if("2d"===r.type)s=t*(r.resolution??0);else if("3d"===r.type){const i=r.overlayPixelSizeInMapUnits(e),n=r.basemapSpatialReference;s=null==n||n.equals(r.spatialReference)?t*i:(0,o.getMetersPerUnitForSR)(n)/(0,o.getMetersPerUnitForSR)(r.spatialReference)}const a=e.x-s,l=e.y-s,u=e.x+s,p=e.y+s,{spatialReference:y}=r;return i.xmin=Math.min(a,u),i.ymin=Math.min(l,p),i.xmax=Math.max(a,u),i.ymax=Math.max(l,p),i.spatialReference=y,i}new(0,n.default)}));
//# sourceMappingURL=TileLayerView2D.0062e720.js.map
