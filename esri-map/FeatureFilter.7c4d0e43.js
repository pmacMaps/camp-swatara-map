!function(){function e(e){return e&&e.__esModule?e.default:e}function t(e,t,r,i){Object.defineProperty(e,t,{get:r,set:i,enumerable:!0,configurable:!0})}var r=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire594f;r.register("l7Xry",(function(i,n){var s;s=i.exports,Object.defineProperty(s,"__esModule",{value:!0,configurable:!0}),t(i.exports,"default",(function(){return w}));var a=r("8TSCy"),u=r("2TvXO"),o=r("kyj08"),l=r("jHOLN"),f=r("7qybv"),c=r("8TwEW"),h=r("5Hy9K"),d=r("iNIOS"),y=r("17eId"),v=r("emniL"),_=r("cRlei"),p=r("dEIm1"),m=r("3FUW6"),b=l.default.getLogger("esri.views.2d.layers.features.controllers.FeatureFilter"),w=function(){"use strict";function t(e){a.classCallCheck(this,t),this._geometryBounds=(0,c.create)(),this._idToVisibility=new Map,this._serviceInfo=e}return a.createClass(t,[{key:"hash",get:function(){return this._hash}},{key:"check",value:function(e){return this._applyFilter(e)}},{key:"clear",value:function(){var e=this._resetAllHiddenIds();return this.update(),{show:e,hide:[]}}},{key:"invalidate",value:function(){var e=this;this._idToVisibility.forEach((function(t,r){e._idToVisibility.set(r,0)}))}},{key:"setKnownIds",value:function(e){var t=!0,r=!1,i=void 0;try{for(var n,s=e[Symbol.iterator]();!(t=(n=s.next()).done);t=!0){var a=n.value;this._idToVisibility.set(a,1)}}catch(e){r=!0,i=e}finally{try{t||null==s.return||s.return()}finally{if(r)throw i}}}},{key:"setTrue",value:function(e){var t=this,r=[],i=[],n=new Set(e);return this._idToVisibility.forEach((function(e,s){var a=!!(1&t._idToVisibility.get(s)),u=n.has(s);!a&&u?r.push(s):a&&!u&&i.push(s),t._idToVisibility.set(s,u?3:0)})),{show:r,hide:i}}},{key:"createQuery",value:function(){var e=this,t=e.geometry,r=e.spatialRel,i=e.where,n=e.timeExtent,s=e.objectIds;return _.default.fromJSON({geometry:t,spatialRel:r,where:i,timeExtent:n,objectIds:s})}},{key:"update",value:function(t,r){var i=this;return a.asyncToGenerator(e(u).mark((function n(){var s;return e(u).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i._hash=JSON.stringify(t),e.next=3,(0,v.normalizeQueryLike)(t,null,r);case 3:return s=e.sent,e.next=6,Promise.all([i._setGeometryFilter(s),i._setIdFilter(s),i._setAttributeFilter(s),i._setTimeFilter(s)]);case 6:case"end":return e.stop()}}),n)})))()}},{key:"_setAttributeFilter",value:function(t){var r=this;return a.asyncToGenerator(e(u).mark((function i(){return e(u).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&t.where){e.next=2;break}return e.abrupt("return",(r._clause=null,void(r.where=null)));case 2:return e.next=4,(0,m.createWhereClause)(t.where,r._serviceInfo.fieldsIndex);case 4:r._clause=e.sent,r.where=t.where;case 6:case"end":return e.stop()}}),i)})))()}},{key:"_setIdFilter",value:function(e){this._idsToShow=e&&e.objectIds&&new Set(e.objectIds),this._idsToHide=e&&e.hiddenIds&&new Set(e.hiddenIds),this.objectIds=e&&e.objectIds}},{key:"_setGeometryFilter",value:function(t){var r=this;return a.asyncToGenerator(e(u).mark((function i(){var n,s,a;return e(u).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&t.geometry){e.next=2;break}return e.abrupt("return",(r._spatialQueryOperator=null,r.geometry=null,void(r.spatialRel=null)));case 2:return n=t.geometry,s=t.spatialRel||"esriSpatialRelIntersects",e.next=6,(0,d.getSpatialQueryOperator)(s,n,r._serviceInfo.geometryType,r._serviceInfo.hasZ,r._serviceInfo.hasM);case 6:a=e.sent,(0,h.getBoundsXY)(r._geometryBounds,n),r._spatialQueryOperator=a,r.geometry=n,r.spatialRel=s;case 8:case"end":return e.stop()}}),i)})))()}},{key:"_setTimeFilter",value:function(e){if(this.timeExtent=this._timeOperator=null,e&&e.timeExtent)if(this._serviceInfo.timeInfo)this.timeExtent=e.timeExtent,this._timeOperator=(0,y.getTimeOperator)(this._serviceInfo.timeInfo,e.timeExtent,p.featureAdapter);else{var t=new(0,o.default)("feature-layer-view:time-filter-not-available","Unable to apply time filter, as layer doesn't have time metadata.",e.timeExtent);b.error(t)}}},{key:"_applyFilter",value:function(e){return this._filterByGeometry(e)&&this._filterById(e)&&this._filterByTime(e)&&this._filterByExpression(e)}},{key:"_filterByExpression",value:function(e){return!this.where||this._clause(e)}},{key:"_filterById",value:function(e){return(!this._idsToHide||!this._idsToHide.size||!this._idsToHide.has(e.getObjectId()))&&(!this._idsToShow||!this._idsToShow.size||this._idsToShow.has(e.getObjectId()))}},{key:"_filterByGeometry",value:function(e){if(!this.geometry)return!0;var t=e.readHydratedGeometry();return!!t&&this._spatialQueryOperator(t)}},{key:"_filterByTime",value:function(e){return!(0,f.isSome)(this._timeOperator)||this._timeOperator(e)}},{key:"_resetAllHiddenIds",value:function(){var e=this,t=[];return this._idToVisibility.forEach((function(r,i){1&r||(e._idToVisibility.set(i,1),t.push(i))})),t}}]),t}()})),r.register("3FUW6",(function(i,n){t(i.exports,"createWhereClause",(function(){return f}));var s=r("8TSCy"),a=r("2TvXO"),u=r("kyj08"),o=r("jHOLN").default.getLogger("esri.views.2d.layers.features.support.whereUtils"),l={getAttribute:function(e,t){return e.field(t)}};function f(e,t){return c.apply(this,arguments)}function c(){return(c=s.asyncToGenerator(e(a).mark((function t(i,n){var s,f,c;return e(a).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r("k0jPp");case 2:return s=e.sent,e.prev=3,(f=s.WhereClause.create(i,n)).isStandardized||(c=new(0,u.default)("mapview - bad input","Unable to apply filter's definition expression, as expression is not standardized.",f),o.error(c)),e.abrupt("return",(function(e){var t=e.readArcadeFeature();return f.testFeature(t,l)}));case 9:return e.prev=9,e.t0=e.catch(3),e.abrupt("return",(o.warn("mapview-bad-where-clause","Encountered an error when evaluating where clause",i),function(e){return!0}));case 12:case"end":return e.stop()}}),t,null,[[3,9]])})))).apply(this,arguments)}})),r.register("k0jPp",(function(e,t){e.exports=Promise.all([r("4WKyX")(r("aNJCr").getBundleURL("1NzFX")+r("iE7OH").resolve("j5U2t")),r("4WKyX")(r("aNJCr").getBundleURL("1NzFX")+r("iE7OH").resolve("cgD2M"))]).then((function(){return r("9AqbE")}))})),r.register("gDoEW",(function(e,i){t(e.exports,"default",(function(){return a}));var n=r("8TSCy"),s=r("7qybv"),a=function(){"use strict";function e(t){n.classCallCheck(this,e),this.size=0,this._start=0,this.maxSize=t,this._buffer=new Array(t)}return n.createClass(e,[{key:"entries",get:function(){return this._buffer}},{key:"enqueue",value:function(e){if(this.size===this.maxSize){var t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return this._buffer[(this._start+this.size++)%this.maxSize]=e,null}},{key:"dequeue",value:function(){if(0===this.size)return null;var e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}},{key:"peek",value:function(){return 0===this.size?null:this._buffer[this._start]}},{key:"find",value:function(e){if(0===this.size)return null;var t=!0,r=!1,i=void 0;try{for(var n,a=this._buffer[Symbol.iterator]();!(t=(n=a.next()).done);t=!0){var u=n.value;if((0,s.isSome)(u)&&e(u))return u}}catch(e){r=!0,i=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw i}}return null}},{key:"clear",value:function(e){for(var t=this.dequeue();(0,s.isSome)(t);)e&&e(t),t=this.dequeue()}}]),e}()}))}();
//# sourceMappingURL=FeatureFilter.7c4d0e43.js.map
