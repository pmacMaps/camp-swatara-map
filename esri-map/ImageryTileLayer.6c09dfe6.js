!function(){function e(e,t,i,n){Object.defineProperty(e,t,{get:i,set:n,enumerable:!0,configurable:!0})}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire594f;t.register("891yq",(function(i,n){var r;r=i.exports,Object.defineProperty(r,"__esModule",{value:!0,configurable:!0}),e(i.exports,"default",(function(){return E}));var a=t("7eJjO"),s=t("3MVX3"),l=t("kyj08"),o=t("jHOLN"),u=t("8NioF"),c=t("10vEZ"),d=t("lKPaD"),f=t("iho5X"),h=t("iJAIC");t("lNwWH"),t("2VlWd");var p=t("bSafx"),m=t("fcwIv"),y=t("4LDxK"),g=t("aLy89"),x=t("gIXJ2"),v=t("cv2jJ"),b=t("8lxwi"),w=t("5N5S1"),I=t("9bAYR"),S=t("13Qxf"),R=t("3GzOb"),_=t("2t08e"),T=t("gRgX5"),M=t("buMuJ"),k=t("5Lo1P"),C=t("EvgSL"),F=t("c2gK9"),N=t("4ZD9O"),D=t("3KY4t"),P=t("37qRo");let O=class extends((0,x.BlendLayer)((0,R.ScaleRangeLayer)((0,w.OperationalLayer)((0,I.PortalLayer)((0,v.CustomParametersMixin)((0,b.ImageryTileMixin)((0,_.TemporalLayer)((0,g.ArcGISService)((0,S.RefreshableLayer)((0,u.MultiOriginJSONMixin)(y.default))))))))))){normalizeCtorArgs(e,t){return"string"==typeof e?{url:e,...t}:e}load(e){const t=null!=e?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Image Service"]},e).catch(c.throwIfAbortError).then((()=>this._openRaster(t)))),Promise.resolve(this)}get defaultPopupTemplate(){return this.createPopupTemplate()}get rasterFields(){const e=[new(0,M.default)({name:"Raster.ServicePixelValue",alias:"Pixel Value",domain:null,editable:!1,length:50,type:"string"}),new(0,M.default)({name:"Raster.ServicePixelValue.Raw",alias:"Raw Pixel Value",domain:null,editable:!1,length:50,type:"string"})],{rasterInfo:t}=this,i=null==t?void 0:t.attributeTable,n=null!=i?i.fields:null;if(n){const t=n.filter((e=>"oid"!==e.type&&"value"!==e.name.toLowerCase())).map((e=>{const t=e.clone();return t.name="Raster."+e.name,t}));e.push(...t)}const r=null==t?void 0:t.dataType,a=null==t?void 0:t.multidimensionalInfo;if(("vector-magdir"===r||"vector-uv"===r)&&null!=a){var s;const t=null===(s=a.variables[0].unit)||void 0===s?void 0:s.trim(),i="Magnitude"+(t?` (${t})`:"");e.push(new(0,M.default)({name:"Raster.Magnitude",alias:i,domain:null,editable:!1,type:"double"})),e.push(new(0,M.default)({name:"Raster.Direction",alias:"Direction (Â°)",domain:null,editable:!1,type:"double"}))}return e}createPopupTemplate(e){const{rasterFields:t}=this,i=new Set(t.map((({name:e})=>e)).filter((e=>"raster.servicepixelvalue.raw"!==e.toLowerCase())));return(0,P.createPopupTemplate)({fields:t,title:this.title},{...e,visibleFieldNames:i})}async generateRasterInfo(e,t){if(!(e=(0,h.ensureClass)(C.default,e)))return this.rasterInfo;try{var i;const r={raster:this._primaryRasters[0]};var n;this._primaryRasters.length>1&&this._primaryRasters.forEach((e=>r[e.url]=e));const a=(0,D.create)(null!==(n=null===(i=e.functionDefinition)||void 0===i?void 0:i.toJSON())&&void 0!==n?n:e.toJSON(),r),s=new(0,F.default)({rasterFunction:a});return await s.open(t),s.rasterInfo}catch(e){if(e instanceof l.default)throw e;throw new(0,l.default)("imagery-tile-layer","the given raster function is not supported")}}write(e,t){var i;const n=null!==(i=this._primaryRasters[0])&&void 0!==i?i:this.raster;if(this.loaded?"RasterTileServer"===n.datasetFormat&&("Raster"===n.tileType||"Map"===n.tileType):this.url&&/\/ImageServer(\/|\/?$)/i.test(this.url))return super.write(e,t);if(t&&t.messages){const e=`${t.origin}/${t.layerContainerType||"operational-layers"}`;t.messages.push(new(0,l.default)("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${e}'`,{layer:this}))}return null}async _openRaster(e){let t=!1;if(this.raster)this.raster.rasterInfo||await this.raster.open(),"Function"===this.raster.datasetFormat?(t=!0,this._primaryRasters=this.raster.primaryRasters.rasters):this._primaryRasters=[this.raster],this.url=this.raster.url;else{const{rasterFunction:t}=this,r=[this.url];t&&(0,D.getPrimaryRasterUrls)(t.toJSON(),r);const a=await Promise.all(r.map((t=>N.default.open({url:t,sourceJSON:this.sourceJSON,ioConfig:{sampling:"closest",...this.ioConfig,customFetchParameters:this.customParameters},signal:e})))),s=a.findIndex((e=>null==e));if(s>-1)throw new(0,l.default)("imagery-tile-layer:open",`cannot open raster: ${r[s]}`);if(this._primaryRasters=a,t){var i;const e={raster:this._primaryRasters[0]};var n;this._primaryRasters.length>1&&this._primaryRasters.forEach((t=>e[t.url]=t));const r=(0,D.create)(null!==(n=null===(i=t.functionDefinition)||void 0===i?void 0:i.toJSON())&&void 0!==n?n:t.toJSON(),e),s=new(0,F.default)({rasterFunction:r});try{await s.open(),this.raster=s}catch(e){const t=o.default.getLogger(this);e instanceof l.default&&t.error("imagery-tile-layer:open",e.message),t.warn("imagery-tile-layer:open","the raster function cannot be applied and is removed"),this._set("rasterFunction",null),this.raster=a[0]}}else this.raster=a[0]}const r=this.raster.rasterInfo;if(!r)throw new(0,l.default)("imagery-tile-layer:load","cannot load resources on "+this.url);if(this._set("rasterInfo",t?r:this._primaryRasters[0].rasterInfo),this._set("spatialReference",r.spatialReference),this.sourceJSON=this.sourceJSON||this.raster.sourceJSON,null!=this.sourceJSON){const e="Map"===this.raster.tileType&&null!=this.sourceJSON.minLOD&&null!=this.sourceJSON.maxLOD?this.sourceJSON:{...this.sourceJSON,minScale:0,maxScale:0};this.read(e,{origin:"service"})}else this.read({tileInfo:this.rasterInfo.storageInfo.tileInfo.toJSON()},{origin:"service"});this.title||(this.title=this.raster.datasetName),"Map"===this.raster.tileType&&(this.popupEnabled=!1),this._configDefaultSettings(),this.addHandles((0,d.watch)((()=>this.customParameters),(e=>{this.raster&&(this.raster.ioConfig.customFetchParameters=e)})))}constructor(...e){super(...e),this._primaryRasters=[],this.bandIds=null,this.interpolation=null,this.legendEnabled=!0,this.isReference=null,this.listMode="show",this.sourceJSON=null,this.version=null,this.type="imagery-tile",this.operationalLayerType="ArcGISTiledImageServiceLayer",this.popupEnabled=!0,this.popupTemplate=null,this.fields=null}};(0,a._)([(0,f.property)()],O.prototype,"_primaryRasters",void 0),(0,a._)([(0,f.property)({type:[h.Integer],json:{write:{overridePolicy(){var e;return{enabled:!this.loaded||"Raster"===this.raster.tileType||"0,1,2"!==(null===(e=this.bandIds)||void 0===e?void 0:e.join(","))}}}}})],O.prototype,"bandIds",void 0),(0,a._)([(0,f.property)({json:{write:{overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType||"bilinear"!==this.interpolation}}}}}),(0,p.enumeration)(k.interpolationKebab)],O.prototype,"interpolation",void 0),(0,a._)([(0,f.property)(T.legendEnabled)],O.prototype,"legendEnabled",void 0),(0,a._)([(0,f.property)({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],O.prototype,"isReference",void 0),(0,a._)([(0,f.property)({type:["show","hide"]})],O.prototype,"listMode",void 0),(0,a._)([(0,f.property)({json:{read:!0,write:!0}})],O.prototype,"blendMode",void 0),(0,a._)([(0,f.property)()],O.prototype,"sourceJSON",void 0),(0,a._)([(0,f.property)({readOnly:!0,json:{origins:{service:{read:{source:"currentVersion"}}}}})],O.prototype,"version",void 0),(0,a._)([(0,f.property)({readOnly:!0,json:{read:!1}})],O.prototype,"type",void 0),(0,a._)([(0,f.property)({type:["ArcGISTiledImageServiceLayer"]})],O.prototype,"operationalLayerType",void 0),(0,a._)([(0,f.property)({type:Boolean,value:!0,json:{read:{source:"disablePopup",reader:(e,t)=>!t.disablePopup},write:{target:"disablePopup",overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}},writer(e,t,i){t[i]=!e}}}})],O.prototype,"popupEnabled",void 0),(0,a._)([(0,f.property)({type:s.default,json:{read:{source:"popupInfo"},write:{target:"popupInfo",overridePolicy(){return{enabled:!this.loaded||"Raster"===this.raster.tileType}}}}})],O.prototype,"popupTemplate",void 0),(0,a._)([(0,f.property)({readOnly:!0})],O.prototype,"defaultPopupTemplate",null),(0,a._)([(0,f.property)({readOnly:!0,type:[M.default]})],O.prototype,"fields",void 0),(0,a._)([(0,f.property)({readOnly:!0,type:[M.default]})],O.prototype,"rasterFields",null),O=(0,a._)([(0,m.subclass)("esri.layers.ImageryTileLayer")],O);const E=O})),t.register("8lxwi",(function(i,n){e(i.exports,"ImageryTileMixin",(function(){return E}));var r=t("7eJjO");t("2ILM8");var a=t("3uTA1"),s=t("9pNSx"),l=t("kyj08"),o=t("jHOLN"),u=t("iho5X"),c=t("iJAIC");t("lNwWH"),t("2VlWd");var d=t("eB8sj"),f=t("fcwIv"),h=t("eY5Yp"),p=t("lmu5w"),m=t("gRgX5"),y=t("d3QQf"),g=t("bmuNs"),x=t("EvgSL"),v=t("1399j"),b=t("xQ42o"),w=t("c2gK9"),I=t("9m6jq"),S=t("h41e2"),R=t("3KY4t"),_=t("jxAFe"),T=t("zMMQr"),M=t("2hwKJ"),k=t("hlKjZ"),C=t("frUQM"),F=t("lcqcF"),N=t("k8DEI"),D=t("j40xv"),P=t("d1Fqh");const O=o.default.getLogger("esri.layers.mixins.ImageryTileMixin"),E=e=>{let t=class extends e{get fullExtent(){var e;return null===(e=this.rasterInfo)||void 0===e?void 0:e.extent}set multidimensionalDefinition(e){this._set("multidimensionalDefinition",e),this.updateRenderer()}set rasterFunction(e){var t;"none"===(null==e||null===(t=e.functionName)||void 0===t?void 0:t.toLowerCase())&&(e=void 0),this._set("rasterFunction",e),this.updateRasterFunction()}set url(e){this._set("url",(0,p.sanitizeUrl)(e,O))}set renderer(e){null==e&&null==this.rasterFunction?this._configDefaultRenderer("override"):(this._set("renderer",e),this.updateRenderer())}readRenderer(e,t,i){var n,r;const s=null==t||null===(n=t.layerDefinition)||void 0===n||null===(r=n.drawingInfo)||void 0===r?void 0:r.renderer;return(0,a.read)(s,i)||void 0}async convertVectorFieldData(e,t){if(null==e||!this.rasterInfo)return null;const i=this._rasterJobHandler.instance,n=this.rasterInfo.dataType;return i?i.convertVectorFieldData({pixelBlock:e,dataType:n},t):(0,M.convertVectorFieldData)(e,n)}async computeStatisticsHistograms(e,t){e=(0,c.ensureClass)(F.default,e).clone();const{rasterInfo:i}=this,{geometry:n}=e;if(null==n)throw new(0,l.default)("imagery-tile-mixin:compute-statistics-histograms","geometry must be specified");let r=n;const{spatialReference:a}=i;var s;n.spatialReference.equals(a)||(await(0,_.load)(),r="extent"===n.type?(0,_.projectExtent)(n,a):(0,_.projectPolygon)(n,a));const o=null!==(s=e.pixelSize)&&void 0!==s?s:new(0,P.default)({x:i.pixelSize.x,y:i.pixelSize.y,spatialReference:a}),{extent:u,width:d,height:f}=(0,S.snapToRaster)(i,r,o),h=await this.fetchPixels(u,d,f,{...t,interpolation:"nearest"});if(null==h.pixelBlock)throw new(0,l.default)("imagery-tile-mixin:compute-statistics-histograms","failed to fetch pixels");const p=await(0,S.clip)(h.pixelBlock,u,r),m=this._rasterJobHandler.instance;return m?m.computeStatisticsHistograms({pixelBlock:p},t):(0,T.computeStatisticsHistograms)(p)}async createFlowMesh(e,t){const i=this._rasterJobHandler.instance;return i?i.createFlowMesh(e,t):(0,N.createFlowMesh)(e.meshType,e.simulationSettings,e.flowData,null!=t.signal?t.signal:(new AbortController).signal)}normalizeRasterFetchOptions(e){var t;const{multidimensionalInfo:i}=null!==(t=this.rasterInfo)&&void 0!==t?t:{};if(null==i)return e;let n=e.multidimensionalDefinition||this.multidimensionalDefinition;null!=n&&n.length||(n=(0,I.getDefaultMultidimensionalDefinition)(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset}));const r=e.timeExtent||this.timeExtent;if(null!=n&&null!=r&&(null!=r.start||null!=r.end)){var a,s;n=n.map((e=>e.clone()));const t=null===(a=i.variables.find((({name:e})=>e===n[0].variableName)))||void 0===a||null===(s=a.dimensions)||void 0===s?void 0:s.find((({name:e})=>"StdTime"===e)),l=n.find((({dimensionName:e})=>"StdTime"===e));if(!t||!l)return{...e,multidimensionalDefinition:null};const{start:o,end:u}=r,c=null==o?null:o.getTime(),d=null==u?null:u.getTime(),f=null!=c?c:d,h=null!=d?d:c;if(null!=t.values){const e=t.values.filter((e=>{if(Array.isArray(e)){if(f===h)return e[0]<=f&&e[1]>=f;const t=e[0]<=f&&e[1]>f||e[0]<h&&e[1]>=h,i=e[0]>=f&&e[1]<=h||e[0]<f&&e[1]>h;return t||i}return f===h?e===f:e>=f&&e<=h}));if(e.length){const t=e.sort(((e,t)=>{const i=Array.isArray(e)?e[0]:e,n=Array.isArray(e)?e[1]:e,r=Array.isArray(t)?t[0]:t,a=Array.isArray(t)?t[1]:t;return f===h?i-r:Math.abs(n-h)-Math.abs(a-h)}))[0];l.values=[t]}else n=null}else if(t.hasRegularIntervals&&t.extent){const[e,i]=t.extent;f>i||h<e?n=null:l.values=f===h?[f]:[Math.max(e,f),Math.min(i,h)]}}return null!=n&&(0,I.hasExcludedVariableOrDimension)(n,this.multidimensionalSubset)?{...e,multidimensionalDefinition:null}:{...e,multidimensionalDefinition:n}}async updateRasterFunction(){if(!this.loaded||"imagery-tile"!==this.type||!this.rasterFunction&&!this._cachedRasterFunctionJson||JSON.stringify(this.rasterFunction)===JSON.stringify(this._cachedRasterFunctionJson))return;if(this._isConstructedFromFunctionRaster&&"Function"===this.raster.datasetFormat){var e;const t=this.raster.rasterFunction.toJSON();return!this.rasterFunction&&t&&this._set("rasterFunction",x.default.fromJSON(t)),void(this._cachedRasterFunctionJson=null===(e=this.rasterFunction)||void 0===e?void 0:e.toJSON())}let t,i=this.raster,n=!1;"Function"===i.datasetFormat?(t=i.primaryRasters.rasters,i=t[0],n=!0):t=[i];const{rasterFunction:r}=this;if(r){var a,s;const e={raster:i};var l;t.length>1&&t.forEach((t=>e[t.url]=t));const n=(0,R.create)(null!==(l=null===(a=r.functionDefinition)||void 0===a?void 0:a.toJSON())&&void 0!==l?l:r.toJSON(),e),o=new(0,w.default)({rasterFunction:n});o.rasterJobHandler=this._rasterJobHandler.instance,await o.open(),this._cachedRasterFunctionJson=null===(s=this.rasterFunction)||void 0===s?void 0:s.toJSON(),this.raster=o}else this.raster=i,this._cachedRasterFunctionJson=null,await i.when();if(this._cachedRendererJson=null,!n&&!r)return;const{bandIds:o}=this,{bandCount:u}=this.raster.rasterInfo,c=(null==o?void 0:o.length)?o.some((e=>e>=u)):u>=3;o&&(c||this.renderer&&"raster-stretch"!==this.renderer.type)&&this._set("bandIds",null),this._configDefaultRenderer("auto")}async updateRenderer(){const{loaded:e,symbolizer:t}=this;if(!e||!t||!this.renderer)return;const{rasterInfo:i}=this.raster,n=(0,I.getDefaultVariablInfo)(i,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}),r=null==n?void 0:n.name,a=(0,k.normalizeRendererJSON)({...this.renderer.toJSON(),variableName:r});if(JSON.stringify(this._cachedRendererJson)===JSON.stringify(a))return;const s=this._rasterJobHandler.instance;s&&(t.rasterInfo=(0,k.getVariableRasterInfo)(i,r),t.rendererJSON=a,t.bind(),await s.updateSymbolizer(t),this._cachedRendererJson=a)}async applyRenderer(e,t){const i=e&&e.pixelBlock;if(!(null!=i&&i.pixels&&i.pixels.length>0))return null;let n;var r;await this.updateRenderer();const a=this._rasterJobHandler.instance,s=null!==(r=this.bandIds)&&void 0!==r?r:[];return n=a?await a.symbolize({...e,simpleStretchParams:t,bandIds:s}):this.symbolizer.symbolize({...e,simpleStretchParams:t,bandIds:s}),n}getTileUrl(e,t,i){return"RasterTileServer"===this.raster.datasetFormat?`${this.url}/tile/${e}/${t}/${i}`:""}getCompatibleTileInfo(e,t,i=!1){if(!this.loaded||null==t)return null;if(i&&e.equals(this.spatialReference))return this.tileInfo;const n=(0,h.getInfo)(e);return b.default.create({size:256,spatialReference:e,origin:n?{x:n.origin[0],y:n.origin[1]}:{x:t.xmin,y:t.ymax}})}getCompatibleFullExtent(e){return this.loaded?(this._compatibleFullExtent&&this._compatibleFullExtent.spatialReference.equals(e)||(this._compatibleFullExtent=this.raster.computeExtent(e)),this._compatibleFullExtent):null}async fetchTile(e,t,n,r={}){var a;if(i(this),r.requestAsImageElement){const i=this.getTileUrl(e,t,n);return(0,s.default)(i,{responseType:"image",query:{...this.refreshParameters,...this.raster.ioConfig.customFetchParameters},signal:r.signal}).then((e=>e.data))}const{rasterInfo:l}=this;if(null!=l.multidimensionalInfo&&null==(r=this.normalizeRasterFetchOptions(r)).multidimensionalDefinition){const i=r.tileInfo||l.storageInfo.tileInfo;return{extent:this.raster.getTileExtentFromTileInfo(e,t,n,i),pixelBlock:null}}return await this._initJobHandler(),await this.updateRasterFunction(),"raster-shaded-relief"===(null===(a=this.renderer)||void 0===a?void 0:a.type)&&(r={...r,buffer:{cols:1,rows:1}}),this.raster.fetchTile(e,t,n,r)}async fetchPixels(e,t,i,n={}){return null!=this.rasterInfo.multidimensionalInfo&&null==(n=this.normalizeRasterFetchOptions(n)).multidimensionalDefinition?{extent:e,pixelBlock:null}:(await this._initJobHandler(),await this.updateRasterFunction(),t=Math.round(t),i=Math.round(i),this.raster.fetchPixels(e,t,i,n))}async identify(e,t={}){var i;const{raster:n,rasterInfo:r}=this;if(null!=r.multidimensionalInfo&&!(r.hasMultidimensionalTranspose&&((0,I.isMultiSliceOrRangeDefinition)(t.multidimensionalDefinition)||t.transposedVariableName||t.timeExtent)||null!=(t=this.normalizeRasterFetchOptions(t)).multidimensionalDefinition))return{location:e,value:null};const a=null===(i=this.multidimensionalSubset)||void 0===i?void 0:i.areaOfInterest;if(a&&!a.contains(e))throw new(0,l.default)("imagery-tile-mixin:identify","the request cannot be fulfilled when falling outside of the multidimensional subset");return n.identify(e,t)}increaseRasterJobHandlerUsage(){this._rasterJobHandler.refCount++}decreaseRasterJobHandlerUsage(){this._rasterJobHandler.refCount--,this._rasterJobHandler.refCount<=0&&this._shutdownJobHandler()}hasStandardTime(){var e,t,i;const n=null===(e=this.rasterInfo)||void 0===e?void 0:e.multidimensionalInfo;if(null==n||"standard-time"!==(null===(t=this.rasterInfo)||void 0===t?void 0:t.dataType))return!1;const r=this.multidimensionalDefinition,a=null==r||null===(i=r[0])||void 0===i?void 0:i.variableName;return n.variables.some((e=>e.name===a&&(!(null==r?void 0:r[0].dimensionName)||e.dimensions.some((e=>"StdTime"===e.name)))))}getStandardTimeValue(e){return new Date(24*(e-25569)*36e5).toString()}getMultidimensionalSubsetVariables(e){var t;const i=null!=e?e:null===(t=this.rasterInfo)||void 0===t?void 0:t.multidimensionalInfo;return(0,I.getSubsetVariablesFromMdInfo)(this.multidimensionalSubset,i)}_configDefaultSettings(){this._configDefaultInterpolation(),this.multidimensionalDefinition||(this.multidimensionalDefinition=(0,I.getDefaultMultidimensionalDefinition)(this.raster.rasterInfo,{multidimensionalSubset:this.multidimensionalSubset})),this.rasterFunction&&"Function"===this.raster.datasetFormat&&(this._cachedRasterFunctionJson=this.rasterFunction.toJSON()),this._configDefaultRenderer()}_initJobHandler(){if(null!=this._rasterJobHandler.connectionPromise)return this._rasterJobHandler.connectionPromise;const e=new(0,v.default);return this._rasterJobHandler.connectionPromise=e.initialize().then((async()=>{i(this),this._rasterJobHandler.instance=e,this.raster.rasterJobHandler=e,"Function"===this.raster.datasetFormat&&this.raster.syncJobHandler(),this.rasterFunction&&await this.updateRasterFunction().catch((()=>{})),this.renderer&&this.updateRenderer()})).catch((()=>{})),this._rasterJobHandler.connectionPromise}_shutdownJobHandler(){this._rasterJobHandler.instance&&this._rasterJobHandler.instance.destroy(),this._rasterJobHandler.instance=null,this._rasterJobHandler.connectionPromise=null,this._rasterJobHandler.refCount=0,this._cachedRendererJson=null,this.raster&&(this.raster.rasterJobHandler=null)}_configDefaultInterpolation(){if(null==this.interpolation){var e;i(this);const{raster:t}=this,n=(0,k.getDefaultInterpolation)(t.rasterInfo,t.tileType,null===(e=this.sourceJSON)||void 0===e?void 0:e.defaultResamplingMethod);this._set("interpolation",n)}}_configDefaultRenderer(e="no"){i(this);const{rasterInfo:t}=this.raster;!this.bandIds&&t.bandCount>1&&(this.bandIds=(0,k.getDefaultBandCombination)(t));const n=(0,I.getDefaultVariablInfo)(t,{multidimensionalDefinition:this.multidimensionalDefinition,multidimensionalSubset:this.multidimensionalSubset}),r=null==n?void 0:n.name;if(!this.renderer||"override"===e){var a,s;const e=(0,k.createDefaultRenderer)(t,{bandIds:this.bandIds,variableName:r}),i=t.statistics,n=i&&i.length>0?i[0]:null,l=null!==(a=null==n?void 0:n.max)&&void 0!==a?a:0,o=null!==(s=null==n?void 0:n.min)&&void 0!==s?s:0;"WCSServer"===this.raster.datasetFormat&&"raster-stretch"===e.type&&(l>1e24||o<-1e24)&&(e.dynamicRangeAdjustment=!0,e.statistics=null,"none"===e.stretchType&&(e.stretchType="min-max")),this.renderer=e}const l=(0,k.normalizeRendererJSON)({...this.renderer.toJSON(),variableName:r}),o=(0,k.getVariableRasterInfo)(t,r);this.symbolizer?(this.symbolizer.rendererJSON=l,this.symbolizer.rasterInfo=o):this.symbolizer=new(0,C.default)({rendererJSON:l,rasterInfo:o});const u=this.symbolizer.bind();if(u.success){if("auto"===e){const{colormap:e}=this.raster.rasterInfo,t=this.renderer;if(null!=e&&"raster-colormap"===t.type){const e=(0,k.createDefaultRenderer)(this.raster.rasterInfo);JSON.stringify(e)!==JSON.stringify(t)&&this._configDefaultRenderer("override")}else if("raster-stretch"===t.type){var c,d;const e=null===(c=this.bandIds)||void 0===c?void 0:c.length,i=null===(d=t.statistics)||void 0===d?void 0:d.length;!t.dynamicRangeAdjustment&&i&&e&&i!==e&&this._configDefaultRenderer("override")}}}else O.warn("imagery-tile-mixin",u.error||"The given renderer is not supported by the layer."),"auto"===e&&this._configDefaultRenderer("override")}constructor(...e){var t,i;super(...e),this._isConstructedFromFunctionRaster=!1,this._rasterJobHandler={instance:null,refCount:0,connectionPromise:null},this.bandIds=null,this.copyright=null,this.interpolation="nearest",this.multidimensionalSubset=null,this.raster=null,this.rasterInfo=null,this.sourceJSON=null,this.spatialReference=null,this.symbolizer=null,this._isConstructedFromFunctionRaster="Function"===(null===(t=e[0])||void 0===t||null===(i=t.raster)||void 0===i?void 0:i.datasetFormat)}};function i(e){if(!e.raster||!e.rasterInfo)throw new(0,l.default)("imagery-tile","no raster")}return(0,r._)([(0,u.property)()],t.prototype,"_cachedRendererJson",void 0),(0,r._)([(0,u.property)()],t.prototype,"_cachedRasterFunctionJson",void 0),(0,r._)([(0,u.property)()],t.prototype,"_compatibleFullExtent",void 0),(0,r._)([(0,u.property)()],t.prototype,"_isConstructedFromFunctionRaster",void 0),(0,r._)([(0,u.property)()],t.prototype,"_rasterJobHandler",void 0),(0,r._)([(0,u.property)()],t.prototype,"bandIds",void 0),(0,r._)([(0,u.property)({json:{origins:{service:{read:{source:"copyrightText"}}}}})],t.prototype,"copyright",void 0),(0,r._)([(0,u.property)({json:{read:!1}})],t.prototype,"fullExtent",null),(0,r._)([(0,u.property)()],t.prototype,"interpolation",void 0),(0,r._)([(0,u.property)()],t.prototype,"ioConfig",void 0),(0,r._)([(0,u.property)({type:[y.default],json:{write:!0}})],t.prototype,"multidimensionalDefinition",null),(0,r._)([(0,u.property)({type:g.default,json:{write:!0}})],t.prototype,"multidimensionalSubset",void 0),(0,r._)([(0,u.property)()],t.prototype,"raster",void 0),(0,r._)([(0,u.property)({type:x.default,json:{name:"renderingRule",write:!0}})],t.prototype,"rasterFunction",null),(0,r._)([(0,u.property)()],t.prototype,"rasterInfo",void 0),(0,r._)([(0,u.property)()],t.prototype,"sourceJSON",void 0),(0,r._)([(0,u.property)({readOnly:!0,type:D.default,json:{read:!1}})],t.prototype,"spatialReference",void 0),(0,r._)([(0,u.property)({type:b.default})],t.prototype,"tileInfo",void 0),(0,r._)([(0,u.property)(m.url)],t.prototype,"url",null),(0,r._)([(0,u.property)({types:a.rasterRendererTypes,json:{name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy(){var e;const t="raster-stretch"===(null===(e=this.renderer)||void 0===e?void 0:e.type)&&"none"===this.renderer.stretchType&&!this.renderer.useGamma;return{enabled:!this.loaded||"Raster"===this.raster.tileType||!t}}},origins:{"web-scene":{types:a.websceneRasterRendererTypes,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:e=>({enabled:e&&"vector-field"!==e.type&&"flow"!==e.type})}}}}})],t.prototype,"renderer",null),(0,r._)([(0,d.reader)("renderer")],t.prototype,"readRenderer",null),(0,r._)([(0,u.property)()],t.prototype,"symbolizer",void 0),t=(0,r._)([(0,f.subclass)("esri.layers.ImageryTileMixin")],t),t}})),t.register("d3QQf",(function(i,n){e(i.exports,"default",(function(){return f}));var r,a=t("7eJjO"),s=t("1XAcN"),l=t("flPLJ"),o=t("iho5X"),u=t("iJAIC"),c=t("fcwIv");let d=r=class extends s.JSONSupport{clone(){return new r({variableName:this.variableName,dimensionName:this.dimensionName,values:(0,l.clone)(this.values),isSlice:this.isSlice})}constructor(e){super(e),this.variableName=null,this.dimensionName=null,this.values=[],this.isSlice=!1}};(0,a._)([(0,o.property)({type:String,json:{write:!0}})],d.prototype,"variableName",void 0),(0,a._)([(0,o.property)({type:String,json:{write:!0}})],d.prototype,"dimensionName",void 0),(0,a._)([(0,o.property)({type:u.types.array(u.types.oneOf([u.types.native(Number),u.types.array(u.types.native(Number))])),json:{write:!0}})],d.prototype,"values",void 0),(0,a._)([(0,o.property)({type:Boolean,json:{write:!0}})],d.prototype,"isSlice",void 0),d=r=(0,a._)([(0,c.subclass)("esri.layers.support.DimensionalDefinition")],d);const f=d})),t.register("c2gK9",(function(i,n){e(i.exports,"default",(function(){return f}));var r=t("7eJjO"),a=t("kyj08"),s=t("iho5X");t("iJAIC"),t("lNwWH"),t("2VlWd");var l=t("fcwIv"),o=t("5EhGd"),u=t("alctY"),c=t("f4h86");let d=class extends o.default{async open(e){var t,i,n,r;await this.init();const{rasterFunction:s}=this;(null===(t=this.primaryRasters)||void 0===t||null===(i=t.rasters)||void 0===i?void 0:i.length)?s.sourceRasters=this.primaryRasters.rasters:(this.primaryRasters=s.getPrimaryRasters(),this.rasterJobHandler&&(null===(n=this.primaryRasters.rasters)||void 0===n||n.forEach((e=>e.rasterJobHandler=this.rasterJobHandler))));const{rasters:l,rasterIds:o}=this.primaryRasters,u=l.map((t=>t.rasterInfo?void 0:t.open(e)));await Promise.all(u);const d=l.map((({rasterInfo:e})=>e)),f=s.bind({rasterInfos:d,rasterIds:o});var h;if(!f.success||0===d.length)throw new(0,a.default)("raster-function:open",`cannot bind the function: ${null!==(h=f.error)&&void 0!==h?h:""}`);const p="Table"===s.functionName?s:null===(r=s.functionArguments)||void 0===r?void 0:r.raster;"Table"===(null==p?void 0:p.functionName)&&(s.rasterInfo.attributeTable=c.default.fromJSON(p.functionArguments.attributeTableAsRecordSet)),await this.syncJobHandler();const m=d[0];this.hasUniqueSourceStorageInfo=1===d.length||d.slice(1).every((e=>this._hasSameStorageInfo(e,m))),this.set("sourceJSON",l[0].sourceJSON),this.set("rasterInfo",s.rasterInfo)}async syncJobHandler(){var e;return null===(e=this.rasterJobHandler)||void 0===e?void 0:e.updateRasterFunction(this.rasterFunction)}async fetchPixels(e,t,i,n={}){var r,a;const{rasters:s,rasterIds:l}=this.primaryRasters;let o=!1;const{interpolation:c}=n,d=null===(r=this.rasterFunction.flatWebGLFunctionChain)||void 0===r?void 0:r.hasSurfaceFunction;!n.requestRawData&&"bilinear"!==c&&d&&(o=1===s.length&&!n.skipRasterFunction,n={...n,interpolation:"bilinear",requestRawData:o});const f=s.map((r=>r.fetchPixels(e,t,i,n))),h=await Promise.all(f),p=h.map((e=>e.pixelBlock)),m=o||n.requestRawData?h.map((e=>e.srcTilePixelSize)):null;if(n.skipRasterFunction||p.every((e=>null==e)))return h[0];var y;const g=null!==(y=null===(a=h.find((e=>null!=e.pixelBlock)))||void 0===a?void 0:a.extent)&&void 0!==y?y:e,x=this.rasterJobHandler?await this.rasterJobHandler.process({extent:g,primaryPixelBlocks:p,primaryPixelSizes:m,primaryRasterIds:l}):this.rasterFunction.process({extent:g,primaryPixelBlocks:p,primaryPixelSizes:m,primaryRasterIds:l}),{transformGrid:v}=h[0];if(!o||null==x||null==v)return{...h[0],pixelBlock:x};const b={rows:v.spacing[0],cols:v.spacing[1]};let w;return w=this.rasterJobHandler?(await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:[x],srcMosaicSize:{width:x.width,height:x.height},destDimension:{width:t,height:i},coefs:v.coefficients,sampleSpacing:b,projectDirections:!1,gcsGrid:null,isUV:!1,interpolation:c,alignmentInfo:void 0,blockWidths:null},n)).pixelBlock:(0,u.approximateTransform)(x,{width:t,height:i},v.coefficients,b,c),{extent:e,srcExtent:h[0].srcExtent,pixelBlock:w}}_hasSameStorageInfo(e,t){const{storageInfo:i,pixelSize:n,spatialReference:r,extent:a}=e,{storageInfo:s,pixelSize:l,spatialReference:o,extent:u}=t;return n.x===l.x&&n.y===l.y&&r.equals(o)&&a.equals(u)&&i.blockHeight===s.blockHeight&&i.blockWidth===s.blockWidth&&i.maximumPyramidLevel===s.maximumPyramidLevel}constructor(){super(...arguments),this.datasetFormat="Function",this.tileType="Raster",this.rasterFunction=null}};(0,r._)([(0,s.property)({type:String,json:{write:!0}})],d.prototype,"datasetFormat",void 0),(0,r._)([(0,s.property)()],d.prototype,"tileType",void 0),(0,r._)([(0,s.property)()],d.prototype,"rasterFunction",void 0),(0,r._)([(0,s.property)()],d.prototype,"primaryRasters",void 0),d=(0,r._)([(0,l.subclass)("esri.layers.support.rasterDatasets.FunctionRaster")],d);const f=d})),t.register("5EhGd",(function(i,n){e(i.exports,"default",(function(){return N}));var r=t("7eJjO");t("2ILM8");var a=t("9pNSx"),s=t("kyj08"),l=t("1XAcN"),o=t("jHOLN"),u=t("7qybv"),c=t("hmHbS"),d=t("10vEZ"),f=t("iho5X"),h=t("iJAIC");t("lNwWH"),t("2VlWd");var p=t("fcwIv"),m=t("lmu5w"),y=t("gRgX5"),g=t("d3QQf"),x=t("he5Ty"),v=t("cQADC"),b=t("xQ42o"),w=t("9m6jq"),I=t("4IP7o"),S=t("43seT"),R=t("2G55A"),_=t("alctY"),T=t("jxAFe"),M=t("2hwKJ"),k=t("gINRd"),C=t("d1Fqh");let F=class extends((0,c.EsriPromiseMixin)(l.JSONSupport)){async init(){const e=(0,T.load)();this.addResolvingPromise(e),await this.when()}normalizeCtorArgs(e){return e&&e.ioConfig&&(e={...e,ioConfig:{resolution:null,bandIds:null,sampling:"closest",tileInfo:b.default.create(),...e.ioConfig}}),e}get _isGlobalWrappableSource(){const{rasterInfo:e}=this,t=(0,T.getWorldWidth)(e.spatialReference);return null!=t&&e.extent.width>=t/2}get _hasNoneOrGCSShiftTransform(){const{transform:e}=this.rasterInfo;return null==e||"gcs-shift"===e.type}set rasterJobHandler(e){var t,i;this._set("rasterJobHandler",e),"Function"===this.datasetFormat&&(null===(t=this.primaryRasters)||void 0===t||null===(i=t.rasters)||void 0===i||i.forEach((t=>t.rasterJobHandler=e)))}set url(e){this._set("url",(0,m.sanitizeUrl)(e,o.default.getLogger(this)))}async open(e){throw new(0,s.default)("BaseRaster:open-not-implemented","open() is not implemented")}async fetchTile(e,t,i,n={}){const r=n.tileInfo||this.rasterInfo.storageInfo.tileInfo,a=this.getTileExtentFromTileInfo(e,t,i,r);return this.fetchPixels(a,r.size[0],r.size[1],n)}async identify(e,t={}){var i;e=(0,h.ensureClass)(C.default,e).clone().normalize();const{multidimensionalDefinition:n,timeExtent:r}=t,{rasterInfo:a}=this,{hasMultidimensionalTranspose:s,multidimensionalInfo:l}=a;let{transposedVariableName:o}=t;const u=null!=l&&s&&(null!=r||(0,w.isMultiSliceOrRangeDefinition)(n));var c;u&&!o&&(o=null!=n&&n.length>0?null!==(c=n[0].variableName)&&void 0!==c?c:void 0:l.variables[0].name,t={...t,transposedVariableName:o}),t=this._getRequestOptionsWithSliceId(t);const{spatialReference:d,extent:f}=a,{datumTransformation:p}=t;let m=(0,T.projectPoint)(e,d,p);if(!f.intersects(m))return{location:m,value:null};if(null!=a.transform){const e=a.transform.inverseTransform(m);if(!a.nativeExtent.intersects(e))return{location:e,value:null};m=e}let y=0;const g=null!=o&&null!=l&&a.hasMultidimensionalTranspose;if("Function"===this.datasetFormat){const e=this.primaryRasters.rasters[0];if(g)return e.identify(m,t);const{pixelSize:i}=a,n=3,r=i.x*n/2,s=i.y*n/2,l=new(0,k.default)({xmin:m.x-r,xmax:m.x+r,ymin:m.y-s,ymax:m.y+s,spatialReference:d}),o={interpolation:"nearest"},{pixelBlock:u}=await e.fetchPixels(l,n,n,o),{pixelBlock:c}=await this.fetchPixels(l,n,n,o);if(null==u)return{location:m,value:null};const f=Math.floor(n*n*.5),h=!u.mask||u.mask[f]?u.pixels.map((e=>e[f])):null;let p;return null!=c&&(p=!c.mask||c.mask[f]?c.pixels.map((e=>e[f])):void 0),{location:m,value:h,processedValue:p,pyramidLevel:0}}if(!g)if(t.srcResolution)y=(0,T.snapPyramid)(t.srcResolution,a,this.ioConfig.sampling).pyramidLevel;else if(y=await this.computeBestPyramidLevelForLocation(e,t),null==y)return{location:m,value:null};const x=this.identifyPixelLocation(m,y,null,g);if(null===x)return{location:m,value:null};const{row:v,col:b,rowOffset:S,colOffset:R,blockWidth:_}=x,M=null!=o?o:t.sliceId,F=(0,I.getRasterId)(this.url,M),N=`${y}/${v}/${b}`;let D=(0,I.getBlock)(F,null,N);null==D&&(D=this.fetchRawTile(y,v,b,t),(0,I.putBlock)(F,null,N,D));const P=await D;if(null==P||!(null===(i=P.pixels)||void 0===i?void 0:i.length))return{location:m,value:null};const O=S*_+R;return this._processIdentifyResult(P,{srcLocation:m,position:O,pyramidLevel:y,useTransposedTile:!!g,requestSomeSlices:u,identifyOptions:t})}async fetchPixels(e,t,i,n={}){e=(0,T.snapExtent)(e),n=this._getRequestOptionsWithSliceId(n);const{_hasNoneOrGCSShiftTransform:r}=this;if(n.requestRawData&&r)return this._fetchPixels(e,t,i,n);const a=(0,T.getWorldWidth)(e.spatialReference),s=(0,T.getWorldWrapCount)(e);if(null==a||0===s||1===s&&this._isGlobalWrappableSource&&r)return this._fetchPixels(e,t,i,n);if(s>=3)return{extent:e,pixelBlock:null};const l=[],{xmin:o,xmax:u}=e,c=Math.round(a/(u-o)*t),d=c-Math.round((a/2-o)/(u-o)*t);let f=0;const h=[];for(let r=0;r<=s;r++){const p=new(0,k.default)({xmin:0===r?o:-a/2,xmax:r===s?u-a*r:a/2,ymin:e.ymin,ymax:e.ymax,spatialReference:e.spatialReference}),m=0===r?c-d:r===s?t-f:c;f+=m,h.push(m);const y=n.disableWrapAround&&r>0?null:this._fetchPixels(p,m,i,n);l.push(y)}const p=(await Promise.all(l)).map((e=>null==e?void 0:e.pixelBlock));let m=null;const y={width:t,height:i};return m=this.rasterJobHandler?(await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:p,srcMosaicSize:y,destDimension:null,coefs:null,sampleSpacing:null,interpolation:"nearest",alignmentInfo:null,blockWidths:h},n)).pixelBlock:(0,_.mosaic)(p,y,{blockWidths:h}),{extent:e,srcExtent:(0,T.projectExtent)(e,this.rasterInfo.spatialReference,n.datumTransformation),pixelBlock:m}}async fetchRawPixels(e,t,i,n={}){t={x:Math.floor(t.x),y:Math.floor(t.y)};const r=await this._fetchRawTiles(e,t,i,n),{nativeExtent:a,nativePixelSize:s,storageInfo:l}=this.rasterInfo,o=2**e,u=s.x*o,c=s.y*o,d=new(0,k.default)({xmin:a.xmin+u*t.x,xmax:a.xmin+u*(t.x+i.width-1),ymin:a.ymax-c*(t.y+i.height-1),ymax:a.ymax-c*t.y,spatialReference:a.spatialReference});if(!r)return{extent:d,srcExtent:d,pixelBlock:null};const{pixelBlocks:f,mosaicSize:h}=r;if(1===f.length&&null!=f[0]&&f[0].width===i.width&&f[0].height===i.height)return{extent:d,srcExtent:d,pixelBlock:r.pixelBlocks[0]};const p=e>0?l.pyramidBlockWidth:l.blockWidth,m=e>0?l.pyramidBlockHeight:l.blockHeight,y={x:t.x%p,y:t.y%m};let g;return g=this.rasterJobHandler?(await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:f,srcMosaicSize:h,destDimension:i,clipOffset:y,clipSize:i,coefs:null,sampleSpacing:null,interpolation:n.interpolation,alignmentInfo:null,blockWidths:null},n)).pixelBlock:(0,_.mosaic)(f,h,{clipOffset:y,clipSize:i}),{extent:d,srcExtent:d,pixelBlock:g}}fetchRawTile(e,t,i,n){throw new(0,s.default)("BaseRaster:read-not-implemented","fetchRawTile() is not implemented")}computeExtent(e){return(0,T.projectExtent)(this.rasterInfo.extent,e)}decodePixelBlock(e,t){return!this.rasterJobHandler||t.useCanvas?(0,R.decode)(e,t):this.rasterJobHandler.decode({data:e,options:t})}async request(e,t,i=0){const{customFetchParameters:n}=this.ioConfig,{range:r,query:s,headers:l}=t;var o;i=null!==(o=null!=i?i:t.retryCount)&&void 0!==o?o:this.ioConfig.retryCount;const u=r?{Range:`bytes=${r.from}-${r.to}`}:null;try{return await(0,a.default)(e,{...t,query:{...s,...n},headers:{...l,...u}})}catch(n){if(i>0)return i--,this.request(e,t,i);throw n}}getSliceIndex(e){const{multidimensionalInfo:t}=this.rasterInfo;return null==t||null==e||0===e.length?null:(0,w.getSliceIndex)(e,t)}getTileExtentFromTileInfo(e,t,i,n){const r=(0,u.unwrapOrThrow)(n.lodAt(e));return this.getTileExtent({x:r.resolution,y:r.resolution},t,i,n.origin,n.spatialReference,n.size)}updateTileInfo(){const{storageInfo:e,spatialReference:t,extent:i,pixelSize:n}=this.rasterInfo;if(!e.tileInfo){const r=[],a=e.maximumPyramidLevel||0;let s=Math.max(n.x,n.y),l=1/.0254*96*s;for(let e=0;e<=a;e++)r.push(new(0,x.default)({level:a-e,resolution:s,scale:l})),s*=2,l*=2;const o=new(0,C.default)({x:i.xmin,y:i.ymax,spatialReference:t});e.tileInfo=new(0,b.default)({origin:o,size:[e.blockWidth,e.blockHeight],spatialReference:t,lods:r}),e.isVirtualTileInfo=!0}}createRemoteDatasetStorageInfo(e,t=512,i=512,n){const{width:r,height:a,nativeExtent:s,pixelSize:l,spatialReference:o}=e,u=new(0,C.default)({x:s.xmin,y:s.ymax,spatialReference:o});null==n&&(n=Math.max(0,Math.round(Math.log(Math.max(r,a))/Math.LN2-8)));const c=this.computeBlockBoundary(s,512,512,{x:s.xmin,y:s.ymax},[l],n);e.storageInfo=new(0,v.default)({blockWidth:t,blockHeight:i,pyramidBlockWidth:t,pyramidBlockHeight:i,origin:u,firstPyramidLevel:1,maximumPyramidLevel:n,blockBoundary:c})}async computeBestPyramidLevelForLocation(e,t={}){return 0}computeBlockBoundary(e,t,i,n,r,a=0,s=2){if(1===r.length&&a>0){r=[...r];let{x:e,y:t}=r[0];for(let i=0;i<a;i++)e*=s,t*=s,r.push({x:e,y:t})}const l=[],{x:o,y:u}=n;for(let n=0;n<r.length;n++){const{x:a,y:s}=r[n];l.push({minCol:Math.floor((e.xmin-o+.1*a)/t/a),maxCol:Math.floor((e.xmax-o-.1*a)/t/a),minRow:Math.floor((u-e.ymax+.1*s)/i/s),maxRow:Math.floor((u-e.ymin-.1*s)/i/s)})}return l}getPyramidPixelSize(e){const{nativePixelSize:t}=this.rasterInfo,{pyramidResolutions:i,pyramidScalingFactor:n}=this.rasterInfo.storageInfo;if(0===e)return t;if(null!=i&&i.length)return i[e-1];const r=n**e;return{x:t.x*r,y:t.y*r}}identifyPixelLocation(e,t,i,n){const{spatialReference:r,nativeExtent:a,storageInfo:s}=this.rasterInfo,{maximumPyramidLevel:l,origin:o,transposeInfo:u}=s,c=n&&null!=u?u.tileSize[0]:s.blockWidth,d=n&&null!=u?u.tileSize[1]:s.blockHeight,f=(0,T.projectPoint)(e,r,i);if(!a.intersects(f))return null;if(t<0||t>l)return null;const h=this.getPyramidPixelSize(t),{x:p,y:m}=h,y=(o.y-f.y)/m/d,g=(f.x-o.x)/p/c,x=Math.min(d-1,Math.floor((y-Math.floor(y))*d)),v=Math.min(c-1,Math.floor((g-Math.floor(g))*c));return{pyramidLevel:t,row:Math.floor(y),col:Math.floor(g),rowOffset:x,colOffset:v,blockWidth:c,srcLocation:f}}getTileExtent(e,t,i,n,r,a){const[s,l]=a,o=n.x+i*s*e.x,u=o+s*e.x,c=n.y-t*l*e.y,d=c-l*e.y;return new(0,k.default)({xmin:o,xmax:u,ymin:d,ymax:c,spatialReference:r})}getBlockWidthHeight(e){return{blockWidth:e>0?this.rasterInfo.storageInfo.pyramidBlockWidth:this.rasterInfo.storageInfo.blockWidth,blockHeight:e>0?this.rasterInfo.storageInfo.pyramidBlockHeight:this.rasterInfo.storageInfo.blockHeight}}isBlockOutside(e,t,i){const n=this.rasterInfo.storageInfo.blockBoundary[e];return!n||n.maxRow<t||n.maxCol<i||n.minRow>t||n.minCol>i}async _fetchPixels(e,t,i,n={}){let r=(0,T.getWorldWrapCount)(e);if(r>=2)return{extent:e,pixelBlock:null};const a=this._getSourceDataInfo(e,t,i,n),{pyramidLevel:s,srcResolution:l,srcExtent:o,srcWidth:u,srcHeight:c,ul:d}=a;if(0===u||0===c)return{extent:e,srcExtent:o,pixelBlock:null};const{rasterInfo:f}=this,h=f.transform,p="gcs-shift"===(null==h?void 0:h.type),m=null!=(0,T.getWorldWidth)(e.spatialReference);!p&&m||(r=(0,T.getWorldWrapCount)(a.srcExtent,p));const y=await this._fetchRawTiles(s,d,{width:u,height:c,wrapCount:r},n);if(!y)return{extent:e,srcExtent:o,pixelBlock:null};const g=f.storageInfo,x=s>0?g.pyramidBlockWidth:g.blockWidth,v=s>0?g.pyramidBlockHeight:g.blockHeight;let{x:b,y:w}=f.pixelSize;if(s>0){const{pyramidResolutions:e,pyramidScalingFactor:t}=g;if(null!=e&&e[s-1])({x:b,y:w}=e[s-1]);else{const e=t**s;b*=e,w*=e}}const I=f.spatialReference,S=new(0,C.default)({x:b,y:w,spatialReference:I}),R=x===u&&v===c&&d.x%x==0&&d.y%v==0,k=new(0,C.default)({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/i,spatialReference:e.spatialReference}),F=!e.spatialReference.equals(I),N=I.isGeographic?1e-9:1e-4,{datumTransformation:D}=n;if(!F&&R&&1===y.pixelBlocks.length&&x===t&&v===i&&this._isSameResolution(l,k,N))return{extent:e,srcExtent:o,srcTilePixelSize:S,pixelBlock:y.pixelBlocks[0]};const P=m&&null!=(0,T.getWorldWidth)(o.spatialReference)&&this._hasNoneOrGCSShiftTransform,O=n.requestProjectedLocalDirections&&this.rasterInfo.dataType.startsWith("vector");O&&!this.rasterJobHandler&&await(0,T.load)();const E=this.rasterJobHandler?await this.rasterJobHandler.getProjectionOffsetGrid({projectedExtent:e,srcBufferExtent:y.extent,pixelSize:k.toJSON(),datumTransformation:D,rasterTransform:h,hasWrapAround:r>0||P,isAdaptive:!1!==this.ioConfig.optimizeProjectionAccuracy,includeGCSGrid:O},n):(0,T.getProjectionOffsetGrid)({projectedExtent:e,srcBufferExtent:y.extent,pixelSize:k,datumTransformation:D,rasterTransform:h,hasWrapAround:r>0||P,isAdaptive:!1,includeGCSGrid:O});let J;const B=!n.requestRawData,A={rows:E.spacing[0],cols:E.spacing[1]},z=this._hasNoneOrGCSShiftTransform?this._getRasterTileAlignmentInfo(s,y.extent.xmin):void 0,{pixelBlocks:L,mosaicSize:H,isPartiallyFilled:V}=y;let j=null;if(this.rasterJobHandler){const e=await this.rasterJobHandler.mosaicAndTransform({srcPixelBlocks:L,srcMosaicSize:H,destDimension:B?{width:t,height:i}:null,coefs:B?E.coefficients:null,sampleSpacing:B?A:null,projectDirections:O,gcsGrid:O?E.gcsGrid:null,isUV:"vector-uv"===this.rasterInfo.dataType,interpolation:n.interpolation,alignmentInfo:z,blockWidths:null},n);({pixelBlock:J,localNorthDirections:j}=e)}else{const e=(0,_.mosaic)(L,H,{alignmentInfo:z});J=B?(0,_.approximateTransform)(e,{width:t,height:i},E.coefficients,A,n.interpolation):e,O&&E.gcsGrid&&(j=(0,_.getLocalArithmeticNorthRotations)({width:t,height:i},E.gcsGrid),J=(0,M.convertToLocalDirections)(J,this.rasterInfo.dataType,j))}return n.requestRawData||O?{extent:e,srcExtent:o,srcTilePixelSize:S,pixelBlock:J,transformGrid:E,localNorthDirections:j,isPartiallyFilled:V}:{extent:e,srcExtent:o,srcTilePixelSize:S,pixelBlock:J}}async _fetchRawTiles(e,t,i,n){const{origin:r,blockBoundary:a}=this.rasterInfo.storageInfo,{blockWidth:s,blockHeight:l}=this.getBlockWidthHeight(e);let{x:o,y:u}=t,{width:c,height:d,wrapCount:f}=i;const h=this._getRasterTileAlignmentInfo(e,0);n.buffer&&(o-=n.buffer.cols,u-=n.buffer.rows,c+=2*n.buffer.cols,d+=2*n.buffer.rows);let p=0,m=0,y=0;f&&null!=h&&(({worldColumnCountFromOrigin:m,originColumnOffset:y,rightPadding:p}=h),m*h.blockWidth-p>=o+c&&(p=0));const g=Math.floor(o/s),x=Math.floor(u/l),v=Math.floor((o+c+p-1)/s),b=Math.floor((u+d+p-1)/l),w=a[e];if(!w)return null;const{minRow:I,minCol:S,maxCol:R,maxRow:_}=w;if(0===f&&(b<I||v<S||x>_||g>R))return null;const T=new Array;let M=!1;const C=null==this.ioConfig.allowPartialFill?n.allowPartialFill:this.ioConfig.allowPartialFill;for(let t=x;t<=b;t++)for(let i=g;i<=v;i++){let r=i;if(!n.disableWrapAround&&f&&null!=h&&m<=i&&(r=i-m-y),t>=I&&r>=S&&_>=t&&R>=r){const i=this._fetchRawTile(e,t,r,n);C?T.push(new Promise((e=>{i.then((t=>e(t))).catch((()=>{M=!0,e(null)}))}))):T.push(i)}else T.push(Promise.resolve(null))}if(0===T.length)return null;const F=await Promise.all(T),N={height:(b-x+1)*l,width:(v-g+1)*s},{spatialReference:D}=this.rasterInfo,P=this.getPyramidPixelSize(e),{x:O,y:E}=P;return{extent:new(0,k.default)({xmin:r.x+g*s*O,xmax:r.x+(v+1)*s*O,ymin:r.y-(b+1)*l*E,ymax:r.y-x*l*E,spatialReference:D}),pixelBlocks:F,mosaicSize:N,isPartiallyFilled:M}}_isSameResolution(e,t,i){return Math.abs(e.x-t.x)<i&&Math.abs(e.y-t.y)<i}_fetchRawTile(e,t,i,n){const r=this.rasterInfo.storageInfo.blockBoundary[e];if(!r)return Promise.resolve(null);const{minRow:a,minCol:s,maxCol:l,maxRow:o}=r;if(t<a||i<s||t>o||i>l)return Promise.resolve(null);const u=(0,I.getRasterId)(this.url,n.sliceId),c=`${e}/${t}/${i}`;let f=(0,I.getBlock)(u,n.registryId,c);if(null==f){const r=new AbortController;f=this.fetchRawTile(e,t,i,{...n,signal:r.signal}),(0,I.putBlock)(u,n.registryId,c,f,r),f.catch((()=>(0,I.deleteBlock)(u,n.registryId,c)))}return n.signal&&(0,d.onAbort)(n,(()=>{(0,I.decreaseRefCount)(u,n.registryId,c)})),f}_computeMagDirValues(e){var t;const{bandCount:i,dataType:n}=this.rasterInfo;if((2!==i||"vector-magdir"!==n)&&"vector-uv"!==n||2!==(null==e?void 0:e.length)||!(null===(t=e[0])||void 0===t?void 0:t.length))return null;const r=e[0].length;if("vector-magdir"===n){const t=e[1].map((e=>(e+360)%360));return[e[0],t]}const[a,s]=e,l=[],o=[];for(let e=0;e<r;e++){const[t,i]=(0,M.uvComponentToVector)([a[e],s[e]]);l.push(t),o.push(i)}return[l,o]}_getRasterTileAlignmentInfo(e,t){return null==this._rasterTileAlighmentInfo&&(this._rasterTileAlighmentInfo=(0,T.getRasterDatasetAlignmentInfo)(this.rasterInfo)),null==this._rasterTileAlighmentInfo.pyramidsInfo?null:{startX:t,halfWorldWidth:this._rasterTileAlighmentInfo.halfWorldWidth,hasGCSSShiftTransform:this._rasterTileAlighmentInfo.hasGCSSShiftTransform,...this._rasterTileAlighmentInfo.pyramidsInfo[e]}}_getSourceDataInfo(e,t,i,n={}){const r={datumTransformation:n.datumTransformation,pyramidLevel:0,pyramidResolution:null,srcExtent:null,srcHeight:0,srcResolution:null,srcWidth:0,ul:{x:0,y:0}};n.srcResolution&&(r.srcResolution=n.srcResolution,this._updateSourceDataInfo(e,r));const a=this.rasterInfo.storageInfo.maximumPyramidLevel||0,{srcWidth:s,srcHeight:l,pyramidLevel:o}=r,u=s/t,c=l/i,d=o<a&&u*c>=16,f=o===a&&this._requireTooManySrcTiles(s,l,t,i);if(d||f||0===s||0===l){const s=new(0,C.default)({x:(e.xmax-e.xmin)/t,y:(e.ymax-e.ymin)/i,spatialReference:e.spatialReference});let l=(0,T.projectResolution)(s,this.rasterInfo.spatialReference,e,r.datumTransformation);const f=!l||n.srcResolution&&l.x+l.y<n.srcResolution.x+n.srcResolution.y;if(d&&n.srcResolution&&f){const e=Math.round(Math.log(Math.max(u,c))/Math.LN2)-1;if(a-o+3>=e){const t=2**e;l={x:n.srcResolution.x*t,y:n.srcResolution.y*t}}}l&&(r.srcResolution=l,this._updateSourceDataInfo(e,r))}return this._requireTooManySrcTiles(r.srcWidth,r.srcHeight,t,i)&&(r.srcWidth=0,r.srcHeight=0),r}_requireTooManySrcTiles(e,t,i,n){const{tileInfo:r}=this.rasterInfo.storageInfo;return Math.ceil(e/r.size[0])*Math.ceil(t/r.size[1])>=256||e/i>8||t/n>8}_updateSourceDataInfo(e,t){t.srcWidth=0,t.srcHeight=0;const{rasterInfo:i}=this,n=i.spatialReference,{srcResolution:r,datumTransformation:a}=t,{pyramidLevel:s,pyramidResolution:l,excessiveReading:o}=(0,T.snapPyramid)(r,i,this.ioConfig.sampling);if(o)return;let u=t.srcExtent||(0,T.projectExtent)(e,n,a);if(null==u)return;const c=i.transform;c&&(u=c.inverseTransform(u)),t.srcExtent=u;const{x:d,y:f}=i.storageInfo.origin,h=Math.floor((u.xmin-d)/l.x+.1),p=Math.floor((f-u.ymax)/l.y+.1),m=Math.floor((u.xmax-d)/l.x-.1),y=Math.floor((f-u.ymin)/l.y-.1),g=u.width<.1*l.x?0:m-h+1,x=u.height<.1*l.y?0:y-p+1;t.pyramidLevel=s,t.pyramidResolution=l,t.srcWidth=g,t.srcHeight=x,t.ul={x:h,y:p}}_getRequestOptionsWithSliceId(e){return null!=this.rasterInfo.multidimensionalInfo&&null==e.sliceId&&(e={...e,sliceId:this.getSliceIndex(e.multidimensionalDefinition)}),e}_processIdentifyResult(e,t){const{srcLocation:i,position:n,pyramidLevel:r,useTransposedTile:a}=t,s=e.pixels[0].length/e.width/e.height;if(e.mask&&!e.mask[n])return{location:i,value:null};const{multidimensionalInfo:l}=this.rasterInfo;if(null==l||!a){const t=e.pixels.map((e=>e[n])),a={location:i,value:t,pyramidLevel:r},s=this._computeMagDirValues(t.map((e=>[e])));return(null==s?void 0:s.length)&&(a.magdirValue=s.map((e=>e[0]))),a}let o=e.pixels.map((e=>e.slice(n*s,n*s+s))),u=this._computeMagDirValues(o);const{requestSomeSlices:c,identifyOptions:d}=t;let f=(0,w.createSlices)(l,d.transposedVariableName);if(c){const e=(0,w.getSliceIds)(f,d.multidimensionalDefinition,d.timeExtent);o=o.map((t=>e.map((e=>t[e])))),u=null==u?void 0:u.map((t=>e.map((e=>t[e])))),f=e.map((e=>f[e]))}const h=e.noDataValues||this.rasterInfo.noDataValue,p={pixels:o,pixelType:e.pixelType};let m;return null!=h&&((0,S.convertNoDataToMask)(p,h),m=p.mask),{location:i,value:null,dataSeries:f.map(((e,t)=>{const i={value:0===(null==m?void 0:m[t])?null:o.map((e=>e[t])),multidimensionalDefinition:e.multidimensionalDefinition.map((e=>new(0,g.default)({...e,isSlice:!0})))};return(null==u?void 0:u.length)&&(i.magdirValue=[u[0][t],u[1][t]]),i})),pyramidLevel:r}}constructor(){super(...arguments),this.datasetName=null,this.datasetFormat=null,this.hasUniqueSourceStorageInfo=!0,this.rasterInfo=null,this.ioConfig={sampling:"closest"}}};(0,r._)([(0,f.property)()],F.prototype,"_rasterTileAlighmentInfo",void 0),(0,r._)([(0,f.property)({readOnly:!0})],F.prototype,"_isGlobalWrappableSource",null),(0,r._)([(0,f.property)({readOnly:!0})],F.prototype,"_hasNoneOrGCSShiftTransform",null),(0,r._)([(0,f.property)()],F.prototype,"rasterJobHandler",null),(0,r._)([(0,f.property)(y.url)],F.prototype,"url",null),(0,r._)([(0,f.property)({type:String,json:{write:!0}})],F.prototype,"datasetName",void 0),(0,r._)([(0,f.property)({type:String,json:{write:!0}})],F.prototype,"datasetFormat",void 0),(0,r._)([(0,f.property)()],F.prototype,"hasUniqueSourceStorageInfo",void 0),(0,r._)([(0,f.property)()],F.prototype,"rasterInfo",void 0),(0,r._)([(0,f.property)()],F.prototype,"ioConfig",void 0),(0,r._)([(0,f.property)()],F.prototype,"sourceJSON",void 0),F=(0,r._)([(0,p.subclass)("esri.layers.support.rasterDatasets.BaseRaster")],F);const N=F})),t.register("9m6jq",(function(i,n){e(i.exports,"createSlices",(function(){return l})),e(i.exports,"getSliceIds",(function(){return o})),e(i.exports,"hasExcludedVariableOrDimension",(function(){return h})),e(i.exports,"intersectMultimensionalSubset",(function(){return p})),e(i.exports,"getDefaultVariablInfo",(function(){return m})),e(i.exports,"getDefaultMultidimensionalDefinition",(function(){return y})),e(i.exports,"isMultiSliceOrRangeDefinition",(function(){return g})),e(i.exports,"getSubsetVariablesFromMdInfo",(function(){return x})),e(i.exports,"getSliceIndex",(function(){return w}));var r=t("lNwWH"),a=t("d3QQf");function s(e,t,i){const n=t.shift();if(0===i.length){const e=[];i.push({sliceId:-1,multidimensionalDefinition:e})}const r=i.length;for(let t=0;t<r;t++){var a;const t=i.shift().multidimensionalDefinition;null===(a=n.values)||void 0===a||a.forEach((r=>{i.push({sliceId:-1,multidimensionalDefinition:[...t,{variableName:e,dimensionName:n.name,values:[r]}]})}))}t.length&&s(e,t,i)}function l(e,t){const i=[];let n=0;return(t?e.variables.filter((e=>e.name.toLowerCase()===t.toLowerCase())):[...e.variables].sort(((e,t)=>e.name>t.name?1:-1))).forEach((e=>{const t=[],r=[...e.dimensions].sort(((e,t)=>e.name>t.name?-1:1));s(e.name,r,t),t.forEach((e=>{i.push({...e,sliceId:n++})}))})),i}function o(e,t,i){let n=e;if(t&&(t=[...t].sort(((e,t)=>e.dimensionName<t.dimensionName?-1:1))).forEach((({dimensionName:e,values:t,isSlice:i})=>{t.length&&(n=n.filter((n=>{const r=n.multidimensionalDefinition.find((t=>t.dimensionName===e));if(null==r)return!1;const a=r.values[0];return"number"==typeof a?"number"==typeof t[0]?t.includes(a):t.some((e=>e[0]<=a&&e[1]>=a)):"number"==typeof t[0]?t.some((e=>a[0]<=e&&a[1]>=e)):i?t.some((e=>e[0]===a[0]&&e[0]===a[1])):t.some((e=>e[0]>=a[0]&&e[0]<=a[1]||e[1]>=a[0]&&e[1]<=a[1]||e[0]<a[0]&&e[1]>a[1]))})))})),n.length&&i&&null!=i.start&&null!=i.end){const e=i.start.getTime(),t=i.end.getTime(),r=n[0].multidimensionalDefinition.findIndex((e=>"StdTime"===e.dimensionName));r>-1&&(n=n.filter((i=>{const n=i.multidimensionalDefinition[r].values[0];return e<=n&&t>=n})))}return n.map((e=>e.sliceId))}function u(e,t){return Array.isArray(e)?t[0]===t[1]?e[0]===t[0]||e[1]===t[0]:e[0]>=t[0]&&e[0]<=t[1]&&e[1]>=t[0]&&e[1]<=t[1]:e>=t[0]&&e<=t[1]}function c(e,t){return e[0]<=t[0]&&e[1]>=t[0]||e[0]<=t[1]&&e[1]>=t[1]||e[0]>=t[0]&&e[1]<=t[1]}function d(e){return 1===e.length?[e[0],e[0]]:[e[0],e[e.length-1]]}function f(e,t,i){var n;if(!(null==t||null===(n=t.subsetDefinitions)||void 0===n?void 0:n.length))return e;let r;if(i){var a;const{variables:n}=t;if(n.length&&!n.includes(i))return null;const s=t.subsetDefinitions.find((t=>t.dimensionName===e.name&&t.variableName===i));if(!(null==s||null===(a=s.values)||void 0===a?void 0:a.length))return e;r=d(s.values)}else{const i=t.dimensions.find((({name:t})=>t===e.name));r=null==i?void 0:i.extent}const s=r;if(!s||!(null==s?void 0:s.length))return e;const l=e.values.filter((e=>u(e,s)));return{...e,extent:[...s],values:l}}function h(e,t,i){var n;if(!(null==t||null===(n=t.subsetDefinitions)||void 0===n?void 0:n.length))return!1;const{variables:r}=t;if(r.length&&e.some((({variableName:e})=>e&&!r.includes(e))))return!0;for(let n=0;n<e.length;n++){const r=e[n],a=t.subsetDefinitions.find((e=>(""===r.variableName||e.variableName===r.variableName)&&e.dimensionName===r.dimensionName));if(null==a?void 0:a.values.length){const e=d(a.values);if(r.isSlice||2!==r.values.length||Array.isArray(r.values[0])||r.values[0]===r.values[1]||!i){if(r.values.some((t=>!u(t,e))))return!0}else if(!c(r.values,e))return!0}}return!1}function p(e,t){if(null==e)return{isOutside:!1};const{geometry:i,timeExtent:n,multidimensionalDefinition:r}=t;let s=null;if(null!=n&&(s=function(e,t){const i=e.dimensions.find((({name:e})=>"StdTime"===e));if(null==i||null==t.start&&null==t.end)return t;t=t.clone();const{start:n,end:r}=t.toJSON(),s=n===r?[n]:null!=n&&null!=r?[n,r]:[null!=n?n:r];var l,o;return 2===s.length&&(null==i?void 0:i.extent.length)&&(s[0]=Math.max(s[0],i.extent[0]),s[1]=Math.min(s[1],null!==(l=i.extent[1])&&void 0!==l?l:i.extent[0]),s[1]<s[0])||h([new(0,a.default)({variableName:"",dimensionName:"StdTime",isSlice:1===s.length,values:s})],e,!0)?null:(t.start=new Date(s[0]),t.end=new Date(null!==(o=s[1])&&void 0!==o?o:s[0]),t)}(e,n),null==s))return{isOutside:!0};const{areaOfInterest:l}=e;if(l&&i){const e="point"===i.type?i:"extent"===i.type?i.center:"polygon"===i.type?i.centroid:null;if(e&&!l.contains(e))return{isOutside:!0}}return null!=r&&r.length&&h(r,e,!0)?{isOutside:!0}:{isOutside:!1,intersection:{geometry:i,timeExtent:s,multidimensionalDefinition:r}}}function m(e,t={}){var i,n;const{multidimensionalInfo:r,keyProperties:a}=e;if(null==r)return null;const{variableName:s,multidimensionalSubset:l,multidimensionalDefinition:o}=t,u=null!=o?null===(i=o[0])||void 0===i?void 0:i.variableName:null,c=s||u||(null==a?void 0:a.DefaultVariable);let{variables:d}=r;var f;return(null==l||null===(n=l.variables)||void 0===n?void 0:n.length)&&(d=d.filter((({name:e})=>l.variables.includes(e)))),c&&null!==(f=d.find((({name:e})=>e===c)))&&void 0!==f?f:d[0]}function y(e,t={}){const i=m(e,t);if(!i)return null;const n=[],{dimensions:r,name:s}=i;if(0===r.length)return[new(0,a.default)({variableName:s,dimensionName:"",values:[],isSlice:!0})];for(let e=0;e<r.length;e++){const i=f(r[e],t.multidimensionalSubset,s);if(!i)return null;const{values:o,extent:u}=i;var l;let c=null!==(l=null==o?void 0:o[0])&&void 0!==l?l:u[0];"stdz"===i.name.toLowerCase()&&!i.hasRanges&&Math.abs(u[1])<=Math.abs(u[0])&&(c=(null==o?void 0:o.length)?o[o.length-1]:u[1]),n.push(new(0,a.default)({variableName:s,dimensionName:i.name,values:[c],isSlice:!t.useRangeForRangedDimensionInfo||!!i.hasRanges}))}return n}function g(e){return!(null==e||!e.length)&&e.some((e=>{if(null==e.values)return!0;const t=e.values.length;return 0===t||t>1||!e.isSlice&&Array.isArray(e.values[0])}))}function x(e,t){var i;if(null==t||null==e)return null;let n=t.variables.map((e=>({...e})));return(null==e||null===(i=e.variables)||void 0===i?void 0:i.length)&&(n=n.filter((({name:t})=>e.variables.includes(t))),n.forEach((t=>{t.dimensions=t.dimensions.map((i=>f(i,e,t.name))).filter(r.isSome)}))),n}function v(e,t){var i;const{values:n}=t;if(null==n?void 0:n.length){const t=Array.isArray(n[0]),i=Array.isArray(e);return t!==i?-1:t&&i?n.findIndex((t=>t[0]===e[0]&&t[1]===e[1])):n.indexOf(e)}const{extent:r}=t;if(Array.isArray(e)||e<r[0]||e>r[1])return-1;const a=t.interval||1;if("ISO8601"!==t.unit)return Math.round((e-r[0])/a);const s=r[0];let l=-1;switch((null===(i=t.intervalUnit)||void 0===i?void 0:i.toLowerCase())||"seconds"){case"seconds":l=Math.round((e-s)/1e3/a);break;case"minutes":l=Math.round((e-s)/6e4/a);break;case"hours":l=Math.round((e-s)/36e5/a);break;case"days":l=Math.round((e-s)/864e5/a);break;case"months":{const t=new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear(),i=new Date(s).getUTCMonth(),n=new Date(e).getUTCMonth();l=0===t?n-i:n+11-i+12*(t-1)}break;case"years":l=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/a);break;case"decades":l=Math.round((new Date(e).getUTCFullYear()-new Date(s).getUTCFullYear())/10/a)}return l}function b(e){var t,i;let n=null===(t=e.values)||void 0===t?void 0:t.length;if(n)return n;const{extent:r,unit:a}=e,s=e.interval||1,l=r?r[1]-r[0]:0;if("ISO8601"!==a)return Math.round(l/s);var o;switch(null!==(o=null===(i=e.intervalUnit)||void 0===i?void 0:i.toLowerCase())&&void 0!==o?o:"seconds"){case"seconds":n=Math.round(l/1e3/s);break;case"minutes":n=Math.round(l/6e4/s);break;case"hours":n=Math.round(l/36e5/s);break;case"days":n=Math.round(l/864e5/s);break;case"months":{const e=new Date(r[1]).getUTCFullYear()-new Date(r[0]).getUTCFullYear(),t=new Date(r[0]).getUTCMonth(),i=new Date(r[1]).getUTCMonth();n=0===e?i-t+1:i+11-t+12*(e-1)+1}break;case"years":n=Math.round((new Date(r[1]).getUTCFullYear()-new Date(r[0]).getUTCFullYear())/s);break;case"decades":n=Math.round((new Date(r[1]).getUTCFullYear()-new Date(r[0]).getUTCFullYear())/10/s);break;default:n=0}return n}function w(e,t){let i=0;const n=e[0].variableName,r=[...t.variables].sort(((e,t)=>e.name>t.name?1:-1));for(let t=0;t<r.length;t++){const a=r[t],s=[...a.dimensions].sort(((e,t)=>e.name>t.name?-1:1));if(a.name!==n){i+=s.map((e=>b(e))).reduce(((e,t)=>e*t));continue}const l=s.map((e=>b(e))),o=s.length;for(let t=0;t<o;t++){const n=e.find((e=>e.dimensionName===s[t].name));if(null==n)return null;const r=v(n.values[0],s[t]);if(-1===r)return null;l.shift(),i+=t===o-1?r:r*l.reduce(((e,t)=>e*t))}break}return i}})),t.register("4IP7o",(function(i,n){e(i.exports,"getRasterId",(function(){return u})),e(i.exports,"register",(function(){return c})),e(i.exports,"unregister",(function(){return d})),e(i.exports,"decreaseRefCount",(function(){return f})),e(i.exports,"getBlock",(function(){return h})),e(i.exports,"putBlock",(function(){return p})),e(i.exports,"deleteBlock",(function(){return m})),e(i.exports,"update",(function(){return y})),t("2ILM8");var r=t("kynKe"),a=t("jxAFe"),s=t("d1Fqh");const l=new Map,o=new(0,r.default);function u(e,t){return null==t?e:`${e}?sliceId=${t}`}function c(e,t){const i={extent:null,rasterInfo:t,cache:new Map},n=l.get(e);return n?(n.push(i),n.length-1):(l.set(e,[i]),0)}function d(e,t){const i=l.get(e);i&&(i[t]=null,i.some((e=>null!=e))||l.delete(e))}function f(e,t,i){var n;const r=l.get(e);if(!r)return null==t?o.decreaseRefCount(e,i):0;if(null==t||null==r[t])return o.decreaseRefCount(e,i);const a=null===(n=r[t])||void 0===n?void 0:n.cache,s=null==a?void 0:a.get(i);if(a&&s){if(s.refCount--,0===s.refCount){var u;a.delete(i);for(let e=0;e<r.length;e++)null===(u=r[e])||void 0===u||u.cache.delete(i);s.controller&&s.controller.abort()}return s.refCount}return 0}function h(e,t,i){var n;const r=l.get(e);if(!r)return null==t?o.getBlock(e,i):null;if(null==t||null==r[t]){for(let e=0;e<r.length;e++){var a;const t=null===(a=r[e])||void 0===a?void 0:a.cache.get(i);if(t)return t.refCount++,t.block}return o.getBlock(e,i)}const s=null===(n=r[t])||void 0===n?void 0:n.cache.get(i);if(s)return s.refCount++,s.block;for(let e=0;e<r.length;e++){var u;if(e===t||!r[e])continue;const n=null===(u=r[e])||void 0===u?void 0:u.cache,a=null==n?void 0:n.get(i);if(n&&a)return a.refCount++,n.set(i,a),a.block}return null}function p(e,t,i,n,r=null){var a;const s=l.get(e);if(!s)return void(null==t&&o.putBlock(e,i,n,r));if(null==t||null==s[t])return void o.putBlock(e,i,n,r);const u={refCount:1,block:n,isResolved:!1,isRejected:!1,controller:r};n.then((()=>u.isResolved=!0)).catch((()=>u.isRejected=!0)),null===(a=s[t])||void 0===a||a.cache.set(i,u)}function m(e,t,i){var n;const r=l.get(e);r?null!=t&&null!=r[t]?null===(n=r[t])||void 0===n||n.cache.delete(i):o.deleteBlock(e,i):null==t&&o.deleteBlock(e,i)}function y(e,t,i,n,r,o,u=null){const c=function(e,t){const i=l.get(e);var n;return i&&null!==(n=i[t])&&void 0!==n?n:null}(e,t);if(!c)return;const d=c.extent,{cache:f,rasterInfo:h}=c;if(d&&d.xmin===i.xmin&&d.xmax===i.xmax&&d.ymin===i.ymin&&d.ymax===i.ymax)return;n=null!=n?n:0;const p=i.clone().normalize(),{spatialReference:m,transform:y}=h,g=new Set;for(let e=0;e<p.length;e++){const t=p[e];if(t.xmax-t.xmin<=n||t.ymax-t.ymin<=n)continue;let i=(0,a.projectExtent)(t,m,u);null!=y&&(i=y.inverseTransform(i));const l=new(0,s.default)({x:n,y:n,spatialReference:t.spatialReference});if(null==r&&!(r=(0,a.projectResolution)(l,m,t,u)))return;const{pyramidLevel:c,pyramidResolution:d,excessiveReading:f}=(0,a.snapPyramid)(r,h,o||"closest");if(f)return;const{storageInfo:x}=h,{origin:v}=x,b={x:Math.max(0,Math.floor((i.xmin-v.x)/d.x)),y:Math.max(0,Math.floor((v.y-i.ymax)/d.y))},w=Math.ceil((i.xmax-i.xmin)/d.x-.1),I=Math.ceil((i.ymax-i.ymin)/d.y-.1),S=c>0?x.pyramidBlockWidth:x.blockWidth,R=c>0?x.pyramidBlockHeight:x.blockHeight,_=1,T=Math.max(0,Math.floor(b.x/S)-_),M=Math.max(0,Math.floor(b.y/R)-_),k=Math.floor((b.x+w-1)/S)+_,C=Math.floor((b.y+I-1)/R)+_;for(let e=M;e<=C;e++)for(let t=T;t<=k;t++)g.add(`${c}/${e}/${t}`)}f.forEach(((e,t)=>{if(!g.has(t)){const e=f.get(t);(null==e||e.isResolved||e.isRejected)&&f.delete(t)}})),c.extent={xmin:i.xmin,ymin:i.ymin,xmax:i.xmax,ymax:i.ymax}}})),t.register("kynKe",(function(t,i){e(t.exports,"default",(function(){return n}));class n{decreaseRefCount(e,t){const i=e+"/"+t,n=this._cachedBlocks;if(n.has(i)){const e=n.get(i);return e.refCount--,e.refCount<=0&&(n.delete(i),e.controller&&e.controller.abort()),e.refCount}return 0}getBlock(e,t){const i=e+"/"+t,n=this._cachedBlocks;if(n.has(i)){const e=n.get(i);return e.ts=Date.now(),e.refCount++,n.delete(i),n.set(i,e),e.block}return null}putBlock(e,t,i,n){const r=this._cachedBlocks,a=e+"/"+t;if(r.has(a)){const e=r.get(a);e.ts=Date.now(),e.refCount++}else r.set(a,{block:i,ts:Date.now(),refCount:1,controller:n});this._trim(),this._updateTimer()}deleteBlock(e,t){const i=this._cachedBlocks,n=e+"/"+t;i.has(n)&&i.delete(n)}updateMaxSize(e){this._size=e,this._trim()}empty(){this._cachedBlocks.clear(),this._clearTimer()}getCurrentSize(){return this._cachedBlocks.size}_updateTimer(){if(null!=this._timer)return;const e=this._cachedBlocks;this._timer=setInterval((()=>{const t=Array.from(e),i=Date.now();for(let n=0;n<t.length&&t[n][1].ts<=i-this._duration;n++)e.delete(t[n][0]);0===e.size&&this._clearTimer()}),this._interval)}_trim(){const e=this._cachedBlocks;if(-1===this._size||this._size>=e.size)return;const t=Array.from(e);for(let i=0;i<t.length-this._size;i++)e.delete(t[i][0])}_clearTimer(){null!=this._timer&&(clearInterval(this._timer),this._timer=null)}constructor(e=15e3,t=5e3){this._timer=null,this._cachedBlocks=new Map,this._size=-1,this._duration=e,this._interval=Math.min(e,t)}}})),t.register("h41e2",(function(i,n){e(i.exports,"clip",(function(){return l})),e(i.exports,"snapToRaster",(function(){return o}));var r=t("5vzSQ"),a=t("gINRd"),s=t("idX6c");async function l(e,i,n){if("extent"===n.type)return function(e,t,i){const{width:n,height:r}=e,a=new Uint8Array(n*r),l=t.width/n,o=t.height/r;if(i.width/l<.5||i.height/o<.5)return new(0,s.default)({pixelType:e.pixelType,width:n,height:r,mask:a,pixels:[...e.pixels]});const{xmin:u,xmax:c,ymin:d,ymax:f}=t,{xmin:h,xmax:p,ymin:m,ymax:y}=i,g=Math.max(u,h),x=Math.min(c,p),v=Math.max(d,m),b=Math.min(f,y),w=.5*l,I=.5*o;if(x-g<w||b-v<I||x<u+w||g>c-w||v>f-I||b<d+I)return new(0,s.default)({pixelType:e.pixelType,width:n,height:r,mask:a,pixels:[...e.pixels]});const S=Math.max(0,(g-u)/l),R=Math.min(n,Math.max(0,(x-u)/l)),_=Math.max(0,(f-b)/o),T=Math.min(r,Math.max(0,(f-v)/o)),M=Math.round(S),k=Math.round(R)-1,C=Math.round(_),F=Math.round(T)-1;if(M===k&&S%1>.5&&R%1<.5||C===F&&_%1>.5&&T%1<.5)return new(0,s.default)({pixelType:e.pixelType,width:n,height:r,mask:a,pixels:[...e.pixels]});if(0===M&&0===C&&k===n&&F===r)return e;const N=e.mask;for(let e=C;e<=F;e++)for(let t=M;t<=k;t++){const i=e*n+t;a[i]=N?N[i]:255}return new(0,s.default)({pixelType:e.pixelType,width:n,height:r,mask:a,pixels:[...e.pixels]})}(e,i,n);const{width:r,height:a}=e,l=new Uint8Array(r*a),{contains:o,intersects:u}=await t("8oxVx");return u(i,n)?"polyline"===n.type?function(e,t,i){const{width:n,height:r}=e,a=new Uint8Array(n*r),l=t.width/n,o=t.height/r,{xmin:u,ymax:c}=t,{paths:d}=i,f=e.mask;for(let e=0;e<d.length;e++){const t=d[e];for(let e=0;e<t.length-1;e++){const[i,s]=t[e],[d,h]=t[e+1];let p=Math.floor((c-s)/o),m=Math.floor((c-h)/o);if(m<p){const e=p;p=m,m=e}p=Math.max(0,p),m=Math.min(r-1,m);const y=(d-i)/(h-s);for(let e=p;e<=m;e++){const t=e===p?Math.max(s,h):(r+1-e)*o,c=e===m?Math.min(s,h):t-o;let g=h===s?Math.floor((i-u)/l):Math.floor((y*(t-s)+i-u)/l),x=h===s?Math.floor((d-u)/l):Math.floor((y*(c-s)+i-u)/l);if(x<g){const e=g;g=x,x=e}const v=e*n;g=Math.max(0,g),x=Math.min(n-1,x);for(let e=v+g;e<=v+x;e++)a[e]=f?f[e]:255}}}return new(0,s.default)({pixelType:e.pixelType,width:n,height:r,mask:a,pixels:[...e.pixels]})}(e,i,n):o(n,i)?e:function(e,t,i){if(!e)return e;const{width:n,height:r}=e,a=t.width/n,l=t.height/r,{xmin:o,ymax:u}=t;let c;if("extent"===i.type){const e=(i.xmin-o)/a,t=(i.xmax-o)/a,n=(u-i.ymax)/l,r=(u-i.ymin)/l;c=[[[e,n],[e,r],[t,r],[t,n],[e,n]]]}else c=i.rings.map((e=>e.map((([e,t])=>[(e-o)/a,(u-t)/l]))));const d=document.createElement("canvas");d.width=n,d.height=r;const f=d.getContext("2d");f.fillStyle="#f00",c.forEach((e=>{f.beginPath(),f.moveTo(e[0][0],e[0][1]);for(let t=0;t<e.length;t++)f.lineTo(e[t][0],e[t][1]);f.closePath(),f.fill()}));const h=f.getImageData(0,0,n,r).data,p=e.mask,m=n*r,y=new Uint8Array(m);for(let e=0;e<m;e++)p&&!p[e]||(y[e]=h[4*e+3]>127?255:0);return new(0,s.default)({pixelType:e.pixelType,width:n,height:r,mask:y,maskIsAlpha:!1,pixels:[...e.pixels]})}(e,i,n):new(0,s.default)({pixelType:e.pixelType,width:r,height:a,mask:l,maskIsAlpha:!1,pixels:[...e.pixels]})}function o(e,t,i,n=!0){const{spatialReference:s}=e,{x:l,y:o}=function(e,t){if(e.spatialReference.equals(t))return e;const i=(0,r.getMetersPerUnitForSR)(e.spatialReference),n=(0,r.getMetersPerUnitForSR)(t);if(i===n)return e;const a=i/n;return{x:e.x*a,y:e.y*a}}(i,s);let u,c,d;const f="extent"===t.type?t:t.extent;let{xmin:h,xmax:p,ymax:m,ymin:y}=f;const{xmin:g,ymax:x}=e.extent;return n?(h=g+(h>g?l*Math.round((h-g)/l):0),m=x-(m<x?o*Math.round((x-m)/o):0),p=g+(p>g?l*Math.round((p-g)/l):0),y=x-(y<x?o*Math.round((x-y)/o):0),u=new(0,a.default)({xmin:h,ymax:m,xmax:p,ymin:y,spatialReference:s}),c=Math.round(u.width/l),d=Math.round(u.height/o)):(c=Math.floor((p-h)/l+.8),d=Math.floor((m-y)/o+.8),h=g+(h>g?l*Math.floor((h-g)/l+.1):0),m=x-(m<x?o*Math.floor((x-m)/o+.1):0),p=h+c*l,y=m-d*o,u=new(0,a.default)({xmin:h,ymax:m,xmax:p,ymin:y,spatialReference:s})),{extent:u,width:c,height:d}}})),t.register("8oxVx",(function(e,i){e.exports=Promise.all([t("4WKyX")(t("aNJCr").getBundleURL("jKG7E")+t("iE7OH").resolve("20VjG")),t("4WKyX")(t("aNJCr").getBundleURL("jKG7E")+t("iE7OH").resolve("9ESom")),t("4WKyX")(t("aNJCr").getBundleURL("jKG7E")+t("iE7OH").resolve("eJ3K3"))]).then((()=>t("bfGBv")))})),t.register("4ZD9O",(function(i,n){e(i.exports,"default",(function(){return d}));var r=t("kyj08"),a=t("1NZtp"),s=t("5K49h"),l=t("jbz8w"),o=t("ljwGu"),u=t("9Ybm2");const c=new Map;c.set("CRF",{desc:"Cloud Raster Format",constructor:a.default}),c.set("MRF",{desc:"Meta Raster Format",constructor:o.default}),c.set("TIFF",{desc:"GeoTIFF",constructor:u.default}),c.set("RasterTileServer",{desc:"Raster Tile Server",constructor:l.default}),c.set("JPG",{desc:"JPG Raster Format",constructor:s.default}),c.set("PNG",{desc:"PNG Raster Format",constructor:s.default}),c.set("GIF",{desc:"GIF Raster Format",constructor:s.default}),c.set("BMP",{desc:"BMP Raster Format",constructor:s.default});class d{static get supportedFormats(){const e=new Set;return c.forEach(((t,i)=>e.add(i))),e}static async open(e){const{url:t,ioConfig:i,sourceJSON:n}=e;let a=e.datasetFormat;null==a&&t.lastIndexOf(".")&&(a=t.slice(t.lastIndexOf(".")+1).toUpperCase()),"OVR"===a||"TIF"===a?a="TIFF":"JPG"!==a&&"JPEG"!==a&&"JFIF"!==a||(a="JPG"),t.toLowerCase().includes("/imageserver")&&!t.toLowerCase().includes("/wcsserver")&&(a="RasterTileServer");const s={url:t,sourceJSON:n,datasetFormat:a,ioConfig:null!=i?i:{bandIds:null,sampling:null}};let l,o;if(a&&this.supportedFormats.has(a)){if("CRF"===a&&!(null==i?void 0:i.enableCRF))throw new(0,r.default)("rasterfactory:open",`cannot open raster: ${t}`);return l=c.get(a).constructor,o=new l(s),await o.open({signal:e.signal}),o}if(a)throw new(0,r.default)("rasterfactory:open","not a supported format "+a);const u=Array.from(c.keys());let d=0;const f=()=>(a=u[d++],a&&("CRF"!==a||(null==i?void 0:i.enableCRF))?(l=c.get(a).constructor,o=new l(s),o.open({signal:e.signal}).then((()=>o)).catch((()=>f()))):null);return f()}static register(e,t,i){c.has(e.toUpperCase())||c.set(e.toUpperCase(),{desc:t,constructor:i})}}})),t.register("1NZtp",(function(i,n){e(i.exports,"default",(function(){return w}));var r=t("7eJjO");t("2ILM8");var a=t("kyj08"),s=t("iho5X");t("iJAIC"),t("lNwWH"),t("2VlWd");var l=t("fcwIv"),o=t("he5Ty"),u=t("d0bii"),c=t("cQADC"),d=t("xQ42o"),f=t("5EhGd"),h=t("0fPji"),p=t("gzPy2"),m=t("f4h86"),y=t("j40xv"),g=t("gINRd"),x=t("d1Fqh");const v=new Map;v.set("int16","esriFieldTypeSmallInteger"),v.set("int32","esriFieldTypeInteger"),v.set("int64","esriFieldTypeInteger"),v.set("float32","esriFieldTypeSingle"),v.set("float64","esriFieldTypeDouble"),v.set("text","esriFieldTypeString");let b=class extends f.default{async open(e){await this.init();const{data:t}=await this.request(this.url+"/conf.json",{signal:null==e?void 0:e.signal});if(!this._validateHeader(t))throw new(0,a.default)("cloudraster:open","Invalid or unsupported conf.json.");this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);const{storageInfo:i,rasterInfo:n}=this._parseHeader(t);if("thematic"===n.dataType){const e=await this._fetchAuxiliaryInformation();n.attributeTable=e}this._set("storageInfo",i),this._set("rasterInfo",n),this.ioConfig.retryCount=this.ioConfig.retryCount||0}async fetchRawTile(e,t,i,n={}){const{transposeInfo:r}=this.rasterInfo.storageInfo,{transposedVariableName:a}=n,s=!(!r||!a),l=s?0:this.rasterInfo.storageInfo.maximumPyramidLevel-e;if(l<0)return null;const o=this._buildCacheFilePath(l,t,i,n.multidimensionalDefinition,a),u=this._getIndexRecordFromBundle(t,i,s),c=await this.request(o,{range:{from:0,to:this.storageInfo.headerSize-1},responseType:"array-buffer",signal:n.signal});if(!c)return null;const d=new Uint8Array(c.data),f=this._getTileEndAndContentType(d,u);if(0===f.recordSize)return null;const h=await this.request(o,{range:{from:f.position,to:f.position+f.recordSize},responseType:"array-buffer",signal:n.signal});if(!h)return null;const[p,m]=this._getTileSize(s);return this.decodePixelBlock(h.data,{width:p,height:m,planes:null,pixelType:null,returnInterleaved:s})}_validateHeader(e){return e&&"RasterInfo"===e.type&&!["origin","extent","geodataXform","LODInfos","blockWidth","blockHeight","bandCount","pixelType","pixelSizeX","pixelSizeY","format","packetSize"].some((t=>!e[t]))}_parseHeader(e){var t;const i=["u1","u2","u4","u8","s8","u16","s16","u32","s32","f32","f64"][e.pixelType],{bandCount:n,histograms:r,colormap:a,blockWidth:s,blockHeight:l,firstPyramidLevel:f,maximumPyramidLevel:h}=e,p=e.statistics&&e.statistics.map((e=>({min:e.min,max:e.max,avg:e.mean,stddev:e.standardDeviation,median:e.median,mode:e.mode}))),m=e.extent.spatialReference,v=null===(t=e.geodataXform)||void 0===t?void 0:t.spatialReference,b=new(0,y.default)((null==m?void 0:m.wkid)||(null==m?void 0:m.wkt)?m:v);let w=new(0,g.default)({xmin:e.extent.xmin,ymin:e.extent.ymin,xmax:e.extent.xmax,ymax:e.extent.ymax,spatialReference:b});const I=new(0,x.default)({x:e.pixelSizeX,y:e.pixelSizeY,spatialReference:b}),S=Math.round((w.xmax-w.xmin)/I.x),R=Math.round((w.ymax-w.ymin)/I.y),_=this._parseTransform(e.geodataXform),T=_?w:null;var M;_&&(w=_.forwardTransform(w),I.x=(w.xmax-w.xmin)/S,I.y=(w.ymax-w.ymin)/R);const k=null!==(M=e.properties)&&void 0!==M?M:{},C=e.format.toLowerCase().replace("cache/",""),F=new(0,x.default)(e.origin.x,e.origin.y,b);let N,D,P,O;if(a&&a.colors)for(N=[],D=0;D<a.colors.length;D++)P=a.colors[D],O=a.values?a.values[D]:D,N.push([O,255&P,P<<16>>>24,P<<8>>>24,P>>>24]);const E=e.LODInfos,J=[];for(D=0;D<E.levels.length;D++)J.push(new(0,o.default)({level:E.levels[D],resolution:E.resolutions[D],scale:96/.0254*E.resolutions[D]}));const B=new(0,d.default)({dpi:96,lods:J,format:C,origin:F,size:[s,l],spatialReference:b}),A={recordSize:8,packetSize:e.packetSize,headerSize:e.packetSize*e.packetSize*8+64},z=[{maxCol:Math.ceil(S/s)-1,maxRow:Math.ceil(R/l)-1,minCol:0,minRow:0}];let L=2;if(h>0)for(D=0;D<h;D++)z.push({maxCol:Math.ceil(S/L/s)-1,maxRow:Math.ceil(R/L/l)-1,minCol:0,minRow:0}),L*=2;const H=e.mdInfo;let V=null;if(H&&k._yxs){const e=k._yxs;V={packetSize:e.PacketSize,tileSize:[e.TileXSize,e.TileYSize]}}return{storageInfo:A,rasterInfo:new(0,u.default)({width:S,height:R,pixelType:i,bandCount:n,extent:w,nativeExtent:T,transform:_,spatialReference:b,pixelSize:I,keyProperties:k,statistics:p,histograms:r,multidimensionalInfo:H,colormap:N,storageInfo:new(0,c.default)({blockWidth:s,blockHeight:l,pyramidBlockWidth:s,pyramidBlockHeight:l,origin:F,tileInfo:B,transposeInfo:V,firstPyramidLevel:f,maximumPyramidLevel:h,blockBoundary:z})})}}_parseTransform(e){var t,i;if(!(0,p.isTransformSupported)(e))throw new(0,a.default)("cloudraster:open","the data contains unsupported geodata transform types");const n=(0,p.readTransform)(e);if("identity"===n.type)return null;if("polynomial"!==n.type||!(null===(t=n.forwardCoefficients)||void 0===t?void 0:t.length)||!(null===(i=n.inverseCoefficients)||void 0===i?void 0:i.length))throw new(0,a.default)("cloudraster:open","the data contains unsupported geodata transforms - both forward and inverse coefficients are required currently");return n}async _fetchAuxiliaryInformation(e){const t=this.request(this.url+"/conf.vat.json",{signal:e}).then((e=>e.data)).catch((()=>null)),i=this.request(this.url+"/conf.vat.dbf",{responseType:"array-buffer",signal:e}).then((e=>e.data)).catch((()=>null)),n=await Promise.all([t,i]);let r;if(n[0]){let e=n[0].fields;const t=n[0].values;if(e&&t){e=e.map((e=>({type:"OID"===e.name?"esriFieldTypeOID":v.get(e.type),name:e.name,alias:e.alias||e.name})));const i=t.map((e=>({attributes:e})));e&&t&&(r={fields:e,features:i})}}return!r&&n[1]&&(r=h.default.parse(n[1]).recordSet),m.default.fromJSON(r)}_buildCacheFilePath(e,t,i,n,r){const a=this._getPackageSize(!!r),s=Math.floor(t/a)*a,l=Math.floor(i/a)*a,o="R"+this._toHexString4(s)+"C"+this._toHexString4(l);let u="L";u+=e>=10?e.toString():"0"+e.toString();const{multidimensionalInfo:c}=this.rasterInfo,d=null==n?void 0:n[0];if(null==c||!d)return`${this.url}/_alllayers/${u}/${o}.bundle`;let f="_yxs";if(!r){f=c.variables.find((e=>e.name===d.variableName)).dimensions[0].values.indexOf(d.values[0]).toString(16);const e=4-f.length;for(let t=0;t<e;t++)f="0"+f;f="S"+f}const h=this._getVariableFolderName(r||d.variableName);return`${this.url}/_alllayers/${h}/${f}/${u}/${o}.bundle`}_getPackageSize(e=!1){const{transposeInfo:t}=this.rasterInfo.storageInfo;var i;return e&&null!=t?null!==(i=t.packetSize)&&void 0!==i?i:0:this.storageInfo.packetSize}_getTileSize(e=!1){const{storageInfo:t}=this.rasterInfo,{transposeInfo:i}=t;return e&&null!=i?i.tileSize:t.tileInfo.size}_getVariableFolderName(e){return""===(e=e.trim())?"_v":e.replaceAll(/[\{|\}\-]/g,"_").replace("\\*","_v")}_getIndexRecordFromBundle(e,t,i=!1){const n=this._getPackageSize(i),r=n*(e%n)+t%n;if(r<0)throw new Error("Invalid level / row / col");return 20+r*this.storageInfo.recordSize+44}_getTileEndAndContentType(e,t){const i=e.subarray(t,t+8);let n,r=0;for(n=0;n<5;n++)r|=(255&i[n])<<8*n;const a=0xffffffffff&r;for(r=0,n=5;n<8;n++)r|=(255&i[n])<<8*(n-5);return{position:a,recordSize:0xffffffffff&r}}_toHexString4(e){let t=e.toString(16);if(4!==t.length){let e=4-t.length;for(;e-- >0;)t="0"+t}return t}constructor(){super(...arguments),this.storageInfo=null,this.datasetFormat="CRF"}};(0,r._)([(0,s.property)({readOnly:!0})],b.prototype,"storageInfo",void 0),(0,r._)([(0,s.property)({type:String,json:{write:!0}})],b.prototype,"datasetFormat",void 0),b=(0,r._)([(0,l.subclass)("esri.layers.support.rasterDatasets.CloudRaster")],b);const w=b})),t.register("0fPji",(function(i,n){e(i.exports,"default",(function(){return s}));var r=t("bN8ex");function a(e){const t=e.fields,i=e.records,n=t.some((e=>"oid"===e.name.toLowerCase()))?"OBJECTID":"OID",r=[{name:n,type:"esriFieldTypeOID",alias:"OID"}].concat(t.map((e=>({name:e.name,type:"esriFieldType"+e.typeName,alias:e.name})))),a=r.map((e=>e.name)),s=[];let l=0,o=0;return i.forEach((e=>{const t={};for(t[n]=l++,o=1;o<a.length;o++)t[a[o]]=e[o-1];s.push({attributes:t})})),{displayFieldName:"",fields:r,features:s}}class s{static get supportedVersions(){return[5]}static parse(e){const t=new DataView(e),i=3&t.getUint8(0);if(3!==i)return{header:{version:i},recordSet:null};const n=t.getUint32(4,!0),s=t.getUint16(8,!0),l=t.getUint16(10,!0),o={version:i,recordCount:n,headerByteCount:s,recordByteCount:l};let u=32;const c=[],d=[];let f;if(3===i){for(;13!==t.getUint8(u);)f=String.fromCharCode(t.getUint8(u+11)).trim(),c.push({name:(0,r.bytesToUTF8)(new Uint8Array(e,u,11)),type:f,typeName:["String","Date","Double","Boolean","String","Integer"][["C","D","F","L","M","N"].indexOf(f)],length:t.getUint8(u+16)}),u+=32;if(u+=1,c.length>0)for(;d.length<n&&e.byteLength-u>l;){const i=[];32===t.getUint8(u)?(u+=1,c.forEach((t=>{if("C"===t.type)i.push((0,r.bytesToUTF8)(new Uint8Array(e,u,t.length)).trim());else if("N"===t.type)i.push(parseInt(String.fromCharCode.apply(null,new Uint8Array(e,u,t.length)).trim(),10));else if("F"===t.type)i.push(parseFloat(String.fromCharCode.apply(null,new Uint8Array(e,u,t.length)).trim()));else if("D"===t.type){const n=String.fromCharCode.apply(null,new Uint8Array(e,u,t.length)).trim();i.push(new Date(parseInt(n.substring(0,4),10),parseInt(n.substring(4,6),10)-1,parseInt(n.substring(6,8),10)))}u+=t.length})),d.push(i)):u+=l}}return{header:o,fields:c,records:d,recordSet:a({fields:c,records:d})}}}})),t.register("5K49h",(function(i,n){e(i.exports,"default",(function(){return v}));var r=t("7eJjO");t("2ILM8");var a=t("kyj08"),s=t("2VlWd"),l=t("10vEZ"),o=t("iho5X");t("iJAIC"),t("lNwWH");var u=t("fcwIv"),c=t("5EhGd"),d=t("7pJ9D"),f=t("iIUME"),h=t("2G55A"),p=t("zMMQr"),m=t("kSbmb"),y=t("j40xv"),g=t("gINRd");let x=class extends c.default{async open(e){await this.init();const t=await this._fetchData(e);let{spatialReference:i,statistics:n,histograms:r,transform:a}=await this._fetchAuxiliaryData(e);const s=!i;s&&(i=new(0,y.default)({wkid:3857})),(null==r?void 0:r.length)&&null==n&&(n=(0,p.estimateStatisticsFromHistograms)(r));const{width:l,height:o}=t;let u=new(0,g.default)({xmin:-.5,ymin:.5-o,xmax:l-.5,ymax:.5,spatialReference:i});const c=a?a.forwardTransform(u):u;let f=!0;if(a){const e=a.forwardCoefficients;f=e&&0===e[1]&&0===e[2],f&&(a=null,u=c)}const h=new(0,d.default)({data:{extent:c,nativeExtent:u,transform:a,pixelBlock:t,statistics:n,histograms:r,keyProperties:{DateType:"Processed"},isPseudoSpatialReference:s}});await h.open(),h.data=null,this._set("rasterInfo",h.rasterInfo),this._inMemoryRaster=h}fetchRawTile(e,t,i,n={}){return this._inMemoryRaster.fetchRawTile(e,t,i,n)}async _fetchData(e){const{data:t}=await this.request(this.url,{responseType:"array-buffer",signal:null==e?void 0:e.signal}),i=(0,h.getFormat)(t).toUpperCase();if("JPG"!==i&&"PNG"!==i&&"GIF"!==i&&"BMP"!==i)throw new(0,a.default)("image-aux-raster:open","the data is not a supported format");this._set("datasetFormat",i);const n=i.toLowerCase(),r="gif"===n||"bmp"===n||!(0,s.default)("ios"),l=await this.decodePixelBlock(t,{format:n,useCanvas:r,hasNoZlibMask:!0});if(null==l)throw new(0,a.default)("image-aux-raster:open","the data cannot be decoded");return l}async _fetchAuxiliaryData(e){var t,i;const n=null==e?void 0:e.signal,r=null!==(i=this.ioConfig.skipExtensions)&&void 0!==i?i:[],a=r.includes("aux.xml")?null:this.request(this.url+".aux.xml",{responseType:"xml",signal:n}),s=this.datasetFormat,o="JPG"===s?"jgw":"PNG"===s?"pgw":"BMP"===s?"bpw":null,u=o&&r.includes(o)?null:this.request(this.url.slice(0,this.url.lastIndexOf("."))+"."+o,{responseType:"text",signal:n}),c=await(0,l.eachAlways)([a,u]);if(null==n?void 0:n.aborted)throw(0,l.createAbortError)();const d=(0,f.parsePAMInfo)(null===(t=c[0].value)||void 0===t?void 0:t.data);if(!d.transform){const e=c[1].value?c[1].value.data.split("\n").slice(0,6).map((e=>Number(e))):null;d.transform=6===(null==e?void 0:e.length)?new(0,m.default)({forwardCoefficients:[e[4],e[5],e[0],-e[1],e[2],-e[3]]}):null}return d}};(0,r._)([(0,o.property)({type:String,json:{write:!0}})],x.prototype,"datasetFormat",void 0),x=(0,r._)([(0,u.subclass)("esri.layers.support.rasterDatasets.ImageAuxRaster")],x);const v=x})),t.register("7pJ9D",(function(i,n){e(i.exports,"default",(function(){return y}));var r=t("7eJjO");t("2ILM8");var a=t("kyj08"),s=t("10vEZ"),l=t("iho5X");t("iJAIC"),t("lNwWH"),t("2VlWd");var o=t("fcwIv"),u=t("d0bii"),c=t("5EhGd"),d=t("alctY"),f=t("zMMQr"),h=t("gINRd"),p=t("j40xv");let m=class extends c.default{async open(e){var t,i;await this.init();const n=this.data,{pixelBlock:r,statistics:a,histograms:s,name:l,keyProperties:o,nativeExtent:c,transform:d}=this.data,{width:f,height:m,pixelType:y}=r,g=null!==(t=n.extent)&&void 0!==t?t:new(0,h.default)({xmin:-.5,ymin:.5,xmax:f-.5,ymax:m-.5,spatialReference:new(0,p.default)({wkid:3857})}),x=null!==(i=n.isPseudoSpatialReference)&&void 0!==i?i:!n.extent,v={x:g.width/f,y:g.height/m},b=new(0,u.default)({width:f,height:m,pixelType:y,extent:g,nativeExtent:c,transform:d,pixelSize:v,spatialReference:g.spatialReference,bandCount:r.pixels.length,keyProperties:o||{},statistics:a,isPseudoSpatialReference:x,histograms:s});this.createRemoteDatasetStorageInfo(b,512,512),this._set("rasterInfo",b),this.updateTileInfo(),await this._buildInMemoryRaster(r,{width:512,height:512},e),this.datasetName=l,this.url="/InMemory/"+l}fetchRawTile(e,t,i,n={}){const r=this._pixelBlockTiles.get(`${e}/${t}/${i}`);return Promise.resolve(r)}async _buildInMemoryRaster(e,t,i){var n,r;const l=this.rasterInfo.storageInfo.maximumPyramidLevel,o=this.rasterJobHandler?this.rasterJobHandler.split({pixelBlock:e,tileSize:t,maximumPyramidLevel:l},i):Promise.resolve((0,d.split)(e,t,l)),u=null!=this.rasterInfo.statistics,c=null!=this.rasterInfo.histograms,h=u?Promise.resolve({statistics:null,histograms:null}):this.rasterJobHandler?this.rasterJobHandler.estimateStatisticsHistograms({pixelBlock:e},i):Promise.resolve((0,f.estimateStatisticsHistograms)(e)),p=await(0,s.eachAlways)([o,h]);if(!p[0].value&&p[1].value)throw new(0,a.default)("inmemory-raster:open","failed to build in memory raster");this._pixelBlockTiles=p[0].value,u||(this.rasterInfo.statistics=null===(n=p[1].value)||void 0===n?void 0:n.statistics),c||(this.rasterInfo.histograms=null===(r=p[1].value)||void 0===r?void 0:r.histograms)}constructor(){super(...arguments),this.datasetFormat="MEMORY",this.data=null}};(0,r._)([(0,l.property)({type:String,json:{write:!0}})],m.prototype,"datasetFormat",void 0),(0,r._)([(0,l.property)()],m.prototype,"data",void 0),m=(0,r._)([(0,o.subclass)("esri.layers.support.rasterDatasets.InMemoryRaster")],m);const y=m})),t.register("iIUME",(function(i,n){e(i.exports,"parseSpatialReference",(function(){return u})),e(i.exports,"parsePAMInfo",(function(){return d})),t("2ILM8");var r=t("lNwWH"),a=t("6RP1g"),s=t("kSbmb"),l=t("j40xv");function o(e,t){if(!e||!t)return null;const i=[];for(let n=0;n<e.length;n++)i.push(e[n]),i.push(t[n]);return i}function u(e){if(!e)return null;let t=Number(e);if(!isNaN(t)&&0!==t)return new(0,l.default)({wkid:t});if((e=String(e)).startsWith("COMPD_CS")){if(!e.includes("VERTCS")||!e.includes("GEOGCS")&&!e.startsWith("PROJCS"))return null;const i=e.indexOf("VERTCS"),n=e.indexOf("PROJCS"),r=n>-1?n:e.indexOf("GEOGCS");if(-1===r)return null;const a=e.slice(r,e.lastIndexOf("]",i)+1).trim(),s=e.slice(i,e.lastIndexOf("]")).trim();t=c(a);const o=new(0,l.default)(t?{wkid:t}:{wkt:a}),u=c(s);return u&&(o.vcsWkid=u),o}return e.startsWith("GEOGCS")||e.startsWith("PROJCS")?(t=c(e),new(0,l.default)(0!==t?{wkid:t}:{wkt:e})):null}function c(e){var t;const i=e.replaceAll("]","[").replaceAll('"',"").split("[").map((e=>e.trim())).filter((e=>""!==e)),n=i[i.length-1].split(","),r=null===(t=n[0])||void 0===t?void 0:t.toLowerCase();if(("epsg"===r||"esri"===r)&&e.endsWith('"]]')){const e=Number(n[1]);if(!isNaN(e)&&0!==e)return e}return 0}function d(e){var t;if("pamdataset"!==(null===(t=null==e?void 0:e.documentElement.tagName)||void 0===t?void 0:t.toLowerCase()))return{};const i={spatialReference:null,transform:null,metadata:{},rasterBands:[],statistics:null,histograms:null};e.documentElement.childNodes.forEach((e=>{if(1===e.nodeType)if((0,a.isSameTagIgnoreNS)(e,"SRS")){if(!i.spatialReference){const t=(0,a.getElementValue)(e);i.spatialReference=u(t)}}else if((0,a.isSameTagIgnoreNS)(e,"Metadata"))if("xml:ESRI"===e.getAttribute("domain")){const{spatialReference:t,transform:n}=function(e){const t=(0,a.getElement)(e,"GeodataXform"),i=u((0,a.getElementNumericValue)(t,"SpatialReference/WKID")||(0,a.getElementValue)(t,"SpatialReference/WKT"));if("typens:PolynomialXform"!==t.getAttribute("xsi:type"))return{spatialReference:i,transform:null};var n;const r=null!==(n=(0,a.getElementNumericValue)(t,"PolynomialOrder"))&&void 0!==n?n:1,l=(0,a.getElementNumericValues)(t,"CoeffX/Double"),c=(0,a.getElementNumericValues)(t,"CoeffY/Double"),d=(0,a.getElementNumericValues)(t,"InverseCoeffX/Double"),f=(0,a.getElementNumericValues)(t,"InverseCoeffY/Double"),h=o(l,c),p=o(d,f);return{spatialReference:i,transform:h&&p&&h.length&&p.length?new(0,s.default)({spatialReference:i,polynomialOrder:r,forwardCoefficients:h,inverseCoefficients:p}):null}}(e);i.transform=n,i.spatialReference||(i.spatialReference=t)}else(0,a.getElements)(e,"MDI").forEach((e=>i.metadata[e.getAttribute("key")]=(0,a.getElementValue)(e)));else if((0,a.isSameTagIgnoreNS)(e,"PAMRasterBand")){const t=function(e){var t;const i=(0,a.getElementNumericValue)(e,"NoDataValue"),n=(0,a.getElement)(e,"Histograms/HistItem"),r=(0,a.getElementNumericValue)(n,"HistMin"),s=(0,a.getElementNumericValue)(n,"HistMax"),l=(0,a.getElementNumericValue)(n,"BucketCount"),o=null===(t=(0,a.getElementValue)(n,"HistCounts"))||void 0===t?void 0:t.split("|").map((e=>Number(e)));let u,c,d,f;(0,a.getElements)(e,"Metadata/MDI").forEach((e=>{var t;const i=Number(null!==(t=e.textContent)&&void 0!==t?t:e.nodeValue);switch(e.getAttribute("key").toUpperCase()){case"STATISTICS_MINIMUM":u=i;break;case"STATISTICS_MAXIMUM":c=i;break;case"STATISTICS_MEAN":d=i;break;case"STATISTICS_STDDEV":f=i}}));const h=(0,a.getElementNumericValue)(e,"Metadata/SourceBandIndex");return{noDataValue:i,histogram:(null==o?void 0:o.length)&&null!=r&&null!=s?{min:r,max:s,size:l||o.length,counts:o}:null,sourceBandIndex:h,statistics:null!=u&&null!=c?{min:u,max:c,avg:d,stddev:f}:null}}(e);null!=t.sourceBandIndex&&null==i.rasterBands[t.sourceBandIndex]?i.rasterBands[t.sourceBandIndex]=t:i.rasterBands.push(t)}}));const n=i.rasterBands;if(n.length){const e=!!n[0].statistics;i.statistics=e?n.map((e=>e.statistics)).filter(r.isSome):null;const t=!!n[0].histogram;i.histograms=t?n.map((e=>e.histogram)).filter(r.isSome):null}return i}})),t.register("6RP1g",(function(t,i){function n(e,t){if(!e||!t)return[];let i=t;t.includes("/")?(i=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";const r=[];if(t){const a=n(e,i);for(let e=0;e<a.length;e++)n(a[e],t).forEach((e=>r.push(e)));return r}const a=e.getElementsByTagNameNS("*",i);if(!a||0===a.length)return[];for(let e=0;e<a.length;e++)r.push(a[e]||a.item(e));return r}function r(e,t){if(!e||!t)return null;let i=t;t.includes("/")?(i=t.slice(0,t.indexOf("/")),t=t.slice(t.indexOf("/")+1)):t="";const a=n(e,i);return a.length>0?t?r(a[0],t):a[0]:null}function a(e,t=null){const i=t?r(e,t):e;let n;return i?(n=i.textContent||i.nodeValue,n?n.trim():null):null}function s(e,t){return function(e,t){const i=n(e,t),r=[];let a;for(let e=0;e<i.length;e++)a=i[e].textContent||i[e].nodeValue,a&&(a=a.trim(),""!==a&&r.push(a));return r}(e,t).map((e=>Number(e)))}function l(e,t){const i=a(e,t);return Number(i)}function o(e,t){var i;const n=null==e||null===(i=e.nodeName)||void 0===i?void 0:i.toLowerCase(),r=t.toLowerCase();return n.slice(n.lastIndexOf(":")+1)===r}e(t.exports,"getElements",(function(){return n})),e(t.exports,"getElement",(function(){return r})),e(t.exports,"getElementValue",(function(){return a})),e(t.exports,"getElementNumericValues",(function(){return s})),e(t.exports,"getElementNumericValue",(function(){return l})),e(t.exports,"isSameTagIgnoreNS",(function(){return o}))})),t.register("jbz8w",(function(i,n){e(i.exports,"default",(function(){return I}));var r=t("7eJjO");t("2ILM8");var a=t("kyj08"),s=t("7qybv"),l=t("kYueh"),o=t("iho5X");t("iJAIC"),t("lNwWH"),t("2VlWd");var u=t("fcwIv"),c=t("d0bii"),d=t("cQADC"),f=t("xQ42o"),h=t("9UGCQ"),p=t("5EhGd"),m=t("alctY"),y=t("h5QJK"),g=t("61FIV"),x=t("j40xv"),v=t("d1Fqh"),b=t("gINRd");let w=class extends p.default{async open(e){var t,i;await this.init();const n=e&&e.signal,r=this.sourceJSON?{data:this.sourceJSON}:await this.request(this.url,{query:{f:"json"},signal:n});r.ssl&&(this.url=this.url.replace(/^http:/i,"https:"));const o=r.data;if(this.sourceJSON=o,!o)throw new(0,a.default)("imageserverraster:open","cannot initialize tiled image service, missing service info");if(!o.tileInfo)throw new(0,a.default)("imageserverraster:open","use ImageryLayer to open non-tiled image services");this._fixScaleInServiceInfo();var u;this.tileType=o.cacheType,null==this.tileType&&(["jpg","jpeg","png","png8","png24","png32","mixed"].includes(o.tileInfo.format.toLowerCase())?this.tileType="Map":"lerc"===o.tileInfo.format.toLowerCase()?this.tileType="Elevation":this.tileType="Raster"),this.datasetName=null!==(u=null===(t=o.name)||void 0===t?void 0:t.slice(o.name.indexOf("/")+1))&&void 0!==u?u:"";const c=await this._fetchRasterInfo({signal:n});if(null==c)throw new(0,a.default)("image-server-raster:open","cannot initialize image service");const p="Map"===this.tileType?function(e,t){if(!e)return null;const{minScale:i,maxScale:n,minLOD:r,maxLOD:a}=t;if(null!=r&&null!=a)return f.default.fromJSON({...e,lods:e.lods.filter((({level:e})=>null!=e&&e>=r&&e<=a))});if(0!==i&&0!==n){const t=e=>Math.round(1e4*e)/1e4,r=i?t(i):1/0,a=n?t(n):-1/0;return f.default.fromJSON({...e,lods:e.lods.filter((e=>{const i=t(e.scale);return i<=r&&i>=a}))})}return f.default.fromJSON(e)}(o.tileInfo,o):f.default.fromJSON(o.tileInfo);(0,s.assertIsSome)(p);const[m,y]=this._computeMinMaxLOD(c,p),{extent:g,pixelSize:x}=c,v=.5/c.width*x.x,b=Math.max(x.x,x.y),{lods:w}=p;("Map"!==this.tileType&&0!==o.maxScale||Math.abs(x.x-x.y)>v||!w.some((e=>Math.abs(e.resolution-b)<v)))&&(x.x=x.y=m.resolution,c.width=Math.ceil((g.xmax-g.xmin)/x.x-.1),c.height=Math.ceil((g.ymax-g.ymin)/x.y-.1));const I=m.level-y.level,[S,R]=p.size,_=[],T=[];w.forEach(((e,t)=>{e.level>=y.level&&e.level<=m.level&&_.push({x:e.resolution,y:e.resolution}),t<w.length-1&&T.push(Math.round(10*e.resolution/w[t+1].resolution)/10)})),_.sort(((e,t)=>e.x-t.x));const M=this.computeBlockBoundary(g,S,R,p.origin,_,I),k=_.length>1?_.slice(1):null;let C;var F,N;o.transposeInfo&&(C={tileSize:[o.transposeInfo.rows,o.transposeInfo.cols],packetSize:null!==(F=null===(i=c.keyProperties)||void 0===i?void 0:i._yxs.PacketSize)&&void 0!==F?F:0});const D=T.length<=1||T.length>=3&&T.slice(0,T.length-1).every((e=>e===T[0]))?null!==(N=T[0])&&void 0!==N?N:2:Math.round(10/(y.resolution/m.resolution)**(-1/I))/10;if(c.storageInfo=new(0,d.default)({blockWidth:p.size[0],blockHeight:p.size[1],pyramidBlockWidth:p.size[0],pyramidBlockHeight:p.size[1],pyramidResolutions:k,pyramidScalingFactor:D,compression:p.format,origin:p.origin,firstPyramidLevel:1,maximumPyramidLevel:I,tileInfo:p,transposeInfo:C,blockBoundary:M}),this._fixGCSShift(c),this._set("rasterInfo",c),o.capabilities.toLowerCase().includes("tilemap")){const e={tileInfo:c.storageInfo.tileInfo,parsedUrl:(0,l.urlToObject)(this.url),url:this.url,tileServers:[]};this._tilemapCache=new(0,h.TilemapCache)({layer:e})}}async fetchRawTile(e,t,i,n={}){const{storageInfo:r,extent:a}=this.rasterInfo,{transposeInfo:s}=r,l=null!=s&&!!n.transposedVariableName;if(this._slices&&!l&&null==n.sliceId)return null;const o=l?0:r.maximumPyramidLevel-e+this._levelOffset,u=`${this.url}/tile/${o}/${t}/${i}`,c=this._slices?l?{variable:n.transposedVariableName}:{sliceId:n.sliceId||0}:null,{data:d}=await this.request(u,{query:c,responseType:"array-buffer",signal:n.signal});if(!d)return null;const f=l?s.tileSize:r.tileInfo.size,h=await this.decodePixelBlock(d,{width:f[0],height:f[1],planes:null,pixelType:null,isPoint:"Elevation"===this.tileType,returnInterleaved:l,noDataValue:this.rasterInfo.noDataValue});if(null==h)return null;const p=r.blockBoundary[e];if("jpg"!==r.compression||i>p.minCol&&i<p.maxCol&&t>p.minRow&&t<p.maxRow)return h;const{origin:y,blockWidth:g,blockHeight:x}=r,{x:v,y:b}=this.getPyramidPixelSize(e),w=Math.round((a.xmin-y.x)/v)%g,I=Math.round((a.xmax-y.x)/v)%g||g,S=Math.round((y.y-a.ymax)/b)%x,R=Math.round((y.y-a.ymin)/b)%x||x,_=i===p.minCol?w:0,T=t===p.minRow?S:0,M=i===p.maxCol?I:g,k=t===p.maxRow?R:x;return(0,m.setValidBoundary)(h,{x:_,y:T},{width:M-_,height:k-T}),h}getSliceIndex(e){if(!this._slices||null==e||0===e.length)return null;const t=e;for(let e=0;e<this._slices.length;e++){const i=this._slices[e].multidimensionalDefinition;if(i.length===t.length&&!i.some((e=>{const i=t.find((t=>e.variableName===t.variableName&&t.dimensionName===e.dimensionName));return!i||(Array.isArray(e.values[0])?`${e.values[0][0]}-${e.values[0][1]}`:e.values[0])!==(Array.isArray(i.values[0])?`${i.values[0][0]}-${i.values[0][1]}`:i.values[0])})))return e}return null}async fetchVariableStatisticsHistograms(e,t){const i=this.request(this.url+"/statistics",{query:{variable:e,f:"json"},signal:t}).then((e=>{var t;return null===(t=e.data)||void 0===t?void 0:t.statistics})),n=this.request(this.url+"/histograms",{query:{variable:e,f:"json"},signal:t}).then((e=>{var t;return null===(t=e.data)||void 0===t?void 0:t.histograms})),r=await Promise.all([i,n]);return r[0]&&r[0].forEach((e=>{e.avg=e.mean,e.stddev=e.standardDeviation})),{statistics:r[0]||null,histograms:r[1]||null}}async computeBestPyramidLevelForLocation(e,t={}){if(!this._tilemapCache)return 0;let i=this.identifyPixelLocation(e,0,t.datumTransformation);if(null===i)return null;let n=0;const{maximumPyramidLevel:r}=this.rasterInfo.storageInfo;let a=r-n+this._levelOffset;const s=i.srcLocation;for(;a>=0;){try{if("available"===await this._tilemapCache.fetchAvailability(a,i.row,i.col,t))break}catch{}if(a--,n++,i=this.identifyPixelLocation(s,n,t.datumTransformation),null===i)return null}return-1===a||null==i?null:n}async _fetchRasterInfo(e){const t=this.sourceJSON;if("Map"===this.tileType){const e=t.fullExtent||t.extent,i=Math.ceil((e.xmax-e.xmin)/t.pixelSizeX-.1),n=Math.ceil((e.ymax-e.ymin)/t.pixelSizeY-.1),r=x.default.fromJSON(t.spatialReference||e.spatialReference),a=new(0,v.default)({x:t.pixelSizeX,y:t.pixelSizeY,spatialReference:r});return new(0,c.default)({width:i,height:n,bandCount:3,extent:b.default.fromJSON(e),spatialReference:r,pixelSize:a,pixelType:"u8",statistics:null,keyProperties:{DataType:"processed"}})}const{signal:i}=e,n=(0,g.fetchServiceRasterInfo)(this.url,this.sourceJSON,{signal:i,query:this.ioConfig.customFetchParameters}),r=t.hasMultidimensions?this.request(`${this.url}/slices`,{query:{f:"json"},signal:i}).then((e=>e.data&&e.data.slices)).catch((()=>null)):null,a=await Promise.all([n,r]);return this._slices=a[1],a[0]}_fixScaleInServiceInfo(){const{sourceJSON:e}=this;e.minScale&&e.minScale<0&&(e.minScale=0),e.maxScale&&e.maxScale<0&&(e.maxScale=0)}_fixGCSShift(e){const{extent:t,spatialReference:i}=e;t.xmin>-1&&t.xmax>181&&(null==i?void 0:i.wkid)&&i.isGeographic&&(e.nativeExtent=e.extent,e.transform=new(0,y.default),e.extent=e.transform.forwardTransform(t))}_computeMinMaxLOD(e,t){const{pixelSize:i}=e,n=.5/e.width*i.x,{lods:r}=t,a=t.lodAt(Math.max.apply(null,r.map((e=>e.level)))),s=t.lodAt(Math.min.apply(null,r.map((e=>e.level)))),{tileType:l}=this;if("Map"===l)return this._levelOffset=r[0].level,[a,s];var o;if("Raster"===l)return[null!==(o=r.find((e=>e.resolution===i.x)))&&void 0!==o?o:a,s];const{minScale:u,maxScale:c}=this.sourceJSON;let d=a;var f;c>0&&(d=r.find((e=>Math.abs(e.scale-c)<n)),d||(d=null!==(f=r.filter((e=>e.scale>c)).sort(((e,t)=>e.scale>t.scale?1:-1))[0])&&void 0!==f?f:a));let h=s;var p;return u>0&&(h=null!==(p=r.find((e=>Math.abs(e.scale-u)<n)))&&void 0!==p?p:s,this._levelOffset=h.level-s.level),[d,h]}constructor(){super(...arguments),this._levelOffset=0,this._tilemapCache=null,this._slices=null,this.datasetFormat="RasterTileServer",this.tileType=null}};(0,r._)([(0,o.property)({type:String,json:{write:!0}})],w.prototype,"datasetFormat",void 0),(0,r._)([(0,o.property)()],w.prototype,"tileType",void 0),w=(0,r._)([(0,u.subclass)("esri.layers.support.rasterDatasets.ImageServerRaster")],w);const I=w})),t.register("ljwGu",(function(i,n){e(i.exports,"default",(function(){return I}));var r=t("7eJjO");t("2ILM8");var a=t("kyj08"),s=t("iho5X");t("iJAIC"),t("lNwWH"),t("2VlWd");var l=t("fcwIv"),o=t("idX6c"),u=t("d0bii"),c=t("cQADC"),d=t("5EhGd"),f=t("iIUME"),h=t("6RP1g"),p=t("ldsnl"),m=t("zMMQr"),y=t("j40xv"),g=t("gINRd"),x=t("d1Fqh");const v=new Map;v.set("Int8","s8"),v.set("UInt8","u8"),v.set("Int16","s16"),v.set("UInt16","u16"),v.set("Int32","s32"),v.set("UInt32","u32"),v.set("Float32","f32"),v.set("Float64","f32"),v.set("Double64","f32");const b=new Map;b.set("none",{blobExtension:".til",isOneSegment:!0,decoderFormat:"bip"}),b.set("lerc",{blobExtension:".lrc",isOneSegment:!1,decoderFormat:"lerc"}),b.set("deflate",{blobExtension:".pzp",isOneSegment:!0,decoderFormat:"deflate"}),b.set("jpeg",{blobExtension:".pjg",isOneSegment:!0,decoderFormat:"jpg"});let w=class extends d.default{async open(e){var t;await this.init(),this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1);const i=e?e.signal:null,n=await this.request(this.url,{responseType:"xml",signal:i}),{rasterInfo:r,files:a}=this._parseHeader(n.data);if(-1===(null===(t=this.ioConfig.skipExtensions)||void 0===t?void 0:t.indexOf("aux.xml"))){const t=await this._fetchAuxiliaryData(e);var s;null!=t&&(r.statistics=null!==(s=t.statistics)&&void 0!==s?s:r.statistics,r.histograms=t.histograms,t.histograms&&null==r.statistics&&(r.statistics=(0,m.estimateStatisticsFromHistograms)(t.histograms)))}this._set("rasterInfo",r),this._files=a;const l=await this.request(a.index,{responseType:"array-buffer",signal:i});this._storageIndex=this._parseIndex(l.data);const{blockWidth:o,blockHeight:u}=this.rasterInfo.storageInfo,c=this.rasterInfo.storageInfo.pyramidScalingFactor,{width:d,height:f}=this.rasterInfo,h=[],p=this._getBandSegmentCount();let y=0,g=-1;for(;y<this._storageIndex.length;){g++;const e=Math.ceil(d/o/c**g)-1,t=Math.ceil(f/u/c**g)-1;y+=(e+1)*(t+1)*p*4,h.push({maxRow:t,maxCol:e,minCol:0,minRow:0})}this.rasterInfo.storageInfo.blockBoundary=h,g>0&&(this.rasterInfo.storageInfo.firstPyramidLevel=1,this.rasterInfo.storageInfo.maximumPyramidLevel=g),this.updateTileInfo()}async fetchRawTile(e,t,i,n={}){const{blockWidth:r,blockHeight:a,blockBoundary:s}=this.rasterInfo.storageInfo,l=s[e];if(!l||l.maxRow<t||l.maxCol<i||l.minRow>t||l.minCol>i)return null;const{bandCount:u,pixelType:c}=this.rasterInfo,{ranges:d,actualTileWidth:f,actualTileHeight:h}=this._getTileLocation(e,t,i);if(!d||0===d.length)return null;if(0===d[0].from&&0===d[0].to){const e=new Uint8Array(r*a);return new(0,o.default)({width:r,height:a,pixels:null,mask:e,validPixelCount:0})}const{bandIds:p}=this.ioConfig,m=this._getBandSegmentCount(),y=[];let g=0;for(g=0;g<m;g++)p&&!p.includes(g)||y.push(this.request(this._files.data,{range:{from:d[g].from,to:d[g].to},responseType:"array-buffer",signal:n.signal}));const x=await Promise.all(y),v=x.map((e=>e.data.byteLength)).reduce(((e,t)=>e+t)),w=new Uint8Array(v);let I=0;for(g=0;g<m;g++)w.set(new Uint8Array(x[g].data),I),I+=x[g].data.byteLength;const S=b.get(this.rasterInfo.storageInfo.compression).decoderFormat,R=await this.decodePixelBlock(w.buffer,{width:r,height:a,format:S,planes:(null==p?void 0:p.length)||u,pixelType:c});if(null==R)return null;let{noDataValue:_}=this.rasterInfo;if(null!=_&&"lerc"!==S&&!R.mask&&(_=_[0],null!=_)){const e=R.width*R.height,t=new Uint8Array(e);if(Math.abs(_)>1e24)for(g=0;g<e;g++)Math.abs((R.pixels[0][g]-_)/_)>1e-6&&(t[g]=1);else for(g=0;g<e;g++)R.pixels[0][g]!==_&&(t[g]=1);R.mask=t}let T=0,M=0;if(f!==r||h!==a){let e=R.mask;if(e)for(g=0;g<a;g++)if(M=g*r,g<h)for(T=f;T<r;T++)e[M+T]=0;else for(T=0;T<r;T++)e[M+T]=0;else for(e=new Uint8Array(r*a),R.mask=e,g=0;g<h;g++)for(M=g*r,T=0;T<f;T++)e[M+T]=1}return R}_parseIndex(e){if(e.byteLength%16>0)throw new Error("invalid array buffer must be multiples of 16");let t,i,n,r,a,s;if(p.isPlatformLittleEndian){for(i=new Uint8Array(e),r=new ArrayBuffer(e.byteLength),n=new Uint8Array(r),a=0;a<e.byteLength/4;a++)for(s=0;s<4;s++)n[4*a+s]=i[4*a+3-s];t=new Uint32Array(r)}else t=new Uint32Array(e);return t}_getBandSegmentCount(){return b.get(this.rasterInfo.storageInfo.compression).isOneSegment?1:this.rasterInfo.bandCount}_getTileLocation(e,t,i){const{blockWidth:n,blockHeight:r,pyramidScalingFactor:a}=this.rasterInfo.storageInfo,{width:s,height:l}=this.rasterInfo,o=this._getBandSegmentCount();let u,c,d,f=0,h=0;for(d=0;d<e;d++)h=a**d,u=Math.ceil(s/n/h),c=Math.ceil(l/r/h),f+=u*c;h=a**e,u=Math.ceil(s/n/h),c=Math.ceil(l/r/h),f+=t*u+i,f*=4*o;const p=this._storageIndex.subarray(f,f+4*o);let m=0,y=0;const g=[];for(let e=0;e<o;e++)m=p[4*e]*2**32+p[4*e+1],y=m+p[4*e+2]*2**32+p[4*e+3],g.push({from:m,to:y});return{ranges:g,actualTileWidth:i<u-1?n:Math.ceil(s/h)-n*(u-1),actualTileHeight:t<c-1?r:Math.ceil(l/h)-r*(c-1)}}_parseHeader(e){const t=(0,h.getElement)(e,"MRF_META/Raster");if(!t)throw new(0,a.default)("mrf:open","not a valid MRF format");const i=(0,h.getElement)(t,"Size"),n=parseInt(i.getAttribute("x"),10),r=parseInt(i.getAttribute("y"),10),s=parseInt(i.getAttribute("c"),10),l=((0,h.getElementValue)(t,"Compression")||"none").toLowerCase();if(!b.has(l))throw new(0,a.default)("mrf:open","currently does not support compression "+l);const o=(0,h.getElementValue)(t,"DataType")||"UInt8",d=v.get(o);if(null==d)throw new(0,a.default)("mrf:open","currently does not support pixel type "+o);const p=(0,h.getElement)(t,"PageSize"),m=parseInt(p.getAttribute("x"),10),w=parseInt(p.getAttribute("y"),10),I=(0,h.getElement)(t,"DataValues");let S,R;if(I&&(R=I.getAttribute("NoData"),null!=R&&(S=R.trim().split(" ").map((e=>parseFloat(e))))),(0,h.getElement)(e,"MRF_META/CachedSource"))throw new(0,a.default)("mrf:open","currently does not support MRF referencing other data files");const _=(0,h.getElement)(e,"MRF_META/GeoTags"),T=(0,h.getElement)(_,"BoundingBox");let M,k=!1;if(null!=T){const e=parseFloat(T.getAttribute("minx")),t=parseFloat(T.getAttribute("miny")),i=parseFloat(T.getAttribute("maxx")),n=parseFloat(T.getAttribute("maxy")),r=(0,h.getElementValue)(_,"Projection")||"";let a=y.default.WGS84;var C;if("LOCAL_CS[]"!==r)if(r.toLowerCase().startsWith("epsg:")){const e=Number(r.slice(5));isNaN(e)||0===e||(a=new(0,y.default)({wkid:e}))}else a=null!==(C=(0,f.parseSpatialReference)(r))&&void 0!==C?C:y.default.WGS84;else k=!0,a=new(0,y.default)({wkid:3857});M=new(0,g.default)(e,t,i,n),M.spatialReference=a}else k=!0,M=new(0,g.default)({xmin:-.5,ymin:.5-r,xmax:n-.5,ymax:.5,spatialReference:new(0,y.default)({wkid:3857})});const F=(0,h.getElement)(e,"MRF_META/Rsets"),N=parseInt(F&&F.getAttribute("scale")||"2",10),D=M.spatialReference,P=new(0,c.default)({origin:new(0,x.default)({x:M.xmin,y:M.ymax,spatialReference:D}),blockWidth:m,blockHeight:w,pyramidBlockWidth:m,pyramidBlockHeight:w,compression:l,pyramidScalingFactor:N}),O=new(0,x.default)({x:M.width/n,y:M.height/r,spatialReference:D}),E=new(0,u.default)({width:n,height:r,extent:M,isPseudoSpatialReference:k,spatialReference:D,bandCount:s,pixelType:d,pixelSize:O,noDataValue:S,storageInfo:P}),J=(0,h.getElementValue)(e,"datafile"),B=(0,h.getElementValue)(e,"IndexFile");return{rasterInfo:E,files:{mrf:this.url,index:B||this.url.replace(".mrf",".idx"),data:J||this.url.replace(".mrf",b.get(l).blobExtension)}}}async _fetchAuxiliaryData(e){try{const{data:t}=await this.request(this.url+".aux.xml",{responseType:"xml",signal:null==e?void 0:e.signal});return(0,f.parsePAMInfo)(t)}catch{return null}}constructor(){super(...arguments),this._files=null,this._storageIndex=null,this.datasetFormat="MRF"}};(0,r._)([(0,s.property)()],w.prototype,"_files",void 0),(0,r._)([(0,s.property)()],w.prototype,"_storageIndex",void 0),(0,r._)([(0,s.property)({type:String,json:{write:!0}})],w.prototype,"datasetFormat",void 0),w=(0,r._)([(0,l.subclass)("esri.layers.support.rasterIO.MRFRaster")],w);const I=w})),t.register("9Ybm2",(function(i,n){e(i.exports,"default",(function(){return _}));var r=t("7eJjO");t("2ILM8");var a=t("lNwWH"),s=t("kyj08"),l=t("iho5X");t("iJAIC"),t("2VlWd");var o=t("fcwIv"),u=t("d0bii"),c=t("cQADC"),d=t("5EhGd"),f=t("0fPji"),h=t("iIUME"),p=t("3pd1I"),m=t("hP3N4"),y=t("zMMQr"),g=t("kSbmb"),x=t("f4h86"),v=t("j40xv"),b=t("gINRd"),w=t("d1Fqh");const I=(e,t)=>{var i;return null===(i=e.get(t))||void 0===i?void 0:i.values},S=(e,t)=>{var i,n;return null===(i=e.get(t))||void 0===i||null===(n=i.values)||void 0===n?void 0:n[0]};let R=class extends d.default{async open(e){var t,i,n,r;await this.init();const a=e?e.signal:null,{data:l}=await this.request(this.url,{range:{from:0,to:this._bufferSize},responseType:"array-buffer",signal:a});if(!l)throw new(0,s.default)("tiffraster:open","failed to open url "+this.url);this.datasetName=this.url.slice(this.url.lastIndexOf("/")+1,this.url.lastIndexOf("."));const{littleEndian:o,firstIFDPos:u,isBigTiff:c}=(0,p.parseSignature)(l),d=[];await this._readIFDs(d,l,o,u,0,c?8:4,a);const{imageInfo:f,rasterInfo:h}=this._parseIFDs(d),m=(0,p.getPyramidIFDs)(d),y=(0,p.getMaskIFDs)(d);if(this._headerInfo={littleEndian:o,isBigTiff:c,ifds:d,pyramidIFDs:m,maskIFDs:y,...f},this._set("rasterInfo",h),!f.isSupported)throw new(0,s.default)("tiffraster:open","this tiff is not supported: "+f.message);if(!f.tileWidth)throw new(0,s.default)("tiffraster:open","none-tiled tiff is not optimized for access, convert to COG and retry.");const g=null===(t=d[0].get("PREDICTOR"))||void 0===t||null===(i=t.values)||void 0===i?void 0:i[0];if(3===(null===(n=d[0].get("SAMPLEFORMAT"))||void 0===n||null===(r=n.values)||void 0===r?void 0:r[0])&&2===g)throw new(0,s.default)("tiffraster:open","unsupported horizontal difference encoding. Predictor=3 is supported for floatting point data");const{skipExtensions:x=[]}=this.ioConfig;if(!x.includes("aux.xml")){const t=await this._fetchAuxiliaryMetaData(e);null!=t&&this._processPAMInfo(t,h)}x.includes("vat.dbf")||1!==h.bandCount||"u8"!==h.pixelType||(h.attributeTable=await this._fetchAuxiliaryTable(e),null!=h.attributeTable&&(h.keyProperties.DataType="thematic")),this.updateTileInfo()}async fetchRawTile(e,t,i,n={}){var r;if(!(null===(r=this._headerInfo)||void 0===r?void 0:r.isSupported)||this.isBlockOutside(e,t,i))return null;const a=await this._fetchRawTiffTile(e,t,i,!1,n);if(null!=a&&this._headerInfo.hasMaskBand){const r=await this._fetchRawTiffTile(e,t,i,!0,n);null!=r&&r.pixels[0]instanceof Uint8Array&&(a.mask=r.pixels[0])}return a}_parseIFDs(e){var t,i;const n=(0,p.getImageInfo)(e),{width:r,height:a,tileWidth:s,tileHeight:l,planes:o,pixelType:d,compression:f,firstPyramidLevel:m,maximumPyramidLevel:y,pyramidBlockWidth:x,pyramidBlockHeight:R,tileBoundary:_,affine:T,metadata:M}=n,k=(null===(t=n.extent.spatialReference)||void 0===t?void 0:t.wkt)||(null===(i=n.extent.spatialReference)||void 0===i?void 0:i.wkid);let C=(0,h.parseSpatialReference)(k),F=!!n.isPseudoGeographic;null==C&&(F=!0,C=new(0,v.default)({wkid:3857}));const N=new(0,b.default)({...n.extent,spatialReference:C}),D=new(0,w.default)(N?{x:N.xmin,y:N.ymax,spatialReference:C}:{x:0,y:0}),P=new(0,c.default)({blockWidth:s,blockHeight:l,pyramidBlockWidth:x,pyramidBlockHeight:R,compression:f,origin:D,firstPyramidLevel:m,maximumPyramidLevel:y,blockBoundary:_}),O=new(0,w.default)({x:(N.xmax-N.xmin)/r,y:(N.ymax-N.ymin)/a,spatialReference:C}),E=M?{BandProperties:M.bandProperties,DataType:M.dataType}:{};let J=null;const B=S(e[0],"PHOTOMETRICINTERPRETATION"),A=I(e[0],"COLORMAP");if(B<=3&&(null==A?void 0:A.length)>3&&A.length%3==0){J=[];const e=A.length/3;for(let t=0;t<e;t++)J.push([t,A[t]>>>8,A[t+e]>>>8,A[t+2*e]>>>8])}const z=new(0,u.default)({width:r,height:a,bandCount:o,pixelType:d,pixelSize:O,storageInfo:P,spatialReference:C,isPseudoSpatialReference:F,keyProperties:E,extent:N,colormap:J,statistics:M?M.statistics:null});return(null==T?void 0:T.length)&&(z.nativeExtent=new(0,b.default)({xmin:-.5,ymin:.5-a,xmax:r-.5,ymax:.5,spatialReference:C}),z.transform=new(0,g.default)({polynomialOrder:1,forwardCoefficients:[T[2]+T[0]/2,T[5]-T[3]/2,T[0],T[3],-T[1],-T[4]]}),z.extent=z.transform.forwardTransform(z.nativeExtent),z.pixelSize=new(0,w.default)({x:(N.xmax-N.xmin)/r,y:(N.ymax-N.ymin)/a,spatialReference:C}),P.origin.x=-.5,P.origin.y=.5),{imageInfo:n,rasterInfo:z}}_processPAMInfo(e,t){var i;if(t.statistics=null!==(i=e.statistics)&&void 0!==i?i:t.statistics,t.histograms=e.histograms,e.histograms&&null==t.statistics&&(t.statistics=(0,y.estimateStatisticsFromHistograms)(e.histograms)),e.transform&&null==t.transform){t.transform=e.transform,t.nativeExtent=t.extent;const i=t.transform.forwardTransform(t.nativeExtent);t.pixelSize=new(0,w.default)({x:(i.xmax-i.xmin)/t.width,y:(i.ymax-i.ymin)/t.height,spatialReference:t.spatialReference}),t.extent=i}t.isPseudoSpatialReference&&e.spatialReference&&(t.spatialReference=e.spatialReference,t.extent.spatialReference=t.nativeExtent.spatialReference=t.storageInfo.origin.spatialReference=t.spatialReference)}async _readIFDs(e,t,i,n,r,a=4,s){if(!n)return null;(n>=t.byteLength||n<0)&&(t=(await this.request(this.url,{range:{from:n+r,to:n+r+this._bufferSize},responseType:"array-buffer",signal:s})).data,r=n+r,n=0);const l=await this._readIFD(t,i,n,r,m.default.TIFF_TAGS,a,s);if(e.push(l.ifd),!l.nextIFD)return null;await this._readIFDs(e,t,i,l.nextIFD-r,r,a,s)}async _readIFD(e,t,i,n,r=m.default.TIFF_TAGS,s=4,l){if(!e)return null;const o=(0,p.parseIFD)(e,t,i,n,r,s);if(o.success){var u,c;const i=[];if(null===(u=o.ifd)||void 0===u||u.forEach((e=>{e.values||i.push(e)})),i.length>0){const r=i.map((e=>e.offlineOffsetSize)).filter(a.isSome),s=Math.min.apply(null,r.map((e=>e[0])));if(Math.min.apply(null,r.map((e=>e[0]+e[1])))-s<=this._bufferSize){const{data:r}=await this.request(this.url,{range:{from:s,to:s+this._bufferSize},responseType:"array-buffer",signal:l});e=r,n=s,i.forEach((i=>(0,p.parseFieldValues)(e,t,i,n)))}}if(null===(c=o.ifd)||void 0===c?void 0:c.has("GEOKEYDIRECTORY")){const i=o.ifd.get("GEOKEYDIRECTORY"),r=null==i?void 0:i.values;if(r&&r.length>4){const a=r[0]+"."+r[1]+"."+r[2],s=await this._readIFD(e,t,i.valueOffset+6-n,n,m.default.GEO_KEYS,2,l);i.data=s.ifd,i.data&&i.data.set("GEOTIFFVersion",{id:0,type:2,valueCount:1,valueOffset:null,values:[a]})}}return o}if(o.requiredBufferSize&&o.requiredBufferSize!==e.byteLength){const i=await this.request(this.url,{range:{from:n,to:n+o.requiredBufferSize+4},responseType:"array-buffer",signal:l});return(e=i.data).byteLength<o.requiredBufferSize?null:this._readIFD(e,t,0,n,m.default.TIFF_TAGS,4,l)}}async _fetchRawTiffTile(e,t,i,n,r={}){const a=this._getTileLocation(e,t,i,n);if(!a)return null;const{ranges:s,actualTileWidth:l,actualTileHeight:o,ifd:u}=a,c=s.map((e=>this.request(this.url,{range:e,responseType:"array-buffer",signal:r.signal}))),d=await Promise.all(c),f=d.map((e=>e.data.byteLength)).reduce(((e,t)=>e+t)),h=1===d.length?d[0].data:new ArrayBuffer(f),p=[0],m=[0];if(d.length>1){const e=new Uint8Array(h);for(let t=0,i=0;t<d.length;t++){const n=d[t].data;e.set(new Uint8Array(n),i),p[t]=i,i+=n.byteLength,m[t]=n.byteLength}}const{blockWidth:y,blockHeight:g}=this.getBlockWidthHeight(e),x=await this.decodePixelBlock(h,{format:"tiff",customOptions:{headerInfo:this._headerInfo,ifd:u,offsets:p,sizes:m},width:y,height:g,planes:null,pixelType:null});if(null==x)return null;let v,b,w;if(l!==y||o!==g){let e=x.mask;if(e)for(v=0;v<g;v++)if(w=v*y,v<o)for(b=l;b<y;b++)e[w+b]=0;else for(b=0;b<y;b++)e[w+b]=0;else for(e=new Uint8Array(y*g),x.mask=e,v=0;v<o;v++)for(w=v*y,b=0;b<l;b++)e[w+b]=1}return x}_getTileLocation(e,t,i,n=!1){const{firstPyramidLevel:r,blockBoundary:a}=this.rasterInfo.storageInfo,s=0===e?0:e-(r-1),{_headerInfo:l}=this;if(!l)return null;const o=n?l.maskIFDs[s]:0===s?null==l?void 0:l.ifds[0]:null==l?void 0:l.pyramidIFDs[s-1];if(!o)return null;const u=(0,p.isBSQConfig)(o,l),c=I(o,"TILEOFFSETS");if(void 0===c)return null;const d=I(o,"TILEBYTECOUNTS"),{minRow:f,minCol:h,maxRow:m,maxCol:y}=a[s];if(t>m||i>y||t<f||i<h)return null;const g=S(o,"IMAGEWIDTH"),x=S(o,"IMAGELENGTH"),v=S(o,"TILEWIDTH"),b=S(o,"TILELENGTH"),w=[];if(u){const{bandCount:e}=this.rasterInfo;for(let n=0;n<e;n++){const e=n*(m+1)*(y+1)+t*(y+1)+i;w[n]={from:c[e],to:c[e]+d[e]-1}}}else{const e=t*(y+1)+i;w.push({from:c[e],to:c[e]+d[e]-1})}for(let e=0;e<w.length;e++)if(null==w[e].from||!w[e].to)return null;return{ranges:w,ifd:o,actualTileWidth:i===y&&g%v||v,actualTileHeight:t===m&&x%b||b}}async _fetchAuxiliaryMetaData(e){try{const{data:t}=await this.request(this.url+".aux.xml",{responseType:"xml",signal:null==e?void 0:e.signal});return(0,h.parsePAMInfo)(t)}catch{return null}}async _fetchAuxiliaryTable(e){try{const{data:t}=await this.request(this.url+".vat.dbf",{responseType:"array-buffer",signal:null==e?void 0:e.signal}),i=f.default.parse(t);return(null==i?void 0:i.recordSet)?x.default.fromJSON(i.recordSet):null}catch{return null}}constructor(){super(...arguments),this._files=null,this._headerInfo=null,this._bufferSize=1048576,this.datasetFormat="TIFF"}};(0,r._)([(0,l.property)()],R.prototype,"_files",void 0),(0,r._)([(0,l.property)()],R.prototype,"_headerInfo",void 0),(0,r._)([(0,l.property)()],R.prototype,"_bufferSize",void 0),(0,r._)([(0,l.property)({type:String,json:{write:!0}})],R.prototype,"datasetFormat",void 0),R=(0,r._)([(0,o.subclass)("esri.layers.support.rasterDatasets.TIFFRaster")],R);const _=R})),t.register("59jTx",(function(i,n){e(i.exports,"default",(function(){return h}));var r=t("7eJjO"),a=t("79ASa"),s=t("1XAcN"),l=t("iho5X");t("iJAIC"),t("lNwWH"),t("2VlWd");var o=t("bSafx"),u=t("fcwIv");const c=new(0,a.JSONMap)({esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation",esriClassifyDefinedInterval:"defined-interval"}),d=new(0,a.JSONMap)({esriNormalizeByLog:"log",esriNormalizeByPercentOfTotal:"percent-of-total",esriNormalizeByField:"field"});let f=class extends s.JSONSupport{set standardDeviationInterval(e){"standard-deviation"===this.classificationMethod&&this._set("standardDeviationInterval",e)}set definedInterval(e){"defined-interval"===this.classificationMethod&&this._set("definedInterval",e)}constructor(e){super(e),this.type="class-breaks-definition",this.breakCount=null,this.classificationField=null,this.classificationMethod=null,this.normalizationField=null,this.normalizationType=null}};(0,r._)([(0,o.enumeration)({classBreaksDef:"class-breaks-definition"})],f.prototype,"type",void 0),(0,r._)([(0,l.property)({json:{write:!0}})],f.prototype,"breakCount",void 0),(0,r._)([(0,l.property)({json:{write:!0}})],f.prototype,"classificationField",void 0),(0,r._)([(0,l.property)({type:String,json:{read:c.read,write:c.write}})],f.prototype,"classificationMethod",void 0),(0,r._)([(0,l.property)({json:{write:!0}})],f.prototype,"normalizationField",void 0),(0,r._)([(0,l.property)({json:{read:d.read,write:d.write}})],f.prototype,"normalizationType",void 0),(0,r._)([(0,l.property)({value:null,json:{write:!0}})],f.prototype,"standardDeviationInterval",null),(0,r._)([(0,l.property)({value:null,json:{write:!0}})],f.prototype,"definedInterval",null),f=(0,r._)([(0,u.subclass)("esri.rest.support.ClassBreaksDefinition")],f);const h=f})),t.register("hxmJW",(function(i,n){e(i.exports,"createGenerateRendererClassBreaks",(function(){return s}));const r=t("jHOLN").default.getLogger("esri.rest.support.generateRendererUtils");function a(e,t){return Number(e.toFixed(t))}function s(e){const{normalizationTotal:t}=e;return{classBreaks:l(e),normalizationTotal:t}}function l(e){var t;const i=e.definition,{classificationMethod:n,normalizationType:r,definedInterval:s}=i,l=null!==(t=i.breakCount)&&void 0!==t?t:1,f=[];let h=e.values;if(0===h.length)return[];h=h.sort(((e,t)=>e-t));const p=h[0],m=h[h.length-1];if("equal-interval"===n)if(h.length>=l){const e=(m-p)/l;let t=p;for(let i=1;i<l;i++){const n=a(p+i*e,6);f.push({minValue:t,maxValue:n,label:o(t,n,r)}),t=n}f.push({minValue:t,maxValue:m,label:o(t,m,r)})}else h.forEach((e=>{f.push({minValue:e,maxValue:e,label:o(e,e,r)})}));else if("natural-breaks"===n){const t=u(h),i=e.valueFrequency||t.valueFrequency,n=function(e,t,i){const n=e.length,r=[];i>n&&(i=n);for(let e=0;e<i;e++)r.push(Math.round(e*n/i-1));r.push(n-1);let a=c(r,e,t,i);return function(e,t,i,n,r,a){let s=0,l=0,o=0,u=0,c=!0;for(let f=0;f<2&&c;f++){0===f&&(c=!1);for(let f=0;f<a-1;f++)for(;i[f+1]+1!==i[f+2];){i[f+1]=i[f+1]+1;const a=d(f,i,n,r);o=a.sbMean,s=a.sbSdcm;const h=d(f+1,i,n,r);if(u=h.sbMean,l=h.sbSdcm,!(s+l<t[f]+t[f+1])){i[f+1]=i[f+1]-1;break}t[f]=s,t[f+1]=l,e[f]=o,e[f+1]=u,c=!0}for(let f=a-1;f>0;f--)for(;i[f]!==i[f-1]+1;){i[f]=i[f]-1;const a=d(f-1,i,n,r);o=a.sbMean,s=a.sbSdcm;const h=d(f,i,n,r);if(u=h.sbMean,l=h.sbSdcm,!(s+l<t[f-1]+t[f])){i[f]=i[f]+1;break}t[f-1]=s,t[f]=l,e[f-1]=o,e[f]=u,c=!0}}return c}(a.mean,a.sdcm,r,e,t,i)&&(a=c(r,e,t,i)),r}(t.uniqueValues,i,l);let s=p;for(let e=1;e<l;e++)if(t.uniqueValues.length>e){const i=a(t.uniqueValues[n[e]],6);f.push({minValue:s,maxValue:i,label:o(s,i,r)}),s=i}f.push({minValue:s,maxValue:m,label:o(s,m,r)})}else if("quantile"===n)if(h.length>=l&&p!==m){let e=p,t=Math.ceil(h.length/l),i=0;for(let n=1;n<l;n++){let a=t+i-1;a>h.length&&(a=h.length-1),a<0&&(a=0),f.push({minValue:e,maxValue:h[a],label:o(e,h[a],r)}),e=h[a],i+=t,t=Math.ceil((h.length-i)/(l-n))}f.push({minValue:e,maxValue:m,label:o(e,m,r)})}else{let e=-1;for(let t=0;t<h.length;t++){const i=h[t];i!==e&&(e=i,f.push({minValue:e,maxValue:i,label:o(e,i,r)}),e=i)}}else if("standard-deviation"===n){const e=function(e){let t=0;for(let i=0;i<e.length;i++)t+=e[i];return t/=e.length,t}(h),t=function(e,t){let i=0;for(let n=0;n<e.length;n++){const r=e[n];i+=(r-t)*(r-t)}return i/=e.length,Math.sqrt(i)}(h,e);if(0===t)f.push({minValue:h[0],maxValue:h[0],label:o(h[0],h[0],r)});else{const i=function(e,t,i,n,r){let a=Math.max(n-e,t-n)/r/i;return a=a>=1?1:a>=.5?.5:.25,a}(p,m,l,e,t)*t;let n=0,s=p;for(let t=l;t>=1;t--){const l=a(e-(t-.5)*i,6);f.push({minValue:s,maxValue:l,label:o(s,l,r)}),s=l,n++}let u=a(e+.5*i,6);f.push({minValue:s,maxValue:u,label:o(s,u,r)}),s=u,n++;for(let t=1;t<=l;t++)u=n===2*l?m:a(e+(t+.5)*i,6),f.push({minValue:s,maxValue:u,label:o(s,u,r)}),s=u,n++}}else if("defined-interval"===n){if(!s)return f;const e=h[0],t=h[h.length-1],i=Math.ceil((t-e)/s);let n=e;for(let t=1;t<i;t++){const i=a(e+t*s,6);f.push({minValue:n,maxValue:i,label:o(n,i,r)}),n=i}f.push({minValue:n,maxValue:t,label:o(n,t,r)})}return f}function o(e,t,i){let n=null;return n=e===t?i&&"percent-of-total"===i?e+"%":e.toString():i&&"percent-of-total"===i?e+"% - "+t+"%":e+" - "+t,n}function u(e){const t=[],i=[];let n=Number.MIN_VALUE,r=1,a=-1;for(let s=0;s<e.length;s++){const l=e[s];l===n?(r++,i[a]=r):null!==l&&(t.push(l),n=l,r=1,i.push(r),a++)}return{uniqueValues:t,valueFrequency:i}}function c(e,t,i,n){let r=[],a=[],s=[],l=0;const o=[],u=[];for(let r=0;r<n;r++){const n=d(r,e,t,i);o.push(n.sbMean),u.push(n.sbSdcm),l+=u[r]}let c,f=l,h=!0;for(;h||l<f;){h=!1,r=[];for(let t=0;t<n;t++)r.push(e[t]);for(let i=0;i<n;i++)for(let r=e[i]+1;r<=e[i+1];r++)if(c=t[r],i>0&&r!==e[i+1]&&Math.abs(c-o[i])>Math.abs(c-o[i-1]))e[i]=r;else if(i<n-1&&e[i]!==r-1&&Math.abs(c-o[i])>Math.abs(c-o[i+1])){e[i+1]=r-1;break}f=l,l=0,a=[],s=[];for(let r=0;r<n;r++){a.push(o[r]),s.push(u[r]);const n=d(r,e,t,i);o[r]=n.sbMean,u[r]=n.sbSdcm,l+=u[r]}}if(l>f){for(let t=0;t<n;t++)e[t]=r[t],o[t]=a[t],u[t]=s[t];l=f}return{mean:o,sdcm:u}}function d(e,t,i,n){let a=0,s=0;for(let r=t[e]+1;r<=t[e+1];r++){const e=n[r];a+=i[r]*e,s+=e}s<=0&&r.warn("Exception in Natural Breaks calculation");const l=a/s;let o=0;for(let r=t[e]+1;r<=t[e+1];r++)o+=n[r]*(i[r]-l)**2;return{sbMean:l,sbSdcm:o}}})),t.register("fegDl",(function(t,i){function n(e,t){const{attributeTable:i,bandCount:n}=e;return!(null!=i||(r=e,!["u8","s8"].includes(r.pixelType)||null==(null===(a=r.statistics)||void 0===a||null===(s=a[0])||void 0===s?void 0:s.min)||null==(null===(l=r.statistics[0])||void 0===l?void 0:l.max)||1!==r.bandCount))||!(null==i||n>1)&&(!t||null!=i.fields.find((e=>e.name.toLowerCase()===t.toLowerCase())));var r,a,s,l}function r(e){const{bandCount:t,dataType:i,pixelType:n}=e;return"elevation"===i||"generic"===i&&1===t&&("s16"===n||"s32"===n||"f32"===n||"f64"===n)}function a(e,t=!1){const{bandCount:i,colormap:n,pixelType:r}=e;return 1===i&&(!!(null==n?void 0:n.length)||!t&&"u8"===r)}function s(e,t=!1){const{attributeTable:i,bandCount:n}=e;return 1===n&&(!t||null!=i||null!=e.histograms)}function l(e){const{dataType:t}=e;return"vector-uv"===t||"vector-magdir"===t}function o(e){const{dataType:t}=e;return"vector-uv"===t||"vector-magdir"===t}e(t.exports,"isUVRendererSupported",(function(){return n})),e(t.exports,"isShadedReliefRendererSupported",(function(){return r})),e(t.exports,"isColormapRendererSupported",(function(){return a})),e(t.exports,"isClassBreaksSupported",(function(){return s})),e(t.exports,"isVectorFieldRendererSupported",(function(){return l})),e(t.exports,"isFlowRendererSupported",(function(){return o}))}))}();
//# sourceMappingURL=ImageryTileLayer.6c09dfe6.js.map
