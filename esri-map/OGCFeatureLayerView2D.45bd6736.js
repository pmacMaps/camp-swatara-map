!function(){function e(e){return e&&e.__esModule?e.default:e}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire594f;t.register("9QPTU",(function(r,n){var i,a,s,u,o;i=r.exports,Object.defineProperty(i,"__esModule",{value:!0,configurable:!0}),a=r.exports,s="default",u=function(){return Q},Object.defineProperty(a,s,{get:u,set:o,enumerable:!0,configurable:!0});var l=t("8TSCy"),c=t("2TvXO"),d=t("7eJjO"),p=t("34Eys");t("2ILM8");var f=t("bsvXr"),y=t("d2yMj"),h=t("kyj08"),v=t("2VlWd"),g=t("flPLJ"),_=t("jHOLN"),m=t("7qybv"),b=t("10vEZ"),x=t("lKPaD"),k=t("iho5X");t("iJAIC");var S=t("fcwIv"),w=t("9B1Fz"),R=t("krMu9"),T=t("f4h86"),C=t("cRlei"),U=t("4WoSm"),I=t("dIFqf"),O=t("li6vg"),F=t("rIUZZ"),E=t("bPKxZ"),q=t("bTKCC"),V=t("iDjnF"),N=t("9M3e1"),P=t("kvL9S"),L=t("7HdkW"),G=t("30vBn"),z=t("hfthk"),H=t("3NAox"),J=t("gINRd");function A(e){return e&&"openPorts"in e}var M=_.default.getLogger("esri.views.2d.layers.FeatureLayerView2D"),j=function(t){"use strict";l.inherits(n,t);var r=l.createSuper(n);function n(){var t;l.classCallCheck(this,n);var i=l.assertThisInitialized(t);return(t=r.call.apply(r,[this].concat(Array.prototype.slice.call(arguments))))._pipelineIsUpdating=!0,t._commandsQueue=new(0,q.default)({process:function(e){switch(e.type){case"processed-edit":return t._doEdit(e);case"refresh":return t._doRefresh(e.dataChanged);case"update":return t._doUpdate()}}}),t._visibilityOverrides=new Set,t._highlightIds=new Map,t._updateHighlight=(0,b.debounce)(l.asyncToGenerator(e(c).mark((function t(){return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",i._proxy.setHighlight(Array.from(i._highlightIds.keys())));case 1:case"end":return e.stop()}}),t)})))),t._uploadsLocked=!1,t._needsClusterSizeUpdate=!1,t.featureEffectView=new(0,w.default),t._lastDefinitionExpression=null,l.possibleConstructorReturn(t)}return l.createClass(n,[{key:"destroy",value:function(){var e;(0,m.applySome)(this._updateClusterSizeTask,(function(e){return e.remove()})),null==(e=this._proxy)||e.destroy(),this._commandsQueue.destroy()}},{key:"initialize",value:function(){var e=this;this.addResolvingPromise(Promise.all([this._initProxy(),this._initServiceOptions()])),this.handles.add([this.on("valueRangesChanged",(function(t){e._set("_aggregateValueRanges",t.valueRanges)})),(0,x.watch)((function(){return e.featureEffect}),(function(t){e.featureEffectView.featureEffect=t}),{initial:!0,sync:!0})])}},{key:"_initProxy",value:function(){var t=this;return l.asyncToGenerator(e(c).mark((function r(){var n;return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("isTable"in t.layer)||!t.layer.isTable){e.next=2;break}throw new(0,h.default)("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:t.layer});case 2:return t._proxy&&t._proxy.destroy(),n=t._createClientOptions(),e.abrupt("return",(t._set("_proxy",new(0,V.default)({client:n})),t._proxy.when()));case 5:case"end":return e.stop()}}),r)})))()}},{key:"_initServiceOptions",value:function(){var t=this;return l.asyncToGenerator(e(c).mark((function r(){return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=t,e.next=3,t._createServiceOptions();case 3:return e.t1=e.sent,e.t0._set.call(e.t0,"_serviceOptions",e.t1),e.abrupt("return",t._serviceOptions);case 6:case"end":return e.stop()}}),r)})))()}},{key:"orderByFields",get:function(){return"stream"!==this._serviceOptions.type&&this._serviceOptions.orderByFields}},{key:"labelsVisible",get:function(){var e="subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer];return!this.suspended&&e.some((function(e){return e.labelingInfo&&e.labelsVisible}))}},{key:"queryMode",get:function(){return this._serviceOptions.type}},{key:"renderingConfigHash",get:function(){if(!this.layer)return null;var e=this.availableFields,t=this.layer,r=this.view.floors,n=t.definitionExpression,i="subtype-group"!==this.layer.type&&this.layer.labelsVisible&&this.layer.labelingInfo,a="renderer"in t&&t.renderer,s="feature"===t.type?t.gdbVersion:void 0,u="feature"===t.type&&t.historicMoment?t.historicMoment.getTime():void 0,o=this.timeExtent,l="customParameters"in t?JSON.stringify(t.customParameters):void 0,c="apiKey"in t?t.apiKey:void 0,d="stream"===t.type?"".concat(JSON.stringify(t.geometryDefinition)).concat(t.definitionExpression):null,p=JSON.stringify(this.clips),f=t.featureReduction&&t.featureReduction.toJSON(),y="orderBy"in this.layer&&JSON.stringify(this.layer.orderBy),h="sublayers"in this.layer&&this.layer.sublayers.items.reduce((function(e,t){return e+"".concat(t.visible?1:0,".").concat(JSON.stringify(t.renderer),".").concat(t.labelsVisible,"\n.").concat(JSON.stringify(t.labelingInfo))}),"");return JSON.stringify({orderBy:y,sublayerHash:h,filterHash:(0,m.isSome)(this.filter)&&this.filter.toJSON(),effectHash:(0,m.isSome)(this.featureEffect)&&this.featureEffect.toJSON(),streamFilter:d,gdbVersion:s,definitionExpression:n,historicMoment:u,availableFields:e,renderer:a,labelingInfo:i,timeExtent:o,floors:r,clipsHash:p,featureReduction:f,customParameters:l,apiKey:c})}},{key:"highlight",value:function(e){var t,r,n=this;return e instanceof f.default?r=[e.getObjectId()]:"number"==typeof e||"string"==typeof e?r=[e]:Array.isArray(e)&&e.length>0?r="number"==typeof e[0]||"string"==typeof e[0]?e:e.map((function(e){return null==e?void 0:e.getObjectId()})):y.default.isCollection(e)&&e.length>0&&(r=e.map((function(e){return null==e?void 0:e.getObjectId()})).toArray()),(r=null==(t=r)?void 0:t.filter((function(e){return null!=e})))&&r.length?(this._addHighlight(r),{remove:function(){return n._removeHighlight(r)}}):{remove:function(){}}}},{key:"hasHighlight",value:function(){return!!this._highlightIds.size}},{key:"hitTest",value:function(t,r){var n=this;return l.asyncToGenerator(e(c).mark((function t(){var i,a,s,u;return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.tileRenderer){e.next=2;break}return e.abrupt("return",null);case 2:return e.next=4,n.tileRenderer.hitTest(r);case 4:if(0!==(i=e.sent).length){e.next=7;break}return e.abrupt("return",null);case 7:return e.next=9,n._proxy.getFeatures(i);case 9:return a=e.sent,s=a.features,u=a.aggregates,e.abrupt("return",l.toConsumableArray(u.map((function(e){return n._createHittestResult(p.default.fromJSON(e))}))).concat(l.toConsumableArray(s.map((function(e){return n._createHittestResult(f.default.fromJSON(e))})))));case 13:case"end":return e.stop()}}),t)})))()}},{key:"queryAggregates",value:function(){var t=this;return l.asyncToGenerator(e(c).mark((function r(){return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t._proxy.getAggregates();case 2:return e.abrupt("return",e.sent.map((function(e){return p.default.fromJSON(e)})));case 3:case"end":return e.stop()}}),r)})))()}},{key:"queryStatistics",value:function(){return this._proxy.queryStatistics()}},{key:"querySummaryStatistics",value:function(t,r,n){var i=this;return l.asyncToGenerator(e(c).mark((function a(){var s;return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=l.objectSpread({},r,{scale:i.view.scale}),e.abrupt("return",i._proxy.querySummaryStatistics(i._cleanUpQuery(t),s,n));case 2:case"end":return e.stop()}}),a)})))()}},{key:"queryUniqueValues",value:function(t,r,n){var i=this;return l.asyncToGenerator(e(c).mark((function a(){var s;return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=l.objectSpread({},r,{scale:i.view.scale}),e.abrupt("return",i._proxy.queryUniqueValues(i._cleanUpQuery(t),s,n));case 2:case"end":return e.stop()}}),a)})))()}},{key:"queryClassBreaks",value:function(t,r,n){var i=this;return l.asyncToGenerator(e(c).mark((function a(){var s;return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=l.objectSpread({},r,{scale:i.view.scale}),e.abrupt("return",i._proxy.queryClassBreaks(i._cleanUpQuery(t),s,n));case 2:case"end":return e.stop()}}),a)})))()}},{key:"queryHistogram",value:function(t,r,n){var i=this;return l.asyncToGenerator(e(c).mark((function a(){var s;return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=l.objectSpread({},r,{scale:i.view.scale}),e.abrupt("return",i._proxy.queryHistogram(i._cleanUpQuery(t),s,n));case 2:case"end":return e.stop()}}),a)})))()}},{key:"queryFeatures",value:function(e,t){var r=this;return this.queryFeaturesJSON(e,t).then((function(e){var t=r,n=T.default.fromJSON(e);return n.features.forEach((function(e){return t._setLayersForFeature(e)})),n}))}},{key:"queryVisibleFeatures",value:function(e,t){var r=this;return this._proxy.queryVisibleFeatures(this._cleanUpQuery(e),t).then((function(e){var t=r,n=T.default.fromJSON(e);return n.features.forEach((function(e){return t._setLayersForFeature(e)})),n}))}},{key:"queryFeaturesJSON",value:function(e,t){return this._proxy.queryFeatures(this._cleanUpQuery(e),t)}},{key:"queryObjectIds",value:function(e,t){return this._proxy.queryObjectIds(this._cleanUpQuery(e),t)}},{key:"queryFeatureCount",value:function(e,t){return this._proxy.queryFeatureCount(this._cleanUpQuery(e),t)}},{key:"queryExtent",value:function(e,t){return this._proxy.queryExtent(this._cleanUpQuery(e),t).then((function(e){return{count:e.count,extent:J.default.fromJSON(e.extent)}}))}},{key:"setVisibility",value:function(e,t){t?this._visibilityOverrides.delete(e):this._visibilityOverrides.add(e),this._update()}},{key:"update",value:function(e){if(this._tileStrategy&&this.tileRenderer){var t=this._tileStrategy.update(e),r=t.hasMissingTiles,n=t.added,i=t.removed;(n.length||i.length)&&this._proxy.updateTiles({added:n,removed:i}),r&&this.requestUpdate(),this.notifyChange("updating")}}},{key:"attach",value:function(){var e=this;this.view.timeline.record("".concat(this.layer.title," (FeatureLayer) Attach")),this._tileStrategy=new(0,P.TileManager)({acquireTile:function(t){return e._acquireTile(t)},releaseTile:function(t){return e._releaseTile(t)},tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.handles.add((0,x.watch)((function(){return e.renderingConfigHash}),(function(){return e._update()}),x.initial),"attach"),"stream"!==this.layer.type&&this.handles.add(this.layer.on("edits",(function(t){return e._edit(t)})),"attach")}},{key:"detach",value:function(){var e;this._commandsQueue.clear(),null==(e=this._proxy)||e.stop(),this.container.removeAllChildren(),this.handles.remove("attach"),this.tileRenderer&&(this.tileRenderer.uninstall(this.container),this.tileRenderer=null),this._tileStrategy&&(this._tileStrategy.destroy(),this._tileStrategy=null),this._tileRendererHash=null}},{key:"moveStart",value:function(){this.requestUpdate()}},{key:"viewChange",value:function(){this.requestUpdate()}},{key:"moveEnd",value:function(){this.requestUpdate()}},{key:"isUpdating",value:function(){var e,t="renderer"in this.layer&&null!=this.layer.renderer,r=this._commandsQueue.updating,n=null!=this._updatingRequiredFieldsPromise,i=!this._proxy||!this._proxy.isReady,a=this._pipelineIsUpdating,s=null==this.tileRenderer||(null==(e=this.tileRenderer)?void 0:e.updating),u=t&&(r||n||i||a||s);return(0,v.default)("esri-2d-log-updating")&&console.log("Updating FLV2D: ".concat(u,"\n  -> hasRenderer ").concat(t,"\n  -> hasPendingCommand ").concat(r,"\n  -> updatingRequiredFields ").concat(n,"\n  -> updatingProxy ").concat(i,"\n  -> updatingPipeline ").concat(a,"\n  -> updatingTileRenderer ").concat(s,"\n")),u}},{key:"_createClientOptions",value:function(){var e=this;return{setUpdating:function(t){e._set("_pipelineIsUpdating",t)},emitEvent:function(t){e.emit(t.name,t.event)}}}},{key:"_detectQueryMode",value:function(t){var r=this;return l.asyncToGenerator(e(c).mark((function n(){var i,a,s,u,o,l,d,p,f,y,h,g,_,b;return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a="path"in t,s="editingInfo"in r.layer&&(null==(i=r.layer.editingInfo)?void 0:i.lastEditDate),u=!!r.layer.refreshInterval,o=!s&&u,!a||"feature"!==r.layer.type&&"subtype-group"!==r.layer.type||"point"!==r.layer.geometryType||!r.layer.capabilities.query.supportsPagination||r.layer.capabilities.operations.supportsEditing||o||!(0,v.default)("featurelayer-snapshot-enabled")){e.next=17;break}return e.prev=3,e.next=6,r.layer.queryFeatureCount();case 6:if(!((l=e.sent)<=(0,v.default)("featurelayer-snapshot-point-min-threshold"))){e.next=9;break}return e.abrupt("return",{mode:"snapshot",featureCount:l});case 9:if(d=(0,v.default)("featurelayer-snapshot-point-max-threshold"),p=(0,v.default)("featurelayer-snapshot-point-coverage"),f=r.view.extent,y=(0,m.unwrap)(r.layer.fullExtent),h=null==y?void 0:y.clone().intersection(f),g=(0,m.isSome)(h)?h.width*h.height:0,_=(null==y?void 0:y.width)*(null==y?void 0:y.height),b=0===_?0:g/_,!(l<=d&&b>=p)){e.next=12;break}return e.abrupt("return",{mode:"snapshot",featureCount:l});case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(3),M.warn("mapview-feature-layer","Encountered an error when querying for featureCount",{error:e.t0});case 17:return e.abrupt("return",{mode:"on-demand"});case 18:case"end":return e.stop()}}),n,null,[[3,14]])})))()}},{key:"_createServiceOptions",value:function(){var t=this;return l.asyncToGenerator(e(c).mark((function r(){var n,i,a,s,u,o,l,d,p,f,y,h,v,_,b,x,k,S;return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("stream"!==(i=t.layer).type){e.next=4;break}return e.abrupt("return",null);case 4:if(a=i.capabilities,s=i.objectIdField,u=i.fields.map((function(e){return e.toJSON()})),o=(0,m.isSome)(i.fullExtent)&&i.fullExtent.toJSON(),l=(0,N.toJSONGeometryType)(i.geometryType),d=i.timeInfo&&i.timeInfo.toJSON()||null,p=i.spatialReference?i.spatialReference.toJSON():null,f="feature"===i.type?i.globalIdField:null,"ogc-feature"!==i.type){e.next=10;break}y=i.source.getFeatureDefinition(),e.next=17;break;case 10:if(!A(i.source)){e.next=16;break}return e.next=13,i.source.openPorts();case 13:y=e.sent,e.next=17;break;case 16:i.parsedUrl&&(y=(0,g.clone)(i.parsedUrl),"dynamicDataSource"in i&&i.dynamicDataSource&&(y.query={layer:JSON.stringify({source:i.dynamicDataSource})}));case 17:return h="datesInUnknownTimezone"in t.layer&&t.layer.datesInUnknownTimezone,v=null!=(n="subtypeField"in t.layer&&t.layer.subtypeField)?n:null,e.next=21,t._detectQueryMode(y);case 21:return _=e.sent,b=_.mode,x=_.featureCount,k=t.layer.objectIdField,"feature"===t.layer.type&&(0,m.isSome)(t.layer.orderBy)&&t.layer.orderBy.length&&(S=!t.layer.orderBy[0].valueExpression&&t.layer.orderBy[0].field)&&(k=S),e.abrupt("return",{type:b,timeReferenceUnknownClient:h,subtypeField:v,featureCount:x,globalIdField:f,maxRecordCount:a.query.maxRecordCount,tileMaxRecordCount:a.query.tileMaxRecordCount,capabilities:a,fields:u,fullExtent:o,geometryType:l,objectIdField:s,source:y,timeInfo:d,spatialReference:p,orderByFields:k});case 27:case"end":return e.stop()}}),r)})))()}},{key:"_createMemoryServiceOptions",value:function(t){var r=this;return l.asyncToGenerator(e(c).mark((function n(){var i;return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.openPorts();case 2:return i=e.sent,e.abrupt("return",l.objectSpread({},r._createServiceOptions(),{type:"memory",source:i}));case 4:case"end":return e.stop()}}),n)})))()}},{key:"_cleanUpQuery",value:function(e){var t=C.default.from(e)||this.createQuery();return t.outSpatialReference||(t.outSpatialReference=this.view.spatialReference),t}},{key:"_update",value:function(){var t=this;return l.asyncToGenerator(e(c).mark((function r(){return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t._commandsQueue.push({type:"update"}));case 1:case"end":return e.stop()}}),r)})))()}},{key:"_edit",value:function(t){var r=this;return l.asyncToGenerator(e(c).mark((function n(){return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r.suspended){e.next=2;break}return e.abrupt("return",void r._clearTiles());case 2:return e.abrupt("return",r._validateEdit(t)?r._commandsQueue.push({type:"edit",edits:t}):void 0);case 3:case"end":return e.stop()}}),n)})))()}},{key:"doRefresh",value:function(t){var r=this;return l.asyncToGenerator(e(c).mark((function n(){return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r._tileStrategy.tileKeys().length){e.next=2;break}return e.abrupt("return",r.suspended&&t?void r._clearTiles():r._commandsQueue.push({type:"refresh",dataChanged:t}));case 2:case"end":return e.stop()}}),n)})))()}},{key:"_clearTiles",value:function(){this._tileStrategy.tileKeys().length&&(this._proxy.updateTiles({added:[],removed:this._tileStrategy.tileKeys()}),this._tileStrategy.clear(),this.requestUpdate(),this._commandsQueue.clear(),this._update())}},{key:"_validateEdit",value:function(e){var t="globalIdField"in this.layer&&this.layer.globalIdField,r=e.deletedFeatures.some((function(e){return-1===e.objectId||!e.objectId})),n=t&&this.availableFields.includes(t);return r&&!n?(M.error(new(0,h.default)("mapview-apply-edits","Editing the specified service requires the layer's globalIdField, ".concat(t," to be included the layer's outFields for updates to be reflected on the map"))),null):e}},{key:"_doUpdate",value:function(){var t=this;return l.asyncToGenerator(e(c).mark((function r(){var n,i,a,s,u,o,l,d,p,f,y,h;return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!t.destroyed&&t._hasRequiredSupport(t.layer)&&t._tileStrategy){e.next=3;break}return e.abrupt("return");case 3:return n=t.featureEffectView,i=t.filter,e.next=6,t._updateRequiredFields();case 6:if(a=t._getEffectiveRenderer(),s=a.renderer,t._set("_effectiveRenderer",s),u=t._createSchemaConfig(),o=t._createConfiguration(u,i,n.filter),l=t._lastDefinitionExpression!==o.definitionExpression,t._lastDefinitionExpression=o.definitionExpression,d=t._createTileRendererHash(s),"snapshot"===t._serviceOptions.type&&(o.schema.source.featureCount=t._serviceOptions.featureCount),d===t._tileRendererHash){e.next=41;break}return e.next=14,t._initTileRenderer(s);case 14:if("stream"!==(p=t.layer).type){e.next=21;break}return e.next=18,t._initServiceOptions();case 18:e.t0=e.sent,e.next=22;break;case 21:e.t0=t._serviceOptions;case 22:if(f=e.t0,t.tileRenderer.onConfigUpdate(s),e.t1="stream"!==p.type&&A(p.source),!e.t1){e.next=29;break}return e.next=28,p.source.openPorts();case 28:f.source=e.sent;case 29:return y={added:t._tileStrategy.tileKeys(),removed:[]},e.next=32,t._proxy.startup(t.view.featuresTilingScheme,o,f,y);case 32:if(e.t2=t.hasHighlight(),!e.t2){e.next=36;break}return e.next=36,t._proxy.setHighlight(Array.from(t._highlightIds.keys()));case 36:return e.next=38,t._onceTilesUpdated();case 38:t.tileRenderer.onConfigUpdate(s),e.next=59;break;case 41:if(e.t3="snapshot"===t._serviceOptions.type&&l,!e.t3){e.next=46;break}return e.next=45,t.layer.queryFeatureCount();case 45:o.schema.source.featureCount=e.sent;case 46:return e.next=48,t._proxy.update(o);case 48:return((h=e.sent).mesh||h.targets.aggregate)&&t._lockGPUUploads(),e.prev=50,e.next=53,t._proxy.applyUpdate(h);case 53:e.next=58;break;case 55:e.prev=55,e.t4=e.catch(50),(0,b.isAbortError)(e.t4)||M.error(e.t4);case 58:(h.mesh||h.targets.aggregate)&&t._unlockGPUUploads(),t.tileRenderer.onConfigUpdate(s),t._updateClusterSizeVariable(),t._forceAttributeTextureUpload();case 59:t._tileRendererHash=d,t.tileRenderer.invalidateLabels(),t.requestUpdate(),e.next=64;break;case 62:e.prev=62,e.t5=e.catch(0);case 64:case"end":return e.stop()}}),r,null,[[0,62],[50,55]])})))()}},{key:"_doEdit",value:function(t){var r=this;return l.asyncToGenerator(e(c).mark((function n(){return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r._proxy.onEdits(t);case 3:e.next=8;break;case 5:e.prev=5,e.t0=e.catch(0),(0,b.isAbortError)(e.t0);case 8:case"end":return e.stop()}}),n,null,[[0,5]])})))()}},{key:"_doRefresh",value:function(t){var r=this;return l.asyncToGenerator(e(c).mark((function n(){var i;return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r._lockGPUUploads(),e.prev=2,e.next=5,r._proxy.refresh(t);case 5:e.next=10;break;case 7:e.prev=7,e.t0=e.catch(2),(0,b.isAbortError)(e.t0);case 10:r._unlockGPUUploads(),null!=(i=r.layer)&&i.featureReduction&&r._updateClusterSizeVariable();case 11:case"end":return e.stop()}}),n,null,[[2,7]])})))()}},{key:"_updateClusterSizeVariable",value:function(){this._needsClusterSizeUpdate&&(this.tileRenderer.onConfigUpdate(this._effectiveRenderer),this._needsClusterSizeUpdate=!1)}},{key:"_createUpdateClusterSizeTask",value:function(t,r){var n,i=this;return this.watch("_aggregateValueRanges",(n=l.asyncToGenerator(e(c).mark((function n(a){return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i._updateClusterEffectiveRendererSizeVariable(t,r,a),i._needsClusterSizeUpdate=!0,i._uploadsLocked||i._updateClusterSizeVariable();case 1:case"end":return e.stop()}}),n)}))),function(e){return n.apply(this,arguments)}))}},{key:"_updateClusterEffectiveRendererSizeVariable",value:function(t,r,n){var i=this;return l.asyncToGenerator(e(c).mark((function a(){var s,u,o;return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t.dynamicClusterSize&&"visualVariables"in t&&t.visualVariables&&(s=(0,E.findSizeVV)(t.visualVariables),(0,m.isSome)(s)&&"cluster_count"===s.field&&(u=t.visualVariables.indexOf(s),t.visualVariables[u]=(0,E.createClusterCountSizeVariable)(r,n),(o=t.clone()).dynamicClusterSize=!0,i._set("_effectiveRenderer",o)));case 1:case"end":return e.stop()}}),a)})))()}},{key:"_getEffectiveRenderer",value:function(){var e="renderer"in this.layer&&this.layer.renderer,t=this.layer.featureReduction;if((0,m.isSome)(this._updateClusterSizeTask)&&(this._updateClusterSizeTask.remove(),this._updateClusterSizeTask=null),t&&"cluster"===t.type&&(0,E.isClusterCompatibleRenderer)(e)){var r=t,n=[],i=(0,E.createClusterRenderer)(n,e,r,this._aggregateValueRanges);return(0,m.applySome)(this._updateClusterSizeTask,(function(e){return e.remove()})),this._updateClusterSizeTask=this._createUpdateClusterSizeTask(i,r),{renderer:i,aggregateFields:n,featureReduction:t}}return{renderer:e,aggregateFields:[],featureReduction:null}}},{key:"_acquireTile",value:function(e){var t=this,r=this.tileRenderer.acquireTile(e);return r.once("attach",(function(){t.requestUpdate()})),r}},{key:"_releaseTile",value:function(e){this.tileRenderer.releaseTile(e)}},{key:"_initTileRenderer",value:function(t){var r=this;return l.asyncToGenerator(e(c).mark((function n(){var i;return e(c).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,F.createOrReuseTileRenderer)(t,{layerView:r,tileInfoView:r.view.featuresTilingScheme,layer:r.layer});case 2:return i=e.sent,e.abrupt("return",(r.tileRenderer&&(r._tileStrategy.clear(),r.tileRenderer.uninstall(r.container),r.tileRenderer.destroy(),r.tileRenderer=null),r.destroyed?null:(r._proxy.tileRenderer=i,r._set("tileRenderer",i),r.tileRenderer.install(r.container),r.tileRenderer.onConfigUpdate(t),r.requestUpdate(),r.tileRenderer)));case 4:case"end":return e.stop()}}),n)})))()}},{key:"_createTileRendererHash",value:function(e){return"".concat("heatmap"===e.type?"heatmap":"symbol")}},{key:"hasFilter",get:function(){var e=!!("floorInfo"in this.layer&&this.layer.floorInfo&&this.view.floors&&this.view.floors.length);return!!this.filter||e||!!this._visibilityOverrides.size||!!this.timeExtent}},{key:"_injectOverrides",value:function(e){var t=(0,m.isSome)(e)?e.timeExtent:null,r=(0,m.isSome)(this.timeExtent)&&(0,m.isSome)(t)?this.timeExtent.intersection(t):this.timeExtent||t,n=null,i="floorInfo"in this.layer&&this.layer.floorInfo;if(i){var a=(0,m.isSome)(e)&&e.where;n=this._addFloorFilterClause(a)}if(!this._visibilityOverrides.size&&!r&&!i)return(0,m.isSome)(e)?e.toJSON():null;(e=(0,m.isSome)(e)&&e.clone()||new(0,R.default)).timeExtent=r,n&&(e.where=n);var s=e.toJSON();return s.hiddenIds=Array.from(this._visibilityOverrides),s}},{key:"_addFloorFilterClause",value:function(e){var t=this.layer,r=e||"";if("floorInfo"in t&&t.floorInfo){var n,i=this.view.floors;if(!i||!i.length)return r;null!=(n=t.floorInfo.viewAllLevelIds)&&n.length&&(i=t.floorInfo.viewAllLevelIds);var a=i.filter((function(e){return""!==e})).map((function(e){return"'"+e+"'"}));a.push("''");var s=t.floorInfo.floorField,u="("+s+" IN ({ids}) OR "+s+" IS NULL)";if(u=u.replace("{ids}",a.join(", ")),(0,m.isSome)(r)&&r.includes(s)){var o=new RegExp("AND \\("+s+".*NULL\\)","g");r=r.replace(o,""),o=new RegExp("\\("+s+".*NULL\\)","g"),r=(r=r.replace(o,"")).replace(/\s+/g," ").trim()}r=""!==r?"("+r+") AND "+u:u}return""!==r?r:null}},{key:"_createConfiguration",value:function(e,t,r){var n="feature"===this.layer.type&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,i="feature"===this.layer.type?this.layer.gdbVersion:void 0,a=new Array(U.MAX_FILTERS),s=this._injectOverrides(t);a[0]=s,a[1]=(0,m.isSome)(r)?r.toJSON():null;var u=(0,O.createSchema)(e);if((0,m.isNone)(u))return null;var o=(0,H.getWebGL1Capabilities)();return{definitionExpression:this.layer.definitionExpression,availableFields:this.availableFields,gdbVersion:i,historicMoment:n,devicePixelRatio:window.devicePixelRatio||1,filters:a,schema:u,supportsTextureFloat:o.supportsTextureFloat,maxTextureSize:o.maxTextureSize}}},{key:"_hasRequiredSupport",value:function(e){var t;return!("renderer"in e&&"dot-density"===(null==(t=e.renderer)?void 0:t.type)&&!(0,H.getWebGL1Capabilities)().supportsTextureFloat&&(M.error(new(0,h.default)("webgl-missing-extension","Missing WebGL extension OES_Texture_Float which is required for DotDensity")),1))}},{key:"_onceTilesUpdated",value:function(){var e=this;return this.requestUpdate(),(0,x.whenOnce)((function(){return!e._pipelineIsUpdating}))}},{key:"_lockGPUUploads",value:function(){this.tileRenderer&&(this._uploadsLocked=!0,this.tileRenderer.lockGPUUploads())}},{key:"_unlockGPUUploads",value:function(){this.tileRenderer&&(this._uploadsLocked=!1,this.tileRenderer.unlockGPUUploads())}},{key:"_forceAttributeTextureUpload",value:function(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}},{key:"_createSchemaConfig",value:function(){var e="feature"===this.layer.type?this.layer.historicMoment:null,t="feature"===this.layer.type?this.layer.gdbVersion:null;return{renderer:"renderer"in this.layer&&this.layer.renderer,spatialReference:this.layer.spatialReference,timeExtent:this.layer.timeExtent,definitionExpression:this.layer.definitionExpression,featureReduction:this.layer.featureReduction,fields:this.layer.fields,geometryType:this.layer.geometryType,historicMoment:e,labelsVisible:"labelsVisible"in this.layer&&this.layer.labelsVisible,labelingInfo:"labelingInfo"in this.layer&&this.layer.labelingInfo,availableFields:this.availableFields,featureEffect:this.featureEffect,filter:this.filter,gdbVersion:t,pixelBuffer:0,orderBy:"orderBy"in this.layer&&this.layer.orderBy?this.layer.orderBy:null,customParameters:l.objectSpread({},"customParameters"in this.layer?this.layer.customParameters:void 0,{token:"apiKey"in this.layer?this.layer.apiKey:void 0})}}},{key:"_addHighlight",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=e[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var s=i.value;if(this._highlightIds.has(s)){var u=this._highlightIds.get(s);this._highlightIds.set(s,u+1)}else this._highlightIds.set(s,1)}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}this._updateHighlight().catch((function(e){(0,b.isAbortError)(e)||M.error(e)}))}},{key:"_removeHighlight",value:function(e){var t=!0,r=!1,n=void 0;try{for(var i,a=e[Symbol.iterator]();!(t=(i=a.next()).done);t=!0){var s=i.value;if(this._highlightIds.has(s)){var u=this._highlightIds.get(s)-1;0===u?this._highlightIds.delete(s):this._highlightIds.set(s,u)}}}catch(e){r=!0,n=e}finally{try{t||null==a.return||a.return()}finally{if(r)throw n}}this._updateHighlight().catch((function(e){(0,b.isAbortError)(e)||M.error(e)}))}},{key:"_setLayersForFeature",value:function(e){var t=this.layer;e.layer=t,e.sourceLayer=t}},{key:"_createHittestResult",value:function(e){return this._setLayersForFeature(e),(0,m.isSome)(e.geometry)&&(e.geometry.spatialReference=this.view.spatialReference),e}}]),n}((0,L.FeatureLayerView)((0,z.RefreshableLayerView)((0,I.LayerView2DMixin)(G.default))));(0,d._)([(0,k.property)()],j.prototype,"_serviceOptions",void 0),(0,d._)([(0,k.property)()],j.prototype,"_proxy",void 0),(0,d._)([(0,k.property)()],j.prototype,"_pipelineIsUpdating",void 0),(0,d._)([(0,k.property)()],j.prototype,"_effectiveRenderer",void 0),(0,d._)([(0,k.property)()],j.prototype,"_aggregateValueRanges",void 0),(0,d._)([(0,k.property)()],j.prototype,"_commandsQueue",void 0),(0,d._)([(0,k.property)()],j.prototype,"featureEffectView",void 0),(0,d._)([(0,k.property)()],j.prototype,"labelsVisible",null),(0,d._)([(0,k.property)({readOnly:!0})],j.prototype,"queryMode",null),(0,d._)([(0,k.property)()],j.prototype,"renderingConfigHash",null),(0,d._)([(0,k.property)()],j.prototype,"tileRenderer",void 0),(0,d._)([(0,k.property)()],j.prototype,"updating",void 0);var Q=j=(0,d._)([(0,S.subclass)("esri.views.2d.layers.FeatureLayerView2D")],j)}))}();
//# sourceMappingURL=OGCFeatureLayerView2D.45bd6736.js.map
