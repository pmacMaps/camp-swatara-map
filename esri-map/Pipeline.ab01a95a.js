!function(){function e(e){return e&&e.__esModule?e.default:e}function t(e,t,r,n){Object.defineProperty(e,t,{get:r,set:n,enumerable:!0,configurable:!0})}var r=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire594f;r.register("fXPOl",(function(n,a){var i;i=n.exports,Object.defineProperty(i,"__esModule",{value:!0,configurable:!0}),t(n.exports,"getInstances",(function(){return b})),t(n.exports,"default",(function(){return k}));var s=r("8TSCy"),o=r("2TvXO"),u=r("7eJjO"),c=r("6dXDO");r("2VlWd");var l=r("iho5X");r("lNwWH"),r("iJAIC");var d=r("fcwIv"),f=r("eY5Yp"),h=r("xQ42o"),p=r("kLL2y"),v=r("5fErK"),y=r("887rD"),g=r("8LcfB"),m=r("cqGfY"),_=new Set;function b(){return _}var x=function(t){"use strict";s.inherits(n,t);var r=s.createSuper(n);function n(){var e;return s.classCallCheck(this,n),(e=r.call.apply(r,[this].concat(Array.prototype.slice.call(arguments)))).controller=null,e.processor=null,e.remoteClient=null,e.tileStore=null,e.service=null,e.viewState=null,e._paused=!1,e._pendingTileUpdates=[],s.possibleConstructorReturn(e)}return s.createClass(n,[{key:"initialize",value:function(){var e=this;this.handles.add(this.watch("updating",(function(t){e.remoteClient.invoke("setUpdating",t).catch((function(e){}))})))}},{key:"destroy",value:function(){var e,t;this.stop(),null==(e=this.controller)||e.destroy(),null==(t=this.processor)||t.destroy(),this.controller=this.processor=this.tileStore=this.remoteClient=null}},{key:"updating",get:function(){return!this.controller||this.controller.updating}},{key:"stop",value:function(){var e,t,r;this._paused=!0,Array.isArray(null==(e=this.service)?void 0:e.source)&&(this.service.source.forEach((function(e){return e.close()})),this.service.source.length=0),null==(t=this.tileStore)||t.updateTiles({added:[],removed:this.tileStore.tiles.map((function(e){return e.id}))}),null==(r=this.tileStore)||r.destroy(),this.tileStore=null,this._pendingTileUpdates.length=0}},{key:"startup",value:function(t){var r=t.service,n=t.config,a=t.tileInfo,i=t.tiles,u=this;return s.asyncToGenerator(e(o).mark((function t(){var s,c,l,d;return e(o).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return u._paused=!0,Array.isArray(null==(s=u.service)?void 0:s.source)&&(u.service.source.forEach((function(e){return e.close()})),u.service.source.length=0),u.service=r,u.tileStore&&(0,f.equals)(u.tileStore.tileScheme.spatialReference,a.spatialReference)||(d=new(0,m.default)(h.default.fromJSON(a)),i.added.length=i.removed.length=0,null==(c=u.tileStore)||c.updateTiles({added:[],removed:u.tileStore.tiles.map((function(e){return e.id}))}),null==(l=u.tileStore)||l.destroy(),u.tileStore=new(0,y.default)(d),u._pendingTileUpdates.length=0),e.next=4,u._createProcessorAndController(n);case 4:return e.next=6,u.update({config:n},!0);case 6:u.tileStore.clear(),u.tileStore.updateTiles(i),u._paused=!1;case 9:if(!u._pendingTileUpdates.length){e.next=13;break}u.tileStore.updateTiles(u._pendingTileUpdates.pop());case 11:e.next=9;break;case 13:case"end":return e.stop()}}),t)})))()}},{key:"updateTiles",value:function(t){var r=this;return s.asyncToGenerator(e(o).mark((function n(){return e(o).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r._paused?r._pendingTileUpdates.push(t):r.tileStore.updateTiles(t);case 1:case"end":return e.stop()}}),n)})))()}},{key:"update",value:function(t){var r=t.config,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],a=this;return s.asyncToGenerator(e(o).mark((function t(){var i;return e(o).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=g.UpdateToken.empty(),n||a.controller.pause(),e.next=4,Promise.all([a.processor.update(i,r),a.controller.update(i,r)]);case 4:return e.abrupt("return",(e.sent,i.toJSON()));case 5:case"end":return e.stop()}}),t)})))()}},{key:"applyUpdate",value:function(t){var r=this;return s.asyncToGenerator(e(o).mark((function n(){return e(o).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r.controller.applyUpdate(g.UpdateToken.create(t)));case 1:case"end":return e.stop()}}),n)})))()}},{key:"_createProcessorAndController",value:function(t){var r=this;return s.asyncToGenerator(e(o).mark((function n(){return e(o).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,Promise.all([r._handleControllerConfig(t),r._handleProcessorConfig(t)]);case 2:r.controller.processor=r.processor;case 3:case"end":return e.stop()}}),n)})))()}},{key:"_handleControllerConfig",value:function(t){var r=this;return s.asyncToGenerator(e(o).mark((function n(){var a;return e(o).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r._createController(r.service,t);case 2:return a=e.sent,e.next=5,a.startup();case 5:return e.abrupt("return",(e.sent,a));case 6:case"end":return e.stop()}}),n)})))()}},{key:"_handleProcessorConfig",value:function(t){var r=this;return s.asyncToGenerator(e(o).mark((function n(){return e(o).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r._createProcessor(r.service,t));case 1:case"end":return e.stop()}}),n)})))()}},{key:"_createController",value:function(t,r){var n=this;return s.asyncToGenerator(e(o).mark((function a(){var i,s,u;return e(o).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.controller&&n.controller.destroy(),i=n.tileStore,s=n.remoteClient,u=new(0,v.default)({service:t,config:r,tileStore:i,remoteClient:s}),e.abrupt("return",(n.controller=u,u));case 3:case"end":return e.stop()}}),a)})))()}},{key:"_createProcessor",value:function(t,r){var n=this;return s.asyncToGenerator(e(o).mark((function a(){var i,s,u,c,l;return e(o).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=r.schema.processors[0].type,e.next=3,(0,p.loadProcessorModule)(i);case 3:return s=e.sent.default,u=n.remoteClient,c=n.tileStore,l=new s({service:t,config:r,tileStore:c,remoteClient:u}),e.abrupt("return",(n.processor&&n.processor.destroy(),n.processor=l,l));case 8:case"end":return e.stop()}}),a)})))()}}]),n}(c.HandleOwner);(0,u._)([(0,l.property)()],x.prototype,"controller",void 0),(0,u._)([(0,l.property)()],x.prototype,"processor",void 0),(0,u._)([(0,l.property)()],x.prototype,"updating",null),(0,u._)([(0,l.property)()],x.prototype,"viewState",void 0);var k=x=(0,u._)([(0,d.subclass)("esri.views.2d.layers.features.Pipeline")],x)})),r.register("kLL2y",(function(e,n){function a(e){return r("heatmap"===e?"kaphY":"40XD7")}t(e.exports,"loadProcessorModule",(function(){return a}))})),r.register("kaphY",(function(e,t){e.exports=r("4WKyX")(r("aNJCr").getBundleURL("b3gJV")+r("iE7OH").resolve("ef3zG")).then((function(){return r("8hKBq")}))})),r.register("40XD7",(function(e,t){e.exports=Promise.all([r("4WKyX")(r("aNJCr").getBundleURL("b3gJV")+r("iE7OH").resolve("2FSCg")),r("4WKyX")(r("aNJCr").getBundleURL("b3gJV")+r("iE7OH").resolve("4BbkU")),r("4WKyX")(r("aNJCr").getBundleURL("b3gJV")+r("iE7OH").resolve("gPWYb")),r("4WKyX")(r("aNJCr").getBundleURL("b3gJV")+r("iE7OH").resolve("16ztO")),r("4WKyX")(r("aNJCr").getBundleURL("b3gJV")+r("iE7OH").resolve("8N9PD")),r("4WKyX")(r("aNJCr").getBundleURL("b3gJV")+r("iE7OH").resolve("2lYZ9")),r("4WKyX")(r("aNJCr").getBundleURL("b3gJV")+r("iE7OH").resolve("iT6wT"))]).then((function(){return r("9Mf0w")}))})),r.register("5fErK",(function(n,a){t(n.exports,"default",(function(){return M}));var i=r("8TSCy"),s=r("2TvXO"),o=r("7eJjO"),u=r("6dXDO"),c=r("2VlWd"),l=r("7qybv"),d=r("10vEZ"),f=r("lKPaD"),h=r("iho5X");r("lNwWH"),r("iJAIC");var p=r("fcwIv"),v=r("akQYU"),y=r("f3b5K"),g=r("4nMX7"),m=r("dEIm1"),_=r("7GExb"),b=r("8c8ji"),x=r("eJHSv"),k=r("angIQ"),S=r("5STKO"),w=r("8LcfB"),I=r("incs0");function T(e){if(!(0,d.isAbortError)(e)&&"worker:port-closed"!==e.name)throw e}function C(e){return"feature"===e.type&&"snapshot"===e.mode}var F=function(t){"use strict";i.inherits(n,t);var r=i.createSuper(n);function n(){var e;return i.classCallCheck(this,n),(e=r.call.apply(r,[this].concat(Array.prototype.slice.call(arguments))))._storage=new(0,k.ComputedAttributeStorage),e._markedIdsBufId=e._storage.createBitset(),e._lastCleanup=performance.now(),e._cleanupNeeded=!1,e._invalidated=!1,e._tileToResolver=new Map,e._didEdit=!1,e.tileStore=null,e.config=null,e.processor=null,e.remoteClient=null,e.service=null,i.possibleConstructorReturn(e)}return i.createClass(n,[{key:"initialize",value:function(){var e=this;this._initAttributeStore(),this._initStores(),this._initQueryEngine(),this._initSource(),this._updateQueue=new(0,I.QueueProcessor)({concurrency:"geoevent"===this._source.type?1:4,process:function(t,r){return e._onTileMessage(t,{signal:r})}}),this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this)),this.watch("updating",(function(t){return!t&&e.onIdle()}))]),this._checkUpdating=setInterval((function(){return e.notifyChange("updating")}),300)}},{key:"startup",value:function(){var t=this;return i.asyncToGenerator(e(s).mark((function r(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t._initAttributeStore();case 1:case"end":return e.stop()}}),r)})))()}},{key:"_initSource",value:function(){var e=this,t=this.tileStore.tileScheme;this._source=(0,_.createSource)(this.service,this.spatialReference,t,(function(t,r){return e._invalidated=!0,e._patchTile(t,r)}),(function(){return e._updateQueue.length<50}),this.featureStore),this._proxyEvents()}},{key:"_proxyEvents",value:function(){if("geoevent"===this._source.type){var e=this,t=this._source.events;this.handles.add([t.on("connectionStatus",(function(t){return e.remoteClient.invoke("setProperty",{propertyName:"connectionStatus",value:t}).catch(T)})),t.on("errorString",(function(t){return e.remoteClient.invoke("setProperty",{propertyName:"errorString",value:t}).catch(T)})),t.on("feature",(function(t){return e.remoteClient.invoke("emitEvent",{name:"data-received",event:{attributes:t.attributes,centroid:t.centroid,geometry:t.geometry}}).catch(T)})),t.on("updateRate",(function(t){return e.remoteClient.invoke("emitEvent",{name:"update-rate",event:i.objectSpread({},t)}).catch(T)}))])}}},{key:"_initAttributeStore",value:function(){var e=this;this.attributeStore?this.attributeStore.invalidateResources():this.attributeStore=new(0,b.default)({type:"remote",initialize:function(t,r){return(0,d.ignoreAbortErrors)(e.remoteClient.invoke("tileRenderer.featuresView.attributeView.initialize",t,{signal:r}).catch(T))},update:function(t,r){return(0,d.ignoreAbortErrors)(e.remoteClient.invoke("tileRenderer.featuresView.attributeView.requestUpdate",t,{signal:r}).catch(T))},render:function(t){return(0,d.ignoreAbortErrors)(e.remoteClient.invoke("tileRenderer.featuresView.requestRender",void 0,{signal:t}).catch(T))}},this.config)}},{key:"_initStores",value:function(){var e=this,t="snapshot"===this.service.type?"snapshot":"on-demand",r={geometryInfo:{geometryType:this.service.geometryType,hasM:!1,hasZ:!1},spatialReference:this.spatialReference,fieldsIndex:this.fieldsIndex,fields:this.service.fields};this.featureStore=new(0,m.FeatureStore2D)(r,this._storage,t),this.aggregateStore=new(0,x.ClusterStore)(r,this.spatialReference,this._storage,this.service),this.handles.add(this.aggregateStore.events.on("valueRangesChanged",(function(t){e.remoteClient.invoke("emitEvent",{name:"valueRangesChanged",event:{valueRanges:t.valueRanges}}).catch(T)})))}},{key:"_initQueryEngine",value:function(){var e,t=this;null==(e=this.queryEngine)||e.destroy(),this.queryEngine=new(0,y.default)({definitionExpression:this.config.definitionExpression,fields:this.service.fields,geometryType:this.service.geometryType,objectIdField:this.service.objectIdField,hasM:!1,hasZ:!1,spatialReference:this.spatialReference.toJSON(),cacheSpatialQueries:!0,featureStore:this.featureStore,aggregateAdapter:{getFeatureObjectIds:function(e){return t.aggregateStore.getFeatureDisplayIdsForAggregate(e).map((function(e){return t.getObjectId(e)}))}},timeInfo:this.service.timeInfo})}},{key:"destroy",value:function(){this._updateQueue.destroy(),this._source.destroy(),this.queryEngine.destroy(),this.attributeStore&&this.attributeStore.destroy();var e=!0,t=!1,r=void 0;try{for(var n,a=this.tileStore.tiles[Symbol.iterator]();!(e=(n=a.next()).done);e=!0){var i=n.value;this._source.unsubscribe(i)}}catch(e){t=!0,r=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw r}}clearInterval(this._checkUpdating)}},{key:"fieldsIndex",get:function(){return new(0,g.default)(this.service.fields)}},{key:"hasAggregates",get:function(){return!!this.config.schema.targets.aggregate}},{key:"spatialReference",get:function(){return this.tileStore.tileScheme.spatialReference}},{key:"updating",get:function(){return this.isUpdating()}},{key:"isUpdating",value:function(){return this._source.updating||!!this._updateQueue.length}},{key:"enableEvent",value:function(e){this._source.enableEvent(e.name,e.value)}},{key:"pause",value:function(){this._updateQueue.pause(),this._updateQueue.clear()}},{key:"pauseStream",value:function(){"geoevent"===this._source.type&&this._source.pauseStream()}},{key:"resumeStream",value:function(){"geoevent"===this._source.type&&this._source.resumeStream()}},{key:"update",value:function(t,r){var n=this;return i.asyncToGenerator(e(s).mark((function a(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n._set("config",r),n._schema=r.schema,n._initQueryEngine(),e.next=5,Promise.all([n._source.update(t,r.schema.source),n.featureStore.updateSchema(t,r.schema.targets.feature),n.attributeStore.update(t,r),n.attributeStore.updateFilters(t,n)]);case 5:return e.next=7,n.aggregateStore.updateSchema(t,r.schema.targets.aggregate);case 7:(0,c.default)("esri-2d-update-debug")&&t.describe();case 8:case"end":return e.stop()}}),a)})))()}},{key:"applyUpdate",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.mesh&&r.clearTiles(),r._updateQueue.resume(),e.next=4,r._source.applyUpdate(t);case 4:return r.notifyChange("updating"),e.next=7,(0,f.whenOnce)((function(){return!r.updating}));case 7:if(e.t0=r.hasAggregates,!e.t0){e.next=13;break}return e.next=11,(0,d.after)(10);case 11:return e.next=13,(0,f.whenOnce)((function(){return!r.updating}));case 13:case"end":return e.stop()}}),n)})))()}},{key:"onEdits",value:function(t){var r=t.edits,n=this;return i.asyncToGenerator(e(s).mark((function t(){var a,i;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,c.default)("esri-2d-update-debug")&&console.debug("Applying Edit:",r),n._didEdit=!0,e.prev=1,a=r.removed.map((function(e){return e.objectId&&-1!==e.objectId?e.objectId:n._lookupObjectIdByGlobalId(e.globalId)})),i=r.addOrModified.map((function(e){return e.objectId})),n.featureStore.invalidate(),e.next=6,n._source.edit(i,a);case 6:return n.clearTiles(),n.notifyChange("updating"),n.aggregateStore.clear(),e.next=11,n._source.resend();case 11:return e.next=13,(0,f.whenOnce)((function(){return!n.updating}));case 13:e.next=17;break;case 15:e.prev=15,e.t0=e.catch(1);case 17:case"end":return e.stop()}}),t,null,[[1,15]])})))()}},{key:"refresh",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){var a;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=3;break}return a=w.UpdateToken.empty(),e.abrupt("return",(a.storage.filters=!0,r.applyUpdate(a)));case 3:return r.featureStore.invalidate(),r.clearTiles(),r._source.refresh(),r._cleanupNeeded=!0,r.notifyChange("updating"),e.next=10,(0,f.whenOnce)((function(){return!r.updating}));case 10:case"end":return e.stop()}}),n)})))()}},{key:"clearTiles",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,a=this.tileStore.tiles[Symbol.iterator]();!(e=(n=a.next()).done);e=!0){var i=n.value;this.processor.onTileClear(i)}}catch(e){t=!0,r=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw r}}}},{key:"onTileUpdate",value:function(e){this.aggregateStore.onTileUpdate(e);var t=!0,r=!1,n=void 0;try{for(var a,i=e.added[Symbol.iterator]();!(t=(a=i.next()).done);t=!0){var s=a.value;this._source.subscribe(s),this._level=s.level}}catch(e){r=!0,n=e}finally{try{t||null==i.return||i.return()}finally{if(r)throw n}}var o=!0,u=!1,c=void 0;try{for(var l,d=e.removed[Symbol.iterator]();!(o=(l=d.next()).done);o=!0){var f=l.value;this._source.unsubscribe(f),this._cleanupNeeded=!0,this._tileToResolver.has(f.id)&&(this._tileToResolver.get(f.id).resolve(),this._tileToResolver.delete(f.id))}}catch(e){u=!0,c=e}finally{try{o||null==d.return||d.return()}finally{if(u)throw c}}this.notifyChange("updating")}},{key:"onIdle",value:function(){this._invalidated&&((this.hasAggregates||"heatmap"===this.processor.type)&&this._repushCurrentLevelTiles(),this._invalidated=!1),this._markAndSweep()}},{key:"querySummaryStatistics",value:function(t){var r=t.query,n=t.params,a=this;return i.asyncToGenerator(e(s).mark((function t(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",a.queryEngine.executeQueryForSummaryStatistics(r,n));case 1:case"end":return e.stop()}}),t)})))()}},{key:"queryUniqueValues",value:function(t){var r=t.query,n=t.params,a=this;return i.asyncToGenerator(e(s).mark((function t(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",a.queryEngine.executeQueryForUniqueValues(r,n));case 1:case"end":return e.stop()}}),t)})))()}},{key:"queryClassBreaks",value:function(t){var r=t.query,n=t.params,a=this;return i.asyncToGenerator(e(s).mark((function t(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",a.queryEngine.executeQueryForClassBreaks(r,n));case 1:case"end":return e.stop()}}),t)})))()}},{key:"queryHistogram",value:function(t){var r=t.query,n=t.params,a=this;return i.asyncToGenerator(e(s).mark((function t(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",a.queryEngine.executeQueryForHistogram(r,n));case 1:case"end":return e.stop()}}),t)})))()}},{key:"queryExtent",value:function(e){return this.queryEngine.executeQueryForExtent(e)}},{key:"queryFeatures",value:function(e){return this.queryEngine.executeQuery(e)}},{key:"queryVisibleFeatures",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){var a,i;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r.queryEngine.executeQuery(t);case 2:return a=e.sent,i=a.objectIdFieldName,e.abrupt("return",(a.features=a.features.filter((function(e){var t=e.attributes[i],n=r.getDisplayId(t);return r.attributeStore.isVisible(n)})),a));case 5:case"end":return e.stop()}}),n)})))()}},{key:"queryFeatureCount",value:function(e){return this.queryEngine.executeQueryForCount(e)}},{key:"queryLatestObservations",value:function(e){return this.queryEngine.executeQueryForLatestObservations(e)}},{key:"queryObjectIds",value:function(e){return this.queryEngine.executeQueryForIds(e)}},{key:"queryStatistics",value:function(){var t=this;return i.asyncToGenerator(e(s).mark((function r(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",t.featureStore.storeStatistics);case 1:case"end":return e.stop()}}),r)})))()}},{key:"getObjectId",value:function(e){return this.featureStore.lookupObjectId(e,this._storage)}},{key:"getDisplayId",value:function(e){if(this._schema.targets.aggregate){var t=this.aggregateStore.getDisplayId(e);if((0,l.isNone)(t)){var r=this.featureStore.lookupDisplayId(e);return this.aggregateStore.getDisplayIdForReferenceId(r)}return t}return this.featureStore.lookupDisplayId(e)}},{key:"getFeatures",value:function(e){var t=[],r=[],n=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var u=s.value,c=this.hasAggregates?this.getAggregate(u):null;if((0,l.isSome)(c))if((0,l.isSome)(c.referenceId)){var d=this.getFeature(c.referenceId);(0,l.isSome)(d)&&t.push(d)}else r.push(c);else{var f=this.getFeature(u);(0,l.isSome)(f)&&t.push(f)}}}catch(e){a=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(a)throw i}}return{features:t,aggregates:r}}},{key:"getFeature",value:function(e){var t=this.featureStore.lookupFeatureByDisplayId(e,this._storage);if((0,l.isNone)(t))return null;var r=t.readHydratedGeometry(),n=(0,v.convertToGeometry)(r,t.geometryType,t.hasZ,t.hasM);return{attributes:t.readAttributes(),geometry:n}}},{key:"getAggregate",value:function(e){return this.aggregateStore.getAggregate(e)}},{key:"getAggregates",value:function(){return this.aggregateStore.getAggregates()}},{key:"setHighlight",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){var a;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=t.map((function(e){return r.getDisplayId(e)})),e.abrupt("return",r.attributeStore.setHighlight(t,a));case 2:case"end":return e.stop()}}),n)})))()}},{key:"_lookupObjectIdByGlobalId",value:function(e){var t=this.service.globalIdField;if((0,l.isNone)(t))throw new Error("Expected globalIdField to be defined");var r=null;if(this.featureStore.forEach((function(n){e===n.readAttribute(t)&&(r=n.getObjectId())})),(0,l.isNone)(r))throw new Error("Expected to find a feature with globalId ".concat(e));return r}},{key:"_repushCurrentLevelTiles",value:function(){var e=this,t=this.tileStore.tiles.filter((function(t){return t.level===e._level})),r=!0,n=!1,a=void 0;try{for(var i,s=t[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var o=i.value;this._patchTile({type:"append",id:o.key.id,addOrUpdate:S.FeatureSetReaderJSON.fromOptimizedFeatures([],this.service),remove:[],end:!0,status:w.UpdateToken.empty()})}}catch(e){n=!0,a=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw a}}}},{key:"_maybeForceCleanup",value:function(){performance.now()-this._lastCleanup>5e3&&this._markAndSweep()}},{key:"_patchTile",value:function(e,t){var r=this,n=this._updateQueue.push(e,t).then((function(){r.notifyChange("updating")})).catch((function(e){r.notifyChange("updating")}));return this.notifyChange("updating"),n}},{key:"_onTileMessage",value:function(t,r){var n=this;return i.asyncToGenerator(e(s).mark((function a(){var o,u,c,f,h,p,v,y,g,m,_,b;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,d.throwIfAborted)(r),o=n.tileStore.get(t.id)){e.next=4;break}return e.abrupt("return");case 4:if(!t.clear){e.next=6;break}return e.abrupt("return",n.processor.onTileClear(o));case 6:for(u=t.status,n._cleanupNeeded=!0,c=[],f=!0,h=!1,p=void 0,e.prev=10,v=t.remove[Symbol.iterator]();!(f=(y=v.next()).done);f=!0)g=y.value,(m=n.featureStore.lookupDisplayId(g))&&c.push(m);e.next=18;break;case 14:e.prev=14,e.t0=e.catch(10),h=!0,p=e.t0;case 18:e.prev=18,e.prev=19,f||null==v.return||v.return();case 21:if(e.prev=21,!h){e.next=24;break}throw p;case 24:return e.finish(21);case 25:return e.finish(18);case 26:if(t.remove=c,e.prev=27,!(0,l.isNone)(t.addOrUpdate)){e.next=30;break}return e.abrupt("return",void n.processor.onTileMessage(o,i.objectSpread({},t,{addOrUpdate:null}),n.hasAggregates,r).catch(d.throwIfNotAbortError));case 30:if(t.addOrUpdate.setArcadeSpatialReference(n.spatialReference),n.featureStore.hasInstance(t.addOrUpdate.instance)&&u.targets.feature||(u.targets.feature=!0,n.featureStore.onTileData(o,t)),u.storage.data&&u.storage.filters){e.next=39;break}if(u.storage.data=!0,u.storage.filters=!0,n.attributeStore.onTileData(o,t),"geoevent"!==n._source.type&&!n._didEdit){e.next=38;break}return e.next=35,n.attributeStore.sendUpdates();case 35:(0,d.throwIfAborted)(r),e.next=39;break;case 38:n.attributeStore.sendUpdates();case 39:if(!n.hasAggregates||u.targets.aggregate){e.next=50;break}if(u.targets.aggregate=!0,_=C(n._source)&&n._source.loading,b=!C(n._source)||_||t.end,n.aggregateStore.onTileData(o,t,n._storage,n.attributeStore,b),b){e.next=44;break}return e.abrupt("return");case 44:if(e.t1=u.mesh,e.t1){e.next=50;break}return n.attributeStore.onTileData(o,t),e.next=49,n.attributeStore.sendUpdates();case 49:n.processor.onTileClear(o);case 50:if(e.t2=u.mesh,e.t2){e.next=56;break}return u.mesh=!0,e.next=55,n.processor.onTileMessage(o,t,n.hasAggregates,r);case 55:(0,d.throwIfAborted)(r);case 56:n._maybeForceCleanup(),e.next=62;break;case 59:e.prev=59,e.t3=e.catch(27),(0,d.throwIfNotAbortError)(e.t3);case 62:case"end":return e.stop()}}),a,null,[[10,14,18,26],[19,,21,25],[27,59]])})))()}},{key:"_mark",value:function(e,t,r){var n=(4294901760&this._storage.getInstanceId(e))>>>16;e&&(t.add(n),r.set(e))}},{key:"_markAndSweep",value:function(){var e=this;if(this._lastCleanup=performance.now(),!("feature"===this._source.type&&"snapshot"===this._source.mode||"geoevent"!==this._source.type&&!this._cleanupNeeded)){this._cleanupNeeded=!1;var t=this._storage.getBitset(this._markedIdsBufId),r=new Set;t.clear();var n=!0,a=!1,i=void 0,s=!0,o=!1,u=void 0;try{for(var c,l=this.tileStore.tiles[Symbol.iterator]();!(s=(c=l.next()).done);s=!0){var d=c.value;try{for(var f,h=this._source.readers(d.id)[Symbol.iterator]();!(n=(f=h.next()).done);n=!0)for(var p=f.value.getCursor();p.next();){var v=p.getDisplayId();if(!v){var y=p.getObjectId();v=this.featureStore.lookupDisplayId(y)}this._mark(v,r,t)}}catch(e){a=!0,i=e}finally{try{n||null==h.return||h.return()}finally{if(a)throw i}}}}catch(e){o=!0,u=e}finally{try{s||null==l.return||l.return()}finally{if(o)throw u}}"symbol"===this.processor.type&&this.processor.forEachBufferId((function(n){e._mark(n,r,t)})),this._updateQueue.forEach((function(n){var a=!0,i=!1,s=void 0;try{for(var o,u=n.remove[Symbol.iterator]();!(a=(o=u.next()).done);a=!0){var c=o.value,l=e.featureStore.lookupDisplayId(c);e._mark(l,r,t)}}catch(e){i=!0,s=e}finally{try{a||null==u.return||u.return()}finally{if(i)throw s}}})),this.config.schema.targets.aggregate&&(this.aggregateStore.sweepFeatures(t,this.featureStore),this.aggregateStore.sweepClusters(this._storage,this.attributeStore,this._level)),this.featureStore.sweepFeatures(t,this._storage,this.attributeStore),this.featureStore.sweepFeatureSets(r)}}}]),n}(u.HandleOwner);(0,o._)([(0,h.property)({constructOnly:!0})],F.prototype,"tileStore",void 0),(0,o._)([(0,h.property)()],F.prototype,"config",void 0),(0,o._)([(0,h.property)({readOnly:!0})],F.prototype,"fieldsIndex",null),(0,o._)([(0,h.property)()],F.prototype,"processor",void 0),(0,o._)([(0,h.property)({constructOnly:!0})],F.prototype,"remoteClient",void 0),(0,o._)([(0,h.property)({constructOnly:!0})],F.prototype,"service",void 0),(0,o._)([(0,h.property)()],F.prototype,"spatialReference",null),(0,o._)([(0,h.property)()],F.prototype,"updating",null);var M=F=(0,o._)([(0,p.subclass)("esri.views.2d.layers.features.controllers.FeatureController2D")],F)})),r.register("7GExb",(function(e,n){t(e.exports,"createSource",(function(){return l}));var a=r("7qybv"),i=r("lmu5w"),s=r("am3mk"),o=r("erRgw"),u=r("aVi46"),c=r("hSjjm");function l(e,t,r,n,l,d){var f=function(e,t,r,n,s,o){switch(e.type){case"snapshot":return{type:"feature",origin:"snapshot",featureCount:(0,a.unwrapOr)(e.featureCount,0),serviceInfo:e,onMessage:n,outSR:t,tileInfoView:r,canAcceptRequest:s,store:o};case"stream":return{type:"geoevent",serviceInfo:e,onMessage:n,outSR:t,canAcceptRequest:s};case"memory":case"on-demand":return{type:"feature",serviceInfo:e,onMessage:n,outSR:t,origin:u(e.source),tileInfoView:r,canAcceptRequest:s}}function u(e){return Array.isArray(e)?"local":"path"in e&&(0,i.isHostedAgolService)(e.path)?"hosted":"unknown"}}(e,t,r,n,l,d);switch(f.type){case"feature":switch(f.origin){case"hosted":case"local":return new(0,u.PagedFeatureSource)(f);case"snapshot":return new(0,c.SnapshotFeatureSource)(f);case"unknown":return new(0,s.DrillDownFeatureSource)(f)}case"geoevent":return new(0,o.GeoEventSource)(f)}}})),r.register("am3mk",(function(n,a){t(n.exports,"DrillDownFeatureSource",(function(){return f}));var i=r("8TSCy"),s=r("2TvXO"),o=r("2VlWd"),u=r("10vEZ"),c=r("NMQPz"),l=(0,o.default)("esri-mobile"),d={maxDrillLevel:l?1:4,maxRecordCountFactor:l?1:3},f=function(t){"use strict";i.inherits(n,t);var r=i.createSuper(n);function n(e){return i.classCallCheck(this,n),r.call(this,e)}return i.createClass(n,[{key:"_fetchDataTile",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){var a,o,c,l,f,h;return e(s).wrap((function(n){for(;;)switch(n.prev=n.next){case 0:a=r._serviceInfo.capabilities.query.supportsMaxRecordCountFactor,o=r._subscriptions.get(t.key.id),c=o.signal,l=t.getQuantizationParameters(),f=0,h=function(){var n=i.asyncToGenerator(e(s).mark((function n(i,p){var v,y,g,m,_,b,x,k,S,w;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return v=r._queryInfo,y=r.createTileQuery(i,{maxRecordCountFactor:a?d.maxRecordCountFactor:void 0,returnExceededLimitFeatures:!1,quantizationParameters:l}),f++,e.prev=2,e.next=5,r._queue.push({tile:t,query:y,signal:c,depth:p});case 5:if(g=e.sent,f--,(0,u.throwIfAborted)(c),g){e.next=8;break}return e.abrupt("return");case 8:if(v===r._queryInfo){e.next=10;break}return e.abrupt("return",void h(i,p));case 10:if(!(g.exceededTransferLimit&&p<d.maxDrillLevel)){e.next=29;break}for(m=!0,_=!1,b=void 0,e.prev=12,x=i.createChildTiles()[Symbol.iterator]();!(m=(k=x.next()).done);m=!0)S=k.value,h(S,p+1);e.next=20;break;case 16:e.prev=16,e.t0=e.catch(12),_=!0,b=e.t0;case 20:e.prev=20,e.prev=21,m||null==x.return||x.return();case 23:if(e.prev=23,!_){e.next=26;break}throw b;case 26:return e.finish(23);case 27:return e.finish(20);case 28:return e.abrupt("return");case 29:w={id:t.id,addOrUpdate:g,end:0===f,type:"append"},o.add({query:y,message:w}),r._onMessage(w),e.next=36;break;case 33:e.prev=33,e.t1=e.catch(2),(0,u.isAbortError)(e.t1)||r._onMessage({id:t.id,addOrUpdate:null,end:!0,type:"append"});case 36:case"end":return e.stop()}}),n,null,[[2,33],[12,16,20,28],[21,,23,27]])})));return function(e,t){return n.apply(this,arguments)}}(),h(t,0);case 4:case"end":return n.stop()}}),n)})))()}}]),n}(c.BaseFeatureSource)})),r.register("NMQPz",(function(n,a){t(n.exports,"BaseFeatureSource",(function(){return g}));var i=r("8TSCy"),s=r("2TvXO"),o=r("9pNSx"),u=r("kyj08"),c=r("2VlWd"),l=r("jHOLN"),d=r("7qybv"),f=r("10vEZ"),h=r("cCtf4"),p=r("23qU2"),v=r("incs0"),y=l.default.getLogger("esri.views.2d.layers.features.sources.BaseFeatureSource"),g=function(t){"use strict";i.inherits(n,t);var r=i.createSuper(n);function n(t){var a;i.classCallCheck(this,n);var o,u=i.assertThisInitialized(a),l=i.assertThisInitialized(a);return(a=r.call(this,t)).type="feature",a.mode="on-demand",a._adapter=(0,h.createSourceAdapter)(t.serviceInfo),a._queue=new(0,v.QueueProcessor)({concurrency:8,process:(o=i.asyncToGenerator(e(s).mark((function t(r){var n,a,o,l;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,f.throwIfAborted)(r),!(0,d.isSome)(r.tile)){e.next=8;break}return n=r.tile.key.id,a=r.signal,o=(0,c.default)("esri-tiles-debug")?{tile:n.replace(/\//g,"."),depth:r.depth}:void 0,e.next=6,u._adapter.executeQuery(r.query,{signal:a,query:i.objectSpread({},o,u._schema.customParameters)});case 6:return l=e.sent,e.abrupt("return",(l.level=r.tile.key.level,l));case 8:return e.abrupt("return",u._adapter.executeQuery(r.query,i.objectSpread({},r,{query:u._schema.customParameters})));case 9:case"end":return e.stop()}}),t)}))),function(e){return o.apply(this,arguments)})}),a._patchQueue=new(0,v.QueueProcessor)({concurrency:8,process:function(){var t=i.asyncToGenerator(e(s).mark((function t(r){var n,a,o,u;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,f.throwIfAborted)(r),!(0,d.isSome)(r.tile)){e.next=8;break}return n=r.tile.key.id,a=r.signal,o=(0,c.default)("esri-tiles-debug")?{tile:n.replace(/\//g,"."),depth:r.depth}:void 0,e.next=6,l._adapter.executeQuery(r.query,{signal:a,query:i.objectSpread({},o,l._schema.customParameters)});case 6:return u=e.sent,e.abrupt("return",(u.level=r.tile.key.level,u));case 8:return e.abrupt("return",l._adapter.executeQuery(r.query,i.objectSpread({},r,{query:l._schema.customParameters})));case 9:case"end":return e.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()}),i.possibleConstructorReturn(a)}return i.createClass(n,[{key:"destroy",value:function(){i.get(i.getPrototypeOf(n.prototype),"destroy",this).call(this),this._adapter.destroy(),this._queue.destroy(),this._patchQueue.destroy()}},{key:"updating",get:function(){return!!this._queue.length||Array.from(this._subscriptions.values()).some((function(e){return!e.done}))}},{key:"maxRecordCountFactor",get:function(){return this._serviceInfo.capabilities.query.supportsMaxRecordCountFactor?4:null}},{key:"maxPageSize",get:function(){var e;return(null!=(e=this._serviceInfo.capabilities.query.maxRecordCount)?e:8e3)*(0,d.unwrapOr)(this.maxRecordCountFactor,1)}},{key:"pageSize",get:function(){return Math.min(8e3,this.maxPageSize)}},{key:"enableEvent",value:function(e,t){}},{key:"subscribe",value:function(e){i.get(i.getPrototypeOf(n.prototype),"subscribe",this).call(this,e);var t=this._subscriptions.get(e.id);this._fetchDataTile(e).catch((function(t){(0,f.isAbortError)(t)||y.error(new(0,u.default)("mapview-query-error","Encountered error when fetching tile",{tile:e,error:t}))})).then((function(){return t.end()}))}},{key:"unsubscribe",value:function(e){i.get(i.getPrototypeOf(n.prototype),"unsubscribe",this).call(this,e)}},{key:"readers",value:function(e){return this._subscriptions.get(e).readers()}},{key:"query",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",r._adapter.executeQuery(t,{query:r._schema.customParameters}));case 1:case"end":return e.stop()}}),n)})))()}},{key:"queryLastEditDate",value:function(){var t=this;return i.asyncToGenerator(e(s).mark((function r(){var n,a;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=t._serviceInfo.source,a=i.objectSpread({},n.query,{f:"json"}),e.next=3,(0,o.default)(n.path,{query:a,responseType:"json"});case 3:return e.abrupt("return",e.sent.data.editingInfo.lastEditDate);case 4:case"end":return e.stop()}}),r)})))()}},{key:"createTileQuery",value:function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=this._serviceInfo.geometryType,a=this.createQuery(r);a.quantizationParameters=null!=(t=r.quantizationParameters)?t:e.getQuantizationParameters(),a.resultType="tile",a.geometry=e.extent,this._serviceInfo.capabilities.query.supportsQuantization?"esriGeometryPolyline"===n&&(a.maxAllowableOffset=e.resolution*(0,c.default)("feature-polyline-generalization-factor")):"esriGeometryPolyline"!==n&&"esriGeometryPolygon"!==n||(a.maxAllowableOffset=e.resolution,"esriGeometryPolyline"===n&&(a.maxAllowableOffset*=(0,c.default)("feature-polyline-generalization-factor")));var i=this._serviceInfo.capabilities.query;return a.defaultSpatialReferenceEnabled=i.supportsDefaultSpatialReference,a.compactGeometryEnabled=i.supportsCompactGeometry,a}},{key:"_executePatchQuery",value:function(t,r,n,a){var o=this;return i.asyncToGenerator(e(s).mark((function u(){var c,l,f;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(c=r.clone()).outFields=[o._serviceInfo.objectIdField].concat(i.toConsumableArray(n)),c.returnCentroid=!1,c.returnGeometry=!1,l=(0,d.isSome)(c.start)?c.start/8e3:0,f=a.signal,e.abrupt("return",o._patchQueue.push({tile:t,query:c,signal:f,depth:l}));case 4:case"end":return e.stop()}}),u)})))()}},{key:"_resend",value:function(t,r){var n=this;return i.asyncToGenerator(e(s).mark((function a(){var o,u,c,l,h,p,v;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=t.query,u=t.message,c=(0,d.isSome)(o.outFields)?o.outFields:[],l=n._queryInfo.outFields,h=l.filter((function(e){return!c.includes(e)})),!(0,d.isNone)(u.addOrUpdate)){e.next=5;break}n._onMessage(i.objectSpread({},u,{type:"append"})),e.next=19;break;case 5:if(!h.length){e.next=18;break}return e.prev=6,p=n._subscriptions.get(u.id).tile,e.next=10,n._executePatchQuery(p,o,h,r);case 10:v=e.sent,(0,f.throwIfAborted)(r),o.outFields=l,u.addOrUpdate.joinAttributes(v),n._onMessage(i.objectSpread({},u,{end:u.end,type:"append"})),e.next=16;break;case 14:e.prev=14,e.t0=e.catch(6);case 16:e.next=19;break;case 18:n._onMessage(i.objectSpread({},u,{type:"append"}));case 19:case"end":return e.stop()}}),a,null,[[6,14]])})))()}},{key:"_resendSubscription",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){var a,i,o,u,c,l,f;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.empty){e.next=2;break}return e.abrupt("return",r._onMessage({id:t.tile.id,addOrUpdate:null,end:!1,type:"append"}));case 2:a=t.signal,i=!0,o=!1,u=void 0,e.prev=4,c=t.requests.done[Symbol.iterator]();case 6:if(i=(l=c.next()).done){e.next=13;break}return f=l.value,e.next=10,r._resend(f,{signal:a});case 10:i=!0,e.next=6;break;case 13:e.next=19;break;case 15:e.prev=15,e.t0=e.catch(4),o=!0,u=e.t0;case 19:e.prev=19,e.prev=20,i||null==c.return||c.return();case 22:if(e.prev=22,!o){e.next=25;break}throw u;case 25:return e.finish(22);case 26:return e.finish(19);case 27:return e.abrupt("return",(0,d.isSome)(t.edits)?r._onMessage(t.edits):void 0);case 28:case"end":return e.stop()}}),n,null,[[4,15,19,27],[20,,22,26]])})))()}},{key:"resend",value:function(){var t=this;return i.asyncToGenerator(e(s).mark((function r(){var n;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=Array.from(t._subscriptions.values()),e.next=3,Promise.all(n.map((function(e){return t._resendSubscription(e)})));case 3:case"end":return e.stop()}}),r)})))()}}]),n}(p.DataTileSource)})),r.register("cCtf4",(function(n,a){t(n.exports,"createSourceAdapter",(function(){return g}));var i=r("8TSCy"),s=r("2TvXO"),o=r("2VlWd"),u=r("7qybv"),c=r("hl4M0"),l=r("ibKgR"),d=r("akQYU"),f=r("1xeva"),h=r("j6c7r"),p=r("5STKO"),v=r("lkLpJ"),y=function(){"use strict";function e(t){i.classCallCheck(this,e),this.service=t}return i.createClass(e,[{key:"destroy",value:function(){}}]),e}();function g(e){var t,r,n=e.capabilities;return(r=e.source)&&r.capabilities&&r.collection&&r.layerDefinition?new k(e):(t=e,Array.isArray(t.source)?new _(e):n.query.supportsFormatPBF&&(0,o.default)("featurelayer-pbf")?new b(e):new x(e))}function m(){return(m=i.asyncToGenerator(e(s).mark((function t(r){var n;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new(0,c.default),e.next=3,n.open(r,{});case 3:return e.abrupt("return",(e.sent,n));case 4:case"end":return e.stop()}}),t)})))).apply(this,arguments)}var _=function(t){"use strict";i.inherits(n,t);var r=i.createSuper(n);function n(e){var t;return i.classCallCheck(this,n),(t=r.call(this,e))._portsOpen=function(e){return m.apply(this,arguments)}(e.source).then((function(e){return t.client=e})),i.possibleConstructorReturn(t)}return i.createClass(n,[{key:"destroy",value:function(){this.client.close(),this.client=null}},{key:"executeQuery",value:function(t,r){var n=this;return i.asyncToGenerator(e(s).mark((function a(){var i;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,n._portsOpen;case 2:return e.next=4,n.client.invoke("queryFeatures",t.toJSON(),r);case 4:return i=e.sent,e.abrupt("return",p.FeatureSetReaderJSON.fromFeatureSet(i,n.service));case 6:case"end":return e.stop()}}),a)})))()}}]),n}(y),b=function(t){"use strict";i.inherits(n,t);var r=i.createSuper(n);function n(){return i.classCallCheck(this,n),r.apply(this,arguments)}return i.createClass(n,[{key:"executeQuery",value:function(t,r){var n=this;return i.asyncToGenerator(e(s).mark((function a(){var i,o,u;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,h.executeQueryPBFBuffer)(n.service.source,t,r);case 2:return i=e.sent,o=i.data,u=!t.quantizationParameters,e.abrupt("return",v.FeatureSetReaderPBF.fromBuffer(o,n.service,u));case 6:case"end":return e.stop()}}),a)})))()}}]),n}(y),x=function(t){"use strict";i.inherits(n,t);var r=i.createSuper(n);function n(){return i.classCallCheck(this,n),r.apply(this,arguments)}return i.createClass(n,[{key:"executeQuery",value:function(t,r){var n=this;return i.asyncToGenerator(e(s).mark((function a(){var i,o,c,f,v,y,g,m,_,b,x,k,S,w;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=n.service,o=i.source,c=i.capabilities,f=i.spatialReference,v=i.objectIdField,y=i.geometryType,!(0,u.isSome)(t.quantizationParameters)||c.query.supportsQuantization){e.next=10;break}return g=t.clone(),m=(0,l.toQuantizationTransform)((0,u.unwrap)(g.quantizationParameters)),g.quantizationParameters=null,e.next=6,(0,h.executeQuery)(o,g,f,r);case 6:return _=e.sent,b=_.data,x=(0,d.convertFromFeatureSet)(b,v),e.abrupt("return",((0,d.quantizeOptimizedFeatureSet)(m,x),p.FeatureSetReaderJSON.fromOptimizedFeatureSet(x,n.service)));case 10:return e.next=12,(0,h.executeQuery)(o,t,n.service.spatialReference,r);case 12:return k=e.sent,S=k.data,"esriGeometryPoint"===y&&(S.features=null==(w=S.features)?void 0:w.filter((function(e){if((0,u.isSome)(e.geometry)){var t=e.geometry;return Number.isFinite(t.x)&&Number.isFinite(t.y)}return!0}))),e.abrupt("return",p.FeatureSetReaderJSON.fromFeatureSet(S,n.service));case 17:case"end":return e.stop()}}),a)})))()}}]),n}(y),k=function(t){"use strict";i.inherits(n,t);var r=i.createSuper(n);function n(){return i.classCallCheck(this,n),r.apply(this,arguments)}return i.createClass(n,[{key:"executeQuery",value:function(t,r){var n=this;return i.asyncToGenerator(e(s).mark((function a(){var i,o,c,h,v,y;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=n.service,o=i.capabilities,!t.quantizationParameters||o.query.supportsQuantization){e.next=8;break}return c=t.clone(),h=(0,l.toQuantizationTransform)((0,u.unwrap)(c.quantizationParameters)),c.quantizationParameters=null,e.next=6,(0,f.queryOptimizedFeatureSet)(n.service.source,t,r);case 6:return v=e.sent,e.abrupt("return",((0,d.quantizeOptimizedFeatureSet)(h,v),p.FeatureSetReaderJSON.fromOptimizedFeatureSet(v,n.service)));case 8:return e.next=10,(0,f.queryOptimizedFeatureSet)(n.service.source,t,r);case 10:return y=e.sent,e.abrupt("return",p.FeatureSetReaderJSON.fromOptimizedFeatureSet(y,n.service));case 12:case"end":return e.stop()}}),a)})))()}}]),n}(y)})),r.register("ibKgR",(function(e,n){t(e.exports,"toQuantizationTransform",(function(){return l})),t(e.exports,"quantizePoint",(function(){return _})),t(e.exports,"quantizeGeometry",(function(){return k})),t(e.exports,"unquantizeMultipoint",(function(){return S})),t(e.exports,"unquantizePoint",(function(){return w})),t(e.exports,"unquantizePolygon",(function(){return I})),t(e.exports,"unquantizePolyline",(function(){return T}));var a=r("8TSCy"),i=r("7qybv"),s=r("79LpT");var o=function(e,t,r){return[t,r]},u=function(e,t,r){return[t,r,e[2]]},c=function(e,t,r){return[t,r,e[2],e[3]]};function l(e){return e?{originPosition:"upper-left"===e.originPosition?"upperLeft":"lower-left"===e.originPosition?"lowerLeft":e.originPosition,scale:e.tolerance?[e.tolerance,e.tolerance]:[1,1],translate:(0,i.isSome)(e.extent)?[e.extent.xmin,e.extent.ymax]:[0,0]}:null}function d(e,t){var r=e.scale,n=e.translate;return Math.round((t-n[0])/r[0])}function f(e,t){var r=e.scale,n=e.translate;return Math.round((n[1]-t)/r[1])}function h(e,t,r){for(var n,a,i,s,o=[],u=0;u<r.length;u++){var c=r[u];u>0?(i=d(e,c[0]),s=f(e,c[1]),i===n&&s===a||(o.push(t(c,i-n,s-a)),n=i,a=s)):(n=d(e,c[0]),a=f(e,c[1]),o.push(t(c,n,a)))}return o.length>0?o:null}function p(e,t){var r=e.scale,n=e.translate;return t*r[0]+n[0]}function v(e,t){var r=e.scale;return e.translate[1]-t*r[1]}function y(e,t,r){var n=new Array(r.length);if(!r.length)return n;var i=a.slicedToArray(e.scale,2),s=i[0],o=i[1],u=p(e,r[0][0]),c=v(e,r[0][1]);n[0]=t(r[0],u,c);for(var l=1;l<r.length;l++){var d=r[l];u+=d[0]*s,c-=d[1]*o,n[l]=t(d,u,c)}return n}function g(e,t,r){for(var n=new Array(r.length),a=0;a<r.length;a++)n[a]=y(e,t,r[a]);return n}function m(e,t,r,n,a){return t.points=(i=e,s=r.points,l=a,h(i,n?l?c:u:l?u:o,s)),t;var i,s,l}function _(e,t,r,n,a){return t.x=d(e,r.x),t.y=f(e,r.y),t!==r&&(n&&(t.z=r.z),a&&(t.m=r.m)),t}function b(e,t,r,n,a){var i=function(e,t,r,n){for(var a=[],i=r?n?c:u:n?u:o,s=0;s<t.length;s++){var l=h(e,i,t[s]);l&&l.length>=3&&a.push(l)}return a.length?a:null}(e,r.rings,n,a);return i?(t.rings=i,t):null}function x(e,t,r,n,a){var i=function(e,t,r,n){for(var a=[],i=r?n?c:u:n?u:o,s=0;s<t.length;s++){var l=h(e,i,t[s]);l&&l.length>=2&&a.push(l)}return a.length?a:null}(e,r.paths,n,a);return i?(t.paths=i,t):null}function k(e,t){return e&&t?(0,s.isPoint)(t)?_(e,{},t,!1,!1):(0,s.isPolyline)(t)?x(e,{},t,!1,!1):(0,s.isPolygon)(t)?b(e,{},t,!1,!1):(0,s.isMultipoint)(t)?m(e,{},t,!1,!1):(0,s.isExtent)(t)?(i=!1,o=!1,(n={}).xmin=d(r=e,(a=t).xmin),n.ymin=f(r,a.ymin),n.xmax=d(r,a.xmax),n.ymax=f(r,a.ymax),n!==a&&(i&&(n.zmin=a.zmin,n.zmax=a.zmax),o&&(n.mmin=a.mmin,n.mmax=a.mmax)),n):null:null;var r,n,a,i,o}function S(e,t,r,n,a){return(0,i.isSome)(r)&&(t.points=(s=e,l=r.points,d=a,y(s,n?d?c:u:d?u:o,l))),t;var s,l,d}function w(e,t,r,n,a){return(0,i.isNone)(r)||(t.x=p(e,r.x),t.y=v(e,r.y),t!==r&&(n&&(t.z=r.z),a&&(t.m=r.m))),t}function I(e,t,r,n,a){return(0,i.isSome)(r)&&(t.rings=(s=e,l=r.rings,d=a,g(s,n?d?c:u:d?u:o,l))),t;var s,l,d}function T(e,t,r,n,a){return(0,i.isSome)(r)&&(t.paths=(s=e,l=r.paths,d=a,g(s,n?d?c:u:d?u:o,l))),t;var s,l,d}})),r.register("lkLpJ",(function(e,n){t(e.exports,"FeatureSetReaderPBF",(function(){return S}));var a=r("8TSCy"),i=r("kyj08"),s=r("jHOLN"),o=r("7qybv"),u=r("acan7"),c=r("akQYU"),l=r("ft2bT"),d=r("awxBI"),f=r("jBcNl"),h=r("6g9gs"),p=s.default.getLogger("esri.view.2d.layers.features.support.FeatureSetReaderPBF"),v=268435455,y=128e3,g={small:{delta:new Int32Array(128),decoded:new Int32Array(128)},large:{delta:new Int32Array(y),decoded:new Int32Array(y)}};function m(e){return e<=g.small.delta.length?g.small:(e<=g.large.delta.length||(g.large.delta=new Int32Array(Math.round(1.25*e)),g.large.decoded=new Int32Array(Math.round(1.25*e))),g.large)}function _(e){return e.toLowerCase().trim()}function b(e){try{for(var t=new(0,u.default)(new Uint8Array(e),new DataView(e));t.next();){if(2===t.tag())return x(t.getMessage());t.skip()}}catch(e){var r=new(0,i.default)("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:e});p.error(r)}return null}function x(e){for(;e.next();){if(1===e.tag())return e.getMessage();e.skip()}return null}function k(e,t,r,n){return 0==e*n-r*t&&e*r+t*n>0}var S=function(e){"use strict";a.inherits(r,e);var t=a.createSuper(r);function r(e,n,i,s){var o;return a.classCallCheck(this,r),(o=t.call(this,e,s))._hasNext=!1,o._isPoints=!1,o._featureIndex=-1,o._featureOffset=0,o._cache={area:0,unquantGeometry:void 0,geometry:void 0,centroid:void 0,legacyFeature:void 0,optFeature:void 0},o._geometryType=s.geometryType,o._reader=n,o._header=i,o._hasNext=i.hasFeatures,o._isPoints="esriGeometryPoint"===s.geometryType,a.possibleConstructorReturn(o)}return a.createClass(r,[{key:"geometryType",get:function(){return this._geometryType}},{key:"size",get:function(){return this._header.featureCount}},{key:"hasZ",get:function(){return!1}},{key:"hasM",get:function(){return!1}},{key:"stride",get:function(){return 2+(this.hasZ?1:0)+(this.hasM?1:0)}},{key:"hasFeatures",get:function(){return this._header.hasFeatures}},{key:"hasNext",get:function(){return this._hasNext}},{key:"exceededTransferLimit",get:function(){return this._header.exceededTransferLimit}},{key:"hasField",value:function(e){return this._header.hasField(e)||this._header.hasField(_(e))}},{key:"getFieldNames",value:function(){return this._header.fields.map((function(e){return e.fieldName}))}},{key:"getSize",value:function(){return this.size}},{key:"getQuantizationTransform",value:function(){return this._header.transform}},{key:"getCursor",value:function(){return this.copy()}},{key:"getIndex",value:function(){return this._featureIndex}},{key:"setIndex",value:function(e){this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0,this._featureIndex=e}},{key:"getAttributeHash",value:function(){var e=this,t="";return this._header.fields.forEach((function(r){var n=r.index;t+=e._readAttributeAtIndex(n)+"."})),t}},{key:"getObjectId",value:function(){return this._readAttributeAtIndex(this._header.objectIdFieldIndex)}},{key:"getDisplayId",value:function(){return this._header.displayIds[this._featureIndex]}},{key:"setDisplayId",value:function(e){this._header.displayIds[this._featureIndex]=e}},{key:"getGroupId",value:function(){return this._header.groupIds[this._featureIndex]}},{key:"setGroupId",value:function(e){this._header.groupIds[this._featureIndex]=e}},{key:"readLegacyFeature",value:function(){if(void 0===this._cache.legacyFeature){var e,t=this.readCentroid(),r={attributes:this.readAttributes(),geometry:this._isPoints?this.readLegacyPointGeometry():this.readLegacyGeometry(),centroid:null!=(e=t&&{x:t.coords[0],y:t.coords[1]})?e:null};return this._cache.legacyFeature=r,r}return this._cache.legacyFeature}},{key:"readOptimizedFeature",value:function(){if(void 0===this._cache.optFeature){var e=new(0,l.OptimizedFeature)(this.readGeometry(),this.readAttributes(),this.readCentroid());return e.objectId=this.getObjectId(),e.displayId=this.getDisplayId(),this._cache.optFeature=e,e}return this._cache.optFeature}},{key:"getXHydrated",value:function(){var e=this._header.centroid[2*this._featureIndex],t=this.getQuantizationTransform();return(0,o.isNone)(t)?e:e*t.scale[0]+t.translate[0]}},{key:"getYHydrated",value:function(){var e=this._header.centroid[2*this._featureIndex+1],t=this.getQuantizationTransform();return(0,o.isNone)(t)?e:t.translate[1]-e*t.scale[1]}},{key:"getX",value:function(){return this._header.centroid[2*this._featureIndex]*this._sx+this._tx}},{key:"getY",value:function(){return this._header.centroid[2*this._featureIndex+1]*this._sy+this._ty}},{key:"readLegacyPointGeometry",value:function(){return{x:this.getX(),y:this.getY()}}},{key:"readLegacyGeometry",value:function(e){var t=this.readGeometry(e);return(0,c.convertToGeometry)(t,this.geometryType,!1,!1)}},{key:"readLegacyCentroid",value:function(){var e=this.readCentroid();if(!e)return null;var t=a.slicedToArray(e.coords,2);return{x:t[0],y:t[1]}}},{key:"readGeometryArea",value:function(){return this._cache.area||this.readGeometry(!0),this._cache.area}},{key:"readUnquantizedGeometry",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(void 0===this._cache.unquantGeometry){var t=this.readGeometry(e);if(!t)return this._cache.unquantGeometry=null,null;var r=m(t.coords.length).decoded,n=t.clone(r),a=n.coords,i=0,s=!0,o=!1,u=void 0;try{for(var c,l=n.lengths[Symbol.iterator]();!(s=(c=l.next()).done);s=!0){for(var d=c.value,f=1;f<d;f++){var h=2*(i+f),p=2*(i+f-1);a[h]+=a[p],a[h+1]+=a[p+1]}i+=d}}catch(e){o=!0,u=e}finally{try{s||null==l.return||l.return()}finally{if(o)throw u}}return this._cache.unquantGeometry=n,n}return this._cache.unquantGeometry}},{key:"readHydratedGeometry",value:function(){if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===v)return null;var e=this.getXHydrated(),t=this.getYHydrated();return new(0,d.default)([],[e,t])}var r=this.readGeometry();if(!r)return null;var n=r.clone(),a=this.getQuantizationTransform();return(0,o.isSome)(a)&&(0,c.unquantizeOptimizedGeometry)(n,n,this.hasZ,this.hasM,a),n}},{key:"readGeometry",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(void 0===this._cache.geometry){var t=null;if(this._isPoints){if(this._header.centroid[2*this._featureIndex]===v)return null;var r=this.getX(),n=this.getY();t=new(0,d.default)([],[r,n])}else{var a=this._header.offsets.geometry[this._featureIndex],i=this._reader;if(0===a)return null;i.move(a);try{t=e?this._parseGeometryForDisplay(i):this._parseGeometry(i)}catch(e){return console.error("Failed to parse geometry!",e),null}}return this._cache.geometry=t,t}return this._cache.geometry}},{key:"readCentroid",value:function(){if(void 0===this._cache.centroid){var e=null,t=this._header.centroid[2*this._featureIndex]+this._tx,r=this._header.centroid[2*this._featureIndex+1]+this._ty;return t===v?(e=this._computeCentroid())&&(this._header.centroid[2*this._featureIndex]=e.coords[0]-this._tx,this._header.centroid[2*this._featureIndex+1]=e.coords[1]-this._ty):e=new(0,d.default)([],[t,r]),this._cache.centroid=e,e}return this._cache.centroid}},{key:"copy",value:function(){var e=this._reader.clone(),t=new r(this.instance,e,this._header,this.fullSchema());return this.copyInto(t),t}},{key:"next",value:function(){for(this._cache.area=0,this._cache.unquantGeometry=void 0,this._cache.geometry=void 0,this._cache.centroid=void 0,this._cache.legacyFeature=void 0,this._cache.optFeature=void 0;++this._featureIndex<this.size&&!this._getExists(););return this._featureIndex<this.size}},{key:"_readAttribute",value:function(e,t){var r=this._header.hasField(e)?e:_(e),n=this._header.getFieldIndex(r);if(null!=n){var a=this._readAttributeAtIndex(n);return t?null==a?a:this._header.isDateField(r)?new Date(a):a:a}}},{key:"_readAttributes",value:function(){var e=this,t={};return this._header.fields.forEach((function(r){var n=r.fieldName,a=r.index;t[n]=e._readAttributeAtIndex(a)})),t}},{key:"copyInto",value:function(e){a.get(a.getPrototypeOf(r.prototype),"copyInto",this).call(this,e),e._featureIndex=this._featureIndex,e._featureOffset=this._featureOffset,e._hasNext=this._hasNext}},{key:"_readAttributeAtIndex",value:function(e){var t=this._header.offsets.attributes[this._featureIndex*this._header.fieldCount+e],r=this._reader;return r.move(t),function(e){for(var t=e.getLength(),r=e.pos()+t;e.pos()<r&&e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}(r)}},{key:"_parseGeometry",value:function(e){for(var t=e.getLength(),r=e.pos()+t,n=[],a=[];e.pos()<r&&e.next();)switch(e.tag()){case 2:for(var i=e.getUInt32(),s=e.pos()+i;e.pos()<s;)a.push(e.getUInt32());break;case 3:var o=e.getUInt32(),u=e.pos()+o;for(n.push(e.getSInt32()+this._tx),n.push(e.getSInt32()+this._ty),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();e.pos()<u;)n.push(e.getSInt32()),n.push(e.getSInt32()),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();break;default:e.skip()}return new(0,d.default)(a,n)}},{key:"_parseGeometryForDisplay",value:function(e){for(var t,r,n,a,i,s,o=e.getLength(),u=e.pos()+o,c=[],l=[],f=0,h=0,p=null,v=0,y="esriGeometryPolygon"===this.geometryType;e.pos()<u&&e.next();)switch(e.tag()){case 2:for(var g=e.getUInt32(),_=e.pos()+g;e.pos()<_;){var b=e.getUInt32();c.push(b),f+=b}p=m(2*f).delta;break;case 3:e.getUInt32();var x=2+(this.hasZ?1:0)+(this.hasM?1:0),S=!0,w=!1,I=void 0;try{for(var T,C=c[Symbol.iterator]();!(S=(T=C.next()).done);S=!0){var F=T.value;if(h+x*F>p.length)for(var M=0;M<F;M++)e.getSInt32(),e.getSInt32(),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();else if(y){var E=this.getAreaSimplificationThreshold(F,this._header.vertexCount),O=2,q=1,A=e.getSInt32(),N=e.getSInt32();p[h++]=A,p[h++]=N,this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();var R=e.getSInt32(),G=e.getSInt32();for(this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();O<F;){var z=e.getSInt32(),V=e.getSInt32();this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32();var P=A+R,U=N+G;t=A,r=N,n=P,a=U,i=P+z,s=U+V,.5*Math.abs(t*a+n*s+i*r-t*s-n*r-i*a)>=E?(v+=-.5*(P-A)*(U+N),q>1&&k(p[h-2],p[h-1],R,G)?(p[h-2]+=R,p[h-1]+=G):(p[h++]=R,p[h++]=G,q++),A=P,N=U):(z+=R,V+=G),R=z,G=V,O++}q<3?h-=2*q:(v+=-.5*(A+R-A)*(N+G+N),k(p[h-2],p[h-1],R,G)?(p[h-2]+=R,p[h-1]+=G,l.push(q)):(p[h++]=R,p[h++]=G,l.push(++q)))}else{var L=0,D=e.getSInt32(),j=e.getSInt32();this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32(),p[h++]=D,p[h++]=j,L+=1;for(var B=1;B<F;B++){var Q=e.getSInt32(),X=e.getSInt32(),J=D+Q,W=j+X;v+=-.5*(J-D)*(W+j),this.hasZ&&e.getSInt32(),this.hasM&&e.getSInt32(),B>2&&k(p[h-2],p[h-1],Q,X)?(p[h-2]+=Q,p[h-1]+=X):(p[h++]=Q,p[h++]=X,L+=1),D=J,j=W}l.push(L)}}}catch(e){w=!0,I=e}finally{try{S||null==C.return||C.return()}finally{if(w)throw I}}break;default:e.skip()}if(this._cache.area=v,!l.length)return null;if(this._tx||this._ty){var Y=0,Z=!0,H=!1,K=void 0;try{for(var $,ee=l[Symbol.iterator]();!(Z=($=ee.next()).done);Z=!0){var te=$.value;p[2*Y]+=this._tx,p[2*Y+1]+=this._ty,Y+=te}}catch(e){H=!0,K=e}finally{try{Z||null==ee.return||ee.return()}finally{if(H)throw K}}}return new(0,d.default)(l,p)}}],[{key:"fromBuffer",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=t.geometryType,i=b(e),s=(0,h.parseHeader)(i,"esriGeometryPoint"===a,n),o=f.FeatureSetReader.createInstance();return new r(o,i,s,t)}}]),r}(f.FeatureSetReader)})),r.register("6g9gs",(function(e,n){t(e.exports,"parseHeader",(function(){return d}));var a=r("8TSCy"),i=r("kyj08"),s=r("gIye9"),o=268435455,u=function(){"use strict";function e(){a.classCallCheck(this,e),this.fieldMap=new Map,this.fields=[],this.hasFeatures=!1,this.fieldCount=0,this.featureCount=0,this.objectIdFieldIndex=0,this.vertexCount=0,this.offsets={attributes:new Array,geometry:new Array},this.centroid=new Array}return a.createClass(e,[{key:"hasField",value:function(e){return this.fieldMap.has(e)}},{key:"isDateField",value:function(e){var t;return null==(t=this.fieldMap.get(e))?void 0:t.isDate}},{key:"getFieldIndex",value:function(e){var t;return null==(t=this.fieldMap.get(e))?void 0:t.index}}]),e}();function c(e){for(var t=e.getLength(),r=e.pos()+t,n={name:"",isDate:!1};e.pos()<r&&e.next();)switch(e.tag()){case 1:n.name=e.getString();break;case 2:"esriFieldTypeDate"===(0,s.parseFieldType)(e.getEnum())&&(n.isDate=!0);break;default:e.skip()}return n}function l(e){return e.toLowerCase().trim()}function d(e,t){for(var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=1,a=3,d=9,f=12,h=13,p=15,v=e.pos(),y=new u,g=0,m=0,_=1,b=2,x=4,k=3,S=null,w=null,I=null,T=!1;e.next();)switch(e.tag()){case n:S=e.getString();break;case a:w=e.getString();break;case f:I=e.processMessage(s.parseTransform);break;case d:if(y.exceededTransferLimit=e.getBool(),y.exceededTransferLimit){y.offsets.geometry=r?new Float64Array(8e3):new Int32Array(8e3),y.centroid=r?new Float64Array(16e3):new Int32Array(16e3);for(var C=0;C<y.centroid.length;C++)y.centroid[C]=o}break;case h:var F=c(e),M=F.name,E=l(F.name),O={fieldName:M,index:g++,isDate:F.isDate};y.fields.push(O),y.fieldMap.set(F.name,O),y.fieldMap.set(E,O);break;case p:var q=e.getLength(),A=e.pos()+q;if(!y.exceededTransferLimit){var N=y.offsets.geometry,R=y.centroid;N.push(0),R.push(o),R.push(o)}!T&&y.exceededTransferLimit&&(T=!0,y.offsets.attributes=r?new Float64Array(8e3*g):new Uint32Array(8e3*g));for(var G=m*g;e.pos()<A&&e.next();)switch(e.tag()){case _:T?y.offsets.attributes[G++]=e.pos():y.offsets.attributes.push(e.pos());var z=e.getLength();e.skipLen(z);break;case b:if(t)for(var V=e.getLength(),P=e.pos()+V;e.pos()<P&&e.next();)if(e.tag()===k){e.getUInt32();var U=e.getSInt64(),L=e.getSInt64();y.centroid[2*m]=U,y.centroid[2*m+1]=L}else e.skip();else{y.offsets.geometry[m]=e.pos();var D=e.getLength();y.vertexCount+=D,e.skipLen(D)}break;case x:for(var j=e.getLength(),B=e.pos()+j;e.pos()<B&&e.next();)if(e.tag()===k){e.getUInt32();var Q=e.getSInt64(),X=e.getSInt64();y.centroid[2*m]=Q,y.centroid[2*m+1]=X}else e.skip();break;default:e.skip()}m++,y.hasFeatures=!0;break;default:e.skip()}var J=S||w;if(!J)throw new(0,i.default)("FeatureSet has no objectId or globalId field name");return y.featureCount=m,y.fieldCount=g,y.objectIdFieldIndex=y.getFieldIndex(J),y.transform=I,y.displayIds=new Uint32Array(y.featureCount),y.groupIds=new Uint16Array(y.featureCount),e.move(v),y}})),r.register("23qU2",(function(n,a){t(n.exports,"DataTileSource",(function(){return y}));var i=r("8TSCy"),s=r("2TvXO"),o=r("9DeZf"),u=r("amfHf"),c=r("2VlWd"),l=r("7qybv"),d=r("10vEZ"),f=r("9doMy"),h=r("cRlei"),p=r("4rMWh"),v=r("8LcfB");var y=function(){"use strict";function t(e){i.classCallCheck(this,t),this.events=new(0,u.default),this._resolver=(0,d.createResolver)(),this._didEdit=!1,this._subscriptions=new Map,this._outSR=e.outSR,this._serviceInfo=e.serviceInfo,this._onTileUpdateMessage=e.onMessage}return i.createClass(t,[{key:"destroy",value:function(){}},{key:"_onMessage",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){var a,o,u,c;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(u=r._subscriptions.get(t.id)){e.next=4;break}return e.abrupt("return");case 4:return c=i.objectSpread({},t,{remove:null!=(a=t.remove)?a:[],status:null!=(o=t.status)?o:v.UpdateToken.empty()}),e.abrupt("return",(0,d.ignoreAbortErrors)(r._onTileUpdateMessage(c,u.options)));case 6:case"end":return e.stop()}}),n)})))()}},{key:"update",value:function(e,t){var r,n,a,i,s=t.fields.length;t.outFields=(n=null==(r=this._schema)?void 0:r.outFields,a=t.outFields,i=new Set,n&&n.forEach((function(e){return i.add(e)})),a&&a.forEach((function(e){return i.add(e)})),i.has("*")?["*"]:Array.from(i)),t.outFields=t.outFields.length>=.75*s?["*"]:t.outFields,t.outFields.sort();var u=(0,f.diff)(this._schema,t);if(u){(0,c.default)("esri-2d-update-debug")&&console.debug("Applying Update - Source:",u);var l="orderByFields"in this._serviceInfo&&this._serviceInfo.orderByFields?this._serviceInfo.orderByFields:this._serviceInfo.objectIdField+" ASC",d={returnCentroid:(0,c.default)("esri-2d-query-centroid-enabled")&&"esriGeometryPolygon"===this._serviceInfo.geometryType,returnGeometry:!0,timeReferenceUnknownClient:"stream"!==this._serviceInfo.type&&this._serviceInfo.timeReferenceUnknownClient,outFields:t.outFields,outSpatialReference:this._outSR,orderByFields:[l],where:t.definitionExpression||"1=1",gdbVersion:t.gdbVersion,historicMoment:t.historicMoment,timeExtent:o.default.fromJSON(t.timeExtent)},h=this._schema&&(0,f.hasDiff)(u,"outFields");this._schema&&(0,f.hasDiffAny)(u,["timeExtent","definitionExpression","gdbVersion","historicMoment","customParameters"])&&(e.why.mesh.push("Layer filter and/or custom parameters changed"),e.why.source.push("Layer filter and/or custom parameters changed"),e.mesh=!0,e.source=!0,e.queryFilter=!0),h&&(e.why.source.push("Layer required fields changed"),e.source=!0),(0,f.diff)(d,this._queryInfo)&&(this._queryInfo=d),this._schema=t,this._resolver.resolve()}}},{key:"whenInitialized",value:function(){return this._resolver.promise}},{key:"applyUpdate",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(t.queryFilter||t.source&&r._didEdit)){e.next=2;break}return e.abrupt("return",(r.refresh(),void(r._didEdit=!1)));case 2:return r._subscriptions.forEach((function(e){return e.applyUpdate(t)})),e.next=5,r.resend();case 5:case"end":return e.stop()}}),n)})))()}},{key:"refresh",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,a=this._tiles()[Symbol.iterator]();!(e=(n=a.next()).done);e=!0){var i=n.value;this.unsubscribe(i),this.subscribe(i)}}catch(e){t=!0,r=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw r}}}},{key:"subscribe",value:function(e){var t=new(0,p.DataTileSubscription)(e);this._subscriptions.set(e.id,t)}},{key:"unsubscribe",value:function(e){var t=this.get(e.id);(0,l.isSome)(t)&&t.abort(),this._subscriptions.delete(e.id)}},{key:"createQuery",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=this._queryInfo.historicMoment?new Date(this._queryInfo.historicMoment):null;return new(0,h.default)(i.objectSpread({},this._queryInfo,{historicMoment:t},e))}},{key:"get",value:function(e){return this._subscriptions.has(e)?this._subscriptions.get(e):null}},{key:"queryLastEditDate",value:function(){return i.asyncToGenerator(e(s).mark((function t(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Service does not support query type");case 1:case"end":return e.stop()}}),t)})))()}},{key:"query",value:function(t){return i.asyncToGenerator(e(s).mark((function t(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Service does not support query");case 1:case"end":return e.stop()}}),t)})))()}},{key:"_tiles",value:e(s).mark((function t(){var r,n,a,i,o,u,c;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=Array.from(this._subscriptions.values()),n=!0,a=!1,i=void 0,e.prev=2,o=r[Symbol.iterator]();case 4:if(n=(u=o.next()).done){e.next=11;break}return c=u.value,e.next=8,c.tile;case 8:n=!0,e.next=4;break;case 11:e.next=17;break;case 13:e.prev=13,e.t0=e.catch(2),a=!0,i=e.t0;case 17:e.prev=17,e.prev=18,n||null==o.return||o.return();case 20:if(e.prev=20,!a){e.next=23;break}throw i;case 23:return e.finish(20);case 24:return e.finish(17);case 25:case"end":return e.stop()}}),t,this,[[2,13,17,25],[18,,20,24]])}))},{key:"edit",value:function(t,r){var n=this;return i.asyncToGenerator(e(s).mark((function a(){var o,u,c,l,f,h,p,v,y;return e(s).wrap((function(a){for(;;)switch(a.prev=a.next){case 0:for(o=Array.from(n._subscriptions.values()),u=o.map((function(e){return e.tile})),c=!0,l=!1,f=void 0,a.prev=2,h=o[Symbol.iterator]();!(c=(p=h.next()).done);c=!0)p.value.removeIds(r);a.next=10;break;case 6:a.prev=6,a.t0=a.catch(2),l=!0,f=a.t0;case 10:a.prev=10,a.prev=11,c||null==h.return||h.return();case 13:if(a.prev=13,!l){a.next=16;break}throw f;case 16:return a.finish(13);case 17:return a.finish(10);case 18:if(!t.length){a.next=25;break}return v=u.map((function(e){var r=n.createTileQuery(e);return r.objectIds=t,{tile:e,query:r}})).map(function(){var t=i.asyncToGenerator(e(s).mark((function t(r){var a,i;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=r.tile,i=r.query,e.t0=a,e.next=4,n.query(i);case 4:return e.t1=e.sent,e.t2=i,e.abrupt("return",{tile:e.t0,result:e.t1,query:e.t2});case 7:case"end":return e.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),a.next=22,(0,d.eachAlwaysValues)(v);case 22:return y=a.sent.map(function(){var a=i.asyncToGenerator(e(s).mark((function a(i){var o,u,c;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=i.tile,(u=i.result).hasFeatures||r.length||t.length){e.next=3;break}return e.abrupt("return");case 3:(c=n._subscriptions.get(o.key.id))&&c.edit(u,t);case 5:case"end":return e.stop()}}),a)})));return function(e){return a.apply(this,arguments)}}()),a.next=25,(0,d.eachAlways)(y);case 25:n._didEdit=!0;case 26:case"end":return a.stop()}}),a,null,[[2,6,10,18],[11,,13,17]])})))()}}]),t}()})),r.register("4rMWh",(function(n,a){t(n.exports,"DataTileSubscription",(function(){return d}));var i=r("8TSCy"),s=r("2TvXO"),o=r("gDoEW"),u=r("7qybv"),c=r("5STKO"),l=r("8LcfB"),d=function(){"use strict";function t(e){i.classCallCheck(this,t),this.requests={done:new Array,stream:new(0,o.default)(10)},this._edits=null,this._abortController=new AbortController,this._done=!1,this.didSend=!1,this.tile=e}return i.createClass(t,[{key:"signal",get:function(){return this._abortController.signal}},{key:"options",get:function(){return{signal:this._abortController.signal}}},{key:"empty",get:function(){return!this.requests.done.length}},{key:"edits",get:function(){return this._edits}},{key:"done",get:function(){return this._done}},{key:"end",value:function(){this._done=!0}},{key:"clear",value:function(){this.requests.done=[]}},{key:"applyUpdate",value:function(e){this.requests.done.forEach((function(t){return t.message.status.unset(e)})),(0,u.isSome)(this._edits)&&this._edits.status.unset(e)}},{key:"add",value:function(e){var t;e.message.status=null!=(t=e.message.status)?t:l.UpdateToken.empty(),e.message.end&&this.requests.done.forEach((function(e){(0,u.isSome)(e.message)&&e.message.end&&(e.message.end=!1)})),this.requests.done.push(e)}},{key:"edit",value:function(e,t){var r=e.getQuantizationTransform(),n=e.fullSchema(),a=Array.from(e.features()),s=i.toConsumableArray(t).concat(i.toConsumableArray(a.map((function(e){return e.objectId}))));this.removeIds(s),this._invalidate(),(0,u.isNone)(this._edits)?this._edits={type:"append",addOrUpdate:c.FeatureSetReaderJSON.fromOptimizedFeatures(a,n,(0,u.unwrap)(r)),id:this.tile.id,status:l.UpdateToken.empty(),end:!0}:(this.requests.done.forEach((function(e){return e.message.end=!1})),(0,u.unwrap)(this._edits.addOrUpdate).append(e.features()))}},{key:"readers",value:e(s).mark((function t(){var r,n,a,i,o,c,l;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=!0,n=!1,a=void 0,e.prev=1,i=this.requests.done[Symbol.iterator]();case 3:if(r=(o=i.next()).done){e.next=12;break}if(c=o.value,l=c.message,e.t0=(0,u.isSome)(l.addOrUpdate),!e.t0){e.next=9;break}return e.next=9,l.addOrUpdate;case 9:r=!0,e.next=3;break;case 12:e.next=18;break;case 14:e.prev=14,e.t1=e.catch(1),n=!0,a=e.t1;case 18:e.prev=18,e.prev=19,r||null==i.return||i.return();case 21:if(e.prev=21,!n){e.next=24;break}throw a;case 24:return e.finish(21);case 25:return e.finish(18);case 26:if(e.t2=(0,u.isSome)(this._edits)&&(0,u.isSome)(this._edits.addOrUpdate),!e.t2){e.next=30;break}return e.next=30,this._edits.addOrUpdate;case 30:case"end":return e.stop()}}),t,this,[[1,14,18,26],[19,,21,25]])}))},{key:"_invalidate",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,a=this.requests.done[Symbol.iterator]();!(e=(n=a.next()).done);e=!0){n.value.message.status=l.UpdateToken.empty()}}catch(e){t=!0,r=e}finally{try{e||null==a.return||a.return()}finally{if(t)throw r}}(0,u.isSome)(this._edits)&&(this._edits.status=l.UpdateToken.empty())}},{key:"removeIds",value:function(e){this._invalidate();var t=!0,r=!1,n=void 0;try{for(var a,i=this.requests.done[Symbol.iterator]();!(t=(a=i.next()).done);t=!0){var s=a.value.message,o=s.addOrUpdate;(0,u.isSome)(o)&&(o.removeIds(e),o.isEmpty&&(s.addOrUpdate=null))}}catch(e){r=!0,n=e}finally{try{t||null==i.return||i.return()}finally{if(r)throw n}}(0,u.isSome)(this._edits)&&(0,u.isSome)(this._edits.addOrUpdate)&&this._edits.addOrUpdate.removeIds(e),this.requests.done=this.requests.done.filter((function(e){return e.message.addOrUpdate||e.message.end}))}},{key:"abort",value:function(){this._abortController.abort()}}]),t}()})),r.register("gDoEW",(function(e,n){t(e.exports,"default",(function(){return s}));var a=r("8TSCy"),i=r("7qybv"),s=function(){"use strict";function e(t){a.classCallCheck(this,e),this.size=0,this._start=0,this.maxSize=t,this._buffer=new Array(t)}return a.createClass(e,[{key:"entries",get:function(){return this._buffer}},{key:"enqueue",value:function(e){if(this.size===this.maxSize){var t=this._buffer[this._start];return this._buffer[this._start]=e,this._start=(this._start+1)%this.maxSize,t}return this._buffer[(this._start+this.size++)%this.maxSize]=e,null}},{key:"dequeue",value:function(){if(0===this.size)return null;var e=this._buffer[this._start];return this._buffer[this._start]=null,this.size--,this._start=(this._start+1)%this.maxSize,e}},{key:"peek",value:function(){return 0===this.size?null:this._buffer[this._start]}},{key:"find",value:function(e){if(0===this.size)return null;var t=!0,r=!1,n=void 0;try{for(var a,s=this._buffer[Symbol.iterator]();!(t=(a=s.next()).done);t=!0){var o=a.value;if((0,i.isSome)(o)&&e(o))return o}}catch(e){r=!0,n=e}finally{try{t||null==s.return||s.return()}finally{if(r)throw n}}return null}},{key:"clear",value:function(e){for(var t=this.dequeue();(0,i.isSome)(t);)e&&e(t),t=this.dequeue()}}]),e}()})),r.register("8LcfB",(function(e,n){t(e.exports,"UpdateToken",(function(){return i}));var a=r("8TSCy"),i=function(){"use strict";function e(){a.classCallCheck(this,e),this.source=!1,this.targets={feature:!1,aggregate:!1},this.storage={filters:!1,data:!1},this.mesh=!1,this.queryFilter=!1,this.why={mesh:[],source:[]}}return a.createClass(e,[{key:"unset",value:function(e){e.source&&(this.source=!1),e.targets.feature&&(this.targets.feature=!1),e.targets.aggregate&&(this.targets.aggregate=!1),e.storage.filters&&(this.storage.filters=!1),e.storage.data&&(this.storage.data=!1),e.mesh&&(this.mesh=!1),e.queryFilter&&(this.queryFilter=!1)}},{key:"any",value:function(){return this.source||this.mesh||this.storage.filters||this.storage.data||this.targets.feature||this.targets.aggregate||this.queryFilter}},{key:"describe",value:function(){var e=0,t="";if(this.mesh){e+=20,t+="-> (20) Mesh needs update\n";var r=!0,n=!1,a=void 0;try{for(var i,s=this.why.mesh[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var o=i.value;t+="    + ".concat(o,"\n")}}catch(e){n=!0,a=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw a}}}if(this.source){e+=10,t+="-> (10) The source needs update\n";var u=!0,c=!1,l=void 0;try{for(var d,f=this.why.source[Symbol.iterator]();!(u=(d=f.next()).done);u=!0){var h=d.value;t+="    + ".concat(h,"\n")}}catch(e){c=!0,l=e}finally{try{u||null==f.return||f.return()}finally{if(c)throw l}}}this.targets.feature&&(e+=5,t+="-> (5) Feature target parameters changed\n"),this.storage.filters&&(e+=5,t+="-> (5) Feature filter parameters changed\n"),this.targets.aggregate&&(e+=4,t+="-> (4) Aggregate target parameters changed\n"),this.storage.data&&(e+=1,t+="-> (1) Texture storage parameters changed");var p=e<5?"Fastest":e<10?"Fast":e<15?"Moderate":e<20?"Slow":"Very Slow";console.debug("Applying ".concat(p," update of cost ").concat(e,"/45 ")),console.debug(t)}},{key:"toJSON",value:function(){return{queryFilter:this.queryFilter,source:this.source,targets:this.targets,storage:this.storage,mesh:this.mesh}}}],[{key:"create",value:function(t){var r=new e;for(var n in t){var a=t[n];if("object"==typeof a)for(var i in a){var s=a[i];r[n][i]=s}r[n]=a}return r}},{key:"empty",value:function(){return e.create({})}},{key:"all",value:function(){return e.create({source:!0,targets:{feature:!0,aggregate:!0},storage:{filters:!0,data:!0},mesh:!0})}}]),e}()})),r.register("erRgw",(function(n,a){t(n.exports,"GeoEventSource",(function(){return _}));var i=r("8TSCy"),s=r("2TvXO");r("2VlWd");var o=r("7qybv"),u=r("38gAI"),c=r("akQYU"),l=r("awxBI"),d=r("3Nw26"),f=r("ho6jZ"),h=r("23qU2"),p=r("5STKO"),v=r("8LcfB");function y(e,t){var r=e.weakClone();if((0,o.isSome)(e.geometry)){var n=(0,c.quantizeX)(t,e.geometry.coords[0]),a=(0,c.quantizeY)(t,e.geometry.coords[1]);r.geometry=new(0,l.default)([],[n,a])}return r}function g(e,t){var r=(0,u.r)(9,"esriGeometryPoint"===t?function(e){return(0,o.isSome)(e.geometry)?{minX:e.geometry.coords[0],minY:e.geometry.coords[1],maxX:e.geometry.coords[0],maxY:e.geometry.coords[1]}:{minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0}}:function(e){var t=1/0,r=1/0,n=-1/0,a=-1/0;return(0,o.isSome)(e.geometry)&&e.geometry.forEachVertex((function(e,i){t=Math.min(t,e),r=Math.min(r,i),n=Math.max(n,e),a=Math.max(a,i)})),{minX:t,minY:r,maxX:n,maxY:a}});return r.load(e),r}var m=function(){"use strict";function e(t,r){i.classCallCheck(this,e),this.onUpdate=t,this._geometryType=r,this._objectIdToFeature=new Map}return i.createClass(e,[{key:"_features",get:function(){var e=[];return this._objectIdToFeature.forEach((function(t){return e.push(t)})),e}},{key:"add",value:function(e){this._objectIdToFeature.set(e.objectId,e),this._index=null}},{key:"get",value:function(e){return this._objectIdToFeature.has(e)?this._objectIdToFeature.get(e):null}},{key:"forEach",value:function(e){this._objectIdToFeature.forEach(e)}},{key:"search",value:function(e){return this._index||(this._index=g(this._features,this._geometryType)),t=this._index,r=e,t.search({minX:r.bounds[0],minY:r.bounds[1],maxX:r.bounds[2],maxY:r.bounds[3]});var t,r}},{key:"removeById",value:function(e){var t=this._objectIdToFeature.get(e);return t?(this._objectIdToFeature.delete(e),this._index=null,t):null}},{key:"update",value:function(e,t){this.onUpdate(e,t)}},{key:"size",get:function(){return this._objectIdToFeature.size}}]),e}(),_=function(t){"use strict";i.inherits(n,t);var r=i.createSuper(n);function n(e){var t;i.classCallCheck(this,n),(t=r.call(this,e)).type="geoevent",t._dataReceiveEventEnabled=!1,t._level=0,t._updateInfo={websocket:0,client:0};var a,s=e.outSR,o=e.serviceInfo,u=o.geometryType,h=o.objectIdField,p=o.timeInfo,v=o.purgeOptions,g=o.source,_=o.spatialReference,b=o.serviceFilter,x=o.maxReconnectionAttempts,k=o.maxReconnectionInterval,S=o.updateInterval,w=o.enableDataReceived,I=o.customParameters,T=new m(t._onUpdate.bind(i.assertThisInitialized(t)),u),C=new(0,d.StreamFeatureManager)(T,h,p,v),F=(0,f.createConnection)(g,_,s,u,b,x,k,I);return t._store=T,t._manager=C,t._connection=F,t._quantize="esriGeometryPoint"===(a=u)?y:function(e,t){var r=e.weakClone(),n=new(0,l.default),i=(0,c.quantizeOptimizedGeometry)(n,e.geometry,!1,!1,a,t,!1,!1);return r.geometry=i,r},t._dataReceiveEventEnabled=w,t._handles=[t._connection.on("feature",(function(e){return t._onFeature(e)})),t._connection.watch("connectionStatus",(function(e){return t.events.emit("connectionStatus",e)})),t._connection.watch("errorString",(function(e){return t.events.emit("errorString",e)}))],t._initUpdateInterval=function(){var r=performance.now();t._updateIntervalId=setInterval((function(){var n=performance.now(),a=n-r;if(a>2500){r=n;var i=Math.round(t._updateInfo.client/(a/1e3)),s=Math.round(t._updateInfo.websocket/(a/1e3));t._updateInfo.client=0,t._updateInfo.websocket=0,t.events.emit("updateRate",{client:i,websocket:s})}e.canAcceptRequest()&&t._manager.checkForUpdates()}),S)},t._initUpdateInterval(),i.possibleConstructorReturn(t)}return i.createClass(n,[{key:"destroy",value:function(){i.get(i.getPrototypeOf(n.prototype),"destroy",this).call(this),this._clearUpdateInterval(),this._handles.forEach((function(e){return e.remove()})),this._connection.destroy()}},{key:"_fetchDataTile",value:function(){}},{key:"pauseStream",value:function(){this._clearUpdateInterval()}},{key:"resumeStream",value:function(){this._initUpdateInterval()}},{key:"enableEvent",value:function(e,t){"data-received"===e&&(this._dataReceiveEventEnabled=t)}},{key:"updating",get:function(){return!1}},{key:"subscribe",value:function(e){i.get(i.getPrototypeOf(n.prototype),"subscribe",this).call(this,e);var t=this._subscriptions.get(e.id);this._level=e.level;var r=this._getTileFeatures(e);this._onMessage({type:"append",id:e.key.id,addOrUpdate:r,end:!0}),t.didSend=!0}},{key:"unsubscribe",value:function(e){i.get(i.getPrototypeOf(n.prototype),"unsubscribe",this).call(this,e)}},{key:"readers",value:e(s).mark((function t(r){var n,a,i,u,c,l,d,f;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._subscriptions.get(r),a=n.tile,e.next=3,this._getTileFeatures(a);case 3:i=!0,u=!1,c=void 0,e.prev=4,l=n.requests.stream.entries[Symbol.iterator]();case 6:if(i=(d=l.next()).done){e.next=15;break}if(f=d.value,e.t0=(0,o.isSome)(f)&&(0,o.isSome)(f.addOrUpdate),!e.t0){e.next=12;break}return e.next=12,f.addOrUpdate;case 12:i=!0,e.next=6;break;case 15:e.next=21;break;case 17:e.prev=17,e.t1=e.catch(4),u=!0,c=e.t1;case 21:e.prev=21,e.prev=22,i||null==l.return||l.return();case 24:if(e.prev=24,!u){e.next=27;break}throw c;case 27:return e.finish(24);case 28:return e.finish(21);case 29:case"end":return e.stop()}}),t,this,[[4,17,21,29],[22,,24,28]])}))},{key:"createTileQuery",value:function(e){throw new Error("Service does not support tile  queries")}},{key:"resend",value:function(){var t=this;return i.asyncToGenerator(e(s).mark((function r(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t._subscriptions.forEach((function(e){var r=e.tile,n={type:"append",id:r.id,addOrUpdate:t._getTileFeatures(r),end:!0};t._onMessage(n)}));case 1:case"end":return e.stop()}}),r)})))()}},{key:"_getTileFeatures",value:function(e){var t=this,r=this._store.search(e).map((function(r){return t._quantize(r,e.transform)}));return p.FeatureSetReaderJSON.fromOptimizedFeatures(r,this._serviceInfo,e.transform)}},{key:"_onFeature",value:function(e){this._updateInfo.websocket++;try{this._dataReceiveEventEnabled&&this.events.emit("feature",e);var t=(0,c.convertFromFeature)(e,this._serviceInfo.geometryType,!1,!1,this._serviceInfo.objectIdField);this._manager.add(t)}catch(e){}}},{key:"_clearUpdateInterval",value:function(){clearInterval(this._updateIntervalId),this._updateIntervalId=0}},{key:"_onUpdate",value:function(e,t){var r=this;(0,o.isSome)(e)&&(this._updateInfo.client+=e.length),this._subscriptions.forEach((function(e,t){e.didSend&&e.tile.level===r._level&&r._onMessage({type:"append",id:t,addOrUpdate:null,clear:!0,end:!1})})),this._subscriptions.forEach((function(e,t){if(e.didSend&&e.tile.level===r._level){var n=e.tile,a={type:"append",id:t,addOrUpdate:r._getTileFeatures(n),remove:[],end:!0,status:v.UpdateToken.empty()};e.requests.stream.enqueue(a),r._onMessage(a)}}))}}]),n}(h.DataTileSource)})),r.register("3Nw26",(function(e,n){t(e.exports,"StreamFeatureManager",(function(){return c}));var a=r("8TSCy"),i=r("gDoEW"),s=r("iVfa0"),o=r("7qybv"),u="__esri_stream_id__",c=function(){"use strict";function e(t,r,n,i){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:128;a.classCallCheck(this,e),this._trackIdToObservations=new Map,this._idCounter=0,this._lastPurge=performance.now(),this._addOrUpdated=new Map,this._removed=[],this._maxAge=0,this._timeInfo=n,this._purgeOptions=i,this.store=t,this.objectIdField=r,this.purgeInterval=s,this._useGeneratedIds=this.objectIdField===u}return a.createClass(e,[{key:"add",value:function(e){if(this._useGeneratedIds){var t=this._nextId();e.attributes[this.objectIdField]=t,e.objectId=t}else e.objectId=e.attributes[this.objectIdField];if(this._addOrUpdated.set(e.objectId,e),this._maxAge=Math.max(this._maxAge,e.attributes[this._timeInfo.startTimeField]),!this._timeInfo.trackIdField)return(0,o.isNone)(this._trackIdLessObservations)&&(this._trackIdLessObservations=new(0,i.default)(1e5)),void this._trackIdLessObservations.enqueue(e.objectId);var r=e.attributes[this._timeInfo.trackIdField];if(!this._trackIdToObservations.has(r)){var n=(0,o.isSome)(this._purgeOptions)&&null!=this._purgeOptions.maxObservations?this._purgeOptions.maxObservations:1e3,a=(0,s.clamp)(n,0,1e3);this._trackIdToObservations.set(r,new(0,i.default)(a))}var u=this._trackIdToObservations.get(r).enqueue(e.objectId);(0,o.isSome)(u)&&(this._addOrUpdated.has(u)?this._addOrUpdated.delete(u):this._removed.push(u))}},{key:"checkForUpdates",value:function(){var e=this._getToAdd(),t=this._getToRemove(),r=performance.now();r-this._lastPurge>=this.purgeInterval&&(this._purge(r),this._lastPurge=r);var n=[],a=!0,i=!1,s=void 0;if((0,o.isSome)(t))try{for(var u,c=t[Symbol.iterator]();!(a=(u=c.next()).done);a=!0){var l=u.value,d=this.store.removeById(l);(0,o.isSome)(d)&&n.push(d)}}catch(e){i=!0,s=e}finally{try{a||null==c.return||c.return()}finally{if(i)throw s}}var f=!0,h=!1,p=void 0;if((0,o.isSome)(e))try{for(var v,y=e[Symbol.iterator]();!(f=(v=y.next()).done);f=!0){var g=v.value;g.attributes.__esri_timestamp__=r,this.store.add(g)}}catch(e){h=!0,p=e}finally{try{f||null==y.return||y.return()}finally{if(h)throw p}}(e||n)&&this.store.update(e,n)}},{key:"_getToAdd",value:function(){if(!this._addOrUpdated.size)return null;var e=new Array(this._addOrUpdated.size),t=0;return this._addOrUpdated.forEach((function(r){return e[t++]=r})),this._addOrUpdated.clear(),e}},{key:"_getToRemove",value:function(){var e=this._removed;return this._removed.length?(this._removed=[],e):null}},{key:"_nextId",value:function(){var e=this._idCounter;return this._idCounter=(this._idCounter+1)%4294967294+1,e}},{key:"_purge",value:function(e){var t=this._purgeOptions;(0,o.isSome)(t)&&(this._purgeSomeByDisplayCount(t),this._purgeByAge(t),this._purgeByAgeReceived(e,t),this._purgeTracks())}},{key:"_purgeSomeByDisplayCount",value:function(e){if(e.displayCount){var t=this.store.size;if(t>e.displayCount){if(this._timeInfo.trackIdField){var r=!0,n=!1,a=void 0;try{for(var i,s=this._trackIdToObservations.values()[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var u=i.value;if(t>e.displayCount&&u.size){var c=(0,o.unwrap)(u.dequeue());this._removed.push(c),t--}}}catch(e){n=!0,a=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw a}}}if((0,o.isSome)(this._trackIdLessObservations))for(var l=t-e.displayCount;l-- >0;){var d=this._trackIdLessObservations.dequeue();(0,o.isSome)(d)&&this._removed.push(d)}}}}},{key:"_purgeByAge",value:function(e){var t,r=this;if(e.age&&null!=(t=this._timeInfo)&&t.startTimeField){var n=60*e.age*1e3,a=this._maxAge-n;this.store.forEach((function(e){e.attributes[r._timeInfo.startTimeField]<a&&r._removed.push(e.objectId)}))}}},{key:"_purgeByAgeReceived",value:function(e,t){var r=this;if(t.ageReceived){var n=e-60*t.ageReceived*1e3;this.store.forEach((function(e){e.attributes.__esri_timestamp__<n&&r._removed.push(e.objectId)}))}}},{key:"_purgeTracks",value:function(){var e=this;this._trackIdToObservations.forEach((function(t,r){0===t.size&&e._trackIdToObservations.delete(r)}))}}]),e}()})),r.register("ho6jZ",(function(e,n){t(e.exports,"createConnection",(function(){return s}));var a=r("56uNx"),i=r("jG03R");function s(e,t,r,n,s,o,u,c){var l=0===e.path.indexOf("wss://")||0===e.path.indexOf("ws://"),d={source:e,sourceSpatialReference:t,spatialReference:r,geometryType:n,filter:s,maxReconnectionAttempts:o,maxReconnectionInterval:u,customParameters:c};return l?new(0,i.WebSocketConnection)(d):new(0,a.default)(d)}})),r.register("56uNx",(function(n,a){t(n.exports,"default",(function(){return S}));var i=r("8TSCy"),s=r("2TvXO"),o=r("7eJjO");r("2ILM8");var u=r("9pNSx"),c=r("kyj08"),l=r("jHOLN"),d=r("7qybv"),f=r("10vEZ"),h=r("kYueh");r("iJAIC"),r("lNwWH"),r("2VlWd"),r("62edV");var p=r("fcwIv"),v=r("jG03R"),y=r("j6c7r"),g=r("cRlei"),m=r("79LpT"),_=r("j40xv"),b=l.default.getLogger("esri.layers.graphics.sources.connections.GeoEventConnection"),x={maxQueryDepth:5,maxRecordCountFactor:3},k=function(t){"use strict";i.inherits(a,t);var n=i.createSuper(a);function a(e){return i.classCallCheck(this,a),n.call(this,i.objectSpread({},x,e))}return i.createClass(a,[{key:"_open",value:function(){var t=this;return i.asyncToGenerator(e(s).mark((function r(){var n,a,i,o,u;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t._fetchServiceDefinition(t._config.source);case 2:return(n=e.sent).timeInfo.trackIdField||b.warn("GeoEvent service was configured without a TrackIdField. This may result in certain functionality being disabled. The purgeOptions.maxObservations property will have no effect."),a=t._fetchWebSocketUrl(n.streamUrls,t._config.spatialReference),t._buddyServicesQuery||(t._buddyServicesQuery=t._queryBuddyServices()),e.next=8,t._buddyServicesQuery;case 8:return e.next=10,t._tryCreateWebSocket(a);case 10:i=t._config,o=i.filter,u=i.outFields,t.destroyed||t._setFilter(o,u);case 12:case"end":return e.stop()}}),r)})))()}},{key:"_onMessage",value:function(e){var t;try{t=this._enrich(JSON.parse(e.data)),(0,d.isSome)(this._featureZScaler)&&this._featureZScaler(t.geometry)}catch(e){return void b.error(new(0,c.default)("geoevent-connection","Failed to parse message",e))}this.onFeature(t)}},{key:"_fetchServiceDefinition",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){var a,o,c;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=i.objectSpread({f:"json"},r._config.customParameters),o=(0,u.default)(t.path,{query:a,responseType:"json"}),e.next=4,o;case 4:return c=e.sent.data,e.abrupt("return",(r._serviceDefinition=c,c));case 6:case"end":return e.stop()}}),n)})))()}},{key:"_fetchWebSocketUrl",value:function(e,t){var r=e[0],n=r.urls,a=r.token,i=this._inferWebSocketBaseUrl(n);return(0,h.addQueryParameters)("".concat(i,"/subscribe"),{outSR:""+t.wkid,token:a})}},{key:"_inferWebSocketBaseUrl",value:function(e){if(1===e.length)return e[0];var t=!0,r=!1,n=void 0;try{for(var a,i=e[Symbol.iterator]();!(t=(a=i.next()).done);t=!0){var s=a.value;if(-1!==s.indexOf("wss"))return s}}catch(e){r=!0,n=e}finally{try{t||null==i.return||i.return()}finally{if(r)throw n}}return b.error(new(0,c.default)("geoevent-connection","Unable to infer WebSocket url",e)),null}},{key:"_setFilter",value:function(t,r){var n=this;return i.asyncToGenerator(e(s).mark((function a(){var i,o,u,l,h,p;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=n._websocket,!((0,d.isNone)(i)||(0,d.isNone)(t)&&(0,d.isNone)(r))){e.next=3;break}return e.abrupt("return");case 3:return o=JSON.stringify({filter:n._serializeFilter(t,r)}),u=!1,l=(0,f.createResolver)(),h=function(){u||(n.destroyed||n._websocket!==i||b.error(new(0,c.default)("geoevent-connection","Server timed out when setting filter")),l.reject())},p=function(e){var t=JSON.parse(e.data);t.filter&&(t.error&&(b.error(new(0,c.default)("geoevent-connection","Failed to set service filter",t.error)),n._set("errorString","Could not set service filter - ".concat(t.error)),l.reject(t.error)),i.onmessage=n._onMessage.bind(n),u=!0,l.resolve())},e.abrupt("return",(i.onmessage=p,i.send(o),setTimeout(h,1e4),l.promise));case 7:case"end":return e.stop()}}),a)})))()}},{key:"_serializeFilter",value:function(e,t){var r={};if((0,d.isNone)(e)&&(0,d.isNone)(t))return r;if((0,d.isSome)(e)&&e.geometry)try{var n=(0,m.fromJSON)(e.geometry);if("extent"!==n.type)throw new(0,c.default)("Expected extent but found type ".concat(n.type));r.geometry=JSON.stringify(n.shiftCentralMeridian())}catch(e){b.error(new(0,c.default)("geoevent-connection","Encountered an error when setting connection geometryDefinition",e))}return(0,d.isSome)(e)&&e.where&&"1 = 1"!==e.where&&(r.where=e.where),(0,d.isSome)(t)&&(r.outFields=t.join(",")),r}},{key:"_enrich",value:function(e){if(!this._relatedFeatures)return e;var t=this._serviceDefinition.relatedFeatures.joinField,r=e.attributes[t];if(!this._relatedFeatures.has(r))return b.warn("geoevent-connection","Feature join failed. Is the join field configured correctly?",e),e;var n=this._relatedFeatures.get(r),a=n.attributes,i=n.geometry;for(var s in a)e.attributes[s]=a[s];return i&&(e.geometry=i),e.geometry||e.centroid||b.error(new(0,c.default)("geoevent-connection","Found malformed feature - no geometry found",e)),e}},{key:"_queryBuddyServices",value:function(){var t=this;return i.asyncToGenerator(e(s).mark((function r(){var n,a,i,o,u,l,d,f,h,p,v,y;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,n=t._serviceDefinition,a=n.relatedFeatures,i=n.keepLatestArchive,o=t._queryRelatedFeatures(a),u=t._queryArchive(i),e.next=4,o;case 4:return e.next=6,u;case 6:if(l=e.sent){e.next=9;break}return e.abrupt("return");case 9:for(d=!0,f=!1,h=void 0,e.prev=10,p=l.features[Symbol.iterator]();!(d=(v=p.next()).done);d=!0)y=v.value,t.onFeature(t._enrich(y));e.next=18;break;case 14:e.prev=14,e.t0=e.catch(10),f=!0,h=e.t0;case 18:e.prev=18,e.prev=19,d||null==p.return||p.return();case 21:if(e.prev=21,!f){e.next=24;break}throw h;case 24:return e.finish(21);case 25:return e.finish(18);case 26:e.next=31;break;case 28:e.prev=28,e.t1=e.catch(0),b.error(new(0,c.default)("geoevent-connection","Encountered an error when querying buddy services",{error:e.t1}));case 31:case"end":return e.stop()}}),r,null,[[0,28],[10,14,18,26],[19,,21,25]])})))()}},{key:"_queryRelatedFeatures",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){var a;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,r._queryBuddy(t.featuresUrl);case 4:a=e.sent,r._addRelatedFeatures(a);case 6:case"end":return e.stop()}}),n)})))()}},{key:"_queryArchive",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t){e.next=2;break}return e.abrupt("return",r._queryBuddy(t.featuresUrl));case 2:case"end":return e.stop()}}),n)})))()}},{key:"_queryBuddy",value:function(t){var n=this;return i.asyncToGenerator(e(s).mark((function a(){var i,o,u,c,l,f,h,p,v,m,b;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r("lRYVJ");case 2:return e.t0=e.sent.default,e.t1={url:t},i=new e.t0(e.t1),e.next=7,i.load();case 7:if(o=e.sent,u=o.capabilities,c=u.query.supportsMaxRecordCountFactor,l=u.query.supportsPagination,f=u.query.supportsCentroid,h=n._config.maxRecordCountFactor,p=i.capabilities.query.maxRecordCount,v=c?p*h:p,(m=new(0,g.default)).outFields=(0,d.unwrapOr)(n._config.outFields,["*"]),m.where=(0,d.unwrapOr)((0,d.get)(n._config.filter,"where"),"1=1"),m.returnGeometry=!0,m.returnExceededLimitFeatures=!0,m.outSpatialReference=_.default.fromJSON(n._config.spatialReference),f&&(m.returnCentroid=!0),c&&(m.maxRecordCountFactor=h),!l){e.next=18;break}return e.abrupt("return",(m.num=v,i.destroy(),n._queryPages(t,m)));case 18:return e.next=20,(0,y.executeQuery)(t,m,n._config.sourceSpatialReference);case 20:return b=e.sent,e.abrupt("return",(i.destroy(),b.data));case 22:case"end":return e.stop()}}),a)})))()}},{key:"_queryPages",value:function(t,r){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=this;return i.asyncToGenerator(e(s).mark((function i(){var u,c;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r.start=(0,d.isSome)(r.num)?a*r.num:null,e.next=3,(0,y.executeQuery)(t,r,o._config.sourceSpatialReference);case 3:return u=e.sent,c=u.data,e.abrupt("return",c.exceededTransferLimit&&a<o._config.maxQueryDepth?(c.features.forEach((function(e){return n.push(e)})),o._queryPages(t,r,n,a+1)):(n.forEach((function(e){return c.features.push(e)})),c));case 6:case"end":return e.stop()}}),i)})))()}},{key:"_addRelatedFeatures",value:function(e){var t=new Map,r=e.features,n=this._serviceDefinition.relatedFeatures.joinField,a=!0,i=!1,s=void 0;try{for(var o,u=r[Symbol.iterator]();!(a=(o=u.next()).done);a=!0){var c=o.value,l=c.attributes[n];t.set(l,c)}}catch(e){i=!0,s=e}finally{try{a||null==u.return||u.return()}finally{if(i)throw s}}this._relatedFeatures=t}}]),a}(v.WebSocketConnection),S=k=(0,o._)([(0,p.subclass)("esri.layers.graphics.sources.connections.GeoEventConnection")],k)})),r.register("jG03R",(function(n,a){t(n.exports,"WebSocketConnection",(function(){return b}));var i=r("8TSCy"),s=r("2TvXO"),o=r("7eJjO"),u=r("kyj08"),c=r("jHOLN"),l=r("7qybv"),d=r("10vEZ"),f=r("kYueh"),h=r("iho5X");r("lNwWH"),r("2VlWd"),r("iJAIC");var p,v,y=r("fcwIv"),g=r("bRuRM"),m=r("79vh7"),_=c.default.getLogger("esri.layers.graphics.sources.connections.WebSocketConnection");(v=p||(p={}))[v.CONNECTING=0]="CONNECTING",v[v.OPEN=1]="OPEN",v[v.CLOSING=2]="CLOSING",v[v.CLOSED=3]="CLOSED";var b=function(t){"use strict";i.inherits(n,t);var r=i.createSuper(n);function n(e){var t;i.classCallCheck(this,n),(t=r.call(this)).errorString=null;var a=e.geometryType,s=e.spatialReference,o=e.sourceSpatialReference;return t._config=e,t._featureZScaler=(0,g.getGeometryZScaler)(a,o,s),t._open(),i.possibleConstructorReturn(t)}return i.createClass(n,[{key:"_open",value:function(){var t=this;return i.asyncToGenerator(e(s).mark((function r(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t._tryCreateWebSocket();case 2:if(e.t0=t.destroyed,e.t0){e.next=6;break}return e.next=6,t._handshake();case 6:case"end":return e.stop()}}),r)})))()}},{key:"destroy",value:function(){(0,l.isSome)(this._websocket)&&(this._websocket.onopen=null,this._websocket.onclose=null,this._websocket.onerror=null,this._websocket.onmessage=null,this._websocket.close()),this._websocket=null}},{key:"connectionStatus",get:function(){if((0,l.isNone)(this._websocket))return"disconnected";switch(this._websocket.readyState){case p.CONNECTING:case p.OPEN:return"connected";case p.CLOSING:case p.CLOSED:return"disconnected"}}},{key:"_tryCreateWebSocket",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._config.source.path,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1e3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,a=this;return i.asyncToGenerator(e(s).mark((function i(){var o,c;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,!a.destroyed){e.next=3;break}return e.abrupt("return");case 3:return o=(0,f.addQueryParameters)(t,a._config.customParameters),e.next=6,a._createWebSocket(o);case 6:a._websocket=e.sent,a.notifyChange("connectionStatus"),e.next=22;break;case 10:if(e.prev=10,e.t0=e.catch(0),c=r/1e3,!(a._config.maxReconnectionAttempts&&n>=a._config.maxReconnectionAttempts)){e.next=17;break}e.t1=(_.error(new(0,u.default)("websocket-connection","Exceeded maxReconnectionAttempts attempts. No further attempts will be made")),void a.destroy()),e.next=21;break;case 17:return _.error(new(0,u.default)("websocket-connection","Failed to connect. Attempting to reconnect in ".concat(c,"s"),e.t0)),e.next=20,(0,d.after)(r);case 20:e.t1=(e.sent,a._tryCreateWebSocket(t,Math.min(1.5*r,1e3*a._config.maxReconnectionInterval),n+1));case 21:return e.abrupt("return",e.t1);case 22:case"end":return e.stop()}}),i,null,[[0,10]])})))()}},{key:"_createWebSocket",value:function(e){var t=this;return new Promise((function(r,n){var a=t,i=new WebSocket(e);i.onopen=function(){var e=a;if(i.onopen=null,a.destroyed)return i.onclose=null,void i.close();i.onclose=function(t){return e._onClose(t)},i.onerror=function(t){return e._onError(t)},i.onmessage=function(t){return e._onMessage(t)},r(i)},i.onclose=function(e){i.onopen=i.onclose=null,n(e)}}))}},{key:"_handshake",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4,r=this;return i.asyncToGenerator(e(s).mark((function n(){var a,i,o,c,f,h,p;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(a=r._websocket,!(0,l.isNone)(a)){e.next=3;break}return e.abrupt("return");case 3:return i=(0,d.createResolver)(),o=a.onmessage,c=r._config,f=c.filter,h=c.outFields,p=c.spatialReference,e.abrupt("return",(i.timeout(t),a.onmessage=function(e){var t,n=null;try{n=JSON.parse(e.data)}catch(e){}n&&"object"==typeof n||(_.error(new(0,u.default)("websocket-connection","Protocol violation. Handshake failed - malformed message",e.data)),i.reject(),r.destroy()),(null==(t=n.spatialReference)?void 0:t.wkid)!==(null==p?void 0:p.wkid)&&(_.error(new(0,u.default)("websocket-connection","Protocol violation. Handshake failed - expected wkid of ".concat(p.wkid),e.data)),i.reject(),r.destroy()),"json"!==n.format&&(_.error(new(0,u.default)("websocket-connection","Protocol violation. Handshake failed - format is not set",e.data)),i.reject(),r.destroy()),f&&n.filter!==f&&_.error(new(0,u.default)("websocket-connection","Tried to set filter, but server doesn't support it")),h&&n.outFields!==h&&_.error(new(0,u.default)("websocket-connection","Tried to set outFields, but server doesn't support it")),a.onmessage=o,i.resolve()},a.send(JSON.stringify({filter:f,outFields:h,format:"json",spatialReference:{wkid:p.wkid}})),i.promise));case 5:case"end":return e.stop()}}),n)})))()}},{key:"_onMessage",value:function(e){try{var t=JSON.parse(e.data);if("featureResult"!==t.type)throw new(0,u.default)("websocket-connection","Protocol violation - Expected to find message of type 'featureResult'",t);var r=!0,n=!1,a=void 0;try{for(var i,s=t.features[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var o=i.value;(0,l.isSome)(this._featureZScaler)&&this._featureZScaler(o.geometry),this.onFeature(o)}}catch(e){n=!0,a=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw a}}}catch(e){return _.error(new(0,u.default)("websocket-connection","Failed to parse message",e)),void this.destroy()}}},{key:"_onError",value:function(e){var t="Encountered an error over WebSocket connection";this._set("errorString",t),_.error("websocket-connection",t)}},{key:"_onClose",value:function(e){this._websocket=null,this.notifyChange("connectionStatus"),1e3!==e.code&&_.error("websocket-connection","WebSocket closed unexpectedly with error code ".concat(e.code)),this.destroyed||this._open()}}]),n}(m.default);(0,o._)([(0,h.property)()],b.prototype,"connectionStatus",null),(0,o._)([(0,h.property)()],b.prototype,"errorString",void 0),b=(0,o._)([(0,y.subclass)("esri.layers.graphics.sources.connections.WebSocketConnection")],b)})),r.register("79vh7",(function(e,n){t(e.exports,"default",(function(){return l}));var a=r("8TSCy"),i=r("7eJjO"),s=r("amfHf"),o=r("6dXDO");r("jHOLN"),r("iJAIC"),r("lNwWH"),r("2VlWd"),r("62edV");var u=r("fcwIv"),c=function(e){"use strict";a.inherits(r,e);var t=a.createSuper(r);function r(){return a.classCallCheck(this,r),t.apply(this,arguments)}return a.createClass(r,[{key:"onFeature",value:function(e){this.emit("feature",e)}}]),r}(s.default.EventedMixin(o.HandleOwner)),l=c=(0,i._)([(0,u.subclass)("esri.layers.graphics.sources.connections.StreamConnection")],c)})),r.register("lRYVJ",(function(e,t){e.exports=r("4WKyX")(r("aNJCr").getBundleURL("b3gJV")+r("iE7OH").resolve("55FX7")).then((function(){return r("g15Jq")}))})),r.register("aVi46",(function(n,a){t(n.exports,"PagedFeatureSource",(function(){return h}));var i=r("8TSCy"),s=r("2TvXO"),o=r("kyj08"),u=r("jHOLN"),c=r("7qybv"),l=r("10vEZ"),d=r("NMQPz"),f=u.default.getLogger("esri.views.2d.layers.features.sources.FeatureSource"),h=function(t){"use strict";i.inherits(n,t);var r=i.createSuper(n);function n(e){return i.classCallCheck(this,n),r.call(this,e)}return i.createClass(n,[{key:"_fetchDataTile",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){var a,i,u,c,d,h,p,v,y,g,m,_;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:a=6,i=20,u=r._subscriptions.get(t.key.id),c=!1,d=0,h=0,p=function(e,n){h--,(0,l.throwIfAborted)(u);var a=t.id,i=e.reader,s=e.query;if(!i.exceededTransferLimit){if(c=!0,0!==n&&!i.hasFeatures){var o={id:a,addOrUpdate:i,end:0===h,type:"append"};return u.add({message:o,query:s}),void r._onMessage(o)}var d={id:a,addOrUpdate:i,end:0===h,type:"append"};return u.add({message:d,query:s}),void r._onMessage(d)}var f={id:a,addOrUpdate:i,end:c&&0===h,type:"append"};u.add({message:f,query:s}),r._onMessage(f)},v=0,y=0;case 4:if(c||!(y++<i)){e.next=13;break}for(m=0;m<v+1;m++)_=d++,h++,g=r._fetchDataTilePage(t,_,u).then((function(e){return e&&p(e,_)})).catch((function(e){c=!0,(0,l.isAbortError)(e)||(f.error(new(0,o.default)("mapview-query-error","Encountered error when fetching tile",{tile:t,error:e})),r._onMessage({id:t.id,addOrUpdate:null,end:c,type:"append"}))}));return e.next=9,g;case 9:(0,l.throwIfAborted)(u),v=Math.min(v+2,a);case 11:e.next=4;break;case 13:case"end":return e.stop()}}),n)})))()}},{key:"_fetchDataTilePage",value:function(t,r,n){var a=this;return i.asyncToGenerator(e(s).mark((function i(){var o,u,d,f,h;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(0,l.throwIfAborted)(n),o=a._queryInfo,u={start:a.pageSize*r,num:a.pageSize,returnExceededLimitFeatures:!0,quantizationParameters:t.getQuantizationParameters()},(0,c.isSome)(a.maxRecordCountFactor)&&(u.maxRecordCountFactor=a.maxRecordCountFactor),d=a.createTileQuery(t,u),e.prev=4,f=n.signal,e.next=8,a._queue.push({tile:t,query:d,signal:f,depth:r});case 8:return h=e.sent,e.abrupt("return",((0,l.throwIfAborted)(n),h?o!==a._queryInfo?a._fetchDataTilePage(t,r,n):{reader:h,query:d}:null));case 12:return e.prev=12,e.t0=e.catch(4),e.abrupt("return",((0,l.throwIfNotAbortError)(e.t0),null));case 15:case"end":return e.stop()}}),i,null,[[4,12]])})))()}}]),n}(d.BaseFeatureSource)})),r.register("hSjjm",(function(n,a){t(n.exports,"SnapshotFeatureSource",(function(){return y}));var i=r("8TSCy"),s=r("2TvXO");r("2VlWd");var o=r("jHOLN"),u=r("7qybv"),c=r("10vEZ"),l=r("hvORu"),d=r("NMQPz"),f=r("esg0R"),h=r("8LcfB"),p=o.default.getLogger("esri.views.2d.layers.features.sources.SnapshotFeatureSource");function v(e,t){if((0,u.isNone)(e))return null;var r=t.transform,n=e.getQuantizationTransform();if((0,u.isNone)(n)){var a=i.slicedToArray(r.scale,2),s=a[0],o=a[1],c=i.slicedToArray(r.translate,2),l=-c[0]/s,d=1/s,f=c[1]/o,h=1/-o;return e.transform(l,f,d,h)}var p=i.slicedToArray(n.scale,2),v=p[0],y=p[1],g=i.slicedToArray(n.translate,2),m=g[0],_=g[1],b=i.slicedToArray(r.scale,2),x=b[0],k=b[1],S=i.slicedToArray(r.translate,2),w=v/x,I=(m-S[0])/x,T=y/k,C=(-_+S[1])/k;return e.transform(I,C,w,T)}var y=function(t){"use strict";i.inherits(n,t);var r=i.createSuper(n);function n(e){var t;return i.classCallCheck(this,n),(t=r.call(this,e)).mode="snapshot",t._loading=!0,t._controller=new AbortController,t._downloadPromise=null,t._didSendEnd=!1,t._queries=new Array,t._invalidated=!1,t._hasAggregates=!1,t._random=new(0,l.default)(1e3),t._store=e.store,t._markedIdsBufId=t._store.storage.createBitset(),i.possibleConstructorReturn(t)}return i.createClass(n,[{key:"destroy",value:function(){i.get(i.getPrototypeOf(n.prototype),"destroy",this).call(this),this._controller.abort()}},{key:"loading",get:function(){return this._loading}},{key:"_signal",get:function(){return this._controller.signal}},{key:"update",value:function(e,t){i.get(i.getPrototypeOf(n.prototype),"update",this).call(this,e,t),this._hasAggregates=e.targets.aggregate}},{key:"resend",value:function(){var t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=this;return i.asyncToGenerator(e(s).mark((function n(){var a,i;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,r._downloadPromise;case 2:if(e.sent,!r._invalidated&&!t){e.next=10;break}return a=(0,u.unwrapOrThrow)(r._schema.featureCount,"Expected featureCount to be defined"),r._invalidated=!1,r._subscriptions.forEach((function(e){return e.clear()})),r._downloadPromise=r._download(a),e.next=9,r._downloadPromise;case 9:return e.abrupt("return",void e.sent);case 10:return i=r._queries.map((function(e){var t=e.query,n=e.reader;return r._sendPatchQuery(t,n)})),e.next=13,Promise.all(i);case 13:r._subscriptions.forEach((function(e){e.requests.done.forEach((function(e){return r._onMessage(e.message)}))}));case 14:case"end":return e.stop()}}),n)})))()}},{key:"refresh",value:function(){var t=this;return i.asyncToGenerator(e(s).mark((function r(){return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.resend(!0);case 2:case"end":return e.stop()}}),r)})))()}},{key:"_sendPatchQuery",value:function(t,r){var n=this;return i.asyncToGenerator(e(s).mark((function a(){var i,o,l,d,f,h;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=(0,u.isSome)(t.outFields)?t.outFields:[],o=n._queryInfo.outFields,(l=o.filter((function(e){return-1===i.indexOf(e)}))).length){e.next=3;break}return e.abrupt("return");case 3:return d=t.clone(),f=n._signal,d.returnGeometry=!1,d.returnCentroid=!1,d.outFields=l,t.outFields=o,e.next=7,n._queue.push({query:d,depth:0,signal:f});case 7:h=e.sent,(0,c.throwIfAborted)({signal:f}),r.joinAttributes(h);case 9:case"end":return e.stop()}}),a)})))()}},{key:"_fetchDataTile",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){var a,i,o,l,d,f,p,y,g,m;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r._downloadPromise||(a=(0,u.unwrapOrThrow)(r._schema.featureCount,"Expected featureCount to be defined"),r._downloadPromise=r._download(a)),i=r._store.search(t),o=r._subscriptions.get(t.key.id),l=i.length-1,d=0;case 3:if(!(d<l)){e.next=14;break}if(f=v(i[d],t),p={type:"append",id:t.id,addOrUpdate:f,end:!1,status:h.UpdateToken.empty()},o.add({query:null,message:p}),e.t0=r._hasAggregates,e.t0){e.next=10;break}return e.next=10,(0,c.after)(1);case 10:r._onMessage(p);case 11:d++,e.next=3;break;case 14:y=v(l>=0?i[l]:null,t),g=r._didSendEnd,m={type:"append",id:t.id,addOrUpdate:y,end:g,status:h.UpdateToken.empty()},o.add({query:null,message:m}),r._onMessage(m);case 16:case"end":return e.stop()}}),n)})))()}},{key:"_download",value:function(t){var r=this;return i.asyncToGenerator(e(s).mark((function n(){var a,i,o,u;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,r.whenInitialized();case 3:return a=r._store.storage.getBitset(r._markedIdsBufId),i=new Set,a.clear(),o=Math.ceil(t/r.pageSize),u=Array.from({length:o},(function(e,t){return t})).sort((function(e,t){return r._random.getInt()-r._random.getInt()})).map((function(e){return r._downloadPage(e,a,i)})),e.next=8,Promise.all(u);case 8:r._store.sweepFeatures(a,r._store.storage),r._store.sweepFeatureSets(i),e.next=15;break;case 12:e.prev=12,e.t0=e.catch(0),p.error("mapview-snapshot-source","Encountered and error when downloading feature snapshot",e.t0);case 15:r._sendEnd(),r._loading=!1;case 16:case"end":return e.stop()}}),n,null,[[0,12]])})))()}},{key:"_downloadPage",value:function(t,r,n){var a=this;return i.asyncToGenerator(e(s).mark((function i(){var o,l,d,f,h,p;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=a.pageSize,l={start:t*o,num:o,cacheHint:!0},(0,u.isSome)(a.maxRecordCountFactor)&&(l.maxRecordCountFactor=a.maxRecordCountFactor),d=a.createQuery(l),f=a._signal,e.next=6,a._queue.push({query:d,depth:t,signal:f});case 6:for(h=e.sent,(0,c.throwIfAborted)({signal:f}),a._queries.push({query:d,reader:h}),a._store.insert(h),n.add(h.instance),p=h.getCursor();p.next();)r.set(p.getDisplayId());a._send(h);case 11:case"end":return e.stop()}}),i)})))()}},{key:"_send",value:function(e){var t=this;if(this._subscriptions.size){var r=null,n=new Map,a=new Set,i=new Map;this._subscriptions.forEach((function(e){var t,s=e.tile;n.set(s.key.id,null),r=s.tileInfoView,a.add(s.level);var o=s.key,u=o.row,c=o.col,l="".concat(s.level,"/").concat(u,"/").concat(c),d=null!=(t=i.get(l))?t:[];d.push(e),i.set(l,d)}));var s,o,c,l,d,p,y,g=!0,m=!1,_=void 0;try{for(var b,x=a[Symbol.iterator]();!(g=(b=x.next()).done);g=!0)for(var k=b.value,S=r.getLODInfoAt(k),w=e.getCursor();w.next();){var I=(o=S,c=k,l=void 0,d=void 0,p=void 0,y=void 0,l=(s=w).getXHydrated(),d=s.getYHydrated(),p=o.getColumnForX(l),y=Math.floor(o.normalizeCol(p)),"".concat(c,"/").concat(Math.floor(o.getRowForY(d)),"/").concat(y)),T=w.getIndex(),C=!0,F=!1,M=void 0;if(i.has(I))try{for(var E,O=i.get(I)[Symbol.iterator]();!(C=(E=O.next()).done);C=!0){var q=E.value.tile.id,A=n.get(q);(0,u.isNone)(A)&&(A=[],n.set(q,A)),A.push(T)}}catch(e){F=!0,M=e}finally{try{C||null==O.return||O.return()}finally{if(F)throw M}}}}catch(e){m=!0,_=e}finally{try{g||null==x.return||x.return()}finally{if(m)throw _}}n.forEach((function(r,n){if((0,u.isSome)(r)){var a=t._subscriptions.get(n),i={type:"append",id:n,addOrUpdate:v(f.FeatureSetReaderIndirect.from(e,r),a.tile),end:!1,status:h.UpdateToken.empty()};a.add({query:null,message:i}),t._onMessage(i)}}))}}},{key:"_sendEnd",value:function(){var e=this;this._subscriptions.forEach((function(t){var r={type:"append",id:t.tile.id,addOrUpdate:null,end:!0,status:h.UpdateToken.empty()};t.add({query:null,message:r}),e._onMessage(r)})),this._didSendEnd=!0}}]),n}(d.BaseFeatureSource)})),r.register("eJHSv",(function(n,a){t(n.exports,"ClusterStore",(function(){return T}));var i=r("8TSCy"),s=r("2TvXO");r("2ILM8");var o=r("amfHf"),u=r("2VlWd"),c=r("7qybv"),l=r("9doMy"),d=r("8Vmmp"),f=r("bUB3w"),h=r("8NvwW"),p=r("eY5Yp"),v=r("akQYU"),y=r("ft2bT"),g=r("awxBI"),m=r("fP7bp"),_=r("4WoSm"),b=r("ieqnL"),x=r("eOTSy"),k=r("5STKO"),S=r("j40xv"),w=function(e){"use strict";i.inherits(r,e);var t=i.createSuper(r);function r(e,n,a,s,o){var u;return i.classCallCheck(this,r),(u=t.call(this,new(0,g.default)([],[n,a]),s,null,e)).geohashBoundsInfo=o,i.possibleConstructorReturn(u)}return i.createClass(r,[{key:"count",get:function(){return this.attributes.cluster_count}},{key:"update",value:function(e,t,r,n,a,i){return this.geometry.coords[0]=e,this.geometry.coords[1]=t,this.tileLevel=r,this.attributes=n,this.geohashBoundsInfo=a,this.referenceId=null,this.referenceId=i,this}},{key:"toJSON",value:function(){return{objectId:this.objectId,referenceId:1===this.attributes.cluster_count?this.referenceId:null,attributes:i.objectSpread({},this.attributes,{clusterId:this.objectId}),geometry:{x:this.geometry.coords[0],y:this.geometry.coords[1]}}}}],[{key:"create",value:function(e,t,n,a,i,s,o,u){var c=new r(t,n,a,s,o);return c.displayId=e.createDisplayId(!0),c.referenceId=u,c.tileLevel=i,c}}]),r}(y.OptimizedFeatureWithGeometry);function I(e){return 57.29577951308232*e}var T=function(t){"use strict";i.inherits(n,t);var r=i.createSuper(n);function n(e,t,a,s){var u;return i.classCallCheck(this,n),(u=r.call(this,e,a)).events=new(0,o.default),u._geohashLevel=0,u._tileLevel=0,u._aggregateValueRanges={},u._aggregateValueRangesChanged=!1,u._geohashBuf=[],u._clusters=new Map,u._tiles=new Map,u._serviceInfo=s,u.geometryInfo=e.geometryInfo,u._spatialReference=t,u._projectionSupportCheck=(0,m.checkProjectionSupport)(t,S.default.WGS84),u._bitsets.geohash=a.getBitset(a.createBitset()),u._bitsets.inserted=a.getBitset(a.createBitset()),i.possibleConstructorReturn(u)}return i.createClass(n,[{key:"updateSchema",value:function(t,r){var a=this,o=this;return i.asyncToGenerator(e(s).mark((function f(){var h,p;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return h=o._schema,e.prev=1,e.next=4,i.get(i.getPrototypeOf(n.prototype),"updateSchema",a).call(o,t,r);case 4:return e.next=6,o._projectionSupportCheck;case 6:e.next=10;break;case 8:e.prev=8,e.t0=e.catch(1);case 10:p=(0,l.diff)(h,r),r&&(!(0,c.isNone)(p)||t.source||t.storage.filters)?(((0,l.hasDiff)(p,"params.fields")||!o._tree||t.source)&&(o._tree=new(0,d.GeohashTree)(o._statisticFields,o._serviceInfo),o._rebuildTree(),(0,u.default)("esri-2d-update-debug")&&console.debug("Aggregate mesh needs update due to tree changing")),(0,u.default)("esri-2d-update-debug")&&console.debug("Applying Update - ClusterStore:",p),t.targets[r.name]=!0,t.mesh=!1,o._aggregateValueRanges={}):h&&(t.mesh=!0);case 12:case"end":return e.stop()}}),f,null,[[1,8]])})))()}},{key:"clear",value:function(){this._rebuildTree()}},{key:"sweepFeatures",value:function(e,t){var r=this;this._bitsets.inserted.forEachSet((function(n){if(!e.has(n)){var a=t.lookupByDisplayIdUnsafe(n);r._remove(a)}}))}},{key:"sweepClusters",value:function(e,t,r){var n=this;this._clusters.forEach((function(a,i){a&&a.tileLevel!==r&&(e.releaseDisplayId(a.displayId),t.unsetAttributeData(a.displayId),n._clusters.delete(i))}))}},{key:"onTileData",value:function(e,t,r,n){var a=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];if(!this._schema||(0,c.isNone)(t.addOrUpdate))return t;for(var i=this._getTransforms(e,this._spatialReference),s=t.addOrUpdate.getCursor();s.next();)this._update(s,n);if(t.status.mesh||!a)return t;var o=new Array,u=this._schema.params.clusterRadius;this._getClustersForTile(o,e,u,r,i),t.addOrUpdate=k.FeatureSetReaderJSON.fromOptimizedFeatures(o,this._serviceInfo),t.addOrUpdate.attachStorage(r),t.end=!0;for(var l=t.addOrUpdate.getCursor();l.next();){var d=l.getDisplayId();this._bitsets.computed.unset(d),this.setComputedAttributes(r,l,d,e.scale)}return this._aggregateValueRangesChanged&&t.end&&(this.events.emit("valueRangesChanged",{valueRanges:this._aggregateValueRanges}),this._aggregateValueRangesChanged=!1),t}},{key:"onTileUpdate",value:function(e){var t=e.added,r=e.removed,n=this;if(t.length){var a=t[0].level;this._tileLevel=a,this._setGeohashLevel(a)}if(this._schema){var i=this._schema.params.clusterRadius;r.forEach((function(e){n._tiles.delete(e.key.id),n._markTileClustersForDeletion(e,i)}))}}},{key:"getAggregate",value:function(e){var t=!0,r=!1,n=void 0;try{for(var a,i=this._clusters.values()[Symbol.iterator]();!(t=(a=i.next()).done);t=!0){var s=a.value;if(((null==s?void 0:s.displayId)&b.DISPLAY_ID_TEXEL_MASK)==(e&b.DISPLAY_ID_TEXEL_MASK))return s.toJSON()}}catch(e){r=!0,n=e}finally{try{t||null==i.return||i.return()}finally{if(r)throw n}}return null}},{key:"getAggregates",value:function(){var e=[],t=!0,r=!1,n=void 0;try{for(var a,i=this._clusters.values()[Symbol.iterator]();!(t=(a=i.next()).done);t=!0){var s=a.value;(null==s?void 0:s.tileLevel)===this._tileLevel&&e.push(s.toJSON())}}catch(e){r=!0,n=e}finally{try{t||null==i.return||i.return()}finally{if(r)throw n}}return e}},{key:"getDisplayId",value:function(e){var t=this._clusters.get(e);return t?t.displayId:null}},{key:"getFeatureDisplayIdsForAggregate",value:function(e){var t=this._clusters.get(e);if(!t)return[];var r=t.geohashBoundsInfo;return this._tree.getRegionDisplayIds(r.xLL,r.yLL,r.xTR,r.yTR,r.level)}},{key:"getDisplayIdForReferenceId",value:function(e){var t=!0,r=!1,n=void 0;try{for(var a,i=this._clusters.values()[Symbol.iterator]();!(t=(a=i.next()).done);t=!0){var s=a.value;if((null==s?void 0:s.referenceId)===e)return s.displayId}}catch(e){r=!0,n=e}finally{try{t||null==i.return||i.return()}finally{if(r)throw n}}return null}},{key:"getAggregateValueRanges",value:function(){return this._aggregateValueRanges}},{key:"forEach",value:function(e){var t=!0,r=!1,n=void 0;try{for(var a,s=this._clusters[Symbol.iterator]();!(t=(a=s.next()).done);t=!0){var o=i.slicedToArray(a.value,2),u=o[0],c=o[1];c&&e(c,u)}}catch(e){r=!0,n=e}finally{try{t||null==s.return||s.return()}finally{if(r)throw n}}}},{key:"size",value:function(){var e=0;return this.forEach((function(t){return e++})),e}},{key:"_rebuildTree",value:function(){this._bitsets.computed.clear(),this._bitsets.inserted.clear(),this._tree&&this._tree.clear()}},{key:"_remove",value:function(e){var t=e.getDisplayId(),r=e.getXHydrated(),n=e.getYHydrated(),a=this._geohashBuf[2*t],i=this._geohashBuf[2*t+1];this._bitsets.inserted.has(t)&&(this._bitsets.inserted.unset(t),this._tree.removeCursor(e,r,n,a,i,this._geohashLevel))}},{key:"_update",value:function(e,t){var r=e.getDisplayId(),n=this._bitsets.inserted,a=t.isVisible(r);if(a!==n.has(r))if(a){var i=e.getXHydrated(),s=e.getYHydrated();if(this._setGeohash(r,i,s)){var o=this._geohashBuf[2*r],u=this._geohashBuf[2*r+1];this._tree.insertCursor(e,r,i,s,o,u,this._geohashLevel),n.set(r)}}else this._remove(e)}},{key:"_setGeohash",value:function(e,t,r){if(this._bitsets.geohash.has(e))return!0;var n=this._geohashBuf;if(this._spatialReference.isWebMercator){var a=I(t/h.earth.radius),i=a-360*Math.floor((a+180)/360),s=I(Math.PI/2-2*Math.atan(Math.exp(-r/h.earth.radius)));(0,f.setGeohashBuf)(n,e,s,i,12)}else{var o=(0,m.project)({x:t,y:r},this._spatialReference,S.default.WGS84);if(!o)return!1;(0,f.setGeohashBuf)(n,e,o.y,o.x,12)}return this._bitsets.geohash.set(e),!0}},{key:"_getClustersForTile",value:function(e,t,r,n,a){for(var s=!(arguments.length>5&&void 0!==arguments[5])||arguments[5],o=this._schema.params.clusterPixelBuffer,u=2*r,l=this._getGeohashLevel(t.key.level),d=Math.ceil(Math.pow(2,t.key.level)*_.TILE_SIZE/u),f=Math.ceil(o/u)+0,h=Math.ceil(_.TILE_SIZE/u),p=t.key,g=p.row,m=p.col,b=m*_.TILE_SIZE,x=g*_.TILE_SIZE,k=Math.floor(b/u)-f,S=Math.floor(x/u)-f,w=k+h+2*f,I=S+h+2*f,T=t.tileInfoView.getLODInfoAt(t.key.level),C=k;C<=w;C++)for(var F=S;F<=I;F++){var M=C;T.wrap&&(M=C<0?C+d:C%d);var E=T.wrap&&C<0,O=T.wrap&&C%d!==C,q=this._lookupCluster(n,T,t.key.level,M,F,l);if((0,c.isSome)(q)){var A=(0,c.applySome)(a,(function(e){return E?e.left:O?e.right:e.tile}));if(s&&(0,c.isNone)(A))continue;if(!q.count)continue;if((0,c.isSome)(A)&&s){var N=q.geometry.clone(),R=q.attributes;N.coords[0]=(0,v.quantizeX)(A,N.coords[0]),N.coords[1]=(0,v.quantizeY)(A,N.coords[1]),1===q.count&&(0,c.isSome)(q.referenceId)&&(R=i.objectSpread({},q.attributes,{referenceId:q.referenceId}));var G=new(0,y.OptimizedFeature)(N,R);G.displayId=q.displayId,e.push(G)}}}}},{key:"_getGeohashLevel",value:function(e){return Math.min(Math.ceil(e/2+2),12)}},{key:"_setGeohashLevel",value:function(e){var t=this._getGeohashLevel(e),r=1*(Math.floor(t/1)+1)-1;if(this._geohashLevel!==r)return this._geohashLevel=r,this._rebuildTree(),void this._bitsets.geohash.clear()}},{key:"_getTransforms",value:function(e,t){var r={originPosition:"upperLeft",scale:[e.resolution,e.resolution],translate:[e.bounds[0],e.bounds[3]]},n=(0,p.getInfo)(t);if(!n)return{tile:r,left:null,right:null};var a=i.slicedToArray(n.valid,2),s=a[0],o=a[1];return{tile:r,left:i.objectSpread({},r,{translate:[o,e.bounds[3]]}),right:i.objectSpread({},r,{translate:[s-o+e.bounds[0],e.bounds[3]]})}}},{key:"_getClusterId",value:function(e,t,r){return(15&e)<<28|(16383&t)<<14|16383&r}},{key:"_markForDeletion",value:function(e,t,r){var n=this._getClusterId(e,t,r);this._clusters.delete(n)}},{key:"_getClusterBounds",value:function(e,t,r){var n=this._schema.params.clusterRadius,a=2*n,i=r%2?t*a:t*a-n,s=r*a,o=i+a,u=s-a,c=Math.pow(2,e.level)*_.TILE_SIZE;e.wrap&&i<0&&(i=0),e.wrap&&o>c&&(o=c);var l=i/_.TILE_SIZE,d=s/_.TILE_SIZE,f=o/_.TILE_SIZE,h=u/_.TILE_SIZE;return[e.getXForColumn(l),e.getYForRow(d),e.getXForColumn(f),e.getYForRow(h)]}},{key:"_lookupCluster",value:function(e,t,r,n,a,s){var o=this._getClusterId(r,n,a),u=this._clusters.get(o),l=i.slicedToArray(this._getClusterBounds(t,n,a),4),d=l[0],p=l[1],v=l[2],y=l[3],g={x:d,y:p},_={x:v,y:y},b=0,x=0,k=0,T=0;if(this._spatialReference.isWebMercator){var C=I(g.x/h.earth.radius);b=C-360*Math.floor((C+180)/360),x=I(Math.PI/2-2*Math.atan(Math.exp(-g.y/h.earth.radius)));var F=I(_.x/h.earth.radius);k=F-360*Math.floor((F+180)/360),T=I(Math.PI/2-2*Math.atan(Math.exp(-_.y/h.earth.radius)))}else{var M=(0,m.project)(g,this._spatialReference,S.default.WGS84),E=(0,m.project)(_,this._spatialReference,S.default.WGS84);if(!M||!E)return null;b=M.x,x=M.y,k=E.x,T=E.y}var O={geohashX:0,geohashY:0},q={geohashX:0,geohashY:0};(0,f.setGeohashXY)(O,x,b,s),(0,f.setGeohashXY)(q,T,k,s);var A=O.geohashX,N=O.geohashY,R=q.geohashX,G=q.geohashY,z={xLL:A,yLL:N,xTR:R,yTR:G,level:s},V=this._tree.getRegionStatistics(A,N,R,G,s),P=V.count,U=V.xTotal,L=V.yTotal,D=V.referenceId,j=P?U/P:0,B=P?L/P:0;if(0===P)return this._clusters.set(o,null),null;var Q=i.objectSpread({cluster_count:P},V.attributes),X=(0,c.isSome)(u)?u.update(j,B,r,Q,z,D):w.create(e,o,j,B,r,Q,z,D);return 0===P&&(X.geometry.coords[0]=(d+v)/2,X.geometry.coords[1]=(p+y)/2),this._clusters.set(o,X),this._updateAggregateValueRangeForCluster(X,X.tileLevel),X}},{key:"_updateAggregateValueRangeForCluster",value:function(e,t){var r=this._aggregateValueRanges[t]||{minValue:1/0,maxValue:0},n=r.minValue,a=r.maxValue;r.minValue=Math.min(n,e.count),r.maxValue=Math.max(a,e.count),this._aggregateValueRanges[t]=r,n===r.minValue&&a===r.maxValue||(this._aggregateValueRangesChanged=!0)}},{key:"_markTileClustersForDeletion",value:function(e,t){for(var r=2*t,n=Math.ceil(_.TILE_SIZE/r),a=e.key,i=a.row,s=a.col*_.TILE_SIZE,o=i*_.TILE_SIZE,u=Math.floor(s/r),c=Math.floor(o/r),l=u;l<u+n;l++)for(var d=c;d<c+n;d++)this._markForDeletion(e.key.level,l,d)}}]),n}(x.Store2D)})),r.register("8Vmmp",(function(e,n){t(e.exports,"GeohashTree",(function(){return c}));var a=r("8TSCy"),i=r("gDoEW"),s=r("7qybv"),o=r("bUB3w"),u=r("5STKO"),c=function(){"use strict";function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments.length>1?arguments[1]:void 0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:8096;a.classCallCheck(this,e),this._nodes=0,this._root=new l(0,0,0),this._statisticFields=t,this._pool=n?new(0,i.default)(8096):null,this._serviceInfo=r}return a.createClass(e,[{key:"_acquire",value:function(e,t,r){this._nodes++;var n=null;return(0,s.isSome)(this._pool)&&(n=this._pool.dequeue()),(0,s.isSome)(n)?n.realloc(e,t,r):new l(e,t,r)}},{key:"_release",value:function(e){this._nodes--,(0,s.isSome)(this._pool)&&this._pool.enqueue(e)}},{key:"count",get:function(){return this._root.count}},{key:"size",get:function(){return this._nodes}},{key:"poolSize",get:function(){return(0,s.mapOr)(this._pool,0,(function(e){return e.size}))}},{key:"depth",get:function(){var e=0;return this._forEachNode((function(t){return e=Math.max(e,t.depth)})),e}},{key:"dropLevels",value:function(e){var t=this;this._forEachNode((function(r){if(r.depth>=e)for(var n=0;n<r.children.length;n++){var a=r.children[n];r.children[n]=null,a&&t._release(a)}}))}},{key:"clear",value:function(){this.dropLevels(0)}},{key:"insert",value:function(e,t){var r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=u.FeatureSetReaderJSON.fromOptimizedFeatures([e],this._serviceInfo).getCursor();n.next();var i=n.readGeometry();if(i){var s=a.slicedToArray(i.coords,2),o=s[0],c=s[1],l=e.geohashX,d=e.geohashY;this.insertCursor(n,e.displayId,o,c,l,d,t,r)}}},{key:"insertCursor",value:function(e,t,r,n,a,i,s){for(var o=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,u=this._root,c=0,l=0,d=0;null!==u;){if(u.depth>=o&&(u.count+=1,u.xTotal+=r,u.yTotal+=n,u.xGeohashTotal+=a,u.yGeohashTotal+=i,u.displayId=t,this._updateStatisticsCursor(e,u,1)),c>=s)return void u.add(t);var f=Math.ceil((c+1)/2),h=Math.floor((c+1)/2),p=1-c%2,v=30-(3*f+2*h),y=30-(2*f+3*h),g=(a&7*p+3*(1-p)<<v)>>v,m=(i&3*p+7*(1-p)<<y)>>y,_=g+m*(8*p+4*(1-p));l=l<<3*p+2*(1-p)|g,d=d<<2*p+3*(1-p)|m,null==u.children[_]&&(u.children[_]=this._acquire(l,d,c+1)),c+=1,u=u.children[_]}}},{key:"remove",value:function(e,t){var r=u.FeatureSetReaderJSON.fromOptimizedFeatures([e],this._serviceInfo).getCursor();r.next();var n=r.readGeometry();if(n){var i=a.slicedToArray(n.coords,2),s=i[0],o=i[1],c=e.geohashX,l=e.geohashY;this.removeCursor(r,s,o,c,l,t)}}},{key:"removeCursor",value:function(e,t,r,n,a,i){for(var s=this._root,o=0;null!==s;){if(s.count-=1,s.xTotal-=t,s.yTotal-=r,s.xGeohashTotal-=n,s.yGeohashTotal-=a,this._updateStatisticsCursor(e,s,-1),o>=i)return void s.remove(e.getDisplayId());var u=Math.ceil((o+1)/2),c=Math.floor((o+1)/2),l=1-o%2,d=30-(3*u+2*c),f=30-(2*u+3*c),h=((n&7*l+3*(1-l)<<d)>>d)+((a&3*l+7*(1-l)<<f)>>f)*(8*l+4*(1-l)),p=s.children[h];1===p.count&&(this._release(p),s.children[h]=null),o+=1,s=p}}},{key:"find",value:function(e,t,r){return this._root.find(e,t,r,0,0,0)}},{key:"findSingleOccupancyNode",value:function(e,t,r,n,a){for(var i=this._root;null!==i;){var s=i.depth,o=i.xNode,u=i.yNode,c=1-s%2,l=i.xGeohashTotal/i.count,d=i.yGeohashTotal/i.count;if(1===i.count&&e<l&&l<=r&&t<d&&d<=n)return i;if(s>=a)i=i.next;else{for(var f=Math.ceil((s+1)/2),h=Math.floor((s+1)/2),p=30-(3*f+2*h),v=30-(2*f+3*h),y=~((1<<p)-1),g=~((1<<v)-1),m=(e&y)>>p,_=(t&g)>>v,b=(r&y)>>p,x=(n&g)>>v,k=o<<3*c+2*(1-c),S=u<<2*c+3*(1-c),w=k+8*c+4*(1-c),I=S+4*c+8*(1-c),T=Math.max(k,m),C=Math.max(S,_),F=Math.min(w,b),M=Math.min(I,x),E=null,O=null,q=C;q<=M;q++)for(var A=T;A<=F;A++){var N=A-k+(q-S)*(8*c+4*(1-c)),R=i.children[N];R&&(E||((E=R).next=i.next),O&&(O.next=R),O=R,R.next=i.next)}i=E||i.next}}return null}},{key:"getRegionDisplayIds",value:function(e,t,r,n,a){for(var i=this._root,s=[];null!==i;){var o=i.depth,u=i.xNode,c=i.yNode;if(o>=a){var l=i.xGeohashTotal/i.count,d=i.yGeohashTotal/i.count;e<=l&&l<=r&&t<=d&&d<=n&&i.displayIds.forEach((function(e){return s.push(e)})),i=i.next}else{for(var f=Math.ceil((o+1)/2),h=Math.floor((o+1)/2),p=1-o%2,v=30-(3*f+2*h),y=30-(2*f+3*h),g=~((1<<v)-1),m=~((1<<y)-1),_=(e&g)>>v,b=(t&m)>>y,x=(r&g)>>v,k=(n&m)>>y,S=u<<3*p+2*(1-p),w=c<<2*p+3*(1-p),I=S+8*p+4*(1-p),T=w+4*p+8*(1-p),C=Math.max(S,_),F=Math.max(w,b),M=Math.min(I,x),E=Math.min(T,k),O=null,q=null,A=F;A<=E;A++)for(var N=C;N<=M;N++){var R=N-S+(A-w)*(8*p+4*(1-p)),G=i.children[R];G&&(O||((O=G).next=i.next),q&&(q.next=G),q=G,G.next=i.next)}i=O||i.next}}return s}},{key:"getRegionStatistics",value:function(e,t,r,n,a){for(var i=this._root,s=0,o=0,u=0,c={},l=0;null!==i;){var d=i.depth,f=i.xNode,h=i.yNode;if(d>=a){var p=i.xGeohashTotal/i.count,v=i.yGeohashTotal/i.count;e<p&&p<=r&&t<v&&v<=n&&(s+=i.count,o+=i.xTotal,u+=i.yTotal,1===i.count&&(l=i.displayId),this._aggregateStatistics(c,i.statistics)),i=i.next}else{for(var y=Math.ceil((d+1)/2),g=Math.floor((d+1)/2),m=1-d%2,_=30-(3*y+2*g),b=30-(2*y+3*g),x=~((1<<_)-1),k=~((1<<b)-1),S=(e&x)>>_,w=(t&k)>>b,I=(r&x)>>_,T=(n&k)>>b,C=f<<3*m+2*(1-m),F=h<<2*m+3*(1-m),M=C+8*m+4*(1-m),E=F+4*m+8*(1-m),O=Math.max(C,S),q=Math.max(F,w),A=Math.min(M,I),N=Math.min(E,T),R=null,G=null,z=q;z<=N;z++)for(var V=O;V<=A;V++){var P=V-C+(z-F)*(8*m+4*(1-m)),U=i.children[P];if(U){if(z!==q&&z!==N&&V!==O&&V!==A){var L=U.xGeohashTotal/U.count,D=U.yGeohashTotal/U.count;e<L&&L<=r&&t<D&&D<=n&&(s+=U.count,o+=U.xTotal,u+=U.yTotal,1===U.count&&(l=U.displayId),this._aggregateStatistics(c,U.statistics));continue}R||((R=U).next=i.next),G&&(G.next=U),G=U,U.next=i.next}}i=R||i.next}}return{count:s,attributes:this._normalizeStatistics(c,s),xTotal:o,yTotal:u,referenceId:l}}},{key:"_forEachNode",value:function(e){for(var t=this._root;null!==t;){var r=this._linkChildren(t)||t.next;e(t),t=r}}},{key:"_linkChildren",value:function(e){for(var t=null,r=null,n=0;n<=e.children.length;n++){var a=e.children[n];a&&(t||((t=a).next=e.next),r&&(r.next=a),r=a,a.next=e.next)}return t}},{key:"_updateStatisticsCursor",value:function(e,t,r){var n=!0,a=!1,i=void 0;try{for(var s,o=this._statisticFields[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var u=s.value,c=u.name,l=u.inField?e.readAttribute(u.inField):e.getComputedNumericAtIndex(u.inFieldIndex);switch(u.statisticType){case"norm":t.statistics[c]||(t.statistics[c]={});var d=u.inNormalizationField,f=e.readAttribute(d),h=t.statistics[c].onStatisticField||0,p=t.statistics[c].onStatisticNormalizationField||0;null==l||isNaN(l)||null==f||0===f||isNaN(f)||(t.statistics[c].onStatisticField=h+r*l,t.statistics[c].onStatisticNormalizationField=p+r*f);break;case"sum":case"avg":t.statistics[c]||(t.statistics[c]={value:0,nanCount:0});var v=t.statistics[c].value,y=t.statistics[c].nanCount;null==l||isNaN(l)?t.statistics[c].nanCount=y+r:t.statistics[c].value=v+r*l;break;case"avg_angle":t.statistics[c]||(t.statistics[c]={x:0,y:0,nanCount:0});var g=t.statistics[c].x,m=t.statistics[c].y,_=t.statistics[c].nanCount,b=Math.PI/180;null==l||isNaN(l)?t.statistics[c].nanCount=_+r:(t.statistics[c].x=g+r*Math.cos(l*b),t.statistics[c].y=m+r*Math.sin(l*b));break;case"mode":t.statistics[c]||(t.statistics[c]={});var x=t.statistics[c][l]||0;t.statistics[c][l]=x+r}}}catch(e){a=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(a)throw i}}}},{key:"_aggregateStatistics",value:function(e,t){var r=!0,n=!1,a=void 0;try{for(var i,s=this._statisticFields[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var o=i.value,u=o.name;switch(o.statisticType){case"sum":case"avg":case"avg_angle":case"mode":case"norm":for(var c in e[u]||(e[u]={}),t[u]){var l=e[u][c]||0;e[u][c]=l+t[u][c]}}}}catch(e){n=!0,a=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw a}}}},{key:"_normalizeStatistics",value:function(e,t){var r={},n=!0,a=!1,i=void 0;try{for(var s,o=this._statisticFields[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var u=s.value,c=u.name;switch(u.statisticType){case"norm":var l=e[c];if(t&&null==l.onStatisticNormalizationField)break;if(t&&l.onStatisticNormalizationField){r[c]=l.onStatisticField/l.onStatisticNormalizationField;break}r[c]=0;break;case"sum":if(!t)break;var d=e[c],f=d.value;if(!(t-d.nanCount))break;r[c]=f;break;case"avg":if(!t)break;var h=e[c],p=h.value,v=h.nanCount;if(!(t-v))break;r[c]=p/(t-v);break;case"avg_angle":if(!t)break;var y=e[c],g=y.x,m=y.y,_=y.nanCount;if(!(t-_))break;var b=g/(t-_),x=m/(t-_),k=180/Math.PI,S=Math.atan2(x,b)*k;r[c]=S;break;case"mode":var w=e[c],I=0,T=null;for(var C in w){var F=w[C];F>I&&(I=F,T=C)}r[c]="null"===T?null:T}}}catch(e){a=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(a)throw i}}return r}}]),e}(),l=function(){"use strict";function e(t,r,n){a.classCallCheck(this,e),this.count=0,this.xTotal=0,this.yTotal=0,this.statistics={},this.displayId=0,this.displayIds=new Set,this.next=null,this.depth=0,this.xNode=0,this.yNode=0,this.xGeohashTotal=0,this.yGeohashTotal=0,this.children=new Array(32);for(var i=0;i<this.children.length;i++)this.children[i]=null;this.xNode=t,this.yNode=r,this.depth=n}return a.createClass(e,[{key:"realloc",value:function(e,t,r){for(var n=0;n<this.children.length;n++)this.children[n]=null;return this.xNode=e,this.yNode=t,this.depth=r,this.next=null,this.xGeohashTotal=0,this.yGeohashTotal=0,this.xTotal=0,this.yTotal=0,this.count=0,this.statistics={},this.displayIds.clear(),this}},{key:"add",value:function(e){this.displayIds.add(e)}},{key:"remove",value:function(e){this.displayIds.delete(e)}},{key:"getLngLatBounds",value:function(){var e=this.depth,t=Math.ceil(e/2),r=Math.floor(e/2),n=30-(3*t+2*r),a=30-(2*t+3*r),i=this.xNode<<n,s=this.yNode<<a;return(0,o.decodeGeohashXY)({geohashX:i,geohashY:s},this.depth)}},{key:"find",value:function(e,t,r,n,a,i){if(n>=r)return this;var s=1-n%2,o=3*s+2*(1-s),u=2*s+3*(1-s),c=30-a-o,l=30-i-u,d=((e&7*s+3*(1-s)<<c)>>c)+((t&3*s+7*(1-s)<<l)>>l)*(8*s+4*(1-s)),f=this.children[d];return null==f?null:f.find(e,t,r,n+1,a+o,i+u)}}]),e}()})),r.register("bUB3w",(function(e,n){t(e.exports,"decodeGeohashXY",(function(){return a})),t(e.exports,"setGeohashXY",(function(){return i})),t(e.exports,"setGeohashBuf",(function(){return s}));r("8TSCy"),new Float64Array(2),new Float64Array(2);function a(e,t){for(var r=-90,n=90,a=-180,i=180,s=0;s<t;s++){for(var o=Math.ceil((s+1)/2),u=Math.floor((s+1)/2),c=1-s%2,l=30-(3*o+2*u),d=30-(2*o+3*u),f=3*c+2*(1-c),h=2*c+3*(1-c),p=3*c+7*(1-c)<<d,v=(7*c+3*(1-c)<<l&e.geohashX)>>l,y=(p&e.geohashY)>>d,g=f-1;g>=0;g--){var m=(a+i)/2,_=v&1<<g?1:0;a=(1-_)*a+_*m,i=(1-_)*m+_*i}for(var b=h-1;b>=0;b--){var x=(r+n)/2,k=y&1<<b?1:0;r=(1-k)*r+k*x,n=(1-k)*x+k*n}}return[a,r,i,n]}function i(e,t,r,n){n%2&&(n+=1);for(var a=0,i=0,s=-90,o=90,u=-180,c=180,l=0;l<n/2;l++){for(var d=0;d<5;d++){var f=(u+c)/2,h=r>f?1:0;a|=h<<29-(d+5*l),u=(1-h)*u+h*f,c=(1-h)*f+h*c}for(var p=0;p<5;p++){var v=(s+o)/2,y=t>v?1:0;i|=y<<29-(p+5*l),s=(1-y)*s+y*v,o=(1-y)*v+y*o}}e.geohashX=a,e.geohashY=i}function s(e,t,r,n,a){a%2&&(a+=1);for(var i=0,s=0,o=-90,u=90,c=-180,l=180,d=0;d<a/2;d++){for(var f=0;f<5;f++){var h=(c+l)/2,p=n>h?1:0;i|=p<<29-(f+5*d),c=(1-p)*c+p*h,l=(1-p)*h+p*l}for(var v=0;v<5;v++){var y=(o+u)/2,g=r>y?1:0;s|=g<<29-(v+5*d),o=(1-g)*o+g*y,u=(1-g)*y+g*u}}e[2*t]=i,e[2*t+1]=s}})),r.register("fP7bp",(function(n,a){t(n.exports,"checkProjectionSupport",(function(){return y})),t(n.exports,"project",(function(){return b})),t(n.exports,"projectMany",(function(){return k}));var i=r("8TSCy"),s=r("2TvXO"),o=r("7qybv"),u=r("7RvA5"),c=r("jGyUI"),l=r("eY5Yp"),d=r("eF88h"),f=[0,0];function h(e,t){if(!t)return null;if("x"in t){var r,n={x:0,y:0};return r=i.slicedToArray(e(t.x,t.y,f),2),n.x=r[0],n.y=r[1],null!=t.z&&(n.z=t.z),null!=t.m&&(n.m=t.m),n}if("xmin"in t){var a,s,o={xmin:0,ymin:0,xmax:0,ymax:0};return a=i.slicedToArray(e(t.xmin,t.ymin,f),2),o.xmin=a[0],o.ymin=a[1],s=i.slicedToArray(e(t.xmax,t.ymax,f),2),o.xmax=s[0],o.ymax=s[1],t.hasZ&&(o.zmin=t.zmin,o.zmax=t.zmax,o.hasZ=!0),t.hasM&&(o.mmin=t.mmin,o.mmax=t.mmax,o.hasM=!0),o}return"rings"in t?{rings:p(t.rings,e),hasM:t.hasM,hasZ:t.hasZ}:"paths"in t?{paths:p(t.paths,e),hasM:t.hasM,hasZ:t.hasZ}:"points"in t?{points:v(t.points,e),hasM:t.hasM,hasZ:t.hasZ}:void 0}function p(e,t){var r=[],n=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var u=s.value;r.push(v(u,t))}}catch(e){a=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(a)throw i}}return r}function v(e,t){var r=[],n=!0,a=!1,i=void 0;try{for(var s,o=e[Symbol.iterator]();!(n=(s=o.next()).done);n=!0){var u=s.value,c=t(u[0],u[1],[0,0]);r.push(c),u.length>2&&c.push(u[2]),u.length>3&&c.push(u[3])}}catch(e){a=!0,i=e}finally{try{n||null==o.return||o.return()}finally{if(a)throw i}}return r}function y(e,t){return g.apply(this,arguments)}function g(){return(g=i.asyncToGenerator(e(s).mark((function t(r,n){var a;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n){e.next=2;break}return e.abrupt("return");case 2:return a=Array.isArray(r)?r.map((function(e){return(0,o.isSome)(e.geometry)&&e.geometry.spatialReference})):[r],e.next=5,(0,u.initializeProjection)(a.map((function(e){return{source:e,dest:n}})));case 5:case"end":return e.stop()}}),t)})))).apply(this,arguments)}var m=h.bind(null,d.lngLatToXY),_=h.bind(null,d.xyToLngLat);function b(e,t,r){if(!e)return e;if(r||(r=t,t=e.spatialReference),!(0,l.isValid)(t)||!(0,l.isValid)(r)||(0,l.equals)(t,r))return e;if((0,d.canProject)(t,r)){var n=(0,l.isWebMercator)(r)?m(e):_(e);return n.spatialReference=r,n}return(0,u.projectMany)(c.jsonAdapter,[e],t,r,null)[0]}var x=new(function(){"use strict";function t(){i.classCallCheck(this,t),this._jobs=[],this._timer=null,this._process=this._process.bind(this)}return i.createClass(t,[{key:"push",value:function(t,r,n){var a=this;return i.asyncToGenerator(e(s).mark((function i(){var o;return e(s).wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&t.length&&r&&n&&!(0,l.equals)(r,n)){e.next=2;break}return e.abrupt("return",t);case 2:return o={geometries:t,inSpatialReference:r,outSpatialReference:n,resolve:null},e.abrupt("return",(a._jobs.push(o),new Promise((function(e){o.resolve=e,null===a._timer&&(a._timer=setTimeout(a._process,10))}))));case 4:case"end":return e.stop()}}),i)})))()}},{key:"_process",value:function(){this._timer=null;var e=this._jobs.shift();if(e){var t=e.geometries,r=e.inSpatialReference,n=e.outSpatialReference,a=e.resolve;(0,d.canProject)(r,n)?(0,l.isWebMercator)(n)?a(t.map(m)):a(t.map(_)):a((0,u.projectMany)(c.jsonAdapter,t,r,n,null)),this._jobs.length>0&&(this._timer=setTimeout(this._process,10))}}}]),t}());function k(e,t,r){return x.push(e,t,r)}})),r.register("jGyUI",(function(e,n){t(e.exports,"jsonAdapter",(function(){return i}));var a=r("8TSCy"),i={convertToGEGeometry:function(e,t){return null==t?null:e.convertJSONToGeometry(t)},exportPoint:function(e,t,r){var n=new s(e.getPointX(t),e.getPointY(t),r),a=e.hasZ(t),i=e.hasM(t);return a&&(n.z=e.getPointZ(t)),i&&(n.m=e.getPointM(t)),n},exportPolygon:function(e,t,r){return new o(e.exportPaths(t),r,e.hasZ(t),e.hasM(t))},exportPolyline:function(e,t,r){return new u(e.exportPaths(t),r,e.hasZ(t),e.hasM(t))},exportMultipoint:function(e,t,r){return new c(e.exportPoints(t),r,e.hasZ(t),e.hasM(t))},exportExtent:function(e,t,r){var n=e.hasZ(t),a=e.hasM(t),i=new l(e.getXMin(t),e.getYMin(t),e.getXMax(t),e.getYMax(t),r);if(n){var s=e.getZExtent(t);i.zmin=s.vmin,i.zmax=s.vmax}if(a){var o=e.getMExtent(t);i.mmin=o.vmin,i.mmax=o.vmax}return i}};var s=function e(t,r,n){"use strict";a.classCallCheck(this,e),this.x=t,this.y=r,this.spatialReference=n,this.z=void 0,this.m=void 0};var o=function e(t,r,n,i){"use strict";a.classCallCheck(this,e),this.rings=t,this.spatialReference=r,this.hasZ=void 0,this.hasM=void 0,n&&(this.hasZ=n),i&&(this.hasM=i)};var u=function e(t,r,n,i){"use strict";a.classCallCheck(this,e),this.paths=t,this.spatialReference=r,this.hasZ=void 0,this.hasM=void 0,n&&(this.hasZ=n),i&&(this.hasM=i)};var c=function e(t,r,n,i){"use strict";a.classCallCheck(this,e),this.points=t,this.spatialReference=r,this.hasZ=void 0,this.hasM=void 0,n&&(this.hasZ=n),i&&(this.hasM=i)};var l=function e(t,r,n,i,s){"use strict";a.classCallCheck(this,e),this.xmin=t,this.ymin=r,this.xmax=n,this.ymax=i,this.spatialReference=s,this.zmin=void 0,this.zmax=void 0,this.mmin=void 0,this.mmax=void 0}})),r.register("ieqnL",(function(e,r){t(e.exports,"DISPLAY_ID_TEXEL_MASK",(function(){return n})),t(e.exports,"DISPLAY_ID_TYPE_FEATURE",(function(){return i})),t(e.exports,"DISPLAY_ID_TYPE_AGGREGATE",(function(){return s})),t(e.exports,"getDisplayIdType",(function(){return o})),t(e.exports,"getDisplayIdTexel",(function(){return u})),t(e.exports,"getDisplayIdFilterMask",(function(){return c})),t(e.exports,"isAggregateId",(function(){return l})),t(e.exports,"createDisplayId",(function(){return d}));var n=8388607,a=8388608,i=0,s=1,o=function(e){return(e&a)>>>23},u=function(e){return e&n},c=function(e){return o(e)===s?254:255};function l(e){return o(e)===s}function d(e,t){return((t?a:0)|e)>>>0}})),r.register("hbg1x",(function(e,n){t(e.exports,"isNullCountSupported",(function(){return d})),t(e.exports,"calculateStringStatistics",(function(){return f})),t(e.exports,"calculatePercentile",(function(){return p})),t(e.exports,"calculateStatistics",(function(){return h})),t(e.exports,"getAttributeComparator",(function(){return v})),t(e.exports,"processSummaryStatisticsResult",(function(){return m})),t(e.exports,"calculateUniqueValuesCount",(function(){return _})),t(e.exports,"createUVResult",(function(){return b})),t(e.exports,"getNormalizedValue",(function(){return x})),t(e.exports,"calculateClassBreaks",(function(){return k})),t(e.exports,"resolveCBResult",(function(){return S})),t(e.exports,"calculateHistogram",(function(){return w}));var a=r("8TSCy"),i=r("59jTx"),s=r("hxmJW"),o="equal-interval",u=/\s*(\+|-)?((\d+(\.\d+)?)|(\.\d+))\s*/gi,c=new Set(["esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]),l=["min","max","avg","stddev","count","sum","variance","nullcount","median"];function d(e){var t=null!=e.normalizationField||null!=e.normalizationType,r=null!=e.minValue||null!=e.maxValue,n=!!e.sqlExpression&&e.supportsSQLExpression;return!t&&!r&&!n}function f(e){var t=e.returnDistinct?a.toConsumableArray(new Set(e.values)):e.values,r=t.filter((function(e){return null!=e})).length,n={count:r};return e.supportsNullCount&&(n.nullcount=t.length-r),e.percentileParams&&(n.median=p(t,e.percentileParams)),n}function h(e){var t=e.values,r=e.useSampleStdDev,n=e.supportsNullCount,a=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,s=null,o=null,u=null,c=null,l=0,d=null==e.minValue?-1/0:e.minValue,f=null==e.maxValue?1/0:e.maxValue,h=!0,v=!1,y=void 0;try{for(var g,m=t[Symbol.iterator]();!(h=(g=m.next()).done);h=!0){var _=g.value;Number.isFinite(_)?_>=d&&_<=f&&(s+=_,a=Math.min(a,_),i=Math.max(i,_),l++):"string"==typeof _&&l++}}catch(e){v=!0,y=e}finally{try{h||null==m.return||m.return()}finally{if(v)throw y}}if(l&&null!=s){o=s/l;var b=0,x=!0,k=!1,S=void 0;try{for(var w,I=t[Symbol.iterator]();!(x=(w=I.next()).done);x=!0){var T=w.value;Number.isFinite(T)&&T>=d&&T<=f&&(b+=Math.pow(T-o,2))}}catch(e){k=!0,S=e}finally{try{x||null==I.return||I.return()}finally{if(k)throw S}}c=r?l>1?b/(l-1):0:l>0?b/l:0,u=Math.sqrt(c)}else a=null,i=null;var C={avg:o,count:l,max:i,min:a,stddev:u,sum:s,variance:c};return n&&(C.nullcount=t.length-l),e.percentileParams&&(C.median=p(t,e.percentileParams)),C}function p(e,t){var r=t.fieldType,n=t.value,i=t.orderBy,s=t.isDiscrete,o=v(r,"desc"===i);if(0===(e=a.toConsumableArray(e).filter((function(e){return null!=e})).sort((function(e,t){return o(e,t)}))).length)return null;if(n<=0)return e[0];if(n>=1)return e[e.length-1];var u=(e.length-1)*n,c=Math.floor(u),l=c+1,d=u%1,f=e[c],h=e[l];return l>=e.length||s||"string"==typeof f||"string"==typeof h?f:f*(1-d)+h*d}function v(e,t){var r=t?1:-1,n=t?function(e,t){return t-e}:function(e,t){return e-t},i=y(t);if(!e||!["esriFieldTypeDate","esriFieldTypeString","esriFieldTypeGUID","esriFieldTypeGlobalID"].concat(a.toConsumableArray(c)).includes(e))return function(e,t){return"number"==typeof e&&"number"==typeof t?n(e,t):"string"==typeof e&&"string"==typeof t?i(e,t):r};if("esriFieldTypeDate"===e)return function(e,t){var a=new Date(e).getTime(),i=new Date(t).getTime();return isNaN(a)||isNaN(i)?r:n(a,i)};if(c.has(e))return function(e,t){return n(e,t)};if("esriFieldTypeString"===e)return function(e,t){return i(e,t)};if("esriFieldTypeGUID"===e||"esriFieldTypeGlobalID"===e){var s=y(t);return function(e,t){return s(g(e),g(t))}}return t?function(e,t){return 1}:function(e,t){return-1}}function y(e){return e?function(e,t){var r,n;return(e=null==(r=e)?void 0:r.toUpperCase())>(t=null==(n=t)?void 0:n.toUpperCase())?-1:e<t?1:0}:function(e,t){var r,n;return(e=null==(r=e)?void 0:r.toUpperCase())<(t=null==(n=t)?void 0:n.toUpperCase())?-1:e>t?1:0}}function g(e){return e.substr(24,12)+e.substr(19,4)+e.substr(16,2)+e.substr(14,2)+e.substr(11,2)+e.substr(9,2)+e.substr(6,2)+e.substr(4,2)+e.substr(2,2)+e.substr(0,2)}function m(e,t){var r;for(r in e)l.indexOf(r)>-1&&(Number.isFinite(e[r])||(e[r]=null));return t?(["avg","stddev","variance"].forEach((function(t){null!=e[t]&&(e[t]=Math.ceil(e[t]))})),e):e}function _(e){var t={},r=!0,n=!1,a=void 0;try{for(var i,s=e[Symbol.iterator]();!(r=(i=s.next()).done);r=!0){var o=i.value;(null==o||"string"==typeof o&&""===o.trim())&&(o=null),null==t[o]?t[o]={count:1,data:o}:t[o].count++}}catch(e){n=!0,a=e}finally{try{r||null==s.return||s.return()}finally{if(n)throw a}}return{count:t}}function b(e,t,r){var n=e.count,a=[];for(var i in r&&t&&"coded-value"===t.type&&t.codedValues.forEach((function(e){var t=e.code;n.hasOwnProperty(t)||(n[t]={data:t,count:0})})),n){var s=n[i];a.push({value:s.data,count:s.count,label:s.label})}return{uniqueValueInfos:a}}function x(e,t,r,n){var a=null;switch(t){case"log":0!==e&&(a=Math.log(e)*Math.LOG10E);break;case"percent-of-total":Number.isFinite(n)&&0!==n&&(a=e/n*100);break;case"field":Number.isFinite(r)&&0!==r&&(a=e/r);break;case"natural-log":e>0&&(a=Math.log(e));break;case"square-root":e>0&&(a=Math.pow(e,.5))}return a}function k(e,t){var r,n,a,u,c,l,d,f,h,p=(r={field:t.field,normalizationType:t.normalizationType,normalizationField:t.normalizationField,classificationMethod:t.classificationMethod,standardDeviationInterval:t.standardDeviationInterval,breakCount:t.numClasses||5},n=r.field,a=r.classificationMethod||o,u=r.normalizationType,c=r.normalizationField,(l=new(0,i.default)).classificationField=n,l.breakCount=r.breakCount,l.classificationMethod=a,l.standardDeviationInterval="standard-deviation"===a?r.standardDeviationInterval||1:void 0,l.normalizationType=u,l.normalizationField="field"===u?c:void 0,l);return d=e,f=t.minValue,h=t.maxValue,f=null==f?-1/0:f,h=null==h?1/0:h,e=d.filter((function(e){return Number.isFinite(e)&&e>=f&&e<=h})),(0,s.createGenerateRendererClassBreaks)({definition:p,values:e,normalizationTotal:t.normalizationTotal})}function S(e,t){var r=e.classBreaks,n=r.length,a=r[0].minValue,i=r[n-1].maxValue,s="standard-deviation"===t,o=u;return{minValue:a,maxValue:i,classBreakInfos:r=r.map((function(e){var t=e.label,r={minValue:e.minValue,maxValue:e.maxValue,label:t};if(s&&t){var n=t.match(o).map((function(e){return+e.trim()}));2===n.length?(r.minStdDev=n[0],r.maxStdDev=n[1],n[0]<0&&n[1]>0&&(r.hasAvg=!0)):1===n.length&&(t.includes("<")?(r.minStdDev=null,r.maxStdDev=n[0]):t.includes(">")&&(r.minStdDev=n[0],r.maxStdDev=null))}return r})),normalizationTotal:e.normalizationTotal}}function w(e,t){var r=function(e,t){var r=t.field,n=t.classificationMethod,a=t.standardDeviationInterval,i=t.normalizationType,s=t.normalizationField,o=t.normalizationTotal,u=t.minValue,c=t.maxValue,l=t.numBins||10,f=null,p=null,v=null;if(n&&"equal-interval"!==n||i){var y=k(e,{field:r,normalizationType:i,normalizationField:s,normalizationTotal:o,classificationMethod:n,standardDeviationInterval:a,minValue:u,maxValue:c,numClasses:l}).classBreaks;f=y[0].minValue,p=y[y.length-1].maxValue,v=y.map((function(e){return[e.minValue,e.maxValue]}))}else{if(null!=u&&null!=c)f=u,p=c;else{var g=h({values:e,minValue:u,maxValue:c,useSampleStdDev:!i,supportsNullCount:d({normalizationType:i,normalizationField:s,minValue:u,maxValue:c})});f=g.min,p=g.max}v=function(e,t,r){for(var n,a=(t-e)/r,i=[],s=e,o=1;o<=r;o++)n=s+a,n=Number(n.toFixed(16)),i.push([s,o===r?t:n]),s=n;return i}(f,p,l)}return{min:f,max:p,intervals:v}}(e,t),n=r.min,a=r.max,i=r.intervals,s=i.map((function(e,t){return{minValue:i[t][0],maxValue:i[t][1],count:0}})),o=!0,u=!1,c=void 0;try{for(var l,f=e[Symbol.iterator]();!(o=(l=f.next()).done);o=!0){var p=l.value;if(null!=p&&p>=n&&p<=a){var v=I(i,p);v>-1&&s[v].count++}}}catch(e){u=!0,c=e}finally{try{o||null==f.return||f.return()}finally{if(u)throw c}}return{bins:s,minValue:n,maxValue:a,normalizationTotal:t.normalizationTotal}}function I(e,t){for(var r=-1,n=e.length-1;n>=0;n--)if(t>=e[n][0]){r=n;break}return r}})),r.register("59jTx",(function(e,n){t(e.exports,"default",(function(){return h}));var a=r("8TSCy"),i=r("7eJjO"),s=r("79ASa"),o=r("iho5X");r("lNwWH"),r("2VlWd"),r("iJAIC");var u=r("fcwIv"),c=r("kt6hM"),l=new(0,s.JSONMap)({esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation",esriClassifyDefinedInterval:"defined-interval"}),d=new(0,s.JSONMap)({esriNormalizeByLog:"log",esriNormalizeByPercentOfTotal:"percent-of-total",esriNormalizeByField:"field"}),f=function(e){"use strict";a.inherits(r,e);var t=a.createSuper(r);function r(){var e;return a.classCallCheck(this,r),(e=t.call.apply(t,[this].concat(Array.prototype.slice.call(arguments)))).breakCount=null,e.classificationField=null,e.classificationMethod=null,e.normalizationField=null,e.normalizationType=null,e.type="class-breaks-definition",a.possibleConstructorReturn(e)}return a.createClass(r,[{key:"standardDeviationInterval",set:function(e){"standard-deviation"===this.classificationMethod&&this._set("standardDeviationInterval",e)}},{key:"definedInterval",set:function(e){"defined-interval"===this.classificationMethod&&this._set("definedInterval",e)}}]),r}(c.default);(0,i._)([(0,o.property)({json:{write:!0}})],f.prototype,"breakCount",void 0),(0,i._)([(0,o.property)({json:{write:!0}})],f.prototype,"classificationField",void 0),(0,i._)([(0,o.property)({type:String,json:{read:l.read,write:l.write}})],f.prototype,"classificationMethod",void 0),(0,i._)([(0,o.property)({json:{write:!0}})],f.prototype,"normalizationField",void 0),(0,i._)([(0,o.property)({json:{read:d.read,write:d.write}})],f.prototype,"normalizationType",void 0),(0,i._)([(0,o.property)({value:null,json:{write:!0}})],f.prototype,"standardDeviationInterval",null),(0,i._)([(0,o.property)({value:null,json:{write:!0}})],f.prototype,"definedInterval",null),(0,i._)([(0,o.property)()],f.prototype,"type",void 0);var h=f=(0,i._)([(0,u.subclass)("esri.rest.support.ClassBreaksDefinition")],f)})),r.register("kt6hM",(function(e,n){t(e.exports,"default",(function(){return p}));var a=r("8TSCy"),i=r("7eJjO"),s=r("79ASa"),o=r("1XAcN"),u=r("iho5X");r("lNwWH"),r("2VlWd"),r("iJAIC");var c=r("fcwIv"),l=r("1DHtQ"),d=r("j9ZJv"),f=new(0,s.JSONMap)({classBreaksDef:"class-breaks-definition",uniqueValueDef:"unique-value-definition"}),h=function(e){"use strict";a.inherits(r,e);var t=a.createSuper(r);function r(){var e;return a.classCallCheck(this,r),(e=t.call.apply(t,[this].concat(Array.prototype.slice.call(arguments)))).baseSymbol=null,e.colorRamp=null,e.type=null,a.possibleConstructorReturn(e)}return r}(o.JSONSupport);(0,i._)([(0,u.property)({type:d.default,json:{write:!0}})],h.prototype,"baseSymbol",void 0),(0,i._)([(0,u.property)({types:l.types,json:{read:{reader:l.fromJSON},write:!0}})],h.prototype,"colorRamp",void 0),(0,i._)([(0,u.property)({json:{read:f.read,write:f.write}})],h.prototype,"type",void 0);var p=h=(0,i._)([(0,c.subclass)("esri.rest.support.ClassificationDefinition")],h)})),r.register("hxmJW",(function(e,r){function n(e,t){return Number(e.toFixed(t))}function a(e){var t=e.normalizationTotal;return{classBreaks:i(e),normalizationTotal:t}}function i(e){var t=e.definition,r=t.classificationMethod,a=t.breakCount,i=t.normalizationType,l=t.definedInterval,d=[],f=e.values;if(0===f.length)return[];var h,p,v,y,g,m,_=(f=f.sort((function(e,t){return e-t})))[0],b=f[f.length-1];if("equal-interval"===r)if(f.length>=a){for(var x=(b-_)/a,k=_,S=1;S<a;S++){var w=n(_+S*x,6);d.push({minValue:k,maxValue:w,label:s(k,w,i)}),k=w}d.push({minValue:k,maxValue:b,label:s(k,b,i)})}else f.forEach((function(e){d.push({minValue:e,maxValue:e,label:s(e,e,i)})}));else if("natural-breaks"===r){for(var I=o(f),T=e.valueFrequency||I.valueFrequency,C=function(e,t,r){var n=e.length,a=[];r>n&&(r=n);for(var i=0;i<r;i++)a.push(Math.round(i*n/r-1));a.push(n-1);var s=u(a,e,t,r);return function(e,t,r,n,a,i){for(var s=0,o=0,u=0,l=0,d=!0,f=0;f<2&&d;f++){0===f&&(d=!1);for(var h=0;h<i-1;h++)for(;r[h+1]+1!==r[h+2];){r[h+1]=r[h+1]+1;var p=c(h,r,n,a);u=p.sbMean,s=p.sbSdcm;var v=c(h+1,r,n,a);if(l=v.sbMean,!(s+(o=v.sbSdcm)<t[h]+t[h+1])){r[h+1]=r[h+1]-1;break}t[h]=s,t[h+1]=o,e[h]=u,e[h+1]=l,d=!0}for(var y=i-1;y>0;y--)for(;r[y]!==r[y-1]+1;){r[y]=r[y]-1;var g=c(y-1,r,n,a);u=g.sbMean,s=g.sbSdcm;var m=c(y,r,n,a);if(l=m.sbMean,!(s+(o=m.sbSdcm)<t[y-1]+t[y])){r[y]=r[y]+1;break}t[y-1]=s,t[y]=o,e[y-1]=u,e[y]=l,d=!0}}return d}(s.mean,s.sdcm,a,e,t,r)&&(s=u(a,e,t,r)),a}(I.uniqueValues,T,a),F=_,M=1;M<a;M++)if(I.uniqueValues.length>M){var E=n(I.uniqueValues[C[M]],6);d.push({minValue:F,maxValue:E,label:s(F,E,i)}),F=E}d.push({minValue:F,maxValue:b,label:s(F,b,i)})}else if("quantile"===r)if(f.length>=a&&_!==b){for(var O=_,q=Math.ceil(f.length/a),A=0,N=1;N<a;N++){var R=q+A-1;R>f.length&&(R=f.length-1),R<0&&(R=0),d.push({minValue:O,maxValue:f[R],label:s(O,f[R],i)}),O=f[R],A+=q,q=Math.ceil((f.length-A)/(a-N))}d.push({minValue:O,maxValue:b,label:s(O,b,i)})}else for(var G=-1,z=0;z<f.length;z++){var V=f[z];V!==G&&(G=V,d.push({minValue:G,maxValue:V,label:s(G,V,i)}),G=V)}else if("standard-deviation"===r){var P=function(e){for(var t=0,r=0;r<e.length;r++)t+=e[r];return t/e.length}(f),U=function(e,t){for(var r=0,n=0;n<e.length;n++){var a=e[n];r+=(a-t)*(a-t)}return r/=e.length,Math.sqrt(r)}(f,P);if(0===U)d.push({minValue:f[0],maxValue:f[0],label:s(f[0],f[0],i)});else{for(var L=(h=_,p=b,v=a,y=P,g=U,((m=Math.max(y-h,p-y)/g/v)>=1?1:m>=.5?.5:.25)*U),D=0,j=_,B=a;B>=1;B--){var Q=n(P-(B-.5)*L,6);d.push({minValue:j,maxValue:Q,label:s(j,Q,i)}),j=Q,D++}var X=n(P+.5*L,6);d.push({minValue:j,maxValue:X,label:s(j,X,i)}),j=X,D++;for(var J=1;J<=a;J++)X=D===2*a?b:n(P+(J+.5)*L,6),d.push({minValue:j,maxValue:X,label:s(j,X,i)}),j=X,D++}}else if("defined-interval"===r){if(!l)return d;for(var W=f[0],Y=f[f.length-1],Z=Math.ceil((Y-W)/l),H=W,K=1;K<Z;K++){var $=n(W+K*l,6);d.push({minValue:H,maxValue:$,label:s(H,$,i)}),H=$}d.push({minValue:H,maxValue:Y,label:s(H,Y,i)})}return d}function s(e,t,r){return e===t?r&&"percent-of-total"===r?e+"%":e.toString():r&&"percent-of-total"===r?e+"% - "+t+"%":e+" - "+t}function o(e){for(var t=[],r=[],n=Number.MIN_VALUE,a=1,i=-1,s=0;s<e.length;s++){var o=e[s];o===n?(a++,r[i]=a):null!==o&&(t.push(o),n=o,a=1,r.push(a),i++)}return{uniqueValues:t,valueFrequency:r}}function u(e,t,r,n){for(var a=[],i=[],s=[],o=0,u=[],l=[],d=0;d<n;d++){var f=c(d,e,t,r);u.push(f.sbMean),l.push(f.sbSdcm),o+=l[d]}for(var h,p=o,v=!0;v||o<p;){v=!1,a=[];for(var y=0;y<n;y++)a.push(e[y]);for(var g=0;g<n;g++)for(var m=e[g]+1;m<=e[g+1];m++)if(h=t[m],g>0&&m!==e[g+1]&&Math.abs(h-u[g])>Math.abs(h-u[g-1]))e[g]=m;else if(g<n-1&&e[g]!==m-1&&Math.abs(h-u[g])>Math.abs(h-u[g+1])){e[g+1]=m-1;break}p=o,o=0,i=[],s=[];for(var _=0;_<n;_++){i.push(u[_]),s.push(l[_]);var b=c(_,e,t,r);u[_]=b.sbMean,l[_]=b.sbSdcm,o+=l[_]}}if(o>p){for(var x=0;x<n;x++)e[x]=a[x],u[x]=i[x],l[x]=s[x];o=p}return{mean:u,sdcm:l}}function c(e,t,r,n){for(var a=0,i=0,s=t[e]+1;s<=t[e+1];s++){var o=n[s];a+=r[s]*o,i+=o}i<=0&&console.log("Exception in Natural Breaks calculation");for(var u=a/i,c=0,l=t[e]+1;l<=t[e+1];l++)c+=n[l]*Math.pow(r[l]-u,2);return{sbMean:u,sbSdcm:c}}t(e.exports,"createGenerateRendererClassBreaks",(function(){return a}))})),r.register("8mTF7",(function(e,n){t(e.exports,"getCentroidOptimizedGeometry",(function(){return s}));var a=r("7qybv");function i(e,t){return e?t?4:3:t?3:2}function s(e,t,r,n,s){if((0,a.isNone)(t)||!t.lengths.length)return null;var f="upperLeft"===(null==s?void 0:s.originPosition)?-1:1;e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0);var h=e.coords,p=[],v=r?[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]:[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY],y=t.lengths,g=t.coords,m=i(r,n),_=0,b=!0,x=!1,k=void 0;try{for(var S,w=y[Symbol.iterator]();!(b=(S=w.next()).done);b=!0){var I=S.value,T=o(v,g,_,I,r,n,f);T&&p.push(T),_+=I*m}}catch(e){x=!0,k=e}finally{try{b||null==w.return||w.return()}finally{if(x)throw k}}if(p.sort((function(e,t){var n=f*e[2]-f*t[2];return 0===n&&r&&(n=e[4]-t[4]),n})),p.length){var C=6*p[0][2];h[0]=p[0][0]/C,h[1]=p[0][1]/C,r&&(C=6*p[0][4],h[2]=0!==C?p[0][3]/C:0),(h[0]<v[0]||h[0]>v[1]||h[1]<v[2]||h[1]>v[3]||r&&(h[2]<v[4]||h[2]>v[5]))&&(h.length=0)}if(!h.length){var F=t.lengths[0]?function(e,t,r,n,a){for(var s=i(n,a),o=t,f=t+s,h=0,p=0,v=0,y=0,g=0,m=r-1;g<m;g++,o+=s,f+=s){var _=e[o],b=e[o+1],x=e[o+2],k=e[f],S=e[f+1],w=e[f+2],I=n?c(_,b,x,k,S,w):u(_,b,k,S);if(I)if(h+=I,n){var T=d(_,b,x,k,S,w);p+=I*T[0],v+=I*T[1],y+=I*T[2]}else{var C=l(_,b,k,S);p+=I*C[0],v+=I*C[1]}}return h>0?n?[p/h,v/h,y/h]:[p/h,v/h]:r>0?n?[e[t],e[t+1],e[t+2]]:[e[t],e[t+1]]:null}(g,0,y[0],r,n):null;if(!F)return null;h[0]=F[0],h[1]=F[1],r&&F.length>2&&(h[2]=F[2])}return e}function o(e,t,r,n,a,s){for(var o=arguments.length>6&&void 0!==arguments[6]?arguments[6]:1,u=i(a,s),c=r,l=r+u,d=0,f=0,h=0,p=0,v=0,y=0,g=n-1;y<g;y++,c+=u,l+=u){var m=t[c],_=t[c+1],b=t[c+2],x=t[l],k=t[l+1],S=t[l+2],w=m*k-x*_;p+=w,d+=(m+x)*w,f+=(_+k)*w,a&&(h+=(b+S)*(w=m*S-x*b),v+=w),m<e[0]&&(e[0]=m),m>e[1]&&(e[1]=m),_<e[2]&&(e[2]=_),_>e[3]&&(e[3]=_),a&&(b<e[4]&&(e[4]=b),b>e[5]&&(e[5]=b))}if(p*o>0&&(p*=-1),v*o>0&&(v*=-1),!p)return null;var I=[d,f,.5*p];return a&&(I[3]=h,I[4]=.5*v),I}function u(e,t,r,n){var a=r-e,i=n-t;return Math.sqrt(a*a+i*i)}function c(e,t,r,n,a,i){var s=n-e,o=a-t,u=i-r;return Math.sqrt(s*s+o*o+u*u)}function l(e,t,r,n){return[e+.5*(r-e),t+.5*(n-t)]}function d(e,t,r,n,a,i){return[e+.5*(n-e),t+.5*(a-t),r+.5*(i-r)]}})),r.register("6Gukk",(function(e,n){t(e.exports,"createDebugLogger",(function(){return s})),t(e.exports,"DEBUG_ATTR_UPDATES",(function(){return o}));var a,i=r("8TSCy"),s=function(e,t){return e&&function(){for(var e=arguments.length,r=new Array(e),n=0;n<e;n++)r[n]=arguments[n];return(a=t).warn.apply(a,["DEBUG:"].concat(i.toConsumableArray(r)))}||function(){return null}},o=!1})),r.register("1Fs6Q",(function(e,n){t(e.exports,"getVisualVariableSizeValueRepresentationRatio",(function(){return d})),t(e.exports,"convertVisualVariables",(function(){return v}));var a=r("8TSCy"),i=r("7qybv"),s=r("iXlXu"),o=r("hUDEJ"),u=r("4WoSm"),c=r("66IJZ"),l=r("2VOK9");function d(e,t){if(!e||!t)return e;switch(t){case"radius":case"distance":return 2*e;case"diameter":case"width":return e;case"area":return Math.sqrt(e)}return e}function f(e){return e.map((function(e){return{value:(t=e).value,size:(0,s.toPt)(t.size)};var t}))}function h(e){if("string"==typeof e||"number"==typeof e)return(0,s.toPt)(e);var t=e;return{type:"size",expression:t.expression,stops:f(t.stops)}}var p=function(e){for(var t=[],r=[],n=f(e),a=n.length,i=0;i<6;i++){var o=n[Math.min(i,a-1)];t.push(o.value),r.push(null==o.size?u.NAN_MAGIC_NUMBER:(0,s.pt2px)(o.size))}return{values:new Float32Array(t),sizes:new Float32Array(r)}};function v(e){var t=e&&e.length>0?{}:null,r=t?{}:null;if(!t)return{vvFields:t,vvRanges:r};var n=!0,i=!1,s=void 0;try{for(var o,u=e[Symbol.iterator]();!(n=(o=u.next()).done);n=!0){var d=o.value;if(d.field&&(t[d.type]=d.field),"size"===d.type){r.size||(r.size={});var v=d;switch((0,l.getTypeOfSizeVisualVariable)(v)){case c.WGLVVFlag.SIZE_MINMAX_VALUE:r.size.minMaxValue={minDataValue:v.minDataValue,maxDataValue:v.maxDataValue,minSize:h(v.minSize),maxSize:h(v.maxSize)};break;case c.WGLVVFlag.SIZE_SCALE_STOPS:r.size.scaleStops={stops:f(v.stops)};break;case c.WGLVVFlag.SIZE_FIELD_STOPS:if(v.levels){var g={};for(var _ in v.levels)g[_]=p(v.levels[_]);r.size.fieldStops={type:"level-dependent",levels:g}}else r.size.fieldStops=a.objectSpread({type:"static"},p(v.stops));break;case c.WGLVVFlag.SIZE_UNIT_VALUE:r.size.unitValue={unit:v.valueUnit,valueRepresentation:v.valueRepresentation}}}else if("color"===d.type)r.color=m(d);else if("opacity"===d.type)r.opacity=y(d);else if("rotation"===d.type){var b=d;r.rotation={type:b.rotationType}}}}catch(e){i=!0,s=e}finally{try{n||null==u.return||u.return()}finally{if(i)throw s}}return{vvFields:t,vvRanges:r}}function y(e){var t={values:[0,0,0,0,0,0,0,0],opacities:[0,0,0,0,0,0,0,0]};if("string"==typeof e.field){if(!e.stops)return null;if(e.stops.length>8)return null;for(var r=e.stops,n=0;n<8;++n){var a=r[Math.min(n,r.length-1)];t.values[n]=a.value,t.opacities[n]=a.opacity}}else{if(!(e.stops&&e.stops.length>=0))return null;for(var i=e.stops&&e.stops.length>=0&&e.stops[0].opacity,s=0;s<8;s++)t.values[s]=1/0,t.opacities[s]=i}return t}function g(e,t,r){e[4*t+0]=r.r/255,e[4*t+1]=r.g/255,e[4*t+2]=r.b/255,e[4*t+3]=r.a}function m(e){if((0,i.isNone)(e))return null;if(e.normalizationField)return null;var t={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};if("string"==typeof e.field){if(!e.stops)return null;if(e.stops.length>8)return null;t.field=e.field;for(var r=e.stops,n=0;n<8;++n){var a=r[Math.min(n,r.length-1)];t.values[n]=a.value,g(t.colors,n,a.color)}}else{if(!(e.stops&&e.stops.length>=0))return null;for(var s=e.stops&&e.stops.length>=0&&e.stops[0].color,u=0;u<8;u++)t.values[u]=1/0,g(t.colors,u,s)}for(var c=0;c<32;c+=4)(0,o.premultiplyAlpha)(t.colors,c,!0);return t}})),r.register("2VOK9",(function(e,n){t(e.exports,"getTypeOfSizeVisualVariable",(function(){return c}));var a=r("kyj08"),i=r("jHOLN"),s=r("66IJZ"),o=r("5WctK"),u=i.default.getLogger("esri.views.2d.engine.webgl");function c(e){return(0,o.isNumber)(e.minDataValue)&&(0,o.isNumber)(e.maxDataValue)&&null!=e.minSize&&null!=e.maxSize?s.WGLVVFlag.SIZE_MINMAX_VALUE:(e.expression&&"view.scale"===e.expression||e.valueExpression&&"$view.scale"===e.valueExpression)&&Array.isArray(e.stops)?s.WGLVVFlag.SIZE_SCALE_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&(Array.isArray(e.stops)||"levels"in e&&e.levels)?s.WGLVVFlag.SIZE_FIELD_STOPS:(null!=e.field||e.expression&&"view.scale"!==e.expression||e.valueExpression&&"$view.scale"!==e.valueExpression)&&null!=e.valueUnit?s.WGLVVFlag.SIZE_UNIT_VALUE:(u.error(new(0,a.default)("mapview-bad-type","Found invalid size VisualVariable",e)),s.WGLVVFlag.NONE)}})),r.register("8lbQw",(function(e,r){t(e.exports,"u32to4Xu8",(function(){return a})),t(e.exports,"i1616to32",(function(){return i})),t(e.exports,"i8888to32",(function(){return s}));var n=new Float32Array(1);new Uint32Array(n.buffer);function a(e){return[255&e,(65280&e)>>>8,(16711680&e)>>>16,(4278190080&e)>>>24]}function i(e,t){return 65535&e|t<<16}function s(e,t,r,n){return 255&e|(255&t)<<8|(255&r)<<16|n<<24}}))}();
//# sourceMappingURL=Pipeline.ab01a95a.js.map
