function e(e,t,a,s){Object.defineProperty(e,t,{get:a,set:s,enumerable:!0,configurable:!0})}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire594f;t.register("9p7MQ",(function(a,s){e(a.exports,"uploadAssets",(function(){return f}));var r=t("bYA0c"),o=t("bPmsI"),n=t("6TszD"),i=t("lHg4e"),l=t("7dRCe"),u=t("e63kH"),c=t("3hKVg"),p=t("1IkKg"),d=t("SRsHh");async function f(e,t,a){return e.length?Promise.all(e.map((e=>async function(e,{layer:t,ongoingUploads:a},s){const r=a.get(e);if(r)return r;if(!function(e){return!!e.infoFor3D&&!!e.url}(t))throw new(0,o.default)(`${t.type}-layer:upload-failure`,"Layer does not support asset uploads.",new Error);if(function(e,t){const{parsedUrl:a}=t;return null!=a&&e.metadata.externalSources.some((e=>(0,c.externalIsOnService)(e,a)))}(e,t))return e;const n=async function(e,t,a){const{metadata:s}=e,{displaySource:r}=s,n=w(r?.source,t),l=!!n,c=s.externalSources.length>0,p=l?async function(e,t,a){return{source:await m(e,t,a),original:!0}}(n,t,a):c?async function(e,t,a){const s=b(t),{externalSources:r}=e.metadata,n=function(e,t){for(const a of e){const e=w(a.source,t);if(e)return e}return null}(r,t);if(!n)throw new(0,o.default)(`${t.type}-layer:upload-failure`,"Could not find an external source that is supported by the service.",new Error);const i=await m(n,t,a);return e.addExternalSources([{source:i,original:!0}]),{source:await g(i,t,s)}}(e,t,a):async function(e,t,a){const s=async function(e,t,a){const s=b(t),r=await e.load(a),o=await r.toBinaryGLTF({ignoreLocalTransform:!0});(0,i.throwIfAborted)(a);const n=await o.buffer();return(0,i.throwIfAborted)(a),{blob:new Blob([n.data],{type:n.type}),assetName:`${(0,u.generateBracedUUID)()}.glb`,assetType:s}}(e,t,a);return{source:await h([s],t,a),extent:e.extent.clone(),original:!0}}(e,t,a),d=await p;return(0,i.throwIfAborted)(a),e.addExternalSources([d]),e}(e,t,s);a.set(e,n);try{await n}finally{a.delete(e)}return e}(e,t,a)))):[]}function w(e,t){if(!e)return null;const{infoFor3D:{supportedFormats:a,editFormats:s}}=t,r=(0,c.externalSourceToMultiPart)(e),o=new Array;let n=!1;for(let e=0;e<r.length;++e){const t=y(r[e],a);if(!t)return null;s.includes(t.assetType)&&(n=!0),o.push(t)}return n?o:null}function y(e,t){const a=(0,c.assetFormatId)(e,t);return a?{asset:e,assetType:a}:null}async function m(e,t,a){return h(e.map((e=>async function(e,t){const{asset:a,assetType:s}=e;if(a instanceof File)return{blob:a,assetName:a.name,assetType:s};const r=await a.toBlob(t);return(0,i.throwIfAborted)(t),{blob:r,assetName:a.assetName,assetType:s}}(e,a))),t,a)}async function h(e,t,a){const s=await Promise.all(e.map((async e=>{const s=async function(e,t,a){const{blob:s,assetType:r,assetName:u}=e;let c=null;try{const e=await(0,p.uploadItem)({data:s,name:u},t.url,a);(0,i.throwIfAborted)(a),c={assetType:r,assetUploadId:e.itemID}}catch(e){(0,i.throwIfAbortError)(e),n.default.getLogger("esri.layers.graphics.sources.support.uploadAssets").warnOnce(`Service ${t.url} does not support the REST Uploads API.`)}if(!c){const e=await(0,l.parseData)(s);if((0,i.throwIfAborted)(a),!e.isBase64)throw new(0,o.default)(`${t.type}-layer:uploadAssets-failure`,"Expected gltf data in base64 format after conversion.",new Error);c={assetType:r,assetData:e.data}}if(!c)throw new(0,o.default)(`${t.type}-layer:uploadAssets-failure`,"Unable to prepare uploadAsset request options.",new Error);return{item:c,assetName:u}}(await e,t,a);return(0,i.throwIfAborted)(a),s})));(0,i.throwIfAborted)(a);const{uploadResults:u}=await async function(e,t,a){const s=await(0,r.default)((0,l.join)(t.parsedUrl.path,"uploadAssets"),{timeout:0,query:{f:"json",assets:JSON.stringify(e)},method:"post",responseType:"json"});if((0,i.throwIfAborted)(a),s.data.uploadResults.length!==e.length)throw new(0,o.default)(`${t.type}-layer:uploadAssets-failure`,`Bad response. Uploaded ${e.length} items and received ${s.data.uploadResults.length} results.`,new Error);return s.data}(s.map((({item:e})=>e)),t,a);return(0,i.throwIfAborted)(a),e.map(((e,a)=>function(e,t,a){const{success:s}=t;if(!s){const{error:s}=t;throw new(0,o.default)(`${a.type}-layer:upload-failure`,`Failed to upload mesh file ${e.assetName}. Error code: ${s.code}. Error message: ${s.messages}`,new Error)}const{assetHash:r}=t,{assetName:n,item:{assetType:i}}=e,{infoFor3D:{supportedFormats:l}}=a,u=(0,d.getFormatIdMimeType)(i,l);if(!u)throw new(0,o.default)(`${a.type}-layer:upload-failure`,`The service allowed us to upload an asset of FormatID ${i}, but it does not list it in its supported formats.`,new Error);return new(0,c.ServiceAsset)(n,u,[new(0,c.ServiceAssetPart)(`${a.parsedUrl.path}/assets/${r}`,r)])}(s[a],u[a],t)))}async function g(e,t,a){const s=e.map((({assetName:e,parts:t})=>({assetName:e,assetHash:t[0].partHash}))),n=t.capabilities?.operations.supportsAsyncConvert3D,u={query:{f:"json",assets:JSON.stringify(s),transportType:"esriTransportTypeUrl",targetFormat:a,async:n},responseType:"json",timeout:0},p=(0,l.join)(t.parsedUrl.path,"convert3D"),f=(n?await async function(e,t){const a=(await(0,r.default)(e,t)).data.statusUrl;for(;;){const e=(await(0,r.default)(a,{query:{f:"json"},responseType:"json"})).data;switch(e.status){case"Completed":return(0,r.default)(e.resultUrl,{query:{f:"json"},responseType:"json"});case"CompletedWithErrors":throw new(0,o.default)("async-convert3D-failed","asynchronous convert3D call failed.");case"Failed ImportChanges":case"InProgress":case"Pending":case"ExportAttachments":case"ExportChanges":case"ExportingData":case"ExportingSnapshot":case"ImportAttachments":case"ProvisioningReplica":case"UnRegisteringReplica":break;default:throw new(0,o.default)("async-convert3D-failed","asynchronous convert3D call failed (undefined response status)")}await(0,i.after)(I)}}(p,u):await(0,r.default)(p,u)).data,{infoFor3D:{supportedFormats:w}}=t;return f.assets.map((e=>{const a=(0,d.getMimeTypeFormatId)(e.contentType,w);if(!a)throw new(0,o.default)(`${t.type}-layer:upload-failure`,`The service allowed us to upload an asset of FormatID ${a}, but it does not list it in its supported formats.`,new Error);return new(0,c.ServiceAsset)(e.assetName,e.contentType,[new(0,c.ServiceAssetPart)(e.assetURL,e.assetHash)])}))}function b(e){const{infoFor3D:t}=e,a=(0,d.getMimeTypeFormatId)("model/gltf-binary",t.supportedFormats)??(0,d.getFilenameFormatId)("glb",t.supportedFormats);if(!a)throw new(0,o.default)(`${e.type}-layer:upload-failure`,"Layer does not support glb.",new Error);return a}const I=1e3})),t.register("1IkKg",(function(a,s){e(a.exports,"uploadItem",(function(){return c}));var r=t("bYA0c"),o=t("lHg4e"),n=t("7dRCe"),i=t("c8U9w");const l=1e6,u=2e7;async function c({data:e,name:t,description:a},s,c){let p=null;try{const d=(0,n.join)(s,"uploads"),f=(0,n.join)(d,"info"),{data:w}=await(0,r.default)(f,{query:{f:"json"},responseType:"json"});(0,o.throwIfAborted)(c);const y=(0,i.isHostedAgolService)(s),m=w.maxUploadFileSize*l,h=y?2e9:m,g=y?Math.min(u,m):u;if(e.size>h)throw new Error("Data too large");const b=(0,n.join)(d,"register"),{data:I}=await(0,r.default)(b,{query:{f:"json",itemName:t,description:a},responseType:"json",method:"post"});if((0,o.throwIfAborted)(c),!I.success)throw new Error("Registration failed");const{itemID:A}=I.item;p=(0,n.join)(d,A);const T=(0,n.join)(p,"uploadPart"),j=Math.ceil(e.size/g),F=new Array;for(let t=0;t<j;++t)F.push(e.slice(t*g,Math.min((t+1)*g,e.size)));const E=F.slice().reverse(),v=new Array,D=async()=>{for(;0!==E.length;){const e=F.length-E.length,t=E.pop(),a=new FormData;a.append("f","json"),a.append("file",t),a.append("partId",`${e}`);const{data:s}=await(0,r.default)(T,{timeout:0,body:a,responseType:"json",method:"post"});if((0,o.throwIfAborted)(c),!s.success)throw new Error("Part upload failed")}};for(let e=0;e<3&&0!==E.length;++e)v.push(D());await Promise.all(v);const $=(0,n.join)(p,"commit"),{data:S}=await(0,r.default)($,{query:{f:"json",parts:F.map(((e,t)=>t)).join(",")},responseType:"json",method:"post"});if((0,o.throwIfAborted)(c),!S.success)throw new Error("Commit failed");return S.item}catch(e){if(null!=p){const e=(0,n.join)(p,"delete");await(0,r.default)(e,{query:{f:"json"},responseType:"json",method:"post"})}throw e}}}));
//# sourceMappingURL=uploadAssets.53cdb838.js.map
