!function(){function e(e,t,a,r){Object.defineProperty(e,t,{get:a,set:r,enumerable:!0,configurable:!0})}var t=("undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{}).parcelRequire594f;t.register("h0ca8",(function(a,r){e(a.exports,"save",(function(){return j})),e(a.exports,"saveAs",(function(){return G}));var n,o,i,l,s,u=t("lNwWH"),d=t("kyj08"),c=t("jHOLN"),f=t("10vEZ"),y=t("amEsL"),p=t("g15Jq"),m=t("lmu5w"),w=t("Hse1P"),v=t("d1ImW"),g=t("ajJOT"),h=t("iYaGG"),S=t("UdTKD"),b=t("7Kuhs");const I=c.default.getLogger("esri.layers.FeatureLayer"),O="Feature Service";function T(e,t){return`Layer (title: ${e.title}, id: ${e.id}) of type '${e.declaredClass}' ${t}`}function K(e,t){if(t.type!==O)throw new(0,d.default)("feature-layer:portal-item-wrong-type",T(e,'should have portal item of type "Feature Service"'))}async function N(e){if(await e.load(),(0,v.isFeatureCollectionLayer)(e))throw new(0,d.default)("feature-layer:save",T(e,"using an in-memory source cannot be saved to a portal item"))}async function J(e,t,a){"beforeSave"in e&&"function"==typeof e.beforeSave&&await e.beforeSave();const r=e.write({},t);return function(e,t){var a;let r=(null!==(a=e.messages)&&void 0!==a?a:[]).filter((({type:e})=>"error"===e)).map((({name:e,message:t,details:a})=>new(0,d.default)(e,t,a)));if((null==t?void 0:t.ignoreUnsupported)&&(r=r.filter((({name:e})=>"layer:unsupported"!==e&&"symbol:unsupported"!==e&&"symbol-layer:unsupported"!==e&&"property:unsupported"!==e&&"url:unsupported"!==e))),r.length>0)throw new(0,d.default)("feature-layer:save","Failed to save feature layer due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:r})}(t,a),r}function P(e){const{layer:t,layerJSON:a}=e;return t.isTable?{layers:[],tables:[a]}:{layers:[a],tables:[]}}function x(e){(0,b.addTypeKeyword)(e,b.TypeKeyword.JSAPI),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(((e,t,a)=>a.indexOf(e)===t)))}async function F(e,t){var a;return/\/\d+\/?$/.test(null!==(a=e.url)&&void 0!==a?a:"")?P(t[0]):async function(e,t){const{layer:{url:a,customParameters:r,apiKey:i}}=t[0];let l=await e.fetchData("json");l&&null!=l.layers&&null!=l.tables||(l=await async function(e,t,a){e||(e={}),(n=e).layers||(n.layers=[]),(o=e).tables||(o.tables=[]);const{url:r,customParameters:i,apiKey:l}=t,{serviceJSON:s,layersJSON:u}=await(0,w.fetchFeatureService)(r,{customParameters:i,apiKey:l}),d=A(e.layers,s.layers,a),c=A(e.tables,s.tables,a);e.layers=d.itemResources,e.tables=c.itemResources;const y=[...d.added,...c.added],m=u?[...u.layers,...u.tables]:[];return await async function(e,t,a,r){const n=t.map((({id:e})=>new(0,p.default)({url:a,layerId:e,sourceJSON:r.find((({id:t})=>t===e))})));await(0,f.eachAlways)(n.map((e=>e.load()))),n.forEach((t=>{const{layerId:a,loaded:r,defaultPopupTemplate:n}=t;r&&null!=n&&L(t,{id:a,popupInfo:n.toJSON()},e)}))}(e,y,r,m),e}(l,{url:null!=a?a:"",customParameters:r,apiKey:i},t.map((e=>e.layer.layerId))));for(const e of t)L(e.layer,e.layerJSON,l);return l}(e,t)}function A(e,t,a){const r=(0,u.difference)(e,t,((e,t)=>e.id===t.id));e=e.filter((e=>!r.removed.some((t=>t.id===e.id))));const n=r.added.map((({id:e})=>({id:e})));return n.forEach((({id:t})=>{e.push({id:t})})),{itemResources:e,added:n.filter((({id:e})=>!a.includes(e)))}}function L(e,t,a){e.isTable?E(a.tables,t):E(a.layers,t)}function E(e,t){if(!e)return;const a=e.findIndex((({id:e})=>e===t.id));-1===a?e.push(t):e[a]=t}function $(e){const{portalItem:t}=e;return(0,v.isFeatureServiceLayer)(e)&&!e.dynamicDataSource&&!!(null==t?void 0:t.loaded)&&t.type===O}const j=(0,f.debounce)((async function(e,t){await N(e),function(e){const t=e.portalItem;if(!t)throw I.error("save: requires the portalItem property to be set"),new(0,d.default)("feature-layer:portal-item-not-set",T(e,"requires the portalItem property to be set"));if(!t.loaded)throw new(0,d.default)("feature-layer:portal-item-not-loaded",T(e,"cannot be saved to a portal item that does not exist or is inaccessible"));K(e,t)}(e);const a=e.portalItem,r=(0,S.createForItemWrite)(a),n=await J(e,r,t),o=await F(a,[{layer:e,layerJSON:n}]);return x(a),await a.update({data:o}),(0,y.updateOrigins)(r),a}));(0,f.debounce)((async(e,t)=>{await async function(e){if(!(null==e?void 0:e.length))throw new(0,d.default)("feature-layer-utils-saveall:missing-parameters","'layers' array should contain at least one feature layer");await Promise.all(e.map((e=>e.load())));for(const t of e)if(!$(t))throw new(0,d.default)("feature-layer-utils-saveall:invalid-parameters",`'layers' array should only contain layers or tables in a feature service loaded from 'Feature Service' item. ${T(t,"does not conform")}`,{layer:t});const t=e.map((e=>e.portalItem.id));if(new Set(t).size>1)throw new(0,d.default)("feature-layer-utils-saveall:invalid-parameters","All layers in the 'layers' array should be loaded from the same portal item");const a=e.map((e=>e.layerId));if(new Set(a).size!==a.length)throw new(0,d.default)("feature-layer-utils-saveall:invalid-parameters","'layers' array should contain only one instance each of layer or table in a feature service")}(e);const a=e[0].portalItem,r=(0,S.createForItemWrite)(a),n=await Promise.all(e.map((e=>J(e,r,t)))),o=await F(a,e.map(((e,t)=>({layer:e,layerJSON:n[t]}))));return x(a),await a.update({data:o}),await Promise.all(e.slice(1).map((e=>e.portalItem.reload()))),(0,y.updateOrigins)(r),a.clone()}));const G=(0,f.debounce)((async function(e,t,a){await N(e);const r=function(e,t){let a=h.default.from(t);var r,n;return a.id&&(a=a.clone(),a.id=null),null!==(r=(i=a).type)&&void 0!==r||(i.type=O),null!==(n=(l=a).portal)&&void 0!==n||(l.portal=g.default.getDefault()),K(e,a),a}(e,t),n=(0,S.createForItemWrite)(r),o=P({layer:e,layerJSON:await J(e,n,a)});return await async function(e,t){const{url:a,layerId:r,title:n,fullExtent:o,isTable:i}=e,l=(0,m.parse)(a),u=null!=l&&"FeatureServer"===l.serverType;t.url=u?a:`${a}/${r}`,(s=t).title||(s.title=n),t.extent=null,i||null==o||(t.extent=await(0,b.getWGS84ExtentForItem)(o)),(0,b.removeTypeKeyword)(t,b.TypeKeyword.METADATA),(0,b.removeTypeKeyword)(t,b.TypeKeyword.MULTI_LAYER),(0,b.addTypeKeyword)(t,b.TypeKeyword.SINGLE_LAYER),i&&(0,b.addTypeKeyword)(t,b.TypeKeyword.TABLE),x(t)}(e,r),await async function(e,t,a){var r;const n=e.portal;await(null==n?void 0:n.signIn()),await(null==n||null===(r=n.user)||void 0===r?void 0:r.addItem({item:e,data:t,folder:null==a?void 0:a.folder}))}(r,o,a),e.portalItem=r,(0,y.updateOrigins)(n),r}))})),t.register("amEsL",(function(a,r){e(a.exports,"updateOrigins",(function(){return o}));var n=t("arTQ0");function o(e){e&&e.writtenProperties&&e.writtenProperties.forEach((({target:e,propName:t,newOrigin:a})=>{(0,n.isMultiOriginJSONMixin)(e)&&a&&e.originOf(t)!==a&&e.updateOrigin(t,a)}))}})),t.register("arTQ0",(function(t,a){function r(e){return e&&"getAtOrigin"in e&&"originOf"in e}e(t.exports,"isMultiOriginJSONMixin",(function(){return r}))})),t.register("Hse1P",(function(a,r){e(a.exports,"fetchFeatureService",(function(){return o}));var n=t("8I1KP");async function o(e,t){const a=await(0,n.fetchArcGISServiceJSON)(e,t);a.layers=a.layers.filter(i);const r={serviceJSON:a};var o;if((null!==(o=a.currentVersion)&&void 0!==o?o:0)<10.5)return r;const l=await(0,n.fetchArcGISServiceJSON)(e+"/layers",t);return r.layersJSON={layers:l.layers.filter(i),tables:l.tables},r}function i(e){return!e.type||"Feature Layer"===e.type}})),t.register("8I1KP",(function(a,r){e(a.exports,"fetchArcGISServiceJSON",(function(){return o}));var n=t("9pNSx");async function o(e,t){const{data:a}=await(0,n.default)(e,{responseType:"json",query:{f:"json",...null==t?void 0:t.customParameters,token:null==t?void 0:t.apiKey}});return a}}))}();
//# sourceMappingURL=featureLayerUtils.2ef4e790.js.map
